
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
      
      
      
        <link rel="canonical" href="https://yfy.cqu.ai/%E5%8D%9A%E5%AE%A2--%E7%BD%91%E7%BB%9C/2024/03/15/MTU%E7%9A%84%E9%82%A3%E4%BA%9B%E5%9D%91%28%E4%BA%8C%E5%B1%82%E9%9A%A7%E9%81%93%E7%BB%84%E7%BD%91%29/">
      
      
        <link rel="prev" href="../../../02/27/%E4%B8%BA%E8%AE%BE%E5%A4%87%E5%88%86%E9%85%8D%E9%9D%99%E6%80%81v6-ndppd/">
      
      
        <link rel="next" href="../../../../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2024/04/05/%E5%8F%B0%E5%BC%8F%E6%9C%BA%E5%8D%87%E7%BA%A7-%E7%A1%AC%E4%BB%B6%E7%AF%87/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>MTU 的那些坑(二层隧道组网) - Rain 的随笔</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#背景" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../../.." title="Rain 的随笔" class="md-header__button md-logo" aria-label="Rain 的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rain 的随笔
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MTU 的那些坑(二层隧道组网)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../../../../.." class="md-tabs__link">
        
  
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../about/" class="md-tabs__link">
        
  
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tags/" class="md-tabs__link">
        
  
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../series/" class="md-tabs__link">
        
  
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tools/" class="md-tabs__link">
        
  
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../archive/2024/" class="md-tabs__link">
          
  
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../category/%E4%B8%AA%E4%BA%BA/" class="md-tabs__link">
          
  
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Rain 的随笔" class="md-nav__button md-logo" aria-label="Rain 的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Rain 的随笔
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    标签
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    系列
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    分类
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E4%B8%AA%E4%BA%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    个人
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%8D%9A%E5%AE%A2--%E7%BD%91%E7%BB%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客 &amp; 网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    学习笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    折腾记录
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    课程笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    软件工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E9%98%85%E8%AF%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    阅读
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    回到主页
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    元数据
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2024-03-15 12:55:15+00:00" class="md-ellipsis">2024年3月15日</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            分类于
                            
                              <a href="../../../../../category/%E5%8D%9A%E5%AE%A2--%E7%BD%91%E7%BB%9C/">博客 &amp; 网络</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              需要 23 分钟阅读时间
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#背景" class="md-nav__link">
    <span class="md-ellipsis">
      背景
    </span>
  </a>
  
    <nav class="md-nav" aria-label="背景">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#二层隧道方案" class="md-nav__link">
    <span class="md-ellipsis">
      二层隧道方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#遇到的问题" class="md-nav__link">
    <span class="md-ellipsis">
      遇到的问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#基础知识" class="md-nav__link">
    <span class="md-ellipsis">
      基础知识
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基础知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ip-分片" class="md-nav__link">
    <span class="md-ellipsis">
      IP 分片
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pmtud" class="md-nav__link">
    <span class="md-ellipsis">
      PMTUD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pmtud-失败与-mss-clamping" class="md-nav__link">
    <span class="md-ellipsis">
      PMTUD 失败与 MSS clamping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mtu-1508" class="md-nav__link">
    <span class="md-ellipsis">
      MTU 1508？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#参考资料" class="md-nav__link">
    <span class="md-ellipsis">
      参考资料
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#定位问题但无法解决" class="md-nav__link">
    <span class="md-ellipsis">
      定位问题（但无法解决）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="定位问题（但无法解决）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#实验一设置-bridge-mtu-不影响接收只影响发送" class="md-nav__link">
    <span class="md-ellipsis">
      实验一：设置 bridge MTU 不影响接收只影响发送
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实验二同一个二层无法发-icmp-unreachable" class="md-nav__link">
    <span class="md-ellipsis">
      实验二：同一个二层无法发 ICMP unreachable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实验三icmp-影响系统-pmtu-缓存" class="md-nav__link">
    <span class="md-ellipsis">
      实验三：ICMP 影响系统 PMTU 缓存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实验四gre-tap-隧道导致二层-mtu-不一致" class="md-nav__link">
    <span class="md-ellipsis">
      实验四：GRE Tap 隧道导致二层 MTU 不一致
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#总结与思考" class="md-nav__link">
    <span class="md-ellipsis">
      总结与思考
    </span>
  </a>
  
    <nav class="md-nav" aria-label="总结与思考">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#可能的解决" class="md-nav__link">
    <span class="md-ellipsis">
      可能的解决？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#解决了" class="md-nav__link">
    <span class="md-ellipsis">
      解决了？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="解决了？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ping-大包测试" class="md-nav__link">
    <span class="md-ellipsis">
      ping 大包测试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcp-mss-也是正常工作的" class="md-nav__link">
    <span class="md-ellipsis">
      TCP MSS 也是正常工作的
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nft-查看-mss-被修改的过程" class="md-nav__link">
    <span class="md-ellipsis">
      nft 查看 MSS 被修改的过程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#补充访问-op2-lan1-优化" class="md-nav__link">
    <span class="md-ellipsis">
      补充：访问 op2 lan1 优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#再次总结与思考" class="md-nav__link">
    <span class="md-ellipsis">
      再次总结与思考
    </span>
  </a>
  
    <nav class="md-nav" aria-label="再次总结与思考">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#通过-dhcp-option-设置所有设备-mtu" class="md-nav__link">
    <span class="md-ellipsis">
      通过 DHCP option 设置所有设备 MTU
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vlan-切换方案" class="md-nav__link">
    <span class="md-ellipsis">
      VLAN 切换方案
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VLAN 切换方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#windows-获得错误的-v6-地址ra-跨了网段" class="md-nav__link">
    <span class="md-ellipsis">
      windows 获得错误的 v6 地址（RA 跨了网段）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#202412-更新-l2tpv3failed" class="md-nav__link">
    <span class="md-ellipsis">
      2024/12 更新 L2TPv3（failed）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2024/12 更新 L2TPv3（failed）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#l2tp-配置" class="md-nav__link">
    <span class="md-ellipsis">
      L2TP 配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openwrt-l2tpv3-pseudowire-bridged-to-lan" class="md-nav__link">
    <span class="md-ellipsis">
      openwrt L2TPv3 Pseudowire bridged to LAN
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#参考" class="md-nav__link">
    <span class="md-ellipsis">
      参考
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  


  <nav class="md-tags" >
    
      
      
      
        <a href="../../../../../tags/#tag:gre" class="md-tag">GRE</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:mss" class="md-tag">MSS</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:mtu" class="md-tag">MTU</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:pmtud" class="md-tag">PMTUD</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:fragment" class="md-tag">fragment</a>
      
    
  </nav>



  <h1>MTU 的那些坑(二层隧道组网)</h1>

<h2 id="背景">背景<a class="headerlink" href="#背景" title="Permanent link">&para;</a></h2>
<p>背景：串流软件不支持手动添加 ip，导致需要二层隧道连接两个路由器。</p>
<div class="admonition note">
<p class="admonition-title">通过 mDNS proxy 实现本地发现</p>
<p>之前还研究过这类软件一般是怎么发现server的。发现确实有一些方法可以实现跨网络的发现。比如常见的“发现”协议（不知道术语是什么）有mDNS和upnp。是通过ipv4 multicast实现的，所以只要能proxy多播包，就可以实现在两个网络互相发现。</p>
</div>
<p>2024/4/17 update: 今天在搜索 vxlan 时发现了一篇博客也遇到了这个问题。他的解决方案是通过设置 bridge-nf-call-iptables 使得桥接的数据包也通过 iptable，然后再通过 iptable 修正 MSS。因此其方案对于 UDP 仍然存在问题。不过将 bridge 的包进行三层的处理的思路是一样的。<a href="https://blog.t123yh.xyz:3/index.php/archives/941">在 OpenWrt 设备间使用 VXLAN 创建隧道 – t123yh's Blog</a>
看来这个问题并不是 gre 才会有的。那有没有更加现代的二层隧道协议，能够自动解决这个问题呢？</p>
<h3 id="二层隧道方案">二层隧道方案<a class="headerlink" href="#二层隧道方案" title="Permanent link">&para;</a></h3>
<p>隧道方案如下图所示：</p>
<p><img alt="二层隧道拓扑图" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/gre-tap.drawio.png" /></p>
<ul>
<li>两个路由器间通过 WAN 口 IPv4 建立 GRE Tap 隧道</li>
<li>op1 上将直接将 tap 接口桥接到到原有 br-lan 上</li>
<li>op2 保留了原本自己的 lan，然后创建了一个新的 br-lan2，连接了 gre tap 接口和 eth2 接口。</li>
</ul>
<div class="admonition note">
<p class="admonition-title">op2 是 PVE Host 上一个容器</p>
<p>op2是PVE上的一个LXC容器，分配了eth0, eth1, eth2分别对应wan, lan1, lan2</p>
</div>
<ul>
<li>op2 侧将一个无线路由器连接到 PVE host（软路由）一个网口，该网口位于 PVE vmbr2 下。op2 eth2 也连接到了 vmbr2。</li>
</ul>
<ul>
<li>通过切换无线路由器连接到 PVE host 不同网口（对应 vmbr1 和 vmbr2），可以控制无线路由器位于 lan1 还是 lan2。</li>
</ul>
<div class="admonition note">
<p class="admonition-title">VLAN 切换 SSID 方案</p>
<p>刚开始想了一个更复杂不用改动AP网线的方案。将AP通过一根线和软路由连接，然后创建2个vlan。AP上，创建两个不同SSID绑定到不同VLAN接口上。这样就可以通过更改连接的WiFi来切换lan1和lan2了。不过PVE上vlan貌似配置有点复杂：可能需要创建一个vlan awareness的vmbr1，然后op2连接到vmbr1的eth1和eth2指定不同vlan id。但是我没想清楚vmbr1下untagged的接口怎么办？vmbr1设置了awareness后还能连接untagged的端口吗？因为不太了解PVE VLAN awareness bridge的更详细内容，加上路由器就在手边，换条线也很快，因此就没有使用该方案。</p>
</div>
<h3 id="遇到的问题">遇到的问题<a class="headerlink" href="#遇到的问题" title="Permanent link">&para;</a></h3>
<p>实现上述方案后，确实让一开始的 VR 串流软件可以工作了，但是确遇到了一些意外的问题。</p>
<p>我发现我的手机平板都无法使用 moonlight 串流我位于 op1 下的台式机 KVM-win10 了。</p>
<ul>
<li>moonlight 显示在线（这个需要开启 MSS clamping），但是一连接就报错。报错让检查 UDP 端口 478000 是否开放。</li>
<li>笔记本同样连接的 WiFi，却确能够正常串流</li>
</ul>
<p>以前也遇到这样能 ping 通，但是一发送数据就出问题的现象。问题一般是哪里的接口 MTU 设置不正确导致的，因此这次也是往 MTU 这方面排查问题。
加上之前遇到的 MSS 问题，于是这次相当于把我知道的都结合起来，看能否解决这个问题。</p>
<!-- more -->
<h2 id="基础知识">基础知识<a class="headerlink" href="#基础知识" title="Permanent link">&para;</a></h2>
<h3 id="ip-分片">IP 分片<a class="headerlink" href="#ip-分片" title="Permanent link">&para;</a></h3>
<p>MTU，链路层的概念，表示能承载的网络层及以上的包的大小。正常以太网帧的 payload 部分范围应该在 46B - 1500B 之间，也就是 MTU 最大为 1500。
<img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240315234352.png" /></p>
<p>当我们使用 GRE，Wireguard 等隧道时，实际的 MTU 需要减去额外 Header 的开销，因此就会小于 1500。比如 wg ipv4 = 1440, wg ipv6 = 1420。</p>
<p>当上层协议包大小超过链路层 MTU 时，我们需要一种机制将包拆分，然后合并（重组）。这个功能是在 IP 层实现的。IPv4 Header 中有 Flag 和 Fragment offset，用于实现分片与合并。</p>
<p><img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240315235458.png" /></p>
<div class="admonition note">
<p class="admonition-title">Don't fragment 标志</p>
<p>ipv4头中Flags可以设置DF flag，表示禁止分片。这样当需要分片时，router节点应该返回ICMP Fragmentation Needed (Type 3, Code 4)。ipv6由于禁止了router分片（只能通信端点进行分片），因此header中没有也不需要该标志。</p>
</div>
<div class="admonition note">
<p class="admonition-title">ipv4 和 ipv6 分片的区别</p>
<p>ipv4中间路由器可以对包进行分片，<strong>最后所有的分片包在目的节点合并</strong>
而ipv6禁止了路由器对包进行分片，分片必须在源和目的节点上进行。因此通信节点间必须先进行PMTUD（路径MTU发现），否则遇到MTU不够时，中间节点会返回ICMPv6 Packet Too Big (Type 2)。</p>
</div>
<h3 id="pmtud">PMTUD<a class="headerlink" href="#pmtud" title="Permanent link">&para;</a></h3>
<p>PMTUD，即 Path MTU Dsicovery，用于发现通信路径上的最大 MTU，用来避免分片。</p>
<p>PMTUD 常见的是基于 ICMP 的方法：</p>
<ul>
<li>对于 IPv4，可以设置 DF 标志，如果收到 Fragmentation Needed，就减小 MTU（ICMP 数据中包含下一条需要的 MTU）</li>
<li>对于 IPv6，没有不分片标志。设置初始 MTU 为网卡 MTU，如果中间设备返回 ICMPv6 type 2 消息，就减少 MTU。</li>
</ul>
<p>我们可以使用 ping 来测试</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span>ping<span class="w"> </span>www.baidu.com<span class="w"> </span>-l<span class="w"> </span><span class="m">1372</span><span class="w"> </span>-f
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>正在<span class="w"> </span>Ping<span class="w"> </span>www.a.shifen.com<span class="w"> </span><span class="o">[</span><span class="m">182</span>.61.200.6<span class="o">]</span><span class="w"> </span>具有<span class="w"> </span><span class="m">1372</span><span class="w"> </span>字节的数据:
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>来自<span class="w"> </span><span class="m">182</span>.61.200.6<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">1372</span><span class="w"> </span><span class="nv">时间</span><span class="o">=</span>33ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">46</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>$<span class="w"> </span>ping<span class="w"> </span>www.baidu.com<span class="w"> </span>-l<span class="w"> </span><span class="m">1373</span><span class="w"> </span>-f
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>正在<span class="w"> </span>Ping<span class="w"> </span>www.a.shifen.com<span class="w"> </span><span class="o">[</span><span class="m">182</span>.61.200.6<span class="o">]</span><span class="w"> </span>具有<span class="w"> </span><span class="m">1373</span><span class="w"> </span>字节的数据:
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>需要拆分数据包但是设置<span class="w"> </span>DF。
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">linux ping 参数</p>
<p>使用<code>-s</code>指定数据部分大小，使用<code>-M do</code>禁止分片</p>
</div>
<p>可以看到，我到百度的 PTMU 为 1372（因为实际中经过了一个 1400 的 wg 隧道）</p>
<ul>
<li>其中 <code>-l</code> 指定 icmp data 部分，因此实际 ip 包大小为：20 + 8 + 1372 = 1400</li>
<li><code>-f</code>禁用分片</li>
</ul>
<p>下图是使用 wireshark 抓到的 ICMP 包截图。type 为 destination unreachable，code 表明这是由于需要分片导致的。ICMP 中还包含了下一跳的 MTU（1400），并且将原本的 ip 包放在了结尾（可以看到原本的 IP 头，和 icmp 头）
<img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240316192524.png" /></p>
<h3 id="pmtud-失败与-mss-clamping">PMTUD 失败与 MSS clamping<a class="headerlink" href="#pmtud-失败与-mss-clamping" title="Permanent link">&para;</a></h3>
<p>实际路由器由于安全考虑，会禁止转发 ICMP 消息，因此会导致 PMTUD 失效。这样对于 ipv6，可能会产生黑洞连接现象：TCP 三次握手成功（数据小于 MTU），但是发送数据没有响应（超过路径 MTU，包被丢弃）。</p>
<p>因此有些路由器提供了 MSS clamping 功能。路由器会对转发的 TCP 包的 MSS 进行修改。这样就能保证通信双方不会产生超过 MTU 的包，从而避免分片。</p>
<div class="admonition note">
<p class="admonition-title">MSS 介绍</p>
<ul>
<li>MSS (maximum segment size) 是 TCP 中的概念，是连接双方能够接收的最大 segment 大小。</li>
<li>MSS = MTU - IP header - TCP header。MTU 为 1500 时，MSS 为 1460</li>
<li>MSS 会在 TCP 三次握手时进行协商，作为 TCP 头中 option 的内容。[并且只能在 SYNC 被设置时才能包含。](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#:~:text=urgent%20data%20byte.-,Options,-(Variable%200%E2%80%93320)
<img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240316195430.png" /></li>
</ul>
</div>
<p>MSS clamping 基于 iptable 实现。可以设置静态的数值，也可以设置成根据出口网卡 MTU 自动设置。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># 固定设置成1460</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>iptables<span class="w"> </span>-t<span class="w"> </span>mangle<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--tcp-flags<span class="w"> </span>SYN,RST<span class="w"> </span>SYN<span class="w"> </span>-o<span class="w"> </span>eth0<span class="w"> </span>-j<span class="w"> </span>TCPMSS<span class="w"> </span>--set-mss<span class="w"> </span><span class="m">1460</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># 根据PMTU自动设置</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>iptables<span class="w"> </span>-t<span class="w"> </span>mangle<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--tcp-flags<span class="w"> </span>SYN,RST<span class="w"> </span>SYN<span class="w"> </span>-o<span class="w"> </span>eth0<span class="w"> </span>-j<span class="w"> </span>TCPMSS<span class="w"> </span>--clamp-mss-to-pmtu
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">openwrt 只对 forward 进行 MSS clamping？</p>
<p>openwrt开启 MSS clamping后，会在mangle_forward中添加以下规则。因此貌似只对forward生效</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>chain<span class="w"> </span>mangle_forward<span class="w"> </span><span class="o">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nb">type</span><span class="w"> </span>filter<span class="w"> </span>hook<span class="w"> </span>forward<span class="w"> </span>priority<span class="w"> </span>mangle<span class="p">;</span><span class="w"> </span>policy<span class="w"> </span>accept<span class="p">;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span>iifname<span class="w"> </span><span class="s2">&quot;warp&quot;</span><span class="w"> </span>tcp<span class="w"> </span>flags<span class="w"> </span>syn<span class="w"> </span>tcp<span class="w"> </span>option<span class="w"> </span>maxseg<span class="w"> </span>size<span class="w"> </span><span class="nb">set</span><span class="w"> </span>rt<span class="w"> </span>mtu<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: Zone warp IPv4/IPv6 ingress MTU fixing&quot;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span>oifname<span class="w"> </span><span class="s2">&quot;warp&quot;</span><span class="w"> </span>tcp<span class="w"> </span>flags<span class="w"> </span>syn<span class="w"> </span>tcp<span class="w"> </span>option<span class="w"> </span>maxseg<span class="w"> </span>size<span class="w"> </span><span class="nb">set</span><span class="w"> </span>rt<span class="w"> </span>mtu<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: Zone warp IPv4/IPv6 egress MTU fixing&quot;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="o">}</span>
</span></code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">MSS clamping 是双向的</p>
<p>MTU的影响是单项的，即路由器往一个接口转发时，如果包大于接口MTU，就会进行分片。MSS clamping后，从该接口进入和出去的包都会被修改MSS。这里列一张参考文献中的图</p>
<p><img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240316201316.png" /></p>
</div>
<p>Openwrt 的 MSS 功能放在防火墙 Zone 设置中（毕竟是基于 iptable 的，确实是防火墙功能），默认 WAN zone 的 MSS clamping 是勾选上的。如果有 wireguard 等隧道接口的话，建议也勾上，因此这样可以避免在路由器上分片，提升 TCP 性能。</p>
<p><img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240316200359.png" /></p>
<h3 id="mtu-1508">MTU 1508？<a class="headerlink" href="#mtu-1508" title="Permanent link">&para;</a></h3>
<p><a href="https://forum.openwrt.org/t/how-to-correctly-set-mtu-of-all-my-network-interfaces-wan-and-lan/108298/12">How to correctly set MTU of all my network interfaces (wan and lan)? - Installing and Using OpenWrt / Network and Wireless Configuration - OpenWrt Forum</a>
<a href="https://datatracker.ietf.org/doc/html/rfc4638">RFC 4638 - Accommodating a Maximum Transit Unit/Maximum Receive Unit (MTU/MRU) Greater Than 1492 in the Point-to-Point Protocol over Ethernet (PPPoE) (ietf.org)</a></p>
<h3 id="参考资料">参考资料<a class="headerlink" href="#参考资料" title="Permanent link">&para;</a></h3>
<ul>
<li>提到隧道往往需要限制 MSS 来避免分片：<a href="https://www.cloudflare-cn.com/learning/network-layer/what-is-mss/">什么是 MSS（最大分段大小）？ | Cloudflare (cloudflare-cn.com)</a></li>
<li>提到了 GRE 下 MSS 的计算：<a href="https://www.cloudflare-cn.com/learning/network-layer/what-is-gre-tunneling/">什么是 GRE 隧道？| GRE 协议如何工作 | Cloudflare (cloudflare-cn.com)</a></li>
<li>同样介绍了 MTU, MSS, PMTUD 联系：<a href="https://zhuanlan.zhihu.com/p/139537936">MTU TCP-MSS 详解 - 知乎 (zhihu.com)</a></li>
<li>提到了 1）v4 和 v6 的差异；2）中间路由器禁用 ICMP 导致黑洞连接现象；3）有些路由器提供 MSS 方案解决 PMTUD 失败的问题。<a href="https://en.wikipedia.org/wiki/Path_MTU_Discovery">Path MTU Discovery - Wikipedia</a></li>
<li>PMTUD 导致 black holes：<a href="https://en.wikipedia.org/wiki/Black_hole_(networking)">Black hole (networking) - Wikipedia</a></li>
<li>openwrt 默认 wan 是 MSS clamping 的，只影响 forward，不影响 output。<a href="https://forum.openwrt.org/t/firewall-mtu-fix-confusion/22138">Firewall mtu_fix confusion - Talk about Documentation - OpenWrt Forum</a></li>
<li>iptable TCPMSS target：<a href="https://www.linuxtopia.org/Linux_Firewall_iptables/x4700.html">Linux Packet Filtering and iptables - TCPMSS target (linuxtopia.org)</a></li>
</ul>
<h2 id="定位问题但无法解决">定位问题（但无法解决）<a class="headerlink" href="#定位问题但无法解决" title="Permanent link">&para;</a></h2>
<h3 id="实验一设置-bridge-mtu-不影响接收只影响发送">实验一：设置 bridge MTU 不影响接收只影响发送<a class="headerlink" href="#实验一设置-bridge-mtu-不影响接收只影响发送" title="Permanent link">&para;</a></h3>
<p>kvm-win10 ping op1，经过的路径：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>kvm-win10<span class="w"> </span><span class="o">(</span><span class="m">1500</span><span class="o">)</span>-&gt;<span class="w"> </span>pve<span class="w"> </span>vmbr1<span class="o">(</span><span class="m">1280</span><span class="o">)</span><span class="w"> </span>-&gt;<span class="w"> </span>op1:<span class="w"> </span>eth1<span class="w"> </span><span class="o">(</span><span class="m">1500</span><span class="o">)</span>-&gt;<span class="w">  </span>br-lan<span class="w"> </span><span class="o">(</span><span class="m">1280</span><span class="o">)</span>
</span></code></pre></div>
<p>虽然 op1 br-lan mtu 已经设置成了 1280，但是实际上由于包是从 eth1 进入的，所以并不会丢掉。</p>
<ul>
<li>中途 vmbr1 没有把包丢掉，我猜测是因为底层的接口实际 MTU 都是 1500 的，因此能够接收就不会丢掉。和 bridge 自身 MTU 没有关系</li>
</ul>
<p>然后可以发现<strong>op1 response 时根据 br-lan 的 MTU 进行了分片</strong>，这是符合 MTU 一开始的设计的。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>-l<span class="w"> </span><span class="m">1472</span><span class="w"> </span>-f
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>具有<span class="w"> </span><span class="m">1472</span><span class="w"> </span>字节的数据:
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>来自<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">1472</span><span class="w"> </span>时间&lt;1ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">64</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>来自<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">1472</span><span class="w"> </span>时间&lt;1ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">64</span>
</span></code></pre></div>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>root@op1<span class="w"> </span>➜<span class="w">  </span>~<span class="w"> </span>tcpdump<span class="w"> </span>-ni<span class="w"> </span>eth1<span class="w"> </span>icmp<span class="w"> </span>and<span class="w"> </span>host<span class="w"> </span><span class="m">192</span>.168.35.5
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>tcpdump:<span class="w"> </span>verbose<span class="w"> </span>output<span class="w"> </span>suppressed,<span class="w"> </span>use<span class="w"> </span>-v<span class="o">[</span>v<span class="o">]</span>...<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>protocol<span class="w"> </span>decode
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>listening<span class="w"> </span>on<span class="w"> </span>eth1,<span class="w"> </span>link-type<span class="w"> </span>EN10MB<span class="w"> </span><span class="o">(</span>Ethernet<span class="o">)</span>,<span class="w"> </span>snapshot<span class="w"> </span>length<span class="w"> </span><span class="m">262144</span><span class="w"> </span>bytes
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="m">20</span>:24:59.427833<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.1:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1386</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1480</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="m">20</span>:24:59.427856<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>reply,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1386</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1256</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="m">20</span>:24:59.427858<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ip-proto-1
</span></code></pre></div>
<h3 id="实验二同一个二层无法发-icmp-unreachable">实验二：同一个二层无法发 ICMP unreachable<a class="headerlink" href="#实验二同一个二层无法发-icmp-unreachable" title="Permanent link">&para;</a></h3>
<p>还是上一个实验，把其中一个接口 mtu 调小：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>kvm-win10<span class="w"> </span><span class="o">(</span><span class="m">1500</span><span class="o">)</span>-&gt;<span class="w"> </span>pve<span class="w"> </span>vmbr1<span class="o">(</span><span class="m">1280</span><span class="o">)</span><span class="w"> </span>-&gt;<span class="w"> </span>op1:<span class="w"> </span>eth1<span class="w"> </span><span class="o">(</span><span class="m">1280</span><span class="o">)</span>-&gt;<span class="w">  </span>br-lan<span class="w"> </span><span class="o">(</span><span class="m">1280</span><span class="o">)</span>
</span></code></pre></div>
<p>设置 eth1 mtu 后。完全 ping 不通，op1 上 tcpdump 抓不到任何包，只有 pve vmbr1 上能抓到。
此时即使是允许分片，也是一样的现象。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>-l<span class="w"> </span><span class="m">1472</span><span class="w"> </span>-f
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>具有<span class="w"> </span><span class="m">1472</span><span class="w"> </span>字节的数据:
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>请求超时。
</span></code></pre></div>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>-l<span class="w"> </span><span class="m">1472</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>具有<span class="w"> </span><span class="m">1472</span><span class="w"> </span>字节的数据:
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>请求超时。
</span></code></pre></div>
<p>产生该现象的原因是，op1 eth1 的 mtu 小了，包根本传不到 op1。<strong>因为它们位于同一个二层，没有路由器负责分片</strong>。</p>
<p>而 op1 又<strong>没法返回 ICMP 报错信息</strong>（因为这里 op1 不做为路由器），因此 kvm-win10 仍然继续以该大小包发送。</p>
<p><em>下一个实验表明，此时如果收到 ICMP 报错，系统就会调整 PMTU，在下次发送 icmp request 时就进行分片。</em></p>
<h3 id="实验三icmp-影响系统-pmtu-缓存">实验三：ICMP 影响系统 PMTU 缓存<a class="headerlink" href="#实验三icmp-影响系统-pmtu-缓存" title="Permanent link">&para;</a></h3>
<p>op1 和 op2 通过 wireguard 隧道 wg_s2s 连接，而该隧道我将 MTU 设置成了 1400。当 kvm-win10 ping op2 的 wg 地址时，就会经过该隧道。大致过程：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>kvm-win10<span class="o">(</span><span class="m">1500</span><span class="o">)</span><span class="w"> </span>-&gt;<span class="w"> </span>op1<span class="w"> </span>eth1<span class="o">(</span><span class="m">1500</span><span class="o">)</span><span class="w"> </span>-&gt;<span class="w"> </span>op1<span class="w"> </span>wg_s2s<span class="w"> </span><span class="o">(</span><span class="m">1400</span><span class="o">)</span><span class="w"> </span><span class="o">(</span>out<span class="o">)</span>
</span></code></pre></div>
<p>可以发现不允许分片时，无法 ping 通，路由器返回 ICMP 报错。允许分片就可以正常 ping 通了。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>-l<span class="w"> </span><span class="m">1373</span><span class="w"> </span>-f
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>具有<span class="w"> </span><span class="m">1373</span><span class="w"> </span>字节的数据:
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>来自<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>的回复:<span class="w"> </span>需要拆分数据包但是设置<span class="w"> </span>DF。
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>需要拆分数据包但是设置<span class="w"> </span>DF。
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>需要拆分数据包但是设置<span class="w"> </span>DF。
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>-l<span class="w"> </span><span class="m">1373</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>具有<span class="w"> </span><span class="m">1373</span><span class="w"> </span>字节的数据:
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>来自<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">1373</span><span class="w"> </span><span class="nv">时间</span><span class="o">=</span>2ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">63</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>来自<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">1373</span><span class="w"> </span><span class="nv">时间</span><span class="o">=</span>2ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">63</span>
</span></code></pre></div>
<p>并且 tcpdump 抓包可以看到第二次 ping 时，kvm-win10 已经提前将包进行分片了。</p>
<ul>
<li>第一条<code>192.168.35.5 &gt; 10.0.32.2</code>，length 还是 1281 (1373+8)</li>
<li>第二次 echo request 就已经变成连续两条<code>192.168.35.5 &gt; 10.0.32.2</code>了。（长度是 1376 而不是 MTU 对应的 1400 - 20(ip header) = 1380，是因为 ipv4 分片需要 8 字节对齐）</li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>root@op1<span class="w"> </span>➜<span class="w">  </span>~<span class="w"> </span>tcpdump<span class="w"> </span>-ni<span class="w"> </span>eth1<span class="w"> </span>icmp<span class="w"> </span>and<span class="w"> </span>host<span class="w"> </span><span class="m">192</span>.168.35.5
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>tcpdump:<span class="w"> </span>verbose<span class="w"> </span>output<span class="w"> </span>suppressed,<span class="w"> </span>use<span class="w"> </span>-v<span class="o">[</span>v<span class="o">]</span>...<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>protocol<span class="w"> </span>decode
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>listening<span class="w"> </span>on<span class="w"> </span>eth1,<span class="w"> </span>link-type<span class="w"> </span>EN10MB<span class="w"> </span><span class="o">(</span>Ethernet<span class="o">)</span>,<span class="w"> </span>snapshot<span class="w"> </span>length<span class="w"> </span><span class="m">262144</span><span class="w"> </span>bytes
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="m">20</span>:45:09.452565<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">10</span>.0.32.2:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1400</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1381</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="m">20</span>:45:09.452590<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ICMP<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>unreachable<span class="w"> </span>-<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>frag<span class="w"> </span><span class="o">(</span>mtu<span class="w"> </span><span class="m">1400</span><span class="o">)</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">556</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="m">20</span>:45:17.217676<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">10</span>.0.32.2:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1403</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1376</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="m">20</span>:45:17.217681<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">10</span>.0.32.2:<span class="w"> </span>ip-proto-1
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="m">20</span>:45:17.219738<span class="w"> </span>IP<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>reply,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1403</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1256</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="m">20</span>:45:17.219741<span class="w"> </span>IP<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ip-proto-1
</span></code></pre></div>
<p><strong>而要想提前分片，表明 OS 需要缓存目的地址的 PMTU</strong>，windows 有命令可以查看 PMTU</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>netsh<span class="w"> </span>interface<span class="w"> </span>ipv4<span class="w"> </span>show<span class="w"> </span>destinationcache
</span></code></pre></div>
<p>可以看到目的地址已经被设置成了 1400</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>接口<span class="w"> </span><span class="m">16</span>:<span class="w"> </span>以太网<span class="w"> </span><span class="m">2</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>PMTU<span class="w"> </span>目标地址<span class="w">                                      </span>下一个跃点地址
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>----<span class="w"> </span>---------------------------------------------<span class="w"> </span>-------------------------
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="m">1400</span><span class="w"> </span><span class="m">10</span>.0.32.2<span class="w">                                     </span><span class="m">192</span>.168.35.1
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="m">1500</span><span class="w"> </span><span class="m">20</span>.42.65.91<span class="w">                                   </span><span class="m">192</span>.168.35.1
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="m">1500</span><span class="w"> </span><span class="m">39</span>.91.134.53<span class="w">                                  </span><span class="m">192</span>.168.35.1
</span></code></pre></div>
<p>之后再发送大于 PMTU 的包且禁止分片时，windows 就会直接提示需要分片，而不会把包发出去，因此收不到来自路由器的 ICMP 报错消息。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>-l<span class="w"> </span><span class="m">1373</span><span class="w"> </span>-f
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">10</span>.0.32.2<span class="w"> </span>具有<span class="w"> </span><span class="m">1373</span><span class="w"> </span>字节的数据:
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>需要拆分数据包但是设置<span class="w"> </span>DF。
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>需要拆分数据包但是设置<span class="w"> </span>DF。
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">如果一开始不限制分片</p>
<p>如果没有建立正确PMTU前发送一个大包，则路由器不会返回ICMP need fragment，而是直接分片传输。这样其实并不能学习到PMTU。</p>
</div>
<h3 id="实验四gre-tap-隧道导致二层-mtu-不一致">实验四：GRE Tap 隧道导致二层 MTU 不一致<a class="headerlink" href="#实验四gre-tap-隧道导致二层-mtu-不一致" title="Permanent link">&para;</a></h3>
<p>由于 GRE Tap 的存在，导致原本全部都是 1500MTU 的二层里，出现了 1284 的隧道通路。因此只要大于该 MTU 的包通过该通路就会被丢弃，并且不会返回 ICMP，从而导致黑洞。</p>
<p>op1 下的 KVM-win10 ping op2 下的笔记本时，只要 icmp data 大于 1256 就会导致该现象。即使允许分片，也 ping 不通。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">192</span>.168.35.180<span class="w"> </span>-l<span class="w"> </span><span class="m">1256</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">192</span>.168.35.180<span class="w"> </span>具有<span class="w"> </span><span class="m">1256</span><span class="w"> </span>字节的数据:
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>来自<span class="w"> </span><span class="m">192</span>.168.35.180<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">1256</span><span class="w"> </span><span class="nv">时间</span><span class="o">=</span>2ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">128</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>来自<span class="w"> </span><span class="m">192</span>.168.35.180<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">1256</span><span class="w"> </span><span class="nv">时间</span><span class="o">=</span>2ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">128</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">192</span>.168.35.180<span class="w"> </span>-l<span class="w"> </span><span class="m">1257</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">192</span>.168.35.180<span class="w"> </span>具有<span class="w"> </span><span class="m">1257</span><span class="w"> </span>字节的数据:
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>Control-C
</span></code></pre></div>
<h2 id="总结与思考">总结与思考<a class="headerlink" href="#总结与思考" title="Permanent link">&para;</a></h2>
<ul>
<li>原因在于二层 MTU 不一致，导致包经过一个更小的通路时既无法分片，也无法返回 ICMP 报错（否则设置了 PMTU，下一次就可以通过），从而导致黑洞。</li>
<li>对于 TCP 还能通过 MSS clamping 解决，但是对于 UDP 就没有办法了</li>
<li>如果二层隧道需要保证 MTU 一致，那用途是否太小？假设隧道 MTU 小于 1500，那么所有 1500 的设备都不能接入这个隧道。感觉只能连入几台可以手动调整 MTU 的设备。</li>
</ul>
<ul>
<li>疑点：<ul>
<li>为什么笔记本可以正确连接，而手机平板不行。wireshark 抓包时，确实笔记本的包更小，不会超过 MTU。<ul>
<li>OS 不同？windows 可能自己做了 PMTUD</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">TCP MSS 工作的条件</p>
<p>关于这点，做的实验数据没记录好。但是按照我模糊的记忆，一开始MSS其实并没有起作用。先要起作用，可能除了开启MSS clamping，还需要设置br-lan的MTU为和gre-tap的一样。否则仍然是按照 bridge的 MTU进行 clamping的。</p>
</div>
<h3 id="可能的解决">可能的解决？<a class="headerlink" href="#可能的解决" title="Permanent link">&para;</a></h3>
<ul>
<li>设置两端设备的 MTU<ul>
<li>不知道 Android 如何设置手动设置 MTU</li>
<li>发现仅设置 windows 的 MTU 不行</li>
</ul>
</li>
<li>windows 上设置目标的 PMTU？（但是 MTU 单向的，貌似影响不到对面发包。但是也许串流场景对面发不了很大的包？）<ul>
<li>发现 windows 设置不了，只能接收到 ICMP 时自己改</li>
</ul>
</li>
<li>有没有 L2 上的 PMTUD？或者不基于 ICMP 不就行了？</li>
<li>ARP proxy，让两边通信实际并不直接通信（走 gre 隧道），而是让路由器路由一下，比如通过 wg 隧道通信？</li>
</ul>
<h2 id="解决了">解决了？<a class="headerlink" href="#解决了" title="Permanent link">&para;</a></h2>
<p>2024/03/17</p>
<p>在学习 nft 时，偶然看到一个使用 nft 将 bridge 改为 routing 的写法。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a># redirect tcp:http from 192.160.0.0/16 to local machine for routing instead of bridging
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a># assumes 00:11:22:33:44:55 is local MAC address.
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>bridge input meta iif eth0 ip saddr 192.168.0.0/16 tcp dport 80 meta pkttype set unicast ether daddr set 00:11:22:33:44:55
</span></code></pre></div>
<p>搜索一下，真的有这种做法，用于实现中间人攻击
<a href="https://serverfault.com/questions/996794/bridge-nftables-how-to-redirect-incoming-http-https-traffic-to-local-port-808">Bridge + nftables: How to redirect incoming HTTP/HTTPS traffic to local port 8080? - Server Fault</a>
<img alt="" src="https://i.stack.imgur.com/tpJDs.png" /></p>
<p>尝试后真的成功了</p>
<p>nft 将 bridge 转成 routing</p>
<ul>
<li>op1 和 op2 上都需要类似操作</li>
<li>ether daddr set 设置的是路由器 bridge 的 mac 地址</li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># op1</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="c1"># delete table bridge gre_tap_fix_mtu</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>add<span class="w"> </span>table<span class="w"> </span>bridge<span class="w"> </span>gre_tap_fix_mtu
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>add<span class="w"> </span>chain<span class="w"> </span>bridge<span class="w"> </span>gre_tap_fix_mtu<span class="w"> </span>c1<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span>filter<span class="w"> </span>hook<span class="w"> </span>prerouting<span class="w"> </span>priority<span class="w"> </span>-301<span class="p">;</span><span class="w"> </span><span class="o">}</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>add<span class="w"> </span>rule<span class="w"> </span>bridge<span class="w"> </span>gre_tap_fix_mtu<span class="w"> </span>c1<span class="w"> </span>meta<span class="w"> </span>iifname<span class="w"> </span>eth1<span class="w"> </span>ip<span class="w"> </span>daddr<span class="w"> </span><span class="m">192</span>.168.35.0/24<span class="w"> </span>meta<span class="w"> </span>pkttype<span class="w"> </span><span class="nb">set</span><span class="w"> </span>host<span class="w"> </span>ether<span class="w"> </span>daddr<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="m">00</span>:16:3e:4b:67:80<span class="w"> </span>counter
</span></code></pre></div>
<p>mtr 测试，可以发现两边 ping 时，路由多了一跳。原本是直接发送，现在变成路由器转发一次</p>
<p>op1 lan 内设备访问两个设备，分别过 gre 隧道和不过</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>➜<span class="w">  </span>~<span class="w"> </span>tracepath<span class="w"> </span>-n<span class="w"> </span><span class="m">192</span>.168.35.126
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w"> </span><span class="m">1</span>?:<span class="w"> </span><span class="o">[</span>LOCALHOST<span class="o">]</span><span class="w">                      </span>pmtu<span class="w"> </span><span class="m">1500</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w"> </span><span class="m">1</span>:<span class="w">  </span><span class="m">192</span>.168.35.1<span class="w">                                          </span><span class="m">0</span>.111ms
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w"> </span><span class="m">1</span>:<span class="w">  </span><span class="m">192</span>.168.35.1<span class="w">                                          </span><span class="m">0</span>.066ms
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w"> </span><span class="m">2</span>:<span class="w">  </span><span class="m">192</span>.168.35.1<span class="w">                                          </span><span class="m">0</span>.076ms<span class="w"> </span>pmtu<span class="w"> </span><span class="m">1370</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w"> </span><span class="m">2</span>:<span class="w">  </span><span class="m">192</span>.168.35.126<span class="w">                                      </span><span class="m">116</span>.700ms<span class="w"> </span>reached
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">     </span>Resume:<span class="w"> </span>pmtu<span class="w"> </span><span class="m">1370</span><span class="w"> </span>hops<span class="w"> </span><span class="m">2</span><span class="w"> </span>back<span class="w"> </span><span class="m">2</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>➜<span class="w">  </span>~<span class="w"> </span>tracepath<span class="w"> </span>-n<span class="w"> </span><span class="m">192</span>.168.35.5
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w"> </span><span class="m">1</span>?:<span class="w"> </span><span class="o">[</span>LOCALHOST<span class="o">]</span><span class="w">                      </span>pmtu<span class="w"> </span><span class="m">1500</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w"> </span><span class="m">1</span>:<span class="w">  </span><span class="m">192</span>.168.35.5<span class="w">                                          </span><span class="m">0</span>.185ms<span class="w"> </span>reached
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w"> </span><span class="m">1</span>:<span class="w">  </span><span class="m">192</span>.168.35.5<span class="w">                                          </span><span class="m">0</span>.230ms<span class="w"> </span>reached
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">     </span>Resume:<span class="w"> </span>pmtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>hops<span class="w"> </span><span class="m">1</span><span class="w"> </span>back<span class="w"> </span><span class="m">1</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>➜<span class="w">  </span>~
</span></code></pre></div>
<p>但是发现，通信端点发来的包如果已经经过分片（之前学习了 PMTU），到达路由器时却会将其合并。然后路由器转发时再根据 bridge(br-lan, br-lan2) 的 MTU 进行分片，这导致仍然无法通过 GRE 隧道。
因此简单地设置了下 br-lan 的 MTU，一切就正常了。</p>
<h3 id="ping-大包测试">ping 大包测试<a class="headerlink" href="#ping-大包测试" title="Permanent link">&para;</a></h3>
<p>kvm-win10 ping 对面设备，可以看到 ping 大包能够 ping 通了，说明<strong>路由器上进行了正确的分片</strong>。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>-l<span class="w"> </span><span class="m">2000</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>正在<span class="w"> </span>Ping<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>具有<span class="w"> </span><span class="m">2000</span><span class="w"> </span>字节的数据:
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>来自<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">2000</span><span class="w"> </span><span class="nv">时间</span><span class="o">=</span>80ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">63</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>来自<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>的回复:<span class="w"> </span><span class="nv">字节</span><span class="o">=</span><span class="m">2000</span><span class="w"> </span><span class="nv">时间</span><span class="o">=</span>95ms<span class="w"> </span><span class="nv">TTL</span><span class="o">=</span><span class="m">63</span>
</span></code></pre></div>
<p>op1 上抓包结果</p>
<ul>
<li>eth1 收到 KVM-win10 的 echo request，是按照 1500 进行分片的（kvm-win10 的 MTU）</li>
<li>op1 将其合并，总共 2008B</li>
<li>然后从 br-lan 转发出去（实际最终从 gre4t-gre3 出去），按照 1420 的 MTU 进行分片</li>
<li>从对面收到 echo reply，也是按照 1420 分片的（op2 上进行了和 op1 类似的操作，无论.126 的设备是按照多大的 MTU 发送的，op2 转发时就会按照 br-lan 的 MTU 进行分片）</li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># 从eth1 收到的</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="m">17</span>:19:13.358784<span class="w"> </span>eth1<span class="w">  </span>P<span class="w">   </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1988</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1472</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="m">17</span>:19:13.358785<span class="w"> </span>eth1<span class="w">  </span>P<span class="w">   </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126:<span class="w"> </span>ip-proto-1
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1"># 合并</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="m">17</span>:19:13.358785<span class="w"> </span>br-lan<span class="w"> </span>In<span class="w">  </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1988</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">2008</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="c1"># 从br-lan 转发出去，进行分片</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="m">17</span>:19:13.358832<span class="w"> </span>br-lan<span class="w"> </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1988</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1400</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="m">17</span>:19:13.358834<span class="w"> </span>gre4t-gre3<span class="w"> </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1988</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1400</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="m">17</span>:19:13.358841<span class="w"> </span>br-lan<span class="w"> </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126:<span class="w"> </span>ip-proto-1
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="m">17</span>:19:13.358842<span class="w"> </span>gre4t-gre3<span class="w"> </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.5<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126:<span class="w"> </span>ip-proto-1
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="c1"># 返回</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="c1"># 收到的已经是分片的了，直接转发</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="m">17</span>:19:13.438654<span class="w"> </span>gre4t-gre3<span class="w"> </span>P<span class="w">   </span>IP<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>reply,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1988</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1400</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="m">17</span>:19:13.438656<span class="w"> </span>gre4t-gre3<span class="w"> </span>P<span class="w">   </span>IP<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ip-proto-1
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="m">17</span>:19:13.438689<span class="w"> </span>eth1<span class="w">  </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>reply,<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1988</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1400</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="m">17</span>:19:13.438690<span class="w"> </span>eth1<span class="w">  </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.5:<span class="w"> </span>ip-proto-1
</span></code></pre></div>
<h3 id="tcp-mss-也是正常工作的">TCP MSS 也是正常工作的<a class="headerlink" href="#tcp-mss-也是正常工作的" title="Permanent link">&para;</a></h3>
<p>192.168.35.126 ssh 192.168.35.2</p>
<p>op2 上可以看到经过 gre4t-gre3 接口出去的 MSS 是 1380（对应 MTU 1420）</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>root@op2<span class="w"> </span>➜<span class="w">  </span>~<span class="w"> </span>tcpdump<span class="w"> </span>-ni<span class="w"> </span>gre4t-gre3<span class="w"> </span>tcp<span class="w"> </span>port<span class="w"> </span><span class="m">2202</span><span class="w"> </span>and<span class="w"> </span>host<span class="w"> </span><span class="m">192</span>.168.35.2<span class="w"> </span>and<span class="w"> </span><span class="s1">&#39;tcp[tcpflags] &amp; (tcp-syn) != 0&#39;</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="m">17</span>:29:15.468383<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.126.55960<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.2.2202:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">604249636</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65535</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1380</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">573389803</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">0</span>,nop,wscale<span class="w"> </span><span class="m">9</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="m">17</span>:29:15.661593<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.2.2202<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126.55960:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">353962643</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">604249637</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65160</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1380</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">265849573</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">573389803</span>,nop,wscale<span class="w"> </span><span class="m">7</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span></code></pre></div>
<p>op1 上更直观，192.168.35.2 刚开始的 MSS 是 1460，经过 br-lan Out 时就改为了 1380 了</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>root@op1<span class="w"> </span>➜<span class="w">  </span>~<span class="w"> </span>tcpdump<span class="w"> </span>-ni<span class="w"> </span>any<span class="w"> </span>tcp<span class="w"> </span>port<span class="w"> </span><span class="m">2202</span><span class="w"> </span>and<span class="w"> </span>host<span class="w"> </span><span class="m">192</span>.168.35.2<span class="w"> </span>and<span class="w"> </span><span class="s1">&#39;tcp[tcpflags] &amp; (tcp-syn) != 0&#39;</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="m">17</span>:29:15.466272<span class="w"> </span>gre4t-gre3<span class="w"> </span>P<span class="w">   </span>IP<span class="w"> </span><span class="m">192</span>.168.35.126.55960<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.2.2202:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">604249636</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65535</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1380</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">573389803</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">0</span>,nop,wscale<span class="w"> </span><span class="m">9</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="m">17</span>:29:15.466306<span class="w"> </span>eth1<span class="w">  </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.126.55960<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.2.2202:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">604249636</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65535</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1380</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">573389803</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">0</span>,nop,wscale<span class="w"> </span><span class="m">9</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="c1"># 刚开始是1460</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="m">17</span>:29:15.658494<span class="w"> </span>eth1<span class="w">  </span>P<span class="w">   </span>IP<span class="w"> </span><span class="m">192</span>.168.35.2.2202<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126.55960:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">353962643</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">604249637</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65160</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1460</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">265849573</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">573389803</span>,nop,wscale<span class="w"> </span><span class="m">7</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="m">17</span>:29:15.658494<span class="w"> </span>br-lan<span class="w"> </span>In<span class="w">  </span>IP<span class="w"> </span><span class="m">192</span>.168.35.2.2202<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126.55960:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">353962643</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">604249637</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65160</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1460</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">265849573</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">573389803</span>,nop,wscale<span class="w"> </span><span class="m">7</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="c1"># 设置为1380</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="m">17</span>:29:15.658511<span class="w"> </span>br-lan<span class="w"> </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.2.2202<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126.55960:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">353962643</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">604249637</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65160</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1380</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">265849573</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">573389803</span>,nop,wscale<span class="w"> </span><span class="m">7</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="m">17</span>:29:15.658514<span class="w"> </span>gre4t-gre3<span class="w"> </span>Out<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.35.2.2202<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.35.126.55960:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">353962643</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">604249637</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">65160</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1380</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">265849573</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">573389803</span>,nop,wscale<span class="w"> </span><span class="m">7</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</span></code></pre></div>
<h3 id="nft-查看-mss-被修改的过程">nft 查看 MSS 被修改的过程<a class="headerlink" href="#nft-查看-mss-被修改的过程" title="Permanent link">&para;</a></h3>
<p>op2 侧的无线路由器下的手机（192.168.35.126）ssh op1（192.168.35.1）。op2 上使用 nft 抓 TCP sync 包</p>
<p>可以看到 ether daddr 被成功修改，包进入了 forward mangle，修改了 MSS</p>
<ul>
<li><code>iif "br-lan2" ether saddr 5a:ff:4d:38:41:2f ether daddr ca:84:4a:ec:90:53 ip saddr 192.168.35.126 ip daddr 192.168.35.1</code>，这里的 ether daddr 不是 op1 的 mac 地址，而是 op2 上 br-lan2 的 mac 地址。说明 nft bridge 规则生效了</li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># 手机 sync</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>trace<span class="w"> </span>id<span class="w"> </span>938d2a85<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>trace_chain<span class="w"> </span>packet:<span class="w"> </span>iif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span><span class="w"> </span>ether<span class="w"> </span>saddr<span class="w"> </span>5a:ff:4d:38:41:2f<span class="w"> </span>ether<span class="w"> </span>daddr<span class="w"> </span>ca:84:4a:ec:90:53<span class="w"> </span>ip<span class="w"> </span>saddr<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>ip<span class="w"> </span>daddr<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>ip<span class="w"> </span>dscp<span class="w"> </span>cs0<span class="w"> </span>ip<span class="w"> </span>ecn<span class="w"> </span>not-ect<span class="w"> </span>ip<span class="w"> </span>ttl<span class="w"> </span><span class="m">64</span><span class="w"> </span>ip<span class="w"> </span>id<span class="w"> </span><span class="m">7498</span><span class="w"> </span>ip<span class="w"> </span>protocol<span class="w"> </span>tcp<span class="w"> </span>ip<span class="w"> </span>length<span class="w"> </span><span class="m">60</span><span class="w"> </span>tcp<span class="w"> </span>sport<span class="w"> </span><span class="m">49780</span><span class="w"> </span>tcp<span class="w"> </span>dport<span class="w"> </span><span class="m">2202</span><span class="w"> </span>tcp<span class="w"> </span><span class="nv">flags</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>syn<span class="w"> </span>tcp<span class="w"> </span>window<span class="w"> </span><span class="m">65535</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>packet:<span class="w"> </span>iif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span><span class="w"> </span>oif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>rule<span class="w"> </span>iifname<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>,<span class="w"> </span><span class="s2">&quot;gre4t-gre3&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span>tcp<span class="w"> </span>flags<span class="w"> </span>syn<span class="w"> </span>tcp<span class="w"> </span>option<span class="w"> </span>maxseg<span class="w"> </span>size<span class="w"> </span><span class="nb">set</span><span class="w"> </span>rt<span class="w"> </span>mtu<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: Zone lan2 IPv4/IPv6 ingress MTU fixing&quot;</span><span class="w"> </span><span class="o">(</span>verdict<span class="w"> </span><span class="k">continue</span><span class="o">)</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>rule<span class="w"> </span>oifname<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>,<span class="w"> </span><span class="s2">&quot;gre4t-gre3&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span>tcp<span class="w"> </span>flags<span class="w"> </span>syn<span class="w"> </span>tcp<span class="w"> </span>option<span class="w"> </span>maxseg<span class="w"> </span>size<span class="w"> </span><span class="nb">set</span><span class="w"> </span>rt<span class="w"> </span>mtu<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: Zone lan2 IPv4/IPv6 egress MTU fixing&quot;</span><span class="w"> </span><span class="o">(</span>verdict<span class="w"> </span><span class="k">continue</span><span class="o">)</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>verdict<span class="w"> </span><span class="k">continue</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>policy<span class="w"> </span>accept
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>forward<span class="w"> </span>packet:<span class="w"> </span>iif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span><span class="w"> </span>oif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>forward<span class="w"> </span>rule<span class="w"> </span>iifname<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>,<span class="w"> </span><span class="s2">&quot;gre4t-gre3&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span>jump<span class="w"> </span>forward_lan2<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: Handle lan2 IPv4/IPv6 forward traffic&quot;</span><span class="w"> </span><span class="o">(</span>verdict<span class="w"> </span>jump<span class="w"> </span>forward_lan2<span class="o">)</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>forward_lan2<span class="w"> </span>rule<span class="w"> </span>jump<span class="w"> </span>accept_to_lan2<span class="w"> </span><span class="o">(</span>verdict<span class="w"> </span>jump<span class="w"> </span>accept_to_lan2<span class="o">)</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>accept_to_lan2<span class="w"> </span>rule<span class="w"> </span>oifname<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>,<span class="w"> </span><span class="s2">&quot;gre4t-gre3&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span>counter<span class="w"> </span>packets<span class="w"> </span><span class="m">283334</span><span class="w"> </span>bytes<span class="w"> </span><span class="m">42471975</span><span class="w"> </span>accept<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: accept lan2 IPv4/IPv6 traffic&quot;</span><span class="w"> </span><span class="o">(</span>verdict<span class="w"> </span>accept<span class="o">)</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_postrouting<span class="w"> </span>packet:<span class="w"> </span>iif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span><span class="w"> </span>oif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_postrouting<span class="w"> </span>verdict<span class="w"> </span><span class="k">continue</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>trace<span class="w"> </span>id<span class="w"> </span>f67d6b7e<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_postrouting<span class="w"> </span>policy<span class="w"> </span>accept
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>...
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="c1"># op1 返回 sync同样经过了 MTU fix</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>trace_chain<span class="w"> </span>packet:<span class="w"> </span>iif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span><span class="w"> </span>ether<span class="w"> </span>saddr<span class="w"> </span><span class="m">00</span>:16:3e:4b:67:80<span class="w"> </span>ether<span class="w"> </span>daddr<span class="w"> </span>5a:ff:4d:38:41:2f<span class="w"> </span>ip<span class="w"> </span>saddr<span class="w"> </span><span class="m">192</span>.168.35.1<span class="w"> </span>ip<span class="w"> </span>daddr<span class="w"> </span><span class="m">192</span>.168.35.126<span class="w"> </span>ip<span class="w"> </span>dscp<span class="w"> </span>af21<span class="w"> </span>ip<span class="w"> </span>ecn<span class="w"> </span>not-ect<span class="w"> </span>ip<span class="w"> </span>ttl<span class="w"> </span><span class="m">64</span><span class="w"> </span>ip<span class="w"> </span>id<span class="w"> </span><span class="m">0</span><span class="w"> </span>ip<span class="w"> </span>protocol<span class="w"> </span>tcp<span class="w"> </span>ip<span class="w"> </span>length<span class="w"> </span><span class="m">60</span><span class="w"> </span>tcp<span class="w"> </span>sport<span class="w"> </span><span class="m">2202</span><span class="w"> </span>tcp<span class="w"> </span>dport<span class="w"> </span><span class="m">49780</span><span class="w"> </span>tcp<span class="w"> </span><span class="nv">flags</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>0x12<span class="w"> </span>tcp<span class="w"> </span>window<span class="w"> </span><span class="m">64860</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>prerouting<span class="w"> </span>packet:<span class="w"> </span>iif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>prerouting<span class="w"> </span>rule<span class="w"> </span>iifname<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>,<span class="w"> </span><span class="s2">&quot;gre4t-gre3&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span>jump<span class="w"> </span>helper_lan2<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: Handle lan2 IPv4/IPv6 helper assignment&quot;</span><span class="w"> </span><span class="o">(</span>verdict<span class="w"> </span>jump<span class="w"> </span>helper_lan2<span class="o">)</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>helper_lan2<span class="w"> </span>verdict<span class="w"> </span><span class="k">continue</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>prerouting<span class="w"> </span>verdict<span class="w"> </span><span class="k">continue</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>prerouting<span class="w"> </span>policy<span class="w"> </span>accept
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>packet:<span class="w"> </span>iif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span><span class="w"> </span>oif<span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>rule<span class="w"> </span>iifname<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>,<span class="w"> </span><span class="s2">&quot;gre4t-gre3&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span>tcp<span class="w"> </span>flags<span class="w"> </span>syn<span class="w"> </span>tcp<span class="w"> </span>option<span class="w"> </span>maxseg<span class="w"> </span>size<span class="w"> </span><span class="nb">set</span><span class="w"> </span>rt<span class="w"> </span>mtu<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: Zone lan2 IPv4/IPv6 ingress MTU fixing&quot;</span><span class="w"> </span><span class="o">(</span>verdict<span class="w"> </span><span class="k">continue</span><span class="o">)</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>rule<span class="w"> </span>oifname<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="s2">&quot;br-lan2&quot;</span>,<span class="w"> </span><span class="s2">&quot;gre4t-gre3&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span>tcp<span class="w"> </span>flags<span class="w"> </span>syn<span class="w"> </span>tcp<span class="w"> </span>option<span class="w"> </span>maxseg<span class="w"> </span>size<span class="w"> </span><span class="nb">set</span><span class="w"> </span>rt<span class="w"> </span>mtu<span class="w"> </span>comment<span class="w"> </span><span class="s2">&quot;!fw4: Zone lan2 IPv4/IPv6 egress MTU fixing&quot;</span><span class="w"> </span><span class="o">(</span>verdict<span class="w"> </span><span class="k">continue</span><span class="o">)</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>verdict<span class="w"> </span><span class="k">continue</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>trace<span class="w"> </span>id<span class="w"> </span>3786311f<span class="w"> </span>inet<span class="w"> </span>fw4<span class="w"> </span>mangle_forward<span class="w"> </span>policy<span class="w"> </span>accept
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>...
</span></code></pre></div>
<h3 id="补充访问-op2-lan1-优化">补充：访问 op2 lan1 优化<a class="headerlink" href="#补充访问-op2-lan1-优化" title="Permanent link">&para;</a></h3>
<p>虽然 MTU 问题解决了，但是连接 op2 wifi 后访问 op2 自身时会发生绕路的情况（<strong>即 op2 上想要从 lan2 访问 lan</strong>）。</p>
<p>例子：直接 ping op2，会发现包从 eth2 进入后，会从 vxlan 出去，再wg_s2s 回，而不会直接 eth2 -&gt; eth1。这可能是因为包已经被 bridge 拿走了，所以不会 eth2 -&gt; eth1。这导致实际上延迟从 1ms 变为 2ms。</p>
<p>p.s 如果 op1 上原本是无法访问 op2 的话，这样还会导致连接 lan2 wifi 无法访问 lan 的情况。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>root@op2 ➜  ~ tcpdump -ni any icmp and host 192.168.36.1
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>tcpdump: data link type LINUX_SLL2
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>20:36:40.191286 eth2  P   IP 192.168.35.180 &gt; 192.168.36.1: ICMP echo request, id 1, seq 2028, length 40
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>20:36:40.191305 vxlan0 Out IP 192.168.35.180 &gt; 192.168.36.1: ICMP echo request, id 1, seq 2028, length 40
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>20:36:40.192829 wg_s2s In  IP 192.168.35.180 &gt; 192.168.36.1: ICMP echo request, id 1, seq 2028, length 40
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>20:36:40.192862 br-lan2 Out IP 192.168.36.1 &gt; 192.168.35.180: ICMP echo reply, id 1, seq 2028, length 40
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>20:36:40.192867 eth2  Out IP 192.168.36.1 &gt; 192.168.35.180: ICMP echo reply, id 1, seq 2028, length 40
</span></code></pre></div>
<p>解决办法：针对 lan1 的地址，也将 bridge 转成 route 即可。</p>
<p>改完后再抓包，可以发现包从 br-lan2 就 Input 了，不像之前得绕路从 wg_s2s input 的情况。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>20:45:55.192422 eth2  P   IP 192.168.35.180.31195 &gt; 192.168.36.1.2202: Flags [.], ack 5648, win 8193, length 0
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>20:45:55.192422 br-lan2 In  IP 192.168.35.180.31195 &gt; 192.168.36.1.2202: Flags [.], ack 5648, win 8193, length 0
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>20:45:55.294526 br-lan2 Out IP 192.168.36.1.2202 &gt; 192.168.35.180.31195: Flags [P.], seq 5648:5852, ack 1, win 502, length 204
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>20:45:55.294528 eth2  Out IP 192.168.36.1.2202 &gt; 192.168.35.180.31195: Flags [P.], seq 5648:5852, ack 1, win 502, length 204
</span></code></pre></div>
<h2 id="再次总结与思考">再次总结与思考<a class="headerlink" href="#再次总结与思考" title="Permanent link">&para;</a></h2>
<p>虽然成功解决了，现在 moonlight UDP 串流没有问题了。但是可能的问题还有：</p>
<ul>
<li>现在两端发送和接收的每个 udp 包，都额外经过了一次分片和合并，是否对性能有较大影响？</li>
<li>同一侧的机器间访问，是否也需要路由器转发？这样是否有性能影响<ul>
<li>发现居然不是，因为同一侧的机器大部分在进入 openwrt 之前，就已经在 pve host 的 vmbr 上已经进行转发了。</li>
</ul>
</li>
</ul>
<h3 id="通过-dhcp-option-设置所有设备-mtu">通过 DHCP option 设置所有设备 MTU<a class="headerlink" href="#通过-dhcp-option-设置所有设备-mtu" title="Permanent link">&para;</a></h3>
<p>只要 dhcp server 启用了 mtu option，好像主流系统都会使用。正好我的 360t7 无法使用 nft bridge 命令导致分片损耗很大，可以试一试该方案。</p>
<h2 id="vlan-切换方案">VLAN 切换方案<a class="headerlink" href="#vlan-切换方案" title="Permanent link">&para;</a></h2>
<ul>
<li>避免需要反复插拔网线来切换 AP 所在的 lan</li>
<li>AP 只用单根网线 连接路由器</li>
<li>注：这里使用了 vxlan</li>
</ul>
<p><img alt="便携路由器-L2-tunnel-新.drawio.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/%E4%BE%BF%E6%90%BA%E8%B7%AF%E7%94%B1%E5%99%A8-L2-tunnel-%E6%96%B0.drawio.png" /></p>
<h3 id="windows-获得错误的-v6-地址ra-跨了网段">windows 获得错误的 v6 地址（RA 跨了网段）<a class="headerlink" href="#windows-获得错误的-v6-地址ra-跨了网段" title="Permanent link">&para;</a></h3>
<p>笔记本通过网线连接到 AX6S AP。由于每个端口配置了 10 作为 pvid，并且 10 是 untagged 的，因此笔记本相当于接入了 VLAN10。</p>
<p>但是笔记本不知为何总会获得 VLAN20 的 ipv6 地址，而该地址是无法使用的。导致<strong>访问 B 站时可能遇到奇怪的卡顿</strong>，上网体验很差。</p>
<p>tcpdump 增加 -e，显示以太网帧后发现了问题。</p>
<ul>
<li>由于每个 port 同时配置了 vlan 10 和 vlan 20，因此只要路由器发送 RA，就会在所有接口上发，不过会带上 vlan id。</li>
<li><strong>windows 接收到 tagged 的包，并不会丢弃，而是正常接收，这导致错误地配置了 SLAAC 的地址</strong>。</li>
</ul>
<p>由于每个接口每 5 分钟对所有节点发送一次 RA，以下是抓到的 op2 和 op1 广播的 ra 消息。只要一接收到该消息，windows 就会出现错误的 v6 地址。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>root@ax6s ➜  ~ tcpdump -nei lan3 -vvvv -tttt &quot;icmp6 and (ip6[40] == 134 or ip6[40] == 133)&quot; # rs, ra
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>2024-08-05 01:12:58.032179 d2:c8:4c:f9:52:a2 &gt; 33:33:00:00:00:01, ethertype 802.1Q (0x8100), length 178: vlan 10, p 0, ethertype IPv6 (0x86dd), (flowlabel 0x0f2eb, hlim 255, next-header ICMPv6 (58) payload length: 120) fe80::d0c8:4cff:fef9:52a2 &gt; ff02::1: [icmp6 sum ok] ICMP6, router advertisement, length 120
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>        hop limit 64, Flags [other stateful], pref medium, router lifetime 1800s, reachable time 0ms, retrans timer 0ms
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>          source link-address option (1), length 8 (1): d2:c8:4c:f9:52:a2
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>            0x0000:  d2c8 4cf9 52a2
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>          mtu option (5), length 8 (1):  1492
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>            0x0000:  0000 0000 05d4
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>          prefix info option (3), length 32 (4): 2409:8a30:4ae:a540::/64, Flags [onlink, auto], valid time 258681s, pref. time 172281s
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>            0x0000:  40c0 0003 f279 0002 a0f9 0000 0000 2409
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>            0x0010:  8a30 04ae a540 0000 0000 0000 0000
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>          route info option (24), length 24 (3):  2409:8a30:4ae:a540::/60, pref=medium, lifetime=1800s
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>            0x0000:  3c00 0000 0708 2409 8a30 04ae a540 0000
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>            0x0010:  0000 0000 0000
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>          rdnss option (25), length 24 (3):  lifetime 1800s, addr: 2409:8a30:4ae:a540::10
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>            0x0000:  0000 0000 0708 2409 8a30 04ae a540 0000
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>            0x0010:  0000 0000 0010
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>          advertisement interval option (7), length 8 (1):  600000ms
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>            0x0000:  0000 0009 27c0
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>2024-08-05 01:13:36.201962 00:16:3e:4b:67:80 &gt; 33:33:00:00:00:01, ethertype 802.1Q (0x8100), length 154: vlan 20, p 0, ethertype IPv6 (0x86dd), (flowlabel 0x31634, hlim 255, next-header ICMPv6 (58) payload length: 96) fe80::216:3eff:fe4b:6780 &gt; ff02::1: [icmp6 sum ok] ICMP6, router advertisement, length 96
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>        hop limit 64, Flags [managed, other stateful], pref medium, router lifetime 1800s, reachable time 0ms, retrans timer 0ms
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>          source link-address option (1), length 8 (1): 00:16:3e:4b:67:80
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>            0x0000:  0016 3e4b 6780
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>          mtu option (5), length 8 (1):  1370
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>            0x0000:  0000 0000 055a
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>          prefix info option (3), length 32 (4): 2001:da8:d800:c019::/64, Flags [onlink, auto], valid time 2443865s, pref. time 456665s
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>            0x0000:  40c0 0025 4a59 0006 f7d9 0000 0000 2001
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>            0x0010:  0da8 d800 c019 0000 0000 0000 0000
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>          rdnss option (25), length 24 (3):  lifetime 1800s, addr: fe80::216:3eff:fe4b:6780
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>            0x0000:  0000 0000 0708 fe80 0000 0000 0000 0216
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>            0x0010:  3eff fe4b 6780
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>          advertisement interval option (7), length 8 (1):  600000ms
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>            0x0000:  0000 0009 27c0
</span></code></pre></div>
<p>解决方法：设置 lan2 只能通过 wifi 接入，所有 lan 端口都不加入 vlan20（注意，wan 用于连接上级路由器 op2，因此需要保留 vlan20）</p>
<p><img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240805013551.png" /></p>
<h2 id="202412-更新-l2tpv3failed">2024/12 更新 L2TPv3（failed）<a class="headerlink" href="#202412-更新-l2tpv3failed" title="Permanent link">&para;</a></h2>
<p>请教一下群内大佬关于 vxlan 的问题，我现在有 B 和 C 两个设备通过 vxlan 连接到 A，B 和 C 都能访问 A，但是 B 和 C 之间不通，请问这是默认行为吗？B 访问 C 时，tcpdump 抓包能在 A 上抓到 arp 但是没有响应。</p>
<p>vxlan 不通的原因</p>
<ul>
<li>A 在 vxlan0 上收到 B -&gt; C 的包，mac 地址是 B -&gt; C，不是自己的，直接丢弃。<ul>
<li>如果有 hairpin 功能，也许可行</li>
</ul>
</li>
<li>vxlan 设计的是多个机器通过虚拟端口间通信，就像在一个交换机上。我这里的情况，变成了希望从一个端口来回一趟。</li>
</ul>
<p>意识到 gre 和 vxlan 这样的协议没有处理 MTU 问题，是因为他们的应用场景。GRE tap确实没想到只能在两个设备间 L2 连接有什么用。 vxlan 用于实现不同 VTEP 之间多对多连接（底层最好基于多播，或者在一个二层内，多跳的网络扩展性不好），可以用于数据中心连接多个机柜中的虚拟机。
至于二层组网场景，企业使用的协议是 L2TPv3 这种协议，v3 是版本号。L2TPv3 并且可以和普通以太网桥接起来，支持处理分片。关键词为 L2TPv3 Pseudowire</p>
<p><strong>发现仍然还是不行，将不同 MTU 接口 bridge 在一起还是有问题</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>TheRainstorm, [2024/12/7 15:17]
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>请教一下群内大佬关于 vxlan 的问题，我现在有 B 和 C 两个设备通过 vxlan 连接到 A，B 和 C 都能访问 A，但是 B 和 C 之间不通，请问这是默认行为吗？B 访问 C 时，tcpdump 抓包能在 A 上抓到 arp 但是没有响应。
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>TheRainstorm, [2024/12/7 15:19]
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>创建 vxlan 的命令：ip link add vxlan0 type vxlan id 8 remote xxx dev eth0 dstport 4789
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>Ciel, [2024/12/7 15:19]
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>看起来你的A没有处理转发（？
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>TheRainstorm, [2024/12/7 15:20]
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>A 是 openwrt，转发是开的。并且理论上 in 和 out 的接口都是 vxlan0，所以应该也没有防火墙问题？
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>Miao Wang, [2024/12/7 15:20]
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>你 abc 三个机器上 vxlan 网络的 IP 是同一个网段？
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>TheRainstorm, [2024/12/7 15:22]
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>是的，都是 A 上 dhcp 下发的地址。B 是我手动添加的静态地址。A 上将 vxlan0 和 eth0 bridge 到了一起。B 和 C 都能访问 A 的 eth0 下设备，但是之间就不互通
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>Miao Wang, [2024/12/7 15:22]
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>这是期待的现象
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>Miao Wang, [2024/12/7 15:22]
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>vxlan 隧道是个多点的隧道
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>Miao Wang, [2024/12/7 15:23]
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>里面有个转发表
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>Miao Wang, [2024/12/7 15:23]
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>写明指定的 mac 地址要发到哪个隧道端点
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>Miao Wang, [2024/12/7 15:23]
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>而你 ip link add 里的 remote 是指没有查到的默认目标
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>Miao Wang, [2024/12/7 15:24]
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a>所以当 B 访问 C 的时候，相当于是 A 收到了 B 发给 C 的包，不是发给自己的，丢掉
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>Miao Wang, [2024/12/7 15:25]
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>对于你的需求，看你 B 和 C 的访问，到底你是否想要经由 A 转发
</span><span id="__span-27-39"><a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a>
</span><span id="__span-27-40"><a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a>Miao Wang, [2024/12/7 15:26]
</span><span id="__span-27-41"><a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>如果需要，那么可能的一个操作是在 A 的 vxlan 接口上开 hairpin（我没试过）
</span><span id="__span-27-42"><a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>
</span><span id="__span-27-43"><a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>Miao Wang, [2024/12/7 15:27]
</span><span id="__span-27-44"><a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>你把以太网和 vxlan bridge 起来都是不对的
</span><span id="__span-27-45"><a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a>
</span><span id="__span-27-46"><a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a>Miao Wang, [2024/12/7 15:27]
</span><span id="__span-27-47"><a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a>因为它们 mtu 不一样
</span><span id="__span-27-48"><a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a>
</span><span id="__span-27-49"><a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a>Miao Wang, [2024/12/7 15:27]
</span><span id="__span-27-50"><a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a>而 vxlan 不支持分片
</span><span id="__span-27-51"><a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a>
</span><span id="__span-27-52"><a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>TheRainstorm, [2024/12/7 15:29]
</span><span id="__span-27-53"><a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a>这个确实，我之前踩了这个坑。后面发现使用 add rule bridge gre_tap_fix_mtu c1 meta iifname eth1 ip daddr 192.168.35.0/24 meta pkttype set host ether daddr set 00:16:3e:4b:67:80 counter 这样一条 nft 命令可以解决
</span><span id="__span-27-54"><a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a>
</span><span id="__span-27-55"><a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a>TheRainstorm, [2024/12/7 15:30]
</span><span id="__span-27-56"><a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a>就是 nft 修改下目的 mac 地址，改为 A 的 bridge mac 地址。这样 A 就会对包在 3 层进行转发一次
</span><span id="__span-27-57"><a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a>
</span><span id="__span-27-58"><a id="__codelineno-27-58" name="__codelineno-27-58" href="#__codelineno-27-58"></a>Miao Wang, [2024/12/7 15:31]
</span><span id="__span-27-59"><a id="__codelineno-27-59" name="__codelineno-27-59" href="#__codelineno-27-59"></a>哦，那也不是不可以
</span><span id="__span-27-60"><a id="__codelineno-27-60" name="__codelineno-27-60" href="#__codelineno-27-60"></a>
</span><span id="__span-27-61"><a id="__codelineno-27-61" name="__codelineno-27-61" href="#__codelineno-27-61"></a>TheRainstorm, [2024/12/7 15:32]
</span><span id="__span-27-62"><a id="__codelineno-27-62" name="__codelineno-27-62" href="#__codelineno-27-62"></a>A 转发的同时就会分片了，同时也可以使用 MSS clamping 修改 TCP 连接的 MSS 来避免分片
</span><span id="__span-27-63"><a id="__codelineno-27-63" name="__codelineno-27-63" href="#__codelineno-27-63"></a>
</span><span id="__span-27-64"><a id="__codelineno-27-64" name="__codelineno-27-64" href="#__codelineno-27-64"></a>Miao Wang, [2024/12/7 15:33]
</span><span id="__span-27-65"><a id="__codelineno-27-65" name="__codelineno-27-65" href="#__codelineno-27-65"></a>不是，我是说 B 和你被桥起来的 eth0 里面的设备的通信
</span><span id="__span-27-66"><a id="__codelineno-27-66" name="__codelineno-27-66" href="#__codelineno-27-66"></a>
</span><span id="__span-27-67"><a id="__codelineno-27-67" name="__codelineno-27-67" href="#__codelineno-27-67"></a>Miao Wang, [2024/12/7 15:36]
</span><span id="__span-27-68"><a id="__codelineno-27-68" name="__codelineno-27-68" href="#__codelineno-27-68"></a>因为这种通信不一定是 tcp，轮不到你改 mss；而且有些应用（比如路由协议）还对跳数有要求，你这个由 A 三层转发的话，就多出来了一跳
</span><span id="__span-27-69"><a id="__codelineno-27-69" name="__codelineno-27-69" href="#__codelineno-27-69"></a>
</span><span id="__span-27-70"><a id="__codelineno-27-70" name="__codelineno-27-70" href="#__codelineno-27-70"></a>Miao Wang, [2024/12/7 15:37]
</span><span id="__span-27-71"><a id="__codelineno-27-71" name="__codelineno-27-71" href="#__codelineno-27-71"></a>我给你一个一劳永逸的建议是，B 和 C 分别建立一个 l2tpv3 的隧道，在 A 上把两个隧道接口和 eth0 桥起来
</span><span id="__span-27-72"><a id="__codelineno-27-72" name="__codelineno-27-72" href="#__codelineno-27-72"></a>
</span><span id="__span-27-73"><a id="__codelineno-27-73" name="__codelineno-27-73" href="#__codelineno-27-73"></a>Miao Wang, [2024/12/7 15:37]
</span><span id="__span-27-74"><a id="__codelineno-27-74" name="__codelineno-27-74" href="#__codelineno-27-74"></a>vxlan 不适合你这种场景
</span><span id="__span-27-75"><a id="__codelineno-27-75" name="__codelineno-27-75" href="#__codelineno-27-75"></a>
</span><span id="__span-27-76"><a id="__codelineno-27-76" name="__codelineno-27-76" href="#__codelineno-27-76"></a>Miao Wang, [2024/12/7 15:37]
</span><span id="__span-27-77"><a id="__codelineno-27-77" name="__codelineno-27-77" href="#__codelineno-27-77"></a>l2tpv3 是点到点的隧道，而且支持分片
</span><span id="__span-27-78"><a id="__codelineno-27-78" name="__codelineno-27-78" href="#__codelineno-27-78"></a>
</span><span id="__span-27-79"><a id="__codelineno-27-79" name="__codelineno-27-79" href="#__codelineno-27-79"></a>TheRainstorm, [2024/12/7 15:39]
</span><span id="__span-27-80"><a id="__codelineno-27-80" name="__codelineno-27-80" href="#__codelineno-27-80"></a>就是本来 B 是直接发给 eth0 下的设备 D 的，B 分片是按 1500 分的，A 收到原本目的 mac 地址为 D 的包改为 A 自己的，就会传到 3 层处理。将分片合并后，按照 eth0 设置的 mtu（减去 VXLAN 的开销） 重新分片。相当与中间多了个分片合并的开销。对于 TCP 流量还可以使用 MSS clamping 消除这个开销，对于 UDP 确实就需要承受这个开销，但是至少不会出现大包不通的情况
</span><span id="__span-27-81"><a id="__codelineno-27-81" name="__codelineno-27-81" href="#__codelineno-27-81"></a>
</span><span id="__span-27-82"><a id="__codelineno-27-82" name="__codelineno-27-82" href="#__codelineno-27-82"></a>Miao Wang, [2024/12/7 15:40]
</span><span id="__span-27-83"><a id="__codelineno-27-83" name="__codelineno-27-83" href="#__codelineno-27-83"></a>B 的 vxlan mtu 小
</span><span id="__span-27-84"><a id="__codelineno-27-84" name="__codelineno-27-84" href="#__codelineno-27-84"></a>
</span><span id="__span-27-85"><a id="__codelineno-27-85" name="__codelineno-27-85" href="#__codelineno-27-85"></a>Miao Wang, [2024/12/7 15:40]
</span><span id="__span-27-86"><a id="__codelineno-27-86" name="__codelineno-27-86" href="#__codelineno-27-86"></a>你考虑一下 D 发给 B？
</span><span id="__span-27-87"><a id="__codelineno-27-87" name="__codelineno-27-87" href="#__codelineno-27-87"></a>
</span><span id="__span-27-88"><a id="__codelineno-27-88" name="__codelineno-27-88" href="#__codelineno-27-88"></a>Miao Wang, [2024/12/7 15:41]
</span><span id="__span-27-89"><a id="__codelineno-27-89" name="__codelineno-27-89" href="#__codelineno-27-89"></a>D 发出来的包是 1500，到 A 这里（注意是二层来的，目的 mac 是 B），由 A 的 bridge 二层转发给 vxlan 接口
</span><span id="__span-27-90"><a id="__codelineno-27-90" name="__codelineno-27-90" href="#__codelineno-27-90"></a>
</span><span id="__span-27-91"><a id="__codelineno-27-91" name="__codelineno-27-91" href="#__codelineno-27-91"></a>Miao Wang, [2024/12/7 15:41]
</span><span id="__span-27-92"><a id="__codelineno-27-92" name="__codelineno-27-92" href="#__codelineno-27-92"></a>然后超过 vxlan 接口的 mtu，丢弃
</span><span id="__span-27-93"><a id="__codelineno-27-93" name="__codelineno-27-93" href="#__codelineno-27-93"></a>
</span><span id="__span-27-94"><a id="__codelineno-27-94" name="__codelineno-27-94" href="#__codelineno-27-94"></a>Miao Wang, [2024/12/7 15:43]
</span><span id="__span-27-95"><a id="__codelineno-27-95" name="__codelineno-27-95" href="#__codelineno-27-95"></a>你要是强行把 vxlan 接口的 mtu 设置为 1500 也可以，那么就是 vxlan 在 underlay 网络发包的时候发现加上隧道头和 udp 头之后超过 underlay 的 mtu，丢弃
</span><span id="__span-27-96"><a id="__codelineno-27-96" name="__codelineno-27-96" href="#__codelineno-27-96"></a>
</span><span id="__span-27-97"><a id="__codelineno-27-97" name="__codelineno-27-97" href="#__codelineno-27-97"></a>TheRainstorm, [2024/12/7 15:43]
</span><span id="__span-27-98"><a id="__codelineno-27-98" name="__codelineno-27-98" href="#__codelineno-27-98"></a>哦，我描述不对。其实 B 和 A 都是路由器，我需要在 B 和 A 上都对本地 eth0 下设备发往对面（vxlan）的包使用那个 nft 命令
</span><span id="__span-27-99"><a id="__codelineno-27-99" name="__codelineno-27-99" href="#__codelineno-27-99"></a>
</span><span id="__span-27-100"><a id="__codelineno-27-100" name="__codelineno-27-100" href="#__codelineno-27-100"></a>Miao Wang, [2024/12/7 15:44]
</span><span id="__span-27-101"><a id="__codelineno-27-101" name="__codelineno-27-101" href="#__codelineno-27-101"></a>所以我觉得你的实现似乎很复杂，很麻烦，把不该用在这个场景下的东西拿了过来
</span><span id="__span-27-102"><a id="__codelineno-27-102" name="__codelineno-27-102" href="#__codelineno-27-102"></a>
</span><span id="__span-27-103"><a id="__codelineno-27-103" name="__codelineno-27-103" href="#__codelineno-27-103"></a>Miao Wang, [2024/12/7 15:45]
</span><span id="__span-27-104"><a id="__codelineno-27-104" name="__codelineno-27-104" href="#__codelineno-27-104"></a>你到底要二层通还是三层通，三层通直接用 gre 隧道，二层通的话用 l2tp 隧道
</span><span id="__span-27-105"><a id="__codelineno-27-105" name="__codelineno-27-105" href="#__codelineno-27-105"></a>
</span><span id="__span-27-106"><a id="__codelineno-27-106" name="__codelineno-27-106" href="#__codelineno-27-106"></a>Miao Wang, [2024/12/7 15:45]
</span><span id="__span-27-107"><a id="__codelineno-27-107" name="__codelineno-27-107" href="#__codelineno-27-107"></a>你现在似乎状态是，呈现的样子好像是二层的，但是实际上还是三层转发
</span><span id="__span-27-108"><a id="__codelineno-27-108" name="__codelineno-27-108" href="#__codelineno-27-108"></a>
</span><span id="__span-27-109"><a id="__codelineno-27-109" name="__codelineno-27-109" href="#__codelineno-27-109"></a>TheRainstorm, [2024/12/7 15:46]
</span><span id="__span-27-110"><a id="__codelineno-27-110" name="__codelineno-27-110" href="#__codelineno-27-110"></a>确实，我可以看看你说的 l2tpv3。
</span><span id="__span-27-111"><a id="__codelineno-27-111" name="__codelineno-27-111" href="#__codelineno-27-111"></a>
</span><span id="__span-27-112"><a id="__codelineno-27-112" name="__codelineno-27-112" href="#__codelineno-27-112"></a>TheRainstorm, [2024/12/7 15:47]
</span><span id="__span-27-113"><a id="__codelineno-27-113" name="__codelineno-27-113" href="#__codelineno-27-113"></a>不过对应用来说没关系，因为我只是需要二层设备发现的能力
</span><span id="__span-27-114"><a id="__codelineno-27-114" name="__codelineno-27-114" href="#__codelineno-27-114"></a>
</span><span id="__span-27-115"><a id="__codelineno-27-115" name="__codelineno-27-115" href="#__codelineno-27-115"></a>Miao Wang, [2024/12/7 15:47]
</span><span id="__span-27-116"><a id="__codelineno-27-116" name="__codelineno-27-116" href="#__codelineno-27-116"></a>嗯，vxlan 主要还是点到多点的用途，就是希望参与的每个节点直接通信
</span><span id="__span-27-117"><a id="__codelineno-27-117" name="__codelineno-27-117" href="#__codelineno-27-117"></a>
</span><span id="__span-27-118"><a id="__codelineno-27-118" name="__codelineno-27-118" href="#__codelineno-27-118"></a>Miao Wang, [2024/12/7 15:47]
</span><span id="__span-27-119"><a id="__codelineno-27-119" name="__codelineno-27-119" href="#__codelineno-27-119"></a>不过现在看似乎不太行。。。。
</span><span id="__span-27-120"><a id="__codelineno-27-120" name="__codelineno-27-120" href="#__codelineno-27-120"></a>
</span><span id="__span-27-121"><a id="__codelineno-27-121" name="__codelineno-27-121" href="#__codelineno-27-121"></a>Miao Wang, [2024/12/7 15:47]
</span><span id="__span-27-122"><a id="__codelineno-27-122" name="__codelineno-27-122" href="#__codelineno-27-122"></a>比如如果是局域网的广播包，你这个似乎就很难处理。。。。
</span><span id="__span-27-123"><a id="__codelineno-27-123" name="__codelineno-27-123" href="#__codelineno-27-123"></a>
</span><span id="__span-27-124"><a id="__codelineno-27-124" name="__codelineno-27-124" href="#__codelineno-27-124"></a>Miao Wang, [2024/12/7 15:48]
</span><span id="__span-27-125"><a id="__codelineno-27-125" name="__codelineno-27-125" href="#__codelineno-27-125"></a>就是 ip l2tp add tunnel，然后 ip l2tp add session 就好了
</span></code></pre></div>
<p><a href="https://support.huawei.com/enterprise/zh/doc/EDOC1100033731/12541fbc">L2TPv3原理介绍 - AR100, AR120, AR150, AR160, AR200, AR300, AR1200, AR2200, AR3200, AR3600 V200R010 配置指南-VPN（命令行） - 华为</a></p>
<h3 id="l2tp-配置">L2TP 配置<a class="headerlink" href="#l2tp-配置" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>sudo ip l2tp add tunnel tunnel_id 100 peer_tunnel_id 1 encap udp local 222.195.72.114 remote 114.214.236.72 udp_sport 1701 udp_dport 1702
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>sudo ip l2tp add session tunnel_id 100 session_id 1 peer_session_id 1
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>ip l2tp add tunnel tunnel_id 1 peer_tunnel_id 100 encap udp remote 222.195.72.114 local 114.214.236.72 udp_sport 1702 udp_dport 1701
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>ip l2tp add session tunnel_id 1 session_id 1 peer_session_id 1
</span></code></pre></div>
<p>之后在 op1 上将 l2tpeth0 添加到 LAN bridge 即可。
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>17:11:10.199353 l2tpeth0 P   IP 192.168.35.42 &gt; 192.168.35.183: ICMP echo request, id 35, seq 17, length 64
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>17:11:10.199366 vxlan0 Out IP 192.168.35.42 &gt; 192.168.35.183: ICMP echo request, id 35, seq 17, length 64
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>17:11:10.204473 vxlan0 P   IP 192.168.35.183 &gt; 192.168.35.42: ICMP echo reply, id 35, seq 17, length 64
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>17:11:10.204496 l2tpeth0 Out IP 192.168.35.183 &gt; 192.168.35.42: ICMP echo reply, id 35, seq 17, length 64
</span></code></pre></div></p>
<h3 id="openwrt-l2tpv3-pseudowire-bridged-to-lan">openwrt L2TPv3 Pseudowire bridged to LAN<a class="headerlink" href="#openwrt-l2tpv3-pseudowire-bridged-to-lan" title="Permanent link">&para;</a></h3>
<p>https://openwrt.org/docs/guide-user/network/tunneling_interface_protocols#l2tpv3_pseudowire_bridged_to_lan</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>opkg install xl2tpd
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>modprobe l2tp_eth l2tp_ip l2tp_ip6
</span></code></pre></div>
<p>发现配置文件选项不太一样，是早期的 openwrt 网络配置，interface 直接使用 type bridge，而不是一个 device</p>
<p>This example establishes a Pseudowire Tunnel and bridges it to the LAN ports. The existing lan interface is reused with protocol <code>l2tp</code> instead of <code>static</code>.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>config interface &#39;lan&#39;
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>    option proto     &#39;l2tp&#39;
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>    option type      &#39;bridge&#39;
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>    option ifname    &#39;eth0&#39;
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>    option ipaddr    &#39;192.168.1.1&#39;
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>    option netmask   &#39;255.255.255.0&#39;
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>    option localaddr &#39;178.24.154.19&#39;
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>    option peeraddr  &#39;89.44.33.61&#39;
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>    option encap     &#39;udp&#39;
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>    option sport     &#39;4000&#39;
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>    option dport     &#39;5410&#39;
</span></code></pre></div>
<p><a href="https://oldwiki.archive.openwrt.org/doc/howto/pseudowire">Pseudowire [Old OpenWrt Wiki]</a>
<strong>仍然不支持 bridge 不同 MTU 的设备</strong>。</p>
<blockquote>
<p>For now the setup works so both sides can ping each other. An ssh connection, however, is not either possible or freezes after a few seconds. The reason: The bridge for the L2TPv3 contains devices with different MTU3 . Furthermore, as the connection is bridged no routing happens and the MTU is not automatically adjusted by the router. All devices in the LAN usually use a MTU of 1500. The MTU of the L2TPv3 devices is about 1400. As the tunnel itself can not fragment packets all packets bigger than the MTU are lost. This happens at longer HTTP request, too. To solve the problem bridge firewalling and TCP MSS Clamping is used. Bridge firewalling means the iptables rules are used when a packet passes a bridge. Normally this should not work, as a bridge only works in Layer 2. However, if bridge firewalling is enabled in the kernel a bridge can work in Layer 2 as well as Layer 3. The following sysctl keys are used for this:</p>
</blockquote>
<h2 id="参考">参考<a class="headerlink" href="#参考" title="Permanent link">&para;</a></h2>
<ul>
<li>windows 查看 PMTU：<a href="https://answers.microsoft.com/en-us/windows/forum/all/windows-mtu-active-value-after-pmtu/ed7c2ce3-adc3-4135-9539-267a8e9fbe56">Windows MTU active value after pmtu ? - Microsoft Community</a></li>
<li>route some packets instead of bridging：<a href="https://www.netfilter.org/projects/nftables/manpage.html#lbBV:~:text=route%20some%20packets%20instead%20of%20bridging.">nft 手册</a></li>
<li>使用 nft 在 bridge 上实现中间人攻击：<a href="https://serverfault.com/questions/996794/bridge-nftables-how-to-redirect-incoming-http-https-traffic-to-local-port-808">Bridge + nftables: How to redirect incoming HTTP/HTTPS traffic to local port 8080? - Server Fault</a></li>
</ul>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../../02/27/%E4%B8%BA%E8%AE%BE%E5%A4%87%E5%88%86%E9%85%8D%E9%9D%99%E6%80%81v6-ndppd/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 为设备分配静态 v6 基于 ndppd">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                为设备分配静态 v6 基于 ndppd
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2024/04/05/%E5%8F%B0%E5%BC%8F%E6%9C%BA%E5%8D%87%E7%BA%A7-%E7%A1%AC%E4%BB%B6%E7%AF%87/" class="md-footer__link md-footer__link--next" aria-label="下一页: 台式机升级-硬件篇">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                台式机升级-硬件篇
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/TheRainstorm" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>