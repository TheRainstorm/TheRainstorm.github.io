
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
      
      
      
        <link rel="canonical" href="https://yfy.cqu.ai/%E5%8D%9A%E5%AE%A2--%E7%BD%91%E7%BB%9C/2024/04/21/%E4%BE%BF%E6%90%BA%E8%B7%AF%E7%94%B1%E5%99%A8/">
      
      
        <link rel="prev" href="../../../../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2024/04/05/%E5%8F%B0%E5%BC%8F%E6%9C%BA%E5%8D%87%E7%BA%A7-%E7%A1%AC%E4%BB%B6%E7%AF%87/">
      
      
        <link rel="next" href="../../../../../%E5%8D%9A%E5%AE%A2/2024/05/25/VR%20%E5%A4%9A%E4%BA%BA%E8%A7%82%E5%BD%B1%E6%96%B9%E6%A1%88%E6%8E%A2%E7%A9%B6/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>便携路由器 - Rain 的随笔</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#背景" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../../.." title="Rain 的随笔" class="md-header__button md-logo" aria-label="Rain 的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rain 的随笔
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              便携路由器
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../../../../.." class="md-tabs__link">
        
  
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../about/" class="md-tabs__link">
        
  
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tags/" class="md-tabs__link">
        
  
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../series/" class="md-tabs__link">
        
  
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tools/" class="md-tabs__link">
        
  
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../archive/2024/" class="md-tabs__link">
          
  
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../category/%E4%B8%AA%E4%BA%BA/" class="md-tabs__link">
          
  
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Rain 的随笔" class="md-nav__button md-logo" aria-label="Rain 的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Rain 的随笔
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    标签
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    系列
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    分类
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E4%B8%AA%E4%BA%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    个人
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%8D%9A%E5%AE%A2--%E7%BD%91%E7%BB%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客 &amp; 网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    学习笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    折腾记录
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    课程笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    软件工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E9%98%85%E8%AF%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    阅读
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    回到主页
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    元数据
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2024-04-21 17:14:38+00:00" class="md-ellipsis">2024年4月21日</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            分类于
                            
                              <a href="../../../../../category/%E5%8D%9A%E5%AE%A2--%E7%BD%91%E7%BB%9C/">博客 &amp; 网络</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              需要 17 分钟阅读时间
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#背景" class="md-nav__link">
    <span class="md-ellipsis">
      背景
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#设备选择" class="md-nav__link">
    <span class="md-ellipsis">
      设备选择
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wg-设置" class="md-nav__link">
    <span class="md-ellipsis">
      wg 设置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="wg 设置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#接口配置" class="md-nav__link">
    <span class="md-ellipsis">
      接口配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#防火墙" class="md-nav__link">
    <span class="md-ellipsis">
      防火墙
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vxlan-设置" class="md-nav__link">
    <span class="md-ellipsis">
      vxlan 设置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="vxlan 设置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#安装" class="md-nav__link">
    <span class="md-ellipsis">
      安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#配置" class="md-nav__link">
    <span class="md-ellipsis">
      配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#配置-vxlan-接口" class="md-nav__link">
    <span class="md-ellipsis">
      配置 vxlan 接口
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#配置-bridge" class="md-nav__link">
    <span class="md-ellipsis">
      配置 bridge
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#配置-lan2-接口" class="md-nav__link">
    <span class="md-ellipsis">
      配置 lan2 接口
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openwrt-配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      openwrt 配置文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#创建多个无线-ssid" class="md-nav__link">
    <span class="md-ellipsis">
      创建多个无线 SSID
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#踩的坑" class="md-nav__link">
    <span class="md-ellipsis">
      踩的坑
    </span>
  </a>
  
    <nav class="md-nav" aria-label="踩的坑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#和-bridge-桥接失败" class="md-nav__link">
    <span class="md-ellipsis">
      和 bridge 桥接失败
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#和无线桥接后不转发广播" class="md-nav__link">
    <span class="md-ellipsis">
      和无线桥接后不转发广播
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mtu-问题消失二层套三层" class="md-nav__link">
    <span class="md-ellipsis">
      MTU 问题消失？（二层套三层）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MTU 问题消失？（二层套三层）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#额外分片测速" class="md-nav__link">
    <span class="md-ellipsis">
      额外分片测速
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#遇到的问题" class="md-nav__link">
    <span class="md-ellipsis">
      遇到的问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="遇到的问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nft-命令报错" class="md-nav__link">
    <span class="md-ellipsis">
      nft 命令报错
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#解决-mtu-问题总结" class="md-nav__link">
    <span class="md-ellipsis">
      解决 MTU 问题总结
    </span>
  </a>
  
    <nav class="md-nav" aria-label="解决 MTU 问题总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#方案对比" class="md-nav__link">
    <span class="md-ellipsis">
      方案对比
    </span>
  </a>
  
    <nav class="md-nav" aria-label="方案对比">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#20250217-x86-两层套三层不自动分片" class="md-nav__link">
    <span class="md-ellipsis">
      2025/02/17 x86 两层套三层不自动分片
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#底层-wg-方案注意" class="md-nav__link">
    <span class="md-ellipsis">
      底层 wg 方案注意
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bridge-转-routing-方案注意" class="md-nav__link">
    <span class="md-ellipsis">
      bridge 转 routing 方案注意
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bridge-转-routing-二层抓包分析" class="md-nav__link">
    <span class="md-ellipsis">
      bridge 转 routing 二层抓包分析
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#其它问题" class="md-nav__link">
    <span class="md-ellipsis">
      其它问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其它问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#使用-dhcp-option-缓解-mtu-问题" class="md-nav__link">
    <span class="md-ellipsis">
      使用 dhcp option 缓解 MTU 问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#测速" class="md-nav__link">
    <span class="md-ellipsis">
      测速
    </span>
  </a>
  
    <nav class="md-nav" aria-label="测速">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wg-组网性能测试" class="md-nav__link">
    <span class="md-ellipsis">
      wg 组网性能测试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#无线下-l2-和-l3-性能" class="md-nav__link">
    <span class="md-ellipsis">
      无线下 L2 和 L3 性能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="无线下 L2 和 L3 性能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#信道影响" class="md-nav__link">
    <span class="md-ellipsis">
      信道影响
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-60dbm" class="md-nav__link">
    <span class="md-ellipsis">
      -60dBm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-65dbm" class="md-nav__link">
    <span class="md-ellipsis">
      -65dBm
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  


  <nav class="md-tags" >
    
      
      
      
        <a href="../../../../../tags/#tag:glinet" class="md-tag">glinet</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:jcg_q30" class="md-tag">jcg_q30</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:openwrt" class="md-tag">openwrt</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:vxlan" class="md-tag">vxlan</a>
      
    
  </nav>



  <h1>便携路由器</h1>

<h2 id="背景">背景<a class="headerlink" href="#背景" title="Permanent link">&para;</a></h2>
<p>很多时候，我们想要出门在外也能方便地连入我们的内网。我最近就遇到了到朋友那玩 VR 结果串流不成功的问题。虽然理论上我可以在那慢慢配置 wireguard 啥的，但是通常一下午并没有这么多时间让我折腾。所以就在想是否可以随身携带一个便携路由器，只需要插上网线，连上 wifi 就能快速接入我的内网呢？这便对路由器提出了一些需求：</p>
<ol>
<li>最重要的，需要便携性，能放入书包里</li>
<li>能刷 openwrt 跑 wireguard</li>
<li>有 <strong>wifi 6</strong></li>
<li>最好是主线 openwrt</li>
<li>性能联发科 <strong>mt7981</strong> 以上</li>
</ol>
<p>2）和4）主要是我设想的组网方案会用到 wireguard，而一些硬件主线还没有支持（比如 360t7 和 wr30u 都是 23 下半年才支持的，我买的时候还没有）。虽然有一些第三方的 openwrt 魔改版固件，比如 QWRT，XWRT 等等。但这些系统有一些我无法接受的点，比如使用闭源 wifi 驱动，这导致无法和主线的 openwrt 组 mesh 和 fast roaming 等。另外 wireguard 需要内核模块，如果第三方固件没有的话，也没法自己安装。</p>
<p>3）和 5）主要是因为 VR 串流对于带宽要求是比较高的，在一些高端硬件情况下，码率设置成 500 mbps 都是可行的。我的硬件一般 60 - 100 Mbps 就够了。由于 wg 需要加解密是需要吃较多 CPU 资源的，mt7981 能够跑到 350-400 Mbps 左右（见<a href="https://github.com/cyyself/wg-bench">cyyself/wg-bench: WireGuard Benchmark using netns and iperf3 (github.com)</a>）。而经典的 mt7261 MIPS SoC 则只能跑到 100 Mbps 左右就明显不够用了。因此为了保障有较好体验，wifi 6 和 mt7981 我觉得是个基准线了。</p>
<p>最终实现的效果</p>
<ul>
<li>设备通过 wg0 接口连接入我的内网</li>
<li>（三层接入）连接 5G wifi SSID1，被分配一个本地局域网地址 192.168.1.x，然后通过 wg0 NAT 后上网</li>
<li>（二层接入）连接 5G wifi SSID2，通过 vxlan 二层接入我的 op1 内网，获得 op1 的内网地址</li>
</ul>
<p>测速</p>
<ul>
<li>有线 wg：420/430 (up/down，下同)</li>
<li>无线（-60dBm signal/-90dBm noise）<ul>
<li>L2:  257/320</li>
<li>L3：300/340</li>
</ul>
</li>
</ul>
<p>最后的接口示例：
<img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240531174013.png" /></p>
<!-- more -->
<h2 id="设备选择">设备选择<a class="headerlink" href="#设备选择" title="Permanent link">&para;</a></h2>
<p>在 tuna tg 群里提问，有人推荐了 GL.iNet 3000 AT 的方案。看了下确实是我的梦中情机，体积只有一个充电宝那么大，硬件参数却非常充足，也是 mt7981 的方案，支持 wifi6，甚至还有 2.5 G 网口和 USB 3.0。最文明的还是它的 typec 供电，充电器也可以省去了，甚至可以用充电宝供电。但是看了看价格，jd 上卖 550 左右的价格。咸鱼二手价格也维持在 380 以上。感觉和 70 块的其它 mt7981 方案性价比还是低了一截。希望以后咸鱼价格能降下来吧，我觉得目前比较合理的价格应该在 200 左右。</p>
<p><img alt="" src="https://static.gl-inet.com/www/images/products/gl-mt3000/mt3000_storage.webp" /></p>
<p>最后我购入了 捷稀 JCG Q30 Pro，主要看重了它天线可折叠的设计（类似的设计还有 CMCC rax3000 定制版和小米 3000AT）。刚开始本来想买 cmcc rax3000（110元），但是让卖家比对了下大小后（图中是 A4 纸），发现和我的 AX6S 差不多大（感觉不太容易放进背包），因此就没买。</p>
<p><img alt="cmcc rax3000" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/cmcc_rax3000.png" /></p>
<p>jcg q30 pro 与 A4 纸对比（发现原来更大）</p>
<p><img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240531171706.png" /></p>
<h2 id="wg-设置">wg 设置<a class="headerlink" href="#wg-设置" title="Permanent link">&para;</a></h2>
<p>由于设备只用于临时接入内网，故不打算使用 wg_s2s 接口，而是使用 wg0 接口，就像我的其它手机、笔记本设备一样。</p>
<p>由于 wg 的配置网上很多了，这里就不具体将如何配置了，只提几个重点。</p>
<ul>
<li>本地监听端口不用设置，随机即可，因为是主动连接到对面。这样防火墙 input 规则也省了（conntrack 会自动允许主动向外流量的 input）</li>
<li><strong>wg0 开启 NAT</strong>，这样设备上任意地址都可以通过 wg0 接口上网，并且两侧 allowed_ips 仅需设置 wg0 接口地址即可<ul>
<li>这里便携路由器 allowed_ips 设置了 0.0.0.0/0，因此所有上网流量会走 wg。当然也可以设置只有内网流量走 wg，其余还是通过原本的 wan 上网。</li>
</ul>
</li>
</ul>
<h3 id="接口配置">接口配置<a class="headerlink" href="#接口配置" title="Permanent link">&para;</a></h3>
<p>jcg_q30p</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>config interface &#39;wg0&#39;
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>        option proto &#39;wireguard&#39;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        option private_key &#39;xxx&#39;
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        list addresses &#39;10.0.31.103/32&#39;
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>config wireguard_wg0
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        option description &#39;op1&#39;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        option public_key &#39;eVL0uj6T5wEMTs039QF9t+JtXOchHJWROCoq/4kEKlE=&#39;
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        list allowed_ips &#39;10.0.31.1/32&#39;
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        list allowed_ips &#39;0.0.0.0/0&#39;
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        option route_allowed_ips &#39;1&#39;
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        option endpoint_host &#39;op1.yfycloud.site&#39;
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        option endpoint_port &#39;51820&#39;
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        option persistent_keepalive &#39;25&#39;
</span></code></pre></div>
<p>op1</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>config wireguard_wg0
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>        option public_key &#39;vXU/50/NA4tAG8fou1or1N22sZz3suCoYu/q4MkiBhE=&#39;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>        option description &#39;jcg_q30&#39;
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>        list allowed_ips &#39;10.0.31.103/32&#39;
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        option route_allowed_ips &#39;1&#39;
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>        option persistent_keepalive &#39;25&#39;
</span></code></pre></div>
<h3 id="防火墙">防火墙<a class="headerlink" href="#防火墙" title="Permanent link">&para;</a></h3>
<p>后面 vxlan 的防火墙也在这一起说明</p>
<ul>
<li>lan 允许 forward 到 wan 和 wg0<ul>
<li>forward wan：虽然现在默认路由走 wg0，但是说不定之后有走 wan 的分流需求</li>
</ul>
</li>
<li>wg0 允许 input，因为后面 vxlan 还需要用到 input udp 4798，这样该规则也省了</li>
</ul>
<p>关于 lan2</p>
<ul>
<li>lan2 不需要 forward 到任何 zone，因为 lan2 是对端的虚拟延伸，可以看作是对端的一部分。因此最好不要和本地有太多交集，否则需要添加太多特殊路由规则。要想访问 lan2，正常通过 wg0 即可。</li>
</ul>
<p><img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240531165130.png" /></p>
<h2 id="vxlan-设置">vxlan 设置<a class="headerlink" href="#vxlan-设置" title="Permanent link">&para;</a></h2>
<p>vxlan 的一篇好文章<a href="https://vincent.bernat.ch/en/blog/2017-vxlan-linux">VXLAN &amp; Linux (bernat.ch)</a></p>
<p>之所以选择 vxlan 而不是 gre，是因为 vxlan 支持<strong>多对多</strong>的连接，这样如果以后更换其它便携路由器，不用每次都在 op1 上增加 gre 接口。</p>
<h3 id="安装">安装<a class="headerlink" href="#安装" title="Permanent link">&para;</a></h3>
<p>安装必要的包</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>opkg install kmod-vxlan luci-proto-vxlan vxlan tcpdump ip-bridge
</span></code></pre></div>
<p>安装后需要<code>/etc/init.d/network restart</code> 重启网络，luci 界面中才可以添加 vxlan 协议接口。</p>
<div class="admonition note">
<p class="admonition-title">pve modprobe 需要的 kernel mod</p>
<p>如果你的 openwrt 是在 pve 里的 lxc 容器。那么可能需要让以下 mod 开机时自动加载
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">#/etc/module</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span>vxlan
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span>ip6_udp_tunnel
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span>udp_tunnel
</span></code></pre></div></p>
</div>
<h3 id="配置">配置<a class="headerlink" href="#配置" title="Permanent link">&para;</a></h3>
<h4 id="配置-vxlan-接口">配置 vxlan 接口<a class="headerlink" href="#配置-vxlan-接口" title="Permanent link">&para;</a></h4>
<p>vxlan 的配置也非常简单。查看 openwrt 关于具体选项的解释 <a href="https://openwrt.org/docs/guide-user/network/tunneling_interface_protocols#protocol_vxlan_vxlan_layer_2_virtualization_over_layer_3_network">[OpenWrt Wiki] Tunneling interface protocols</a></p>
<ul>
<li>最好绑定一个 mac 地址，不然会每次重启会发生变化</li>
<li>设置下 mtu，因为底层 wg0 是 1420，减 50 为 1370</li>
</ul>
<h4 id="配置-bridge">配置 bridge<a class="headerlink" href="#配置-bridge" title="Permanent link">&para;</a></h4>
<p>设置好 vxlan0 接口后，需要将其和 bridge 绑定起来，这样才能和其它正常接口连接起来。</p>
<h4 id="配置-lan2-接口">配置 lan2 接口<a class="headerlink" href="#配置-lan2-接口" title="Permanent link">&para;</a></h4>
<p>br-lan2 是物理设备的概念，配置 dhcp server 等还需要创建 interface。这里我们在 br-lan2 设备上创建一个 lan2 接口。</p>
<p><img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240531175932.png" /></p>
<p><del>这里创建了一个 br-lan2 的设备，并在此之上创建了一个 lan2 的interface，作为 dhcp client，从 op1 那获得 ip 地址。</del></p>
<p><del>这里需要开启<code>option defaultroute '0'</code>，否则 lan2 接口就会替换掉原本的默认路由。这样 lan 就无法通过 wg0 上网了。</del></p>
<p>UPDATE：lan2 接口推荐设置成 Unmanaged，这样 lan2 接口不会获得地址，因此不会生成额外的路由干扰原本的网络。</p>
<p>lan2 接口本质上是一条连接到 op1 的虚拟链路，因此和本系统交互越少越好。虽然这样会导致连接 lan2 会无法访问 lan。但是换来了更简单清晰的网络。</p>
<h4 id="openwrt-配置文件">openwrt 配置文件<a class="headerlink" href="#openwrt-配置文件" title="Permanent link">&para;</a></h4>
<p>jcg_q30p</p>
<ul>
<li>peeraddr 添加对端地址</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>config interface &#39;vxlan0&#39;
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>        option proto &#39;vxlan&#39;
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>        option peeraddr &#39;10.0.31.1&#39;
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        option port &#39;4789&#39;
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        option vid &#39;8&#39;
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        option mtu &#39;1370&#39;
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        option macaddr &#39;12:0A:F7:78:24:B0&#39;
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        option force_link &#39;1&#39;
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>config device
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        option type &#39;bridge&#39;
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        option name &#39;br-lan2&#39;
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        list ports &#39;lan3&#39;
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        list ports &#39;vxlan0&#39;
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        option mtu &#39;1370&#39;
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        option bridge_empty &#39;1&#39;
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>config interface &#39;lan2&#39;
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        option proto &#39;none&#39;
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        option device &#39;br-lan2&#39;
</span></code></pre></div>
<p>op1。由于要连接多个 peer，因此使用了 vxlan_peer 的格式</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>config interface &#39;vxlan0&#39;
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>        option proto &#39;vxlan&#39;
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>        option port &#39;4789&#39;
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>        option vid &#39;8&#39;
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>        option tunlink &#39;wg0&#39;
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>config vxlan_peer
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        option vxlan &#39;vxlan0&#39;
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        option dst &#39;10.0.31.103&#39;
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>config vxlan_peer
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        option vxlan &#39;vxlan0&#39;
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        option dst &#39;xxx&#39;   # 其它 vxlan 设备
</span></code></pre></div>
<h3 id="创建多个无线-ssid">创建多个无线 SSID<a class="headerlink" href="#创建多个无线-ssid" title="Permanent link">&para;</a></h3>
<p>如图在 5G 设备上创建两个 SSID: <strong>JCG Q30 Pro 5G (L3)</strong> 和 <strong>JCG Q30 Pro 5G (L2)</strong> 分别绑定到 lan 和 lan2。这样就可以通过切换 wifi 的方式切换网络了。</p>
<p><img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240422114149.png" /></p>
<h3 id="踩的坑">踩的坑<a class="headerlink" href="#踩的坑" title="Permanent link">&para;</a></h3>
<h4 id="和-bridge-桥接失败">和 bridge 桥接失败<a class="headerlink" href="#和-bridge-桥接失败" title="Permanent link">&para;</a></h4>
<p>刚开始在 jcg_q30 上死活无法将 vxlan0 和新创建的 br-vxlan 桥接起来。只要一桥接，vxlan0 设备就会消失，重启 vxlan 后恢复，但是 br-vxlan 又消失。</p>
<p>不确定是哪些原因修复了问题，记录下做的一些改动</p>
<ul>
<li>vxlan 原本绑定了接口 wg0，现在将其设置为 unspecific （op1 上也一样）</li>
<li>删除了原本的 br-vxlan，改名为 br-lan2，勾选了 bring up empty bridge。</li>
</ul>
<h4 id="和无线桥接后不转发广播">和无线桥接后不转发广播<a class="headerlink" href="#和无线桥接后不转发广播" title="Permanent link">&para;</a></h4>
<p>将无线绑定到 lan2 网络后，发现设备没法获得 ip 地址。tcpdump 抓包，发现 phy1-ap0 上收到 dhcp request，但是没有将其从 vxlan0 口发出去。</p>
<p>phy-ap0 为 5G 无线对应接口</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>34: phy0-ap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-lan state UP group default qlen 1000
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    link/ether 50:33:f0:e2:fe:9e brd ff:ff:ff:ff:ff:ff
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    inet6 fe80::5233:f0ff:fee2:fe9e/64 scope link
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>       valid_lft forever preferred_lft forever
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>35: phy1-ap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-lan2 state UP group default qlen 1000
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    link/ether 52:33:f0:e2:fe:9e brd ff:ff:ff:ff:ff:ff
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    inet6 fe80::5033:f0ff:fee2:fe9e/64 scope link
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>       valid_lft forever preferred_lft forever
</span></code></pre></div>
<p>后面发现不知为何，无线接口 phy1-ap0 的 master 是空的。于是删除了原本的 vxlan 接口，重新创建了 lan2，然后设置无线绑定到 lan2 就好了。</p>
<h2 id="mtu-问题消失二层套三层">MTU 问题消失？（二层套三层）<a class="headerlink" href="#mtu-问题消失二层套三层" title="Permanent link">&para;</a></h2>
<p><a href="../../../03/15/MTU%E7%9A%84%E9%82%A3%E4%BA%9B%E5%9D%91%28%E4%BA%8C%E5%B1%82%E9%9A%A7%E9%81%93%E7%BB%84%E7%BD%91%29/">之前博客</a>已经探讨过，如果同一个二层存在 MTU 不一致，那么会存在包因为无法分片而丢失的情况。</p>
<p>然后由于使用的 ARM openwrt 系统编译时可能没有开启一些 flag，导致之前让 bridge 变为 route 的 nft 命令无法运行。但是神奇的是，这次 ping 大包时居然没有出现不通的情况。经过研究，<strong>发现原因在于二层隧道套三层隧道后，底层的三层隧道会对上层的包再次分片</strong>，因而不会存在之前的问题。以下是具体抓包细节。</p>
<p>kvm-win10 连接了 jcg_q30p 的 wifi，获取到了 ip。使用该 ip ping op1</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>yfy@kvm-win10 UCRT64 ~
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>$ ping -S 192.168.35.135 192.168.35.1 -l 2000 -t
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>正在 Ping 192.168.35.1 从 192.168.35.135 具有 2000 字节的数据:
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>请求超时。
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>来自 192.168.35.1 的回复: 字节=2000 时间=1ms TTL=64
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>来自 192.168.35.1 的回复: 字节=2000 时间=1ms TTL=64
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>来自 192.168.35.1 的回复: 字节=2000 时间=1ms TTL=64
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>来自 192.168.35.1 的回复: 字节=2000 时间=1ms TTL=64
</span></code></pre></div>
<p>在 jcg_q30p 上抓包，可以发现包确实是通过 vxlan 传递到了 op1。并且设备是按照 MTU=1500 进行分片的，所以理论上 1500 的包是无法通过 MTU = 1370 的 vxlan0 的。但是结果是正确收到了 icmp reply。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>14:45:02.547067 phy1-ap0 P   IP 192.168.35.135 &gt; 192.168.35.1: ICMP echo request, id 1, seq 506, length 1480
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>14:45:02.547089 vxlan0 Out IP 192.168.35.135 &gt; 192.168.35.1: ICMP echo request, id 1, seq 506, length 1480
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>14:45:02.547067 phy1-ap0 P   IP 192.168.35.135 &gt; 192.168.35.1: ip-proto-1
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>14:45:02.547181 vxlan0 Out IP 192.168.35.135 &gt; 192.168.35.1: ip-proto-1
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>14:45:02.547984 vxlan0 P   IP 192.168.35.1 &gt; 192.168.35.135: ICMP echo reply, id 1, seq 506, length 1344
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>14:45:02.548031 phy1-ap0 Out IP 192.168.35.1 &gt; 192.168.35.135: ICMP echo reply, id 1, seq 506, length 1344
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>14:45:02.547984 vxlan0 P   IP 192.168.35.1 &gt; 192.168.35.135: ip-proto-1
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>14:45:02.548054 phy1-ap0 Out IP 192.168.35.1 &gt; 192.168.35.135: ip-proto-1
</span></code></pre></div>
<p>通过在 jcg_q30p 对 wg0 接口进行抓包（vxlan 底层基于的接口），可以发现 icmp request 对应 3 个包，reply 对应 2 个包。</p>
<p><img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240421163238.png" /></p>
<p>仔细研究后，终于理清了它们的对应关系，以下是结果。</p>
<p>层层封装的包的格式如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>20         8     8       14    20          8    
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>ip(wg0)  | udp | vxlan | eth | ip(vxlan) | icmp | data=2000
</span></code></pre></div>
<p>首先在 kvm-win10 的视角，由于假设了 MTU = 1500，因此对于 ip 负载为 2008B 的 icmp 包（2000 data + 8 header），需要按照 1480 + 528 分片成两个包。各添加 20B ip header 后交给 vxlan 接口。</p>
<p>在 vxlan 的视角，有两个 ip 层长度分别为 1500, 548 的包要发送出去。添加了 udp + vxlan + eth 后就是 1530, 578（没有包含 ip 头部），需要交给 wg0 发出去。</p>
<p>在 wg0 视角，1530+20 明显超过了自己 1420 的 MTU，因此又需要分成两个包。按照 1400 分片，分为 1400 + 130 两个包。添加 wg ip header 后就是 1420 和 150。这刚好对应 wireshark 中前两个包的大小。对于另一个 578 的包则不用分片，添加 ip header 后就是 598。</p>
<p>可以看到 wireshark 做了很多处理。由于 vxlan 没有加密，因此 wireshark 直接展示了 vxlan 内的内容。对于第一个包，只显示了是 ip fragment，源地址后目的地址也都是 10.0.31。而收到第二个包后，由于已经可以和第一个重组成一个完整的 ip 包了（应该说是经过 vxlan 包装后的 ip 包），因此显示了 内部的地址 192.168.35。等收到第三个包时，内部的 ip 包也能够重组了，因此显示了最终的 icmp 信息。</p>
<p>以下显示了这种层层嵌套的关系
<img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240421170503.png" /></p>
<p>为什么 reply 只有两个包呢。因此 op1 上 vxlan 对应的接口 MTU 已经被设置成了 1370，因此返回时对于 2008B 的包会按照 1370 进行分片，分成两个包。这两个包加上 vxlan 开销后对于 wg0 都不会超过 MTU 大小，因此不会产生更多分片，因此只有两个包。</p>
<p>可能会发现 reply 包的 ip 层大小并不是 1420，而是 1414。这是因为上层按照 MTU=1370 分片时，ip 负载部分需要是 8 的倍数，因此不是 1350 而是 1344，如图中红框圈起部分。这导致加上 vxlan 开销后就是 1344 + 20 + 50 = 1414 了</p>
<p><img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240421171121.png" /></p>
<h3 id="额外分片测速">额外分片测速<a class="headerlink" href="#额外分片测速" title="Permanent link">&para;</a></h3>
<p>看看 L2 额外分片导致的性能影响，使用 iperf3 进行测速。测试 jcg_q30p 和 op1 间通过 wg 和 vxlan 时的速度。</p>
<table>
<thead>
<tr>
<th></th>
<th>vxlan</th>
<th>wg</th>
</tr>
</thead>
<tbody>
<tr>
<td>up</td>
<td>350</td>
<td>500</td>
</tr>
<tr>
<td>down</td>
<td>400</td>
<td>470</td>
</tr>
<tr>
<td>可以看到额外的分片确实造成了一定的性能影响。主要在于 jcg_q30p 上传时（jcg_q30p 负责分片）。下载影响较小。</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="遇到的问题">遇到的问题<a class="headerlink" href="#遇到的问题" title="Permanent link">&para;</a></h3>
<h4 id="nft-命令报错">nft 命令报错<a class="headerlink" href="#nft-命令报错" title="Permanent link">&para;</a></h4>
<p>报错，但是同样的命令 x86 上的 openwrt 又没有问题。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>root@JCG_Q30P ➜  ~ nft list table bridge fix_mtu
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>table bridge fix_mtu {
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>        chain c1 {
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>                type filter hook prerouting priority dstnat - 1; policy accept;
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        }
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>}
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>root@JCG_Q30P ➜  ~ nft add rule bridge fix_mtu c1 meta iifname vxlan0 ip daddr 192.168.35.0/24 meta pkttype set host ether daddr set 9e:65:fa:e5:bb:c0 counter
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>Error: Could not process rule: No such file or directory
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>add rule bridge fix_mtu c1 meta iifname vxlan0 ip daddr 192.168.35.0/24 meta pkttype set host ether daddr set 9e:65:fa:e5:bb:c0 counter
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>                           ^^^^^^^^^^^^
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>root@JCG_Q30P ➜  ~ nft add rule bridge fix_mtu c1 ip daddr 192.168.35.0/24 meta pkttype set host ether daddr set 9e:65:fa:e5:bb:c0 counter
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>Error: Could not process rule: No such file or directory
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>add rule bridge fix_mtu c1 ip daddr 192.168.35.0/24 meta pkttype set host ether daddr set 9e:65:fa:e5:bb:c0 counter
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>                           ^^^^^^^^
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>root@JCG_Q30P ➜  ~ nft add rule bridge fix_mtu c1 meta pkttype set host ether daddr set 9e:65:fa:e5:bb:c0 counter
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>Error: Could not process rule: No such file or directory
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>add rule bridge fix_mtu c1 meta pkttype set host ether daddr set 9e:65:fa:e5:bb:c0 counter
</span></code></pre></div>
<p>可能是没有开启相关内核选项：<a href="https://unix.stackexchange.com/questions/537912/nftables-rule-no-such-file-or-directory-error">linux - nftables rule: No such file or directory error - Unix &amp; Linux Stack Exchange</a></p>
<p>也不知道如何查看开了哪些内核选项：<a href="https://forum.openwrt.org/t/obtain-kernel-config-from-currently-running-openwrt-system/151339">Obtain kernel config from currently running OpenWrt system - Installing and Using OpenWrt - OpenWrt Forum</a></p>
<p>待解决</p>
<h2 id="解决-mtu-问题总结">解决 MTU 问题总结<a class="headerlink" href="#解决-mtu-问题总结" title="Permanent link">&para;</a></h2>
<h3 id="方案对比">方案对比<a class="headerlink" href="#方案对比" title="Permanent link">&para;</a></h3>
<p>MTU 问题：本地路由器通过 vxlan 二层隧道连接到主路由器 op1，并将 vxlan 接口桥接到以太网口和无线，从而让手机、笔记本等设备也连入 op1 的二层网络。然而，由于原本 op1 的二层 MTU 是 1500，而通过隧道的链路只有 1370（wg 1420 - vxlan 50），因此 op1 的二层出现了不同 MTU 的部分。</p>
<p>解决办法有两种</p>
<ul>
<li>bridge 转 routing。本地路由器转发一次，对 ip 报文分片。利用 nftable bridge 命令，<strong>修改包的目的 mac 地址</strong>为本地路由器，这样本地路由器接收到包后会转发该包，<strong>过程和普通的转发包没有区别</strong>。该操作和使用 ARP Proxy 来路由不同 VLAN 间的 IP 包设备原理类似。<ul>
<li>优点<ul>
<li>对速度影响较小。多一跳路由后，MSS clamping 可以正常工作，因此可以避免 TCP 的非必要分片</li>
</ul>
</li>
<li>缺点<ul>
<li>需要设置 nft 命令，一点点复杂</li>
<li>拉低了 op1 的 br-lan 的 MTU，需要设置成和 vxlan 一致</li>
</ul>
</li>
<li>lan2 设置：设置成 <strong>dhcp client</strong> 比较好，因为转发需要有路由。lan2 有 ip 地址，会自动设置路由</li>
</ul>
</li>
<li>二层套三层。在 wg 上创建 vxlan，wg 会自动将超过理论 MTU 的包按照 wg 接口 MTU 分片<ul>
<li>优点<ul>
<li>just work，不会遇到 MTU 问题</li>
</ul>
</li>
<li>缺点<ul>
<li>没有 MSS 功能，路由器上无法避免分片。分片有额外性能开销</li>
</ul>
</li>
<li>lan2 设置：设置成 <strong>umanaged</strong> 即可</li>
</ul>
</li>
</ul>
<h4 id="20250217-x86-两层套三层不自动分片">2025/02/17 x86 两层套三层不自动分片<a class="headerlink" href="#20250217-x86-两层套三层不自动分片" title="Permanent link">&para;</a></h4>
<p>在 op1 和 op2 尝试两层套三层方案，发现 ping 不通大包，在 op2 上抓包，发现底层 wg_s2s 或者 ipip 均不自动分片。</p>
<p><em>p.s vxlan 比较坑的一点是，底层切换了 peer 使用的 ip 后，重启接口仍然还是使用原本的 ip 建立 vxlan 连接。导致我无法快速切换底层的 wg 和 ipip。解决办法为 service network restart。</em></p>
<ul>
<li>但是 vr 串流没问题，moonlight 也没有问题（均是 udp 的）</li>
<li>iperf3 udp 测试无法进行，tcp 可以。使用 wireshark 抓包发现 tcp 时 MSS 设置的很小，不会超过路径 MTU。</li>
</ul>
<p>上述问题容易复现，目前解决办法为使用原本的 bridge 转 routing 方案。</p>
<p>硬路由明明没问题，区别在于这个是 x86 软路由。</p>
<p>TODO：进一步研究原因</p>
<h4 id="底层-wg-方案注意">底层 wg 方案注意<a class="headerlink" href="#底层-wg-方案注意" title="Permanent link">&para;</a></h4>
<p>推荐设置为 umanaged，这样对原本路由没有影响。而连接 lan2 的设备流量一定会通过 vxlan 发送出去。</p>
<p>如果要设置为 dhcp client</p>
<ul>
<li><strong>lan2 记住勾选 no default router</strong>，否则默认路由变为走 lan2 而不是 wan。</li>
<li>添加 ip rule 使得 src lan1 到 lan2 的走 wg 接口，否则会走 main 中 lan2 /24 的路由
  <div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a># ip ru
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>3:      from 192.168.36.0/24 lookup lan
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a># ip table show lan
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>192.168.35.0/24 dev wg_s2s proto static scope link
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a># ip ro
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>192.168.35.0/24 dev br-lan2 proto kernel scope link src 192.168.35.169
</span></code></pre></div></li>
</ul>
<p>此时 lan1 访问 lan2 走 wg 接口。lan2 访问 lan2 直接通过 vxlan 接口。</p>
<h4 id="bridge-转-routing-方案注意">bridge 转 routing 方案注意<a class="headerlink" href="#bridge-转-routing-方案注意" title="Permanent link">&para;</a></h4>
<p>本质已经变成路由了，所以来回甚至可以不走 vxlan。（但是确实解决了局域网发现设备的问题）</p>
<p>需要设置为 dhcp client，否则 br-lan2 没有 ip，无法路由 lan2 流量。</p>
<ul>
<li><strong>同样 lan2 记住勾选 no default router</strong>，否则默认路由变为走 lan2 而不是 wan。</li>
<li><strong>未必需要走 vxlan</strong>，如下去时走了 wg_s2s，回时走 vxlan，也没有问题。可以根据需求（比如隧道的延迟、带宽）切换不同路由。</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>root@op2 ➜  ~ tcpdump -ni any icmp and host 192.168.35.1
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>tcpdump: data link type LINUX_SLL2
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>00:06:58.678431 eth2  P   IP 192.168.35.180 &gt; 192.168.35.1: ICMP echo request, id 1, seq 3550, length 1480
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>00:06:58.678432 eth2  P   IP 192.168.35.180 &gt; 192.168.35.1: ip-proto-1
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>00:06:58.678432 br-lan2 In  IP 192.168.35.180 &gt; 192.168.35.1: ICMP echo request, id 1, seq 3550, length 2008
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>00:06:58.678500 wg_s2s Out IP 192.168.35.180 &gt; 192.168.35.1: ICMP echo request, id 1, seq 3550, length 1336
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>00:06:58.678811 wg_s2s Out IP 192.168.35.180 &gt; 192.168.35.1: ip-proto-1
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>00:06:58.690066 vxlan0 P   IP 192.168.35.1 &gt; 192.168.35.180: ICMP echo reply, id 1, seq 3550, length 1288
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>00:06:58.690114 vxlan0 P   IP 192.168.35.1 &gt; 192.168.35.180: ip-proto-1
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>00:06:58.690135 eth2  Out IP 192.168.35.1 &gt; 192.168.35.180: ICMP echo reply, id 1, seq 3550, length 1288
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>00:06:58.690137 eth2  Out IP 192.168.35.1 &gt; 192.168.35.180: ip-proto-1
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>root@op2 ➜  ~ ip ru
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>0:      from all lookup local
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>999:    from all lookup oversea
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>1009:   from all lookup mynet_lugvpn
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>1010:   from all lookup mynet_wg
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>32766:  from all lookup main
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>32767:  from all lookup default
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>root@op2 ➜  ~ ipt mynet_wg
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>192.168.35.0/24 dev wg_s2s proto static scope link
</span></code></pre></div>
<p>不通
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>root@op2 ➜  ~ tcpdump -ni any icmp and host 192.168.35.1
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>tcpdump: data link type LINUX_SLL2
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>00:42:12.035625 eth2  P   IP 192.168.35.180 &gt; 192.168.35.1: ICMP echo request, id 1, seq 5527, length 1480
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>00:42:12.035627 eth2  P   IP 192.168.35.180 &gt; 192.168.35.1: ip-proto-1
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>00:42:12.035627 br-lan2 In  IP 192.168.35.180 &gt; 192.168.35.1: ICMP echo request, id 1, seq 5527, length 2008
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>00:42:12.035698 ipip-s2s_ipip Out IP 10.99.1.2 &gt; 192.168.35.1: ICMP echo request, id 1, seq 5527, length 1256
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>00:42:12.035719 ipip-s2s_ipip Out IP 10.99.1.2 &gt; 192.168.35.1: ip-proto-1
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>00:42:12.044109 ipip-s2s_ipip In  IP 192.168.35.1 &gt; 10.99.1.2: ICMP echo reply, id 1, seq 5527, length 1256
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>00:42:12.044109 ipip-s2s_ipip In  IP 192.168.35.1 &gt; 10.99.1.2: ip-proto-1
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>00:42:12.044149 ipip-s2s_ipip Out IP 192.168.35.1 &gt; 192.168.35.180: ICMP echo reply, id 1, seq 5527, length 1256
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>00:42:12.044163 ipip-s2s_ipip Out IP 192.168.35.1 &gt; 192.168.35.180: ip-proto-1
</span></code></pre></div></p>
<p>通，但是逆天
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>root@op2 ➜  ~ tcpdump -ni any icmp and host 192.168.35.2
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>tcpdump: data link type LINUX_SLL2
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>00:43:46.715022 eth2  P   IP 192.168.35.180 &gt; 192.168.35.2: ICMP echo request, id 1, seq 5546, length 1256
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>00:43:46.715023 eth2  P   IP 192.168.35.180 &gt; 192.168.35.2: ip-proto-1
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>00:43:46.715023 br-lan2 In  IP 192.168.35.180 &gt; 192.168.35.2: ICMP echo request, id 1, seq 5546, length 2008
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>00:43:46.715109 ipip-s2s_ipip Out IP 10.99.1.2 &gt; 192.168.35.2: ICMP echo request, id 1, seq 5546, length 1256
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>00:43:46.715128 ipip-s2s_ipip Out IP 10.99.1.2 &gt; 192.168.35.2: ip-proto-1
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>00:43:46.724325 ipip-s2s_ipip In  IP 192.168.35.2 &gt; 10.99.1.2: ICMP echo reply, id 1, seq 5546, length 1256
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>00:43:46.724325 ipip-s2s_ipip In  IP 192.168.35.2 &gt; 10.99.1.2: ip-proto-1
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>00:43:46.724390 ipip-s2s_ipip Out IP 192.168.35.2 &gt; 192.168.35.180: ICMP echo reply, id 1, seq 5546, length 1256
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>00:43:46.724404 ipip-s2s_ipip Out IP 192.168.35.2 &gt; 192.168.35.180: ip-proto-1
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>00:43:46.733108 vxlan0 P   IP 192.168.35.2 &gt; 192.168.35.180: ICMP echo reply, id 1, seq 5546, length 1256
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>00:43:46.733181 vxlan0 P   IP 192.168.35.2 &gt; 192.168.35.180: ip-proto-1
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>00:43:46.733217 eth2  Out IP 192.168.35.2 &gt; 192.168.35.180: ICMP echo reply, id 1, seq 5546, length 1256
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>00:43:46.733220 eth2  Out IP 192.168.35.2 &gt; 192.168.35.180: ip-proto-1
</span></code></pre></div></p>
<h3 id="bridge-转-routing-二层抓包分析">bridge 转 routing 二层抓包分析<a class="headerlink" href="#bridge-转-routing-二层抓包分析" title="Permanent link">&para;</a></h3>
<p>之前<a href="../../../03/15/MTU%E7%9A%84%E9%82%A3%E4%BA%9B%E5%9D%91%28%E4%BA%8C%E5%B1%82%E9%9A%A7%E9%81%93%E7%BB%84%E7%BD%91%29/">《MTU的那些坑(二层隧道组网)》</a> 博客没有从二层进行抓包分析，这里进一步分析 bridge 转 routing 方法的原理。</p>
<p>涉及的接口：</p>
<ul>
<li>vxlan0：vxlan 接口</li>
<li>eth2：用于连接实际物理设备，如无线 AP。</li>
<li>br-lan2：将前两者桥接在一起</li>
</ul>
<p>n5105 连接了 op2 eth2，地址为 192.168.35.183，ping 192.158.35.1 (op1) 时的抓包结果如下。</p>
<ul>
<li>包从 eth2 进入，源 mac 为 n5105（7e10），目的 mac 地址为 op1（6780）（见 tcpdump eth2）。符合局域网直接发送的情况。</li>
<li>到达 br-lan2 时，由于 nft 规则，目的 mac 被修改成了 op2 br-lan2 的 mac 地址（9053)（见 tcpdump br-lan2）</li>
<li>op2 接收该包，发现不是给自己的，于是进入 forward 流程。</li>
<li>op2 发现 op1 位于自己 br-lan2 接口的网段，不需要路由，于是直接发送，产生一个目的 mac 为 op1 的包。</li>
<li>包最后从 vxlan0 发出去。</li>
<li>op1 接收到包，产生 reply。由于是一个网段，因此直接发送，源 mac 为 op1，目的 mac 地址为 n5105。</li>
</ul>
<p><img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240707181856.png" /></p>
<p>分片情况下的上述实验(n5105 ping -s 2000 op1)</p>
<ul>
<li>eth2 到 br-lan2 时，除了改变目的 mac 地址，还对分片进行了合并。</li>
<li>合并后，op2 转发时再次进行分片。</li>
</ul>
<p><img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240707181949.png" /></p>
<p>这是，op2 下 lan35 设备访问 op1 下 lan35 设备时。两边都对 mac 地址进行修改的例子。
<img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240707183647.png" /></p>
<p>MSS</p>
<p>简单来说就是从哪个接口出去，MSS 就会被设置成该接口的 MTU - 40。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>root@op2 ➜  ~ tcpdump -ni any tcp and &#39;tcp[tcpflags] &amp; tcp-syn != 0&#39;
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>tcpdump: data link type LINUX_SLL2
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>18:59:28.263559 eth1  In  IP 192.168.36.215.31229 &gt; 192.168.35.2.2202: Flags [S], seq 772932793, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>18:59:28.263617 wg_s2s Out IP 192.168.36.215.31229 &gt; 192.168.35.2.2202: Flags [S], seq 772932793, win 64240, options [mss 1372,nop,wscale 8,nop,nop,sackOK], length 0
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>18:59:28.266696 wg_s2s In  IP 192.168.35.2.2202 &gt; 192.168.36.215.31229: Flags [S.], seq 1164402249, ack 772932794, win 64240, options [mss 1330,nop,nop,sackOK,nop,wscale 7], length 0
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>18:59:28.266725 eth1  Out IP 192.168.35.2.2202 &gt; 192.168.36.215.31229: Flags [S.], seq 1164402249, ack 772932794, win 64240, options [mss 1330,nop,nop,sackOK,nop,wscale 7], length 0
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>root@op1 ➜  ~ tcpdump -ni any tcp and &#39;tcp[tcpflags] &amp; tcp-syn != 0&#39; and host 192.168.35.2
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>tcpdump: data link type LINUX_SLL2
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>19:00:17.590135 wg_s2s In  IP 192.168.36.215.31245 &gt; 192.168.35.2.2202: Flags [S], seq 3691553873, win 64240, options [mss 1372,nop,wscale 8,nop,nop,sackOK], length 0
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>19:00:17.590161 br-lan Out IP 192.168.36.215.31245 &gt; 192.168.35.2.2202: Flags [S], seq 3691553873, win 64240, options [mss 1330,nop,wscale 8,nop,nop,sackOK], length 0
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>19:00:17.590163 eth1  Out IP 192.168.36.215.31245 &gt; 192.168.35.2.2202: Flags [S], seq 3691553873, win 64240, options [mss 1330,nop,wscale 8,nop,nop,sackOK], length 0
</span></code></pre></div>
<h2 id="其它问题">其它问题<a class="headerlink" href="#其它问题" title="Permanent link">&para;</a></h2>
<h3 id="使用-dhcp-option-缓解-mtu-问题">使用 dhcp option 缓解 MTU 问题<a class="headerlink" href="#使用-dhcp-option-缓解-mtu-问题" title="Permanent link">&para;</a></h3>
<p>虽然 wg 能解决 MTU 问题，但是会带来不小的损耗。（wg 层和 vxlan 层都要分片），比较好的情况是避免 wg 层的分片，前提是 vxlan 层所有设备正确设置了 MTU。</p>
<p>不过有些设备不会请求 dhcp mtu 选项，因此该方案对其无效。不过对于支持的设备，确实能起到优化的效果。</p>
<h2 id="测速">测速<a class="headerlink" href="#测速" title="Permanent link">&para;</a></h2>
<h3 id="wg-组网性能测试">wg 组网性能测试<a class="headerlink" href="#wg-组网性能测试" title="Permanent link">&para;</a></h3>
<p>测试 jcg_q30p wg 组网性能</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>root@JCG_Q30P ➜  ~ iperf3 -c 192.168.35.1
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>[ ID] Interval           Transfer     Bitrate         Retr
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>[  5]   0.00-10.00  sec   499 MBytes   419 Mbits/sec    0             sender
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>[  5]   0.00-10.01  sec   497 MBytes   417 Mbits/sec                  receiver
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>root@JCG_Q30P ➜  ~ iperf3 -c 192.168.35.1 -R
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>[ ID] Interval           Transfer     Bitrate         Retr
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>[  5]   0.00-10.00  sec   525 MBytes   440 Mbits/sec  2069             sender
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>[  5]   0.00-10.00  sec   522 MBytes   437 Mbits/sec                  receiver
</span></code></pre></div>
<p>加上 NAT：仍然是 400。<code>iperf3 -B 192.168.1.1 -c op1.op1</code></p>
<p>和 wg-bench 测得结果相近</p>
<h3 id="无线下-l2-和-l3-性能">无线下 L2 和 L3 性能<a class="headerlink" href="#无线下-l2-和-l3-性能" title="Permanent link">&para;</a></h3>
<h4 id="信道影响">信道影响<a class="headerlink" href="#信道影响" title="Permanent link">&para;</a></h4>
<ul>
<li>信道是否受干扰是最影响结果的<ul>
<li>36 信道和其他冲突：平均 230（L2，下同）</li>
<li>149 信道稍微没冲突：平均290</li>
<li>162（AU）完全没冲突：平均 330，但是只有电脑能连，手机扫不出 wifi。</li>
<li>以上值是信号强度大概在 -60dBm，隔了一实验室一个薄的墙</li>
<li>最后发现设置成 CN + auto + 80MHz 即可。160 MHz 在有干扰+信号不强情况下基本上起不到作用。不设置 CN 的话，会 auto 到非法信道（比如 ，电脑可以</li>
</ul>
</li>
</ul>
<p><img alt="image_2024-09-11_17-24-09.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/image_2024-09-11_17-24-09.png" /></p>
<p>设置成 160Mhz 干扰太大
<img alt="image_2024-09-11_17-46-26.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/image_2024-09-11_17-46-26.png" /></p>
<p>纯无线性能（直接 iperf jcg_q30p）
- send：350
- receive：300 和 677 都测到过。</p>
<h4 id="-60dbm">-60dBm<a class="headerlink" href="#-60dbm" title="Permanent link">&para;</a></h4>
<p>L2：257/320（up/down）
L3：300/340</p>
<p>设置笔记本 WLAN mtu=1370
L2：270/300
L3：300/330</p>
<h4 id="-65dbm">-65dBm<a class="headerlink" href="#-65dbm" title="Permanent link">&para;</a></h4>
<p>隔了一堵厚墙，信号只有 -65 dBm 的情况下，kvm-win11 测试</p>
<p>L3</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$ iperf3.exe -B 192.168.1.135 -c 192.168.1.1
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>- - - - - - - - - - - - - - - - - - - - - - - - -
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>[ ID] Interval           Transfer     Bitrate
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>[  5]   0.00-10.01  sec  71.4 MBytes  59.8 Mbits/sec                  sender
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>[  5]   0.00-10.06  sec  71.2 MBytes  59.4 Mbits/sec                  receiver
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>$ iperf3.exe -B 192.168.1.135 -c 192.168.1.1 -R
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>- - - - - - - - - - - - - - - - - - - - - - - - -
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>[ ID] Interval           Transfer     Bitrate         Retr
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>[  5]   0.00-10.03  sec   200 MBytes   167 Mbits/sec    0             sender
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>[  5]   0.00-10.00  sec   197 MBytes   165 Mbits/sec                  receiver
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>$ iperf3.exe -B 192.168.1.135 -c 192.168.35.2
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>- - - - - - - - - - - - - - - - - - - - - - - - -
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>[ ID] Interval           Transfer     Bitrate
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>[  5]   0.00-10.01  sec  69.0 MBytes  57.8 Mbits/sec                  sender
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>[  5]   0.00-10.39  sec  67.2 MBytes  54.2 Mbits/sec                  receiver
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>$ iperf3.exe -B 192.168.1.135 -c 192.168.35.2 -R
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>- - - - - - - - - - - - - - - - - - - - - - - - -
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>[ ID] Interval           Transfer     Bitrate         Retr
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>[  5]   0.00-10.05  sec   202 MBytes   168 Mbits/sec    0             sender
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>[  5]   0.00-10.00  sec   198 MBytes   166 Mbits/sec                  receiver
</span></code></pre></div>
<p>L2</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>$ iperf3.exe -B 192.168.35.135 -c 192.168.35.2 -R
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>- - - - - - - - - - - - - - - - - - - - - - - - -
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>[ ID] Interval           Transfer     Bitrate         Retr
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>[  5]   0.00-10.05  sec   194 MBytes   162 Mbits/sec   10             sender
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>[  5]   0.00-10.00  sec   191 MBytes   160 Mbits/sec                  receiver
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>$ iperf3.exe -B 192.168.35.135 -c 192.168.35.2
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>- - - - - - - - - - - - - - - - - - - - - - - - -
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>[ ID] Interval           Transfer     Bitrate
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>[  5]   0.00-10.00  sec  71.2 MBytes  59.8 Mbits/sec                  sender
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>[  5]   0.00-10.08  sec  71.1 MBytes  59.2 Mbits/sec                  receiver
</span></code></pre></div>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../../../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2024/04/05/%E5%8F%B0%E5%BC%8F%E6%9C%BA%E5%8D%87%E7%BA%A7-%E7%A1%AC%E4%BB%B6%E7%AF%87/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 台式机升级-硬件篇">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                台式机升级-硬件篇
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../../../%E5%8D%9A%E5%AE%A2/2024/05/25/VR%20%E5%A4%9A%E4%BA%BA%E8%A7%82%E5%BD%B1%E6%96%B9%E6%A1%88%E6%8E%A2%E7%A9%B6/" class="md-footer__link md-footer__link--next" aria-label="下一页: VR 多人观影">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                VR 多人观影
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/TheRainstorm" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>