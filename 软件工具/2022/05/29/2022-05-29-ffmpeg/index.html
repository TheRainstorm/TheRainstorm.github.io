
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
      
      
      
        <link rel="canonical" href="https://yfy.cqu.ai/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/2022/05/29/2022-05-29-ffmpeg/">
      
      
        <link rel="prev" href="../../../../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2022/05/24/2022-05-24-%E4%BD%BF%E7%94%A8docker%E9%85%8D%E7%BD%AEhexo%E5%8D%9A%E5%AE%A2%E7%8E%AF%E5%A2%83/">
      
      
        <link rel="next" href="../../../../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2022/07/11/2022-07-11-%E5%8F%B0%E5%BC%8F%E6%9C%BA%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>ffmpeg - Rain 的随笔</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#记录一个困扰很久的问题" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../../.." title="Rain 的随笔" class="md-header__button md-logo" aria-label="Rain 的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rain 的随笔
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ffmpeg
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../../../../.." class="md-tabs__link">
        
  
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../about/" class="md-tabs__link">
        
  
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tags/" class="md-tabs__link">
        
  
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../series/" class="md-tabs__link">
        
  
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tools/" class="md-tabs__link">
        
  
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../archive/2024/" class="md-tabs__link">
          
  
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../category/%E4%B8%AA%E4%BA%BA/" class="md-tabs__link">
          
  
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Rain 的随笔" class="md-nav__button md-logo" aria-label="Rain 的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Rain 的随笔
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    标签
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    系列
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    分类
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E4%B8%AA%E4%BA%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    个人
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%8D%9A%E5%AE%A2--%E7%BD%91%E7%BB%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客 &amp; 网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    学习笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    折腾记录
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    课程笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    软件工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E9%98%85%E8%AF%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    阅读
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    回到主页
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    元数据
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2022-05-29 18:14:50+00:00" class="md-ellipsis">2022年5月29日</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            分类于
                            
                              <a href="../../../../../category/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/">软件工具</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              需要 38 分钟阅读时间
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#记录一个困扰很久的问题" class="md-nav__link">
    <span class="md-ellipsis">
      记录一个困扰很久的问题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#基础" class="md-nav__link">
    <span class="md-ellipsis">
      基础
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基础">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ffmpeg-流程" class="md-nav__link">
    <span class="md-ellipsis">
      ffmpeg 流程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter" class="md-nav__link">
    <span class="md-ellipsis">
      filter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simple-filter" class="md-nav__link">
    <span class="md-ellipsis">
      simple filter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complex-filter" class="md-nav__link">
    <span class="md-ellipsis">
      Complex filter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stream-selection" class="md-nav__link">
    <span class="md-ellipsis">
      stream selection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stream selection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#自动选择" class="md-nav__link">
    <span class="md-ellipsis">
      自动选择
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#map-选项" class="md-nav__link">
    <span class="md-ellipsis">
      map 选项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stream-handling" class="md-nav__link">
    <span class="md-ellipsis">
      stream handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#options" class="md-nav__link">
    <span class="md-ellipsis">
      Options
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stream-specifier" class="md-nav__link">
    <span class="md-ellipsis">
      stream specifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#main-options" class="md-nav__link">
    <span class="md-ellipsis">
      main options
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      quick start
    </span>
  </a>
  
    <nav class="md-nav" aria-label="quick start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#命令格式" class="md-nav__link">
    <span class="md-ellipsis">
      命令格式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#常用参数" class="md-nav__link">
    <span class="md-ellipsis">
      常用参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#查看支持的编码器" class="md-nav__link">
    <span class="md-ellipsis">
      查看支持的编码器
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#常用命令" class="md-nav__link">
    <span class="md-ellipsis">
      常用命令
    </span>
  </a>
  
    <nav class="md-nav" aria-label="常用命令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#心得-坑" class="md-nav__link">
    <span class="md-ellipsis">
      心得 (坑)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#查看文件元信息" class="md-nav__link">
    <span class="md-ellipsis">
      查看文件元信息
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#提取音频" class="md-nav__link">
    <span class="md-ellipsis">
      提取音频
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#截图" class="md-nav__link">
    <span class="md-ellipsis">
      截图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#串流优化" class="md-nav__link">
    <span class="md-ellipsis">
      串流优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="串流优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#faststart" class="md-nav__link">
    <span class="md-ellipsis">
      faststart
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyframe" class="md-nav__link">
    <span class="md-ellipsis">
      keyframe
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#参考资料" class="md-nav__link">
    <span class="md-ellipsis">
      参考资料
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#截取-seeking-位置" class="md-nav__link">
    <span class="md-ellipsis">
      截取 Seeking 位置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="截取 Seeking 位置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#查看关键帧方法" class="md-nav__link">
    <span class="md-ellipsis">
      查看关键帧方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input-seeking" class="md-nav__link">
    <span class="md-ellipsis">
      input seeking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="input seeking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#实验" class="md-nav__link">
    <span class="md-ellipsis">
      实验
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output-seeking" class="md-nav__link">
    <span class="md-ellipsis">
      output seeking
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#相关选项" class="md-nav__link">
    <span class="md-ellipsis">
      相关选项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#转码" class="md-nav__link">
    <span class="md-ellipsis">
      转码
    </span>
  </a>
  
    <nav class="md-nav" aria-label="转码">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#像素格式" class="md-nav__link">
    <span class="md-ellipsis">
      像素格式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crf-vs-固定码率等模式" class="md-nav__link">
    <span class="md-ellipsis">
      CRF vs 固定码率等模式
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#即使没有指定目标码率对于-crf-仍然是有帮助的" class="md-nav__link">
    <span class="md-ellipsis">
      即使没有指定目标码率，对于 CRF 仍然是有帮助的
    </span>
  </a>
  
    <nav class="md-nav" aria-label="即使没有指定目标码率，对于 CRF 仍然是有帮助的">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vp9" class="md-nav__link">
    <span class="md-ellipsis">
      vp9
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#h264" class="md-nav__link">
    <span class="md-ellipsis">
      h264
    </span>
  </a>
  
    <nav class="md-nav" aria-label="h264">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constrained-encoding-vbv--maximum-bit-rate" class="md-nav__link">
    <span class="md-ellipsis">
      Constrained encoding (VBV / maximum bit rate)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#h265" class="md-nav__link">
    <span class="md-ellipsis">
      h265
    </span>
  </a>
  
    <nav class="md-nav" aria-label="h265">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crf码率选择" class="md-nav__link">
    <span class="md-ellipsis">
      crf/码率选择
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#av1" class="md-nav__link">
    <span class="md-ellipsis">
      av1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#音频" class="md-nav__link">
    <span class="md-ellipsis">
      音频
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#调节帧数" class="md-nav__link">
    <span class="md-ellipsis">
      调节帧数
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#字幕" class="md-nav__link">
    <span class="md-ellipsis">
      字幕
    </span>
  </a>
  
    <nav class="md-nav" aria-label="字幕">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pgs-字幕图像字幕" class="md-nav__link">
    <span class="md-ellipsis">
      PGS 字幕（图像字幕）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PGS 字幕（图像字幕）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#想尝试使用-handbrake-压制" class="md-nav__link">
    <span class="md-ellipsis">
      想尝试使用 handbrake 压制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#文本字幕" class="md-nav__link">
    <span class="md-ellipsis">
      文本字幕
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extract" class="md-nav__link">
    <span class="md-ellipsis">
      extract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#burn-to-video" class="md-nav__link">
    <span class="md-ellipsis">
      burn to video
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filter_1" class="md-nav__link">
    <span class="md-ellipsis">
      Filter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#concat" class="md-nav__link">
    <span class="md-ellipsis">
      concat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stereo3d" class="md-nav__link">
    <span class="md-ellipsis">
      stereo3d
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scale" class="md-nav__link">
    <span class="md-ellipsis">
      scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pad" class="md-nav__link">
    <span class="md-ellipsis">
      pad
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpu-硬件加速" class="md-nav__link">
    <span class="md-ellipsis">
      GPU 硬件加速
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GPU 硬件加速">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vaapi-测试" class="md-nav__link">
    <span class="md-ellipsis">
      vaapi 测试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nvidia-nvenc" class="md-nav__link">
    <span class="md-ellipsis">
      nvidia NVENC
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#时间戳相关" class="md-nav__link">
    <span class="md-ellipsis">
      时间戳相关
    </span>
  </a>
  
    <nav class="md-nav" aria-label="时间戳相关">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#选项" class="md-nav__link">
    <span class="md-ellipsis">
      选项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ffmpeg-输出时间戳默认会置为-0" class="md-nav__link">
    <span class="md-ellipsis">
      ffmpeg 输出时间戳默认会置为 0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ffmpeg-合并视频和音频默认居然会有问题" class="md-nav__link">
    <span class="md-ellipsis">
      ffmpeg 合并视频和音频，默认居然会有问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delay-某个流" class="md-nav__link">
    <span class="md-ellipsis">
      delay 某个流
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#b-站问题" class="md-nav__link">
    <span class="md-ellipsis">
      B 站问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="B 站问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#为什么-seek-0638s结果导致-video-起始变成了-41s" class="md-nav__link">
    <span class="md-ellipsis">
      为什么 seek 0.638s，结果导致 video 起始变成了 4.1s
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#感觉问题在于为什么自己的视频-video-和-audio-duration-相差没那么大而-b-站转码后就相差-05s-了" class="md-nav__link">
    <span class="md-ellipsis">
      感觉问题在于为什么自己的视频 video 和 audio duration 相差没那么大，而 B 站转码后，就相差 0.5s 了
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#猜想问题原因" class="md-nav__link">
    <span class="md-ellipsis">
      猜想问题原因
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#其它" class="md-nav__link">
    <span class="md-ellipsis">
      其它
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其它">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#发现原始视频有两个-audio" class="md-nav__link">
    <span class="md-ellipsis">
      发现原始视频有两个 audio
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#youtube-没问题" class="md-nav__link">
    <span class="md-ellipsis">
      youtube 没问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设置输入和输出-pts" class="md-nav__link">
    <span class="md-ellipsis">
      设置输入和输出 pts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  


  <nav class="md-tags" >
    
      
      
      
        <a href="../../../../../tags/#tag:ffmpeg" class="md-tag">ffmpeg</a>
      
    
  </nav>



  <h1>ffmpeg</h1>

<p>ffmpeg</p>
<!-- more -->

<h2 id="记录一个困扰很久的问题">记录一个困扰很久的问题<a class="headerlink" href="#记录一个困扰很久的问题" title="Permanent link">&para;</a></h2>
<p>我的台式机使用 AMD 5800x，无论在 linux 下和 windows 下，使用 ffmpeg 用 CPU 编码视频时总是遇到“伪影” (artifacts) 问题。使用 ffmpeg 默认参数，用 libx264 编码一下视频就可以复现。然而同样的视频在其它机器上就无法复现。</p>
<p>artifacts 找到的最像相关帖子是：<a href="https://forum.videohelp.com/threads/411090-Artifacts-on-4k-video-encoded-with-ffmpeg-placebo-preset">Artifacts on 4k video encoded with ffmpeg placebo preset - VideoHelp Forum</a>。这里提到 artifact 是播放时出现，其实视频文件用软件解码是没有问题的。
但是我的视频文件导出 png，仍然有 artifact，也就是还是 encoder 的问题。</p>
<ul>
<li>
<p>尝试使用 docker 版的 ffmpeg，仍然还是有问题。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w"> </span><span class="nb">alias</span><span class="w"> </span><span class="nv">ffmpegd</span><span class="o">=</span><span class="s1">&#39;docker run -v $(pwd):$(pwd) -w $(pwd) --rm --name ffmpeg-run jrottenberg/ffmpeg &#39;</span>
</span></code></pre></div>
</li>
</ul>
<ul>
<li>windows 使用 handbrake，更奇怪了，出现了绿色条条。<ul>
<li>mpv 播放视频截图时，也会出现这种绿色竖条</li>
</ul>
</li>
<li>平时用 sunshine 串流也会出现网页图片完全糊成马赛克的情况</li>
</ul>
<p>这些都让我觉得，不会是 CPU 出问题了吧。</p>
<h2 id="基础">基础<a class="headerlink" href="#基础" title="Permanent link">&para;</a></h2>
<ul>
<li>ffmpeg 读取任意个 input（使用-i 指定），写到任意个输出（通过 plain output url 指定）</li>
<li>每个输出或者输出可以包含任意数量的不同类型的流 (stream)，streams 种类有<code>video/audio/subtitle/attachment/data</code></li>
<li>stream 的类型和数量受容器格式 (container format) 影响，从哪些 input 选取哪些流，输出到哪些 output 的过程（<strong>stream selection</strong>）既可以是自动的也可以通过<code>-map</code>指定。</li>
<li><strong>options 对下一个文件起作用</strong>，可以重复相同的选项</li>
<li>引用 input 或者 stream，可以使用从 0 开始的索引。比如第一个输入是<code>0</code>，<code>2:3</code> 表示第 3 个文件的第 4 个流</li>
<li><code>ffmpeg [全局选项] [输入选项] -i [输入文件] [输出选项] [输出文件]</code></li>
</ul>
<p>一些简单的例子</p>
<p>Convert an input media file to a different format, by re-encoding media streams:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>ffmpeg -i input.avi output.mp4
</span></code></pre></div>
<p>Set the video bitrate of the output file to 64 kbit/s:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>ffmpeg -i input.avi -b:v 64k -bufsize 64k output.mp4
</span></code></pre></div>
<p>Force the frame rate of the output file to 24 fps:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>ffmpeg -i input.avi -r 24 output.mp4
</span></code></pre></div>
<p>Force the frame rate of the input file (valid for raw formats only) to 1 fps and the frame rate of the output file to 24 fps:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>ffmpeg -r 1 -i input.m2v -r 24 output.mp4
</span></code></pre></div>
<h3 id="ffmpeg-流程">ffmpeg 流程<a class="headerlink" href="#ffmpeg-流程" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>decode -&gt; filter -&gt; encode</strong></li>
<li>
<p>使用 copy 选项时，可以跳过 decode。Encoded packets are then passed to the decoder (unless streamcopy is selected for the stream, see further for a description).</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a> _______              ______________
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>|       |            |              |
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>| input |  demuxer   | encoded data |   decoder
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>| file  | ---------&gt; | packets      | -----+
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>|_______|            |______________|      |
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>                                           v
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>                                       _________
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>                                      |         |
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>                                      | decoded |
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                                      | frames  |
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>                                      |_________|
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a> ________             ______________       |
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>|        |           |              |      |
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>| output | &lt;-------- | encoded data | &lt;----+
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>| file   |   muxer   | packets      |   encoder
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>|________|           |______________|
</span></code></pre></div>
</li>
</ul>
<h3 id="filter">filter<a class="headerlink" href="#filter" title="Permanent link">&para;</a></h3>
<h4 id="simple-filter">simple filter<a class="headerlink" href="#simple-filter" title="Permanent link">&para;</a></h4>
<ul>
<li>一个输入，一个输出，类型相同</li>
<li>对每个流使用-filter 选项。-vf, -af 是 video 和 audio 的别名</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>_________                        ______________
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>|         |                      |              |
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>| decoded |                      | encoded data |
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>| frames  |\                   _ | packets      |
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>|_________| \                  /||______________|
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>           \   __________   /
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>simple     _\||          | /  encoder
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>filtergraph   | filtered |/
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>              | frames   |
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>              |__________|
</span></code></pre></div>
<h4 id="complex-filter">Complex filter<a class="headerlink" href="#complex-filter" title="Permanent link">&para;</a></h4>
<p>Complex filter graphs are those which cannot be described as simply a linear processing chain applied to one stream.</p>
<ul>
<li>多个输入或输出</li>
<li>使用<code>-filter_complex</code></li>
<li>默认是全局的选项</li>
</ul>
<p>例子</p>
<p>overlay：将一个视频叠加到另一个视频上</p>
<p>Define a complex filtergraph, i.e. one with arbitrary number of inputs and/or outputs.  “Filtergraph syntax” section of the ffmpeg-filters manual.</p>
<p>Input link labels must refer to input streams using the <code>[file_index:stream_specifier]</code> syntax (i.e. the same as -map uses). If stream_specifier matches multiple streams, the first one will be used. An unlabeled input will be connected to the first unused input stream of the matching type.</p>
<p>Output link labels are referred to with -map. Unlabeled outputs are added to the first output file.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>ffmpeg -i video.mkv -i image.png -filter_complex &#39;[0:v][1:v]overlay[out]&#39; -map
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>        &#39;[out]&#39; out.mkv
</span></code></pre></div>
<h3 id="stream-selection">stream selection<a class="headerlink" href="#stream-selection" title="Permanent link">&para;</a></h3>
<h4 id="自动选择">自动选择<a class="headerlink" href="#自动选择" title="Permanent link">&para;</a></h4>
<ul>
<li>根据 output 文件的类型，决定是否包含 video/audio/subtitles 等各种类型的流</li>
<li>流选择的具体规则<ul>
<li>for video, it is the stream with the highest resolution,</li>
<li>for audio, it is the stream with the most channels,</li>
<li>for subtitles, it is the first subtitle stream found but there’s a caveat. The output format’s default subtitle encoder can be either text-based or image-based, and only a subtitle stream of the same type will be chosen.</li>
</ul>
</li>
</ul>
<h4 id="map-选项">map 选项<a class="headerlink" href="#map-选项" title="Permanent link">&para;</a></h4>
<p><code>-map [-]input_file_id[:stream_specifier][?][,sync_file_id[:stream_specifier]] | [linklabel] (*output*)</code></p>
<ul>
<li><code>stream_type[:additional_stream_specifier]</code><ul>
<li>’v’ or ’V’ for video, ’a’ for audio, ’s’ for subtitle, ’d’ for data, and ’t’ for attachments.</li>
<li>如果不指定编号，则表示所有</li>
</ul>
</li>
<li><code>m:key[:value]</code><ul>
<li>Matches streams with the metadata tag key having the specified value. If value is not given, matches streams that contain the given tag with any value.</li>
</ul>
</li>
</ul>
<p>Designate one or more input streams as a source for the output file. Each input stream is identified by the input file index input_file_id and the input stream index input_stream_id within the input file. Both indices start at 0. If specified, sync_file_id:stream_specifier sets which input stream is used as a presentation sync reference.</p>
<p>例子</p>
<p>For example, if you have two audio streams in the first input file, these streams are identified by "0:0" and "0:1". You can use <code>-map</code> to select which streams to place in an output file.</p>
<p>For example:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>ffmpeg -i INPUT -map 0:1 out.wav
</span></code></pre></div>
<p>will map the input stream in INPUT identified by "0:1" to the (single) output stream in out.wav.</p>
<p>For example, to select the stream with index 2 from input file a.mov (specified by the identifier "0:2"), and stream with index 6 from input b.mov (specified by the identifier "1:6"), and copy them to the output file out.mov:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>ffmpeg -i a.mov -i b.mov -c copy -map 0:2 -map 1:6 out.mov
</span></code></pre></div>
<p>To select all video and the third audio stream from an input file:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>ffmpeg -i INPUT -map 0:v -map 0:a:2 OUTPUT
</span></code></pre></div>
<p>To map all the streams except the second audio, use negative mappings</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>ffmpeg -i INPUT -map 0 -map -0:a:1 OUTPUT
</span></code></pre></div>
<p>To map the video and audio streams from the first input, and using the trailing <code>?</code>, ignore the audio mapping if no audio streams exist in the first input:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>ffmpeg -i INPUT -map 0:v -map 0:a? OUTPUT
</span></code></pre></div>
<p>To pick the English audio stream:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>ffmpeg -i INPUT -map 0:m:language:eng OUTPUT
</span></code></pre></div>
<p>Note that using this option disables the default mappings for this output file.</p>
<h3 id="stream-handling">stream handling<a class="headerlink" href="#stream-handling" title="Permanent link">&para;</a></h3>
<p>Stream handling is independent of stream selection, with an exception for subtitles described below. Stream handling is set via the <code>-codec</code> option addressed to streams within a specific <em>output</em> file. In particular, codec options are applied by ffmpeg after the stream selection process and thus do not influence the latter. If no <code>-codec</code> option is specified for a stream type, ffmpeg will select the default encoder registered by the output file muxer.</p>
<ul>
<li>在 stream selection 之后进行</li>
<li>使用-codec 指定对 output 中流的处理方式</li>
<li>如果没有指定-codec，则按照 output 文件格式选择默认的 encoder</li>
</ul>
<h3 id="options">Options<a class="headerlink" href="#options" title="Permanent link">&para;</a></h3>
<p><em>注意：ffmpeg 很多选项，其关于 input/output 的位置的不同，会产生完全不同的效果</em></p>
<h4 id="stream-specifier">stream specifier<a class="headerlink" href="#stream-specifier" title="Permanent link">&para;</a></h4>
<p>对于一些针对某个流的选项（如-codec, -bitrate），使用 stream specifier 来指定针对哪个流。Some options are applied per-stream, e.g. bitrate or codec. Stream specifiers are used to precisely specify which stream(s) a given option belongs to.
如：</p>
<ul>
<li>-codec: a:1 ac3，指定第<strong>2</strong>个<strong>audio</strong>流的编码</li>
<li>-codec:v copy 指定复制 video 流（-codec or -codec:指定复制所有流）</li>
</ul>
<h4 id="main-options">main options<a class="headerlink" href="#main-options" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p><code>-c[:stream_specifier] codec (input/output,per-stream)</code>
  <strong>Select an encoder (when used before an output file) or a decoder (when used before an input file)</strong>  for one or more streams. codec is the name of a decoder/encoder or a special value copy (output only) to indicate that the stream is not to be re-encoded.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>ffmpeg -i INPUT -map 0 -c:v libx264 -c:a copy OUTPUT
</span></code></pre></div>
<p>encodes all video streams with libx264 and copies all audio streams.</p>
<p>作用顺序为后者优先</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>ffmpeg -i INPUT -map 0 -c copy -c:v:1 libx264 -c:a:137 libvorbis OUTPUT
</span></code></pre></div>
<p>will copy all the streams except the second video, which will be encoded with libx264, and the 138th audio, which will be encoded with libvorbis.</p>
</li>
</ul>
<ul>
<li><code>-t duration (*input/output*)</code>
  When used as an input option (before <code>-i</code>), limit the duration of data read from the input file.
  When used as an output option (before an output url), stop writing the output after its duration reaches duration.</li>
</ul>
<ul>
<li><code>-ss position (*input/output*)</code>
    When used as an input option (before <code>-i</code>), seeks in this input file to position.<ul>
<li>Note that in most formats it is not possible to seek exactly, so <code>ffmpeg</code> will seek to the closest seek point before position. When transcoding and -accurate_seek is enabled (the default), this extra segment between the seek point and position will be decoded and discarded</li>
<li>When doing stream copy or when -noaccurate_seek is used, it will be preserved.
  When used as an output option (before an output url), decodes but discards input until the timestamps reach position.</li>
</ul>
</li>
</ul>
<ul>
<li><code>-to position (*input/output*)</code>
  Stop writing the output or reading the input at position.</li>
</ul>
<ul>
<li>
<p><code>-filter[:stream_specifier] filtergraph (*output,per-stream*)</code>
  Create the filtergraph specified by filtergraph and use it to filter the stream.</p>
<p>filtergraph is a description of the filtergraph to apply to the stream, and must have a single input and a single output of the same type of the stream. In the filtergraph, the input is associated to the label <code>in</code>, and the output to the label <code>out</code>. See the ffmpeg-filters manual for more information about the filtergraph syntax.</p>
</li>
</ul>
<ul>
<li>Video 相关<ul>
<li><code>-vn (input/output)</code>
  As an input option, <strong>blocks all video streams of a file from being filtered or being automatically selected or mapped for any output.</strong> See <code>-discard</code> option to disable streams individually.
  As an output option, disables video recording i.e. automatic selection or mapping of any video stream. For full manual control see the <code>-map</code> option.</li>
<li><code>-vcodec codec (output)</code></li>
<li><code>-vf filtergraph (output)</code>
  Create the filtergraph specified by filtergraph and use it to filter the stream.</li>
</ul>
</li>
</ul>
<h2 id="quick-start">quick start<a class="headerlink" href="#quick-start" title="Permanent link">&para;</a></h2>
<p>参考：<a href="https://www.ruanyifeng.com/blog/2020/01/ffmpeg.html">FFmpeg 视频处理入门教程 - 阮一峰的网络日志 (ruanyifeng.com)</a></p>
<h3 id="命令格式">命令格式<a class="headerlink" href="#命令格式" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>$ ffmpeg \
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>[全局参数] \
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>[输入文件参数] \
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>-i [输入文件] \
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>[输出文件参数] \
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>[输出文件]
</span></code></pre></div>
<p>如下面的命令将 mp4 文件转成 webm 文件，这两个都是容器格式。输入的 mp4 文件的音频编码格式是 aac，视频编码格式是 H.264；输出的 webm 文件的视频编码格式是 VP9，音频格式是 Vorbis。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>$ ffmpeg \
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>-y \ # 全局参数
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>-c:a libfdk_aac -c:v libx264 \ # 输入文件参数
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>-i input.mp4 \ # 输入文件
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>-c:v libvpx-vp9 -c:a libvorbis \ # 输出文件参数
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>output.webm # 输出文件
</span></code></pre></div>
<h3 id="常用参数">常用参数<a class="headerlink" href="#常用参数" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>-c：指定编码器
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>-c copy：直接复制，不经过重新编码（这样比较快）
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>-c:v：指定视频编码器
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>-c:a：指定音频编码器
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>-i：指定输入文件
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>-an：去除音频流
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>-vn： 去除视频流
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>-preset：指定输出的视频质量，会影响文件的生成速度，有以下几个可用的值 ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow。
</span></code></pre></div>
<h3 id="查看支持的编码器">查看支持的编码器<a class="headerlink" href="#查看支持的编码器" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>~ ffmpeg.exe -encoders |grep av1
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a> V..... libaom-av1           libaom AV1 (codec av1)
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a> V....D librav1e             librav1e AV1 (codec av1)
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a> V..... libsvtav1            SVT-AV1(Scalable Video Technology for AV1) encoder (codec av1)
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>~ ffmpeg.exe -encoders |grep HEVC
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a> V..... libx265              libx265 H.265 / HEVC (codec hevc)
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a> V....D hevc_amf             AMD AMF HEVC encoder (codec hevc)
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a> V....D hevc_mf              HEVC via MediaFoundation (codec hevc)
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>~ ffmpeg.exe -encoders |grep h264
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>V..... libx264              libx264 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (codec h264)
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a> V..... libx264rgb           libx264 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 RGB (codec h264)
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a> V..... libopenh264          OpenH264 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (codec h264)
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a> V....D h264_amf             AMD AMF H.264 Encoder (codec h264)
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a> V....D h264_mf              H264 via MediaFoundation (codec h264)
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a> V....D h264_nvenc           NVIDIA NVENC H.264 encoder (codec h264)
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a> V..... h264_qsv             H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (Intel Quick Sync Video acceleration) (codec h264)
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a> V..... nvenc                NVIDIA NVENC H.264 encoder (codec h264)
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a> V..... nvenc_h264           NVIDIA NVENC H.264 encoder (codec h264)
</span></code></pre></div>
<h2 id="常用命令">常用命令<a class="headerlink" href="#常用命令" title="Permanent link">&para;</a></h2>
<h3 id="心得-坑">心得 (坑)<a class="headerlink" href="#心得-坑" title="Permanent link">&para;</a></h3>
<ul>
<li>截取一段视频时，<strong>-ss 的位置不同有不同的效果，详见 seeking 章节</strong>。比如会导致你 seek 的速度非常慢（需要解码）。</li>
<li>流复制不用转码是很好，但是会导致各种问题。比如 seek 不精确、seek 后视频和音频长度相差几百 ms。<strong>因此剪辑视频最稳妥起见还是重新转码一下</strong></li>
<li>转码时 crf 一定要选好，默认的码率是很低的
h265 4K<ul>
<li>crf 26: 11mbps（B 站转成 h264 就剩 10mb 了，但实际最高可达 18mb）</li>
<li>crf 20: 22281kb</li>
<li>crf 16: 34894kb</li>
</ul>
</li>
</ul>
<p>h265 crf20 对 4K 60fps 的视频，可能造成过高码率，导致有些客户端播放卡顿。最好先测试不同 crf，看看播放效果。码率最好不要超过 25Mbps，平均控制在 10Mbps 左右。</p>
<p>h264 并不支持 crf 模式下设置最大峰值码率<a href="https://superuser.com/questions/559386/using-crf-and-setting-a-maximum-bitrate-with-x264-in-ffmpeg">video encoding - Using CRF and setting a maximum bitrate with x264 in FFmpeg - Super User</a></p>
<ul>
<li>要么使用 two pass mode</li>
<li>要么换 av1 等更高级的编码</li>
</ul>
<h3 id="查看文件元信息">查看文件元信息<a class="headerlink" href="#查看文件元信息" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>ffmpeg -i input.mp4 -hide_banner
</span></code></pre></div>
<h3 id="提取音频">提取音频<a class="headerlink" href="#提取音频" title="Permanent link">&para;</a></h3>
<p>输出文件可以选择不同容器格式，根据音频编码选择。（如 m4a, mp3，也可以直接用 mkv 存储）</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>ffmpeg -i input.mp4 -vn -c:a copy output.aac
</span></code></pre></div>
<h3 id="截图">截图<a class="headerlink" href="#截图" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>ffmpeg -i input.mp4 -ss 00:01:24 -t 00:00:01 output_%3d.png
</span></code></pre></div>
<p><strong>JPG 和 PNG</strong></p>
<p>jpg 是有损压缩，png 是无损压缩。
生成 jpg 时可以指定编码质量。<code>-q:v 2</code>表示输出的 jpg 图片质量，一般是 1 到 5 之间（1 为质量最高）。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>ffmpeg -ss 01:23:45 -i input -vframes 1 -q:v 2 output.jpg
</span></code></pre></div>
<p><strong>帧率控制</strong> (<code>-r</code>)</p>
<p>表示每秒提取一帧图片</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>ffmpeg -i input.mp4 -r 1 output_%03d.png
</span></code></pre></div>
<p><strong>帧数限制</strong> (<code>-frames:v</code>)</p>
<p><code>-vframes 1</code>指定只截取一帧</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>ffmpeg -ss 01:23:45 -i input -vframes 1 -q:v 2 output.jpg
</span></code></pre></div>
<p><strong>选择帧</strong> (<code>-vf select</code>)</p>
<p>每 10 帧提取一张图片</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>ffmpeg -i input.mp4 -vf &quot;select=not(mod(n\,10))&quot; -vsync vfr output_%03d.png
</span></code></pre></div>
<p><strong>过滤器后处理</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>ffmpeg -i input.mp4 -vf &quot;crop=640:360:0:0&quot; output_%03d.png  # 裁剪图片，640x360 从左上角截取（不指定时居中截取）
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>ffmpeg -i input.mp4 -vf &quot;scale=640:360&quot; output_%03d.png   # 将输出图片调整为 640x360 分辨率
</span></code></pre></div>
<h3 id="串流优化">串流优化<a class="headerlink" href="#串流优化" title="Permanent link">&para;</a></h3>
<p><a href="https://juejin.cn/post/6844903656798568461">[译] 优化 MP4 视频以获得更快的流传输速度 - 掘金 (juejin.cn)</a></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>-movflags faststart -g 50 -sc_threshold 0
</span></code></pre></div>
<h4 id="faststart">faststart<a class="headerlink" href="#faststart" title="Permanent link">&para;</a></h4>
<ul>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fhandbrake.fr%2F" title="https://handbrake.fr/">Handbrake</a> 的 <em>“Web Optimized”</em> 选项</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>-movflags faststart
</span></code></pre></div>
<h4 id="keyframe">keyframe<a class="headerlink" href="#keyframe" title="Permanent link">&para;</a></h4>
<p><a href="https://stackoverflow.com/questions/18085458/checking-keyframe-interval">ffmpeg - Checking keyframe interval? - Stack Overflow</a></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>ffprobe -loglevel error -select_streams v:0 -show_entries packet=pts_time,flags -of csv=print_section=0 input.mp4 | awk -F&#39;,&#39; &#39;/K/ {print $1}&#39;
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>0.000000
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>2.933333
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>11.266667
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>14.233333
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>22.400000
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>30.733333
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>37.133333
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>43.266667
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>45.633333
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>53.966667
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>62.300000
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>ffmpeg -i YOUR_INPUT -c:v h264 -keyint_min 25 -g 50 -sc_threshold 0 OUTPUT.mp4
</span></code></pre></div>
<ul>
<li><code>-keyint_min</code>: specifies the minimum interval to set a keyrame.</li>
<li><code>-g 50</code>: this option stands for "Group of Pictures" and will instruct FFMPEG to sets the maximum keyframe interval every 50 frames, or 2 seconds, assuming that your input runs at 25 FPS.</li>
<li><code>-sc_threshold 0</code>: This "SC" stands for Scene Change. FFmpeg defaults to a keyframe interval of 250 frames and inserts keyframes at scene changes, meaning when a picture's content change. This option will make sure not to add any new keyframe at scene changes.</li>
</ul>
<blockquote>
<p>The reason why a short keyframe interval is very important is because we need to provide the end user with a fast experience during playback or seeking (fast forward or rewind) a video, especially for the Adaptive Bitrate case scenario, where the end user automatically receives the highest or the lowest quality, based on his own available bandwidth. Also, a player can not start playback on a pframe or b-frame.</p>
</blockquote>
<h2 id="参考资料">参考资料<a class="headerlink" href="#参考资料" title="Permanent link">&para;</a></h2>
<p><a href="https://ffmpeg.org/ffmpeg-formats.html">FFmpeg Formats Documentation</a>
-fflags flags 是另外的选项</p>
<ul>
<li>‘genpts’：Generate missing PTS if DTS is present.</li>
</ul>
<p><a href="https://stackoverflow.com/questions/51085133/does-pts-have-to-start-at-0">video - Does PTS have to start at 0? - Stack Overflow</a></p>
<ul>
<li>想让 start_pts 包含实际时间信息</li>
</ul>
<p><a href="https://stackoverflow.com/questions/53388471/ffmpeg-setpts-apply-uniform-offset-without-re-encoding">video - ffmpeg setpts apply uniform offset without re-encoding - Stack Overflow</a></p>
<ul>
<li>两个流，知道结尾，因此可以同步</li>
<li>使用 setpts filter 可以做到，但是想要避免转码</li>
</ul>
<h2 id="截取-seeking-位置">截取 Seeking 位置<a class="headerlink" href="#截取-seeking-位置" title="Permanent link">&para;</a></h2>
<p><strong>一定要读</strong>：<a href="https://trac.ffmpeg.org/wiki/Seeking">Seeking – FFmpeg</a></p>
<p><strong>关键帧（Keyframes）</strong>：在视频编码中，关键帧是视频序列中的特殊帧，<strong>它们是独立的、不依赖于其他帧的帧</strong>。关键帧包含完整的图像信息，而其他帧（如 P 帧和 B 帧）则利用关键帧和/或其他帧的信息进行压缩。
关键帧是视频中的重要参考点，它们通常出现在视频场景变化或运动发生的地方。由于关键帧是独立的，视频播放器或解码器可以在任何关键帧处开始解码，而不需要依赖之前的帧。这有助于快速定位和随机访问视频。</p>
<p><strong>PTS（Presentation Timestamp）</strong>：
PTS 是一个时间戳，表示视频或音频帧在播放时应该呈现的时间。PTS 用于确定帧何时应该在播放时间轴上显示或播放。</p>
<p><strong>GOP（Group of Pictures）</strong>：GOP 是视频序列中的一组帧，它包含一个关键帧（I 帧）和一些后续帧，包括预测帧（P 帧）和双向预测帧（B 帧）。GOP 的结构有助于视频压缩和解码。
典型的 GOP 结构可能是"IBBPBBPBBPBB"，其中"I"是关键帧，"B"是双向预测帧，"P"是预测帧。关键帧始终是 GOP 的第一个帧。</p>
<p><strong>关键帧和 GOP 的关系</strong>：
关键帧是 GOP 的起点，它定义了一个新的编码组，其后跟随一系列依赖于它的预测帧和双向预测帧。整个 GOP 的结构有助于在视频编码中实现高压缩比，因为预测帧和双向预测帧可以利用关键帧的信息进行差异编码，而不必携带完整的图像信息。
在视频流中，关键帧的选择和 GOP 的设置对于视频的质量、压缩效率和快速定位能力都具有重要影响。不同的应用和使用场景可能需要不同的关键帧间隔和 GOP 结构来平衡压缩效率和解码性能。</p>
<h3 id="查看关键帧方法">查看关键帧方法<a class="headerlink" href="#查看关键帧方法" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>ffprobe -select_streams v -show_frames -show_entries frame=pict_type,pkt_pts_time bbb_sunflower_1080p_30fps_normal.mp4 &gt; log
</span></code></pre></div>
<h3 id="input-seeking">input seeking<a class="headerlink" href="#input-seeking" title="Permanent link">&para;</a></h3>
<p>-ss  position (<em>input/output</em>)</p>
<p>When used as an input option (before <code>-i</code>), seeks in this input file to position. Note that in most formats it is not possible to seek exactly, so <code>ffmpeg</code> will seek to the closest seek point <strong>before</strong> position.</p>
<ul>
<li>简单理解为 seek 到 I 帧。</li>
<li>转码时：When transcoding and -accurate_seek is enabled (the default), this extra segment between the seek point and position will be decoded and discarded</li>
<li>copy 时：When doing stream copy or when -noaccurate_seek is used, it will be preserved.<ul>
<li>由于不能编解码，所以实际 seek 位置必须对应 I 帧，因此 seek 位置实际在 pos 最前的一个 I 帧，然后将 ts 置为 0？</li>
</ul>
</li>
</ul>
<h4 id="实验">实验<a class="headerlink" href="#实验" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>ffmpeg -i bbb_sunflower_1080p_30fps_normal.mkv -t 10 ref/ref_%04d.png
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>f421d45d1b8b491dc36a564c01246ef8  i_ss_2-noacc.png
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>468a10a80c838526709d4d35abe7af3a  i_ss_2.png
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>(base) fyyuan@icarus4 ➜  test cat ref/log2|grep f421d45d1b8b491dc36a564c01246ef8
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>f421d45d1b8b491dc36a564c01246ef8  ref_0061.png
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>(base) fyyuan@icarus4 ➜  test cat ref/log2|grep 468a10a80c838526709d4d35abe7af3a
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>468a10a80c838526709d4d35abe7af3a  ref_0059.png
</span></code></pre></div>
<h3 id="output-seeking">output seeking<a class="headerlink" href="#output-seeking" title="Permanent link">&para;</a></h3>
<p>When used as an output option (before an output url), decodes but discards input until the timestamps reach position.</p>
<ul>
<li>由于 input 已经被解码了，因此每帧的 timestamp 可以获得，seek 到指定位置前的 frame。</li>
<li>Here, the input will be decoded (and discarded) until it reaches the position given by <code>-ss</code>. This will be done <strong>very slowly</strong>, frame by frame.</li>
<li>As of FFmpeg 2.1, the main advantage is that when applying filters to the output stream, the <strong>timestamps aren't reset prior to filtering</strong> (i.e. when <a href="https://trac.ffmpeg.org/wiki/HowToBurnSubtitlesIntoVideo">​burning subtitles into a video</a>, you don't need to modify the subtitle timestamps),</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>ffprobe -select_streams v -show_frames -show_entries frame=pict_type,pkt_pts_time src.mkv
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>[FRAME]
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>pkt_pts_time=0.613000
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>pict_type=I
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>[/FRAME]
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>[FRAME]
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>pkt_pts_time=0.630000
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>pict_type=B
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>[/FRAME]
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>...
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>[FRAME]
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>pkt_pts_time=1.130000
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>pict_type=B
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>[/FRAME]
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>[FRAME]
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>pkt_pts_time=1.147000
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>pict_type=I
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>[/FRAME]
</span></code></pre></div>
<h3 id="相关选项">相关选项<a class="headerlink" href="#相关选项" title="Permanent link">&para;</a></h3>
<p>-copyts</p>
<p>Do not process input timestamps, but keep their values without trying to sanitize them. In particular, do not remove the initial start time offset value.
Note that, depending on the vsync option or on specific muxer processing (e.g. in case the format option avoid_negative_ts is enabled) the output timestamps may mismatch with the input timestamps even when this option is selected.</p>
<p>-start_at_zero</p>
<p>When used with copyts, shift input timestamps so they start at zero.
This means that using e.g. <code>-ss 50</code> will make output timestamps start at 50 seconds, regardless of what timestamp the input file started at.</p>
<p>-avoid_negative_ts integer (<em>output</em>)</p>
<p>Possible values:
‘make_non_negative’
Shift timestamps to make them non-negative. Also note that this affects only leading negative timestamps, and not non-monotonic negative timestamps.</p>
<p>‘make_zero’
Shift timestamps so that the first timestamp is 0.</p>
<p>‘auto (default)’
Enables shifting when required by the target format.</p>
<p>‘disabled’
Disables shifting of timestamp.</p>
<p>When shifting is enabled, all output timestamps are shifted by the same amount. Audio, video, and subtitles desynching and relative timestamp differences are preserved compared to how they would have been without shifting.</p>
<h2 id="转码">转码<a class="headerlink" href="#转码" title="Permanent link">&para;</a></h2>
<h3 id="像素格式">像素格式<a class="headerlink" href="#像素格式" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>Encoder h264_nvenc [NVIDIA NVENC H.264 encoder]:
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>    General capabilities: dr1 delay hardware
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>    Threading capabilities: none
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    Supported hardware devices: cuda cuda
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    Supported pixel formats: yuv420p nv12 p010le yuv444p p016le yuv444p16le bgr0 rgb0 cuda
</span></code></pre></div>
<h3 id="crf-vs-固定码率等模式">CRF vs 固定码率等模式<a class="headerlink" href="#crf-vs-固定码率等模式" title="Permanent link">&para;</a></h3>
<p>A change of ±6 should result in about half/double the file size
You should use CRF encoding primarly for offline file storage, in order to achieve the most optimal encodes</p>
<p>For x264, sane values are between 18 and 28. The default is 23
For x265, the default CRF is 28</p>
<ul>
<li><strong>Constant Quality</strong>: ensure that every frame gets the number of bits it deserves to achieve a certain (perceptual) quality level<ul>
<li>h264, h265: <code>-crf</code></li>
</ul>
</li>
<li><strong>Average Bitrate (ABR</strong>): Target Bitrate mode, try to reach the specified bit rate on average<ul>
<li><code>-b:v 2M</code></li>
</ul>
</li>
<li>Two pass<ul>
<li>用于达到目标码率</li>
<li>
<h2 id="即使没有指定目标码率对于-crf-仍然是有帮助的">即使没有指定目标码率，对于 CRF 仍然是有帮助的<a class="headerlink" href="#即使没有指定目标码率对于-crf-仍然是有帮助的" title="Permanent link">&para;</a></h2>
</li>
</ul>
</li>
</ul>
<p>CRF
VBR
CBR</p>
<h3 id="vp9">vp9<a class="headerlink" href="#vp9" title="Permanent link">&para;</a></h3>
<p>vbr</p>
<ul>
<li>1-pass average bitrate</li>
<li>2-pass average bitrate<ul>
<li>Two-pass is the recommended encoding method for libvpx-vp9 as some quality-enhancing encoder features are only available in 2-pass mode.</li>
</ul>
</li>
<li>Constant quality (Constant quantizer)</li>
<li>2-pass constant quality</li>
<li>Constant bitrate</li>
</ul>
<p>2-pass 模式</p>
<p>Constant quality 2-pass is invoked by setting <code>-b:v</code> to zero and specifiying a quality level using the <code>-crf</code> switch:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>input=
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>output=
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>crf=30
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>ffmpeg -i &quot;$(input)&quot; -c:v libvpx-vp9 -b:v 0 -crf $crf -pass 1 -an -f null /dev/null &amp;&amp; \
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>ffmpeg -i &quot;$(input)&quot; -c:v libvpx-vp9 -b:v 0 -crf $crf -pass 2 -c:a copy $output
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>ffmpeg -i input.mp4 -c:v libvpx-vp9 -crf 30 -b:v 0 output.webm
</span></code></pre></div>
<p>非常慢，体验很差</p>
<h3 id="h264">h264<a class="headerlink" href="#h264" title="Permanent link">&para;</a></h3>
<p><a href="https://trac.ffmpeg.org/wiki/Encode/H.264">Encode/H.264 – FFmpeg</a></p>
<p>两种模式</p>
<ul>
<li>CRF：不关心文件大小<ul>
<li>17–28</li>
<li>默认 23</li>
<li>相差6 码率差一倍</li>
</ul>
</li>
<li>2pass: 对文件大小有要求的场景，比如 streaming</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>ffmpeg -i input -c:v libx264 -preset medium -crf 23 -c:a copy output.mkv
</span></code></pre></div>
<p>preset</p>
<ul>
<li><code>ultrafast</code></li>
<li><code>superfast</code></li>
<li><code>veryfast</code></li>
<li><code>faster</code></li>
<li><code>fast</code></li>
<li><code>medium</code> – default preset</li>
<li><code>slow</code></li>
<li><code>slower</code></li>
<li><code>veryslow</code></li>
<li><code>placebo</code> – ignore this as it is not useful (see <a href="https://trac.ffmpeg.org/wiki/Encode/H.264#FAQ">FAQ</a>)</li>
</ul>
<p>tune</p>
<ul>
<li><code>film</code> – use for high quality movie content; lowers deblocking</li>
<li><code>animation</code> – good for cartoons; uses higher deblocking and more reference frames</li>
<li><code>grain</code> – preserves the grain structure in old, grainy film material</li>
<li><code>stillimage</code> – good for slideshow-like content</li>
<li><code>fastdecode</code> – allows faster decoding by disabling certain filters</li>
<li><code>zerolatency</code> – good for fast encoding and low-latency streaming</li>
<li><code>psnr</code> – ignore this as it is only used for codec development</li>
<li><code>ssim</code> – ignore this as it is only used for codec development</li>
</ul>
<p>profile：非常老的设备支持 main 以下。通常支持 main 和 high</p>
<ul>
<li><code>baseline</code></li>
<li><code>main</code></li>
<li><code>high</code></li>
<li><code>high10</code> (first 10 bit compatible profile)</li>
<li><code>high422</code> (supports yuv420p, yuv422p, yuv420p10le and yuv422p10le)</li>
<li><code>high444</code> (supports as above as well as yuv444p and yuv444p10le)</li>
</ul>
<h4 id="constrained-encoding-vbv--maximum-bit-rate">Constrained encoding (VBV / maximum bit rate)<a class="headerlink" href="#constrained-encoding-vbv--maximum-bit-rate" title="Permanent link">&para;</a></h4>
<p>You can use <code>-crf</code> or <code>-b:v</code> with a maximum bit rate by specifying both <code>-maxrate</code> and <code>-bufsize</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>ffmpeg -i input -c:v libx264 -crf 23 -maxrate 1M -bufsize 2M output.mp4
</span></code></pre></div>
<p><code>-bufsize</code> is the "rate control buffer", so it will enforce your requested "average" (1 MBit/s in this case) across each 2 MBit worth of video.</p>
<p>This will effectively "target" <code>-crf 23</code>, but if the output were to exceed 1 MBit/s, the encoder would increase the CRF to prevent bitrate spikes. However, be aware that <code>libx264</code> does <strong>not strictly control the maximum bit rate</strong> as you specified (the maximum bit rate may be well over 1M for the above file). To reach a perfect maximum bit rate, use two-pass.</p>
<h3 id="h265">h265<a class="headerlink" href="#h265" title="Permanent link">&para;</a></h3>
<p><a href="https://trac.ffmpeg.org/wiki/Encode/H.265">Encode/H.265 – FFmpeg</a></p>
<ul>
<li>Choose a CRF. CRF affects the quality. The default is 28, and it should visually correspond to libx264 video at CRF 23, but result in about half the file size. CRF works just like in x264, so choose the highest value that provides an acceptable quality.</li>
</ul>
<ul>
<li>Choose a preset. The default is <code>medium</code>. The preset determines compression efficiency and therefore affects encoding speed. Valid presets are <code>ultrafast</code>, <code>superfast</code>, <code>veryfast</code>, <code>faster</code>, <code>fast</code>, <code>medium</code>, <code>slow</code>, <code>slower</code>, <code>veryslow</code>, and <code>placebo</code>. Use the slowest preset you have patience for. Ignore <code>placebo</code> as it provides insignificant returns for a significant increase in encoding time.</li>
</ul>
<ul>
<li>Choose a tune (optional). By default, this is disabled, and it is generally not required to set a tune option. x265 supports the following <code>-tune</code> options: <code>psnr</code>, <code>ssim</code>, <code>grain</code>, <code>zerolatency</code>, <code>fastdecode</code>. They are explained in the <a href="https://trac.ffmpeg.org/wiki/Encode/H.264#crf">H.264 guide</a>.</li>
</ul>
<h4 id="crf码率选择">crf/码率选择<a class="headerlink" href="#crf码率选择" title="Permanent link">&para;</a></h4>
<ul>
<li>转码 4K 时 crf 一定要选好，默认的码率是很低的
h265<ul>
<li>crf 26: 11mbps（B 站转成 h264 就剩 10mb 了，但实际最高可达 18mb）</li>
<li>crf 20: 22281kb</li>
<li>crf 16: 34894kb</li>
</ul>
</li>
</ul>
<p>实测：</p>
<p>直接转码，仍使用了原本的 59.94fps</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>ffmpeg -i INPUT -c:v libx265 -crf 26 -preset slow -c:a aac -b:a 320k OUTPUT
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>frame=31195 fps= 12 q=35.8 Lsize=  709168kB time=00:08:41.00 bitrate=11150.6kbits/s speed=0.195x
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>video:688379kB audio:20388kB subtitle:0kB other streams:0kB global headers:2kB muxing overhead: 0.056575%
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>x265 [info]: frame I:    132, Avg QP:27.54  kb/s: 60301.51
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>x265 [info]: frame P:   7805, Avg QP:29.13  kb/s: 28855.09
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>x265 [info]: frame B:  23258, Avg QP:34.69  kb/s: 4505.13
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>x265 [info]: Weighted P-Frames: Y:1.7% UV:1.4%
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>x265 [info]: consecutive B-frames: 1.0% 2.5% 2.3% 91.0% 3.3%
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>encoded 31195 frames in 2677.46s (11.65 fps), 10833.60 kb/s, Avg QP:33.27
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>[aac @ 0x55d67964f4c0] Qavg: 174.559
</span></code></pre></div>
<p>设置帧率 60fps</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>ffmpeg -i INPUT -c:v libx265 -crf 26 -preset slow -r 60 -c:a aac -b:a 320k OUTPUT
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>frame=31195 fps=8.3 q=36.0 Lsize=  708843kB time=00:08:41.00 bitrate=11145.6kbits/s speed=0.139x
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>video:688054kB audio:20388kB subtitle:0kB other streams:0kB global headers:2kB muxing overhead: 0.056600%
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>x265 [info]: frame I:    132, Avg QP:27.54  kb/s: 60361.57
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>x265 [info]: frame P:   7805, Avg QP:29.14  kb/s: 28870.71
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>x265 [info]: frame B:  23258, Avg QP:34.70  kb/s: 4507.21
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>x265 [info]: Weighted P-Frames: Y:1.7% UV:1.4%
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>x265 [info]: consecutive B-frames: 1.0% 2.5% 2.3% 91.0% 3.3%
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>encoded 31195 frames in 3751.69s (8.31 fps), 10839.31 kb/s, Avg QP:33.27
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>[aac @ 0x56079a852080] Qavg: 174.559
</span></code></pre></div>
<p>6.x GB 2 小时 h264 电影，转码成 h265 后，1.6GB</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>video:1601155kB audio:98562kB subtitle:0kB other streams:0kB global headers:6kB muxing overhead: 0.310183%
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>x265 [info]: frame I:   1140, Avg QP:23.90  kb/s: 9640.57
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>x265 [info]: frame P:  85553, Avg QP:26.19  kb/s: 3183.49
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>x265 [info]: frame B: 180658, Avg QP:32.30  kb/s: 606.13
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>x265 [info]: Weighted P-Frames: Y:1.0% UV:0.5%
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>x265 [info]: consecutive B-frames: 1.7% 1.5% 86.7% 6.7% 3.4%
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>encoded 267351 frames in 11214.90s (23.84 fps), 1469.42 kb/s, Avg QP:30.30
</span></code></pre></div>
<h3 id="av1">av1<a class="headerlink" href="#av1" title="Permanent link">&para;</a></h3>
<p><a href="https://trac.ffmpeg.org/wiki/Encode/AV1">Encode/AV1 – FFmpeg</a></p>
<p>AV1 can achieve about 30% higher compression efficiency than VP9, and about 50% higher efficiency than H.264.</p>
<p>现有几种编码器可以选择</p>
<ul>
<li>libaom-av1<ul>
<li>慢到不可用！</li>
</ul>
</li>
<li>libsvtav1<ul>
<li>可以跑满 128 个核！！！</li>
<li>SVT-AV1 (<code>libsvtav1</code>) is an encoder originally developed by Intel in collaboration with Netflix.</li>
<li>The encoder supports a wide range of speed-efficiency tradeoffs and scales fairly well across many CPU cores.</li>
</ul>
</li>
</ul>
<p>Constant Quality:</p>
<p>libaom-av1 has a constant quality (CQ) mode (like CRF in x264 and x265) which will ensure that <em>every frame gets the number of bits it deserves to achieve a certain (perceptual) quality level</em>, rather than encoding each frame to meet a bit rate target. This results in better overall quality. <strong>If you do not need to achieve a fixed target file size, this should be your method of choice.</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>ffmpeg -i input.mp4 -c:v libsvtav1 -crf 32 -preset 12 av1_test.mkv
</span></code></pre></div>
<p><a href="https://ottverse.com/analysis-of-svt-av1-presets-and-crf-values/">Comparing SVT-AV1 Presets: Size, Quality, and Speed with CRF Variations - OTTVerse</a></p>
<ul>
<li>preset 1 实在太慢，2 - 12 为有意义的值</li>
<li>2 -&gt; 12 速度提升 124x</li>
<li>6 -&gt; 12 速度提升 6x</li>
<li><strong>CRF &gt;= 38, 无论 preset 怎么变，VMAF &gt;= 95%</strong></li>
<li><strong>2 -&gt; 12，文件大小增加 20%</strong></li>
<li><strong>6 和 2 最接近，速度提升 20x</strong><ul>
<li>只考虑<code>[6, 12]</code></li>
</ul>
</li>
</ul>
<p><img alt="FPS vs crf, preset" src="https://lh5.googleusercontent.com/_sTdjoVtfTDWnfeT2Nk6VDIebmP8Jm7OAWGQe2fBOEaKJJ9ZKQHhzVj4hEsC1WNdOeXLP26I00bogoJPdcmTzZhOP4XgBBVaZXr6QawKQRFYECKwQFM6ZQMCqER-59C5PN7mS2Pt6DX8kZTUVsVlWog" /></p>
<p><img alt="VMAF vs CRF, preset" src="https://lh5.googleusercontent.com/Gk2U5kRX8iuw8O0va94hBIZ8uGG9YmngZJ66Frcdm0Q3dJk7zqbrIHPv7WZlOK07z8C3qFzm101jPIEZIEfx0xZqaopGVaUs9QOpxkG1SxhaqqYygVbkUgyT1d7AoAzydR2MM_S7tenx2peoAHY_pgE" /></p>
<table>
<thead>
<tr>
<th>Preset</th>
<th>CRF</th>
<th><strong>Filesize (MB)</strong></th>
<th><strong>Bitrate (kbps)</strong></th>
<th><strong>PSNR (dB)</strong></th>
<th>SSIM</th>
<th>VMAF</th>
<th>Time (sec)</th>
<th>FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>38</td>
<td><strong>32</strong></td>
<td><strong>26290.6</strong></td>
<td>34.593</td>
<td>0.955</td>
<td>98.84</td>
<td>826.6</td>
<td>0.6</td>
</tr>
<tr>
<td>12</td>
<td>38</td>
<td><strong>39</strong></td>
<td><strong>32693.4</strong></td>
<td>32.99</td>
<td>0.936</td>
<td>95.90</td>
<td>6.1</td>
<td>81</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Preset</th>
<th>CRF</th>
<th>Filesize (MB)</th>
<th>Bitrake (kbps)</th>
<th>PSNR (dB)</th>
<th>SSIM</th>
<th>VMAF</th>
<th>Time (sec)</th>
<th>FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>26</td>
<td>75</td>
<td>62757.8</td>
<td>39.283</td>
<td>Bitrate (kbps)</td>
<td>99.709</td>
<td>974.094</td>
<td>0.5</td>
</tr>
<tr>
<td>4</td>
<td>26</td>
<td>75</td>
<td>62446.2</td>
<td>38.727</td>
<td>0.977</td>
<td>99.679</td>
<td>147.694</td>
<td>3.4</td>
</tr>
<tr>
<td><strong>6</strong></td>
<td><strong>26</strong></td>
<td><strong>75</strong></td>
<td><strong>63023.0</strong></td>
<td><strong>38.439</strong></td>
<td><strong>0.975</strong></td>
<td><strong>99.565</strong></td>
<td><strong>53.14</strong></td>
<td><strong>9.4</strong></td>
</tr>
<tr>
<td>8</td>
<td>26</td>
<td>81</td>
<td>67342.4</td>
<td>37.965</td>
<td>0.973</td>
<td>99.506</td>
<td>20.237</td>
<td>25</td>
</tr>
<tr>
<td>10</td>
<td>26</td>
<td>86</td>
<td>71827.7</td>
<td>37.677</td>
<td>0.97</td>
<td>99.446</td>
<td>10.524</td>
<td>48</td>
</tr>
<tr>
<td>12</td>
<td>26</td>
<td>92</td>
<td>77138.9</td>
<td>36.816</td>
<td>0.965</td>
<td>99.289</td>
<td>8.052</td>
<td>62</td>
</tr>
</tbody>
</table>
<h3 id="音频">音频<a class="headerlink" href="#音频" title="Permanent link">&para;</a></h3>
<p><a href="https://trac.ffmpeg.org/wiki/Encode/HighQualityAudio">Encode/HighQualityAudio – FFmpeg</a></p>
<ul>
<li>避免从一个 lossy 格式转码成另一个 lossy 格式，最好直接 copy。<ul>
<li>Transcoding from a lossy format like <a href="https://trac.ffmpeg.org/wiki/Encoding%20VBR%20(Variable%20Bit%20Rate)%20mp3%20audio">MP3</a>, <a href="https://trac.ffmpeg.org/wiki/AACEncodingGuide">AAC</a>, Vorbis, Opus, WMA, etc. to the same or different lossy format might degrade the audio quality even if the bitrate stays the same (or higher).</li>
</ul>
</li>
<li>libopus &gt; libvorbis &gt;= libfdk_aac &gt; libmp3lame &gt;= eac3/ac3 &gt; aac &gt; libtwolame &gt; vorbis &gt; mp2 &gt; wmav2/wmav1</li>
<li>128, 384 k</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>fyyuan@icarus4<span class="w"> </span>➜<span class="w">  </span>Media<span class="w"> </span>ffmpeg<span class="w"> </span>-vn<span class="w"> </span>-i<span class="w"> </span>src.mkv<span class="w"> </span>-c:a<span class="w"> </span>aac<span class="w"> </span>-b:a<span class="w"> </span>256k<span class="w"> </span>audio.mp3
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>Stream<span class="w"> </span>mapping:
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">  </span>Stream<span class="w"> </span><span class="c1">#0:1 -&gt; #0:0 (aac_latm (native) -&gt; aac (native))</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>Press<span class="w"> </span><span class="o">[</span>q<span class="o">]</span><span class="w"> </span>to<span class="w"> </span>stop,<span class="w"> </span><span class="o">[</span>?<span class="o">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">help</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="o">[</span>mp3<span class="w"> </span>@<span class="w"> </span>0x564c9fc61340<span class="o">]</span><span class="w"> </span>Invalid<span class="w"> </span>audio<span class="w"> </span>stream.<span class="w"> </span>Exactly<span class="w"> </span>one<span class="w"> </span>MP3<span class="w"> </span>audio<span class="w"> </span>stream<span class="w"> </span>is<span class="w"> </span>required.
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>Could<span class="w"> </span>not<span class="w"> </span>write<span class="w"> </span>header<span class="w"> </span><span class="k">for</span><span class="w"> </span>output<span class="w"> </span>file<span class="w"> </span><span class="c1">#0 (incorrect codec parameters ?): Invalid argument</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>Error<span class="w"> </span>initializing<span class="w"> </span>output<span class="w"> </span>stream<span class="w"> </span><span class="m">0</span>:0<span class="w"> </span>--
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="o">[</span>aac<span class="w"> </span>@<span class="w"> </span>0x564c9fc60900<span class="o">]</span><span class="w"> </span>Qavg:<span class="w"> </span>nan
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>Conversion<span class="w"> </span>failed!
</span></code></pre></div>
<h3 id="调节帧数">调节帧数<a class="headerlink" href="#调节帧数" title="Permanent link">&para;</a></h3>
<p><a href="https://stackoverflow.com/questions/33749109/best-way-to-convert-a-59-94fps-video-to-29-97">ffmpeg - Best way to convert a 59.94fps video to 29.97? - Stack Overflow</a></p>
<p><a href="https://ffmpeg-user.ffmpeg.narkive.com/VAyCRakI/framerate-conversion-with-sync-audio">[FFmpeg-user] framerate conversion with sync audio (narkive.com)</a>
这位老哥的需求时将 24fps 的视频转成 25fps，要求单纯只是加速，不改变 frame 内容。由于改变了 video 的速率，因此也要同时改变 audio 的速率，最后的结果命令</p>
<ul>
<li>有老哥说-r 不是很可靠，建议使用<code>-vf setpts=PTS*0.8</code></li>
<li>还有老哥提议测试以下<code>asetpts</code> filter 是否可以</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>ffmpeg -r 25 -i input_24fps.mov -af asetrate=50000,aresample=48000 -c:v  
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>prores -profile:v 3 -c:a pcm_s24le output_25fps_resampledaudio.mov
</span></code></pre></div>
<p><a href="https://stackoverflow.com/questions/43333542/what-is-video-timescale-timebase-or-timestamp-in-ffmpeg">What is video timescale, timebase, or timestamp in ffmpeg? - Stack Overflow</a></p>
<ul>
<li>每 frame 包含 timestamp 信息。<strong>P</strong>resentation <strong>T</strong>ime<strong>S</strong>tamps，表示其应该显示的时间？</li>
<li>For the sake of precise resolution of these time values, a timebase is used。比如 1/75 为单位</li>
<li>timescale 即 timebase 的倒数，FFmpeg shows the timescale as the <code>tbn</code> value in the readout of a stream.</li>
</ul>
<h2 id="字幕">字幕<a class="headerlink" href="#字幕" title="Permanent link">&para;</a></h2>
<h3 id="pgs-字幕图像字幕">PGS 字幕（图像字幕）<a class="headerlink" href="#pgs-字幕图像字幕" title="Permanent link">&para;</a></h3>
<p>优点</p>
<ul>
<li>不会因缺失字体而显示不正常（相对于 ASS）</li>
<li>支持字幕特效</li>
<li>相对于硬字幕，可以切换字幕流
缺点</li>
<li>一些老电视可能不支持 PGS 字幕</li>
</ul>
<p><a href="https://post.smzdm.com/p/ad2l6m0k/">自己动手给视频添加PGS/SUP字幕_软件应用_什么值得买 (smzdm.com)</a></p>
<p>也有人问如何将 PGS 字幕压制成硬字幕
<a href="https://cnlang.org/thread-59664-1-1.html">如何将SUP字幕压制到电影中，成为硬字幕 - 字幕 - 音轨 - 国语视界 (cnlang.org)</a></p>
<p>ffmpeg 貌似</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>ffmpeg -i c:\xxxx.xxx -filter_complex &quot;[0:v][0:s]overlay[v]&quot; -map &quot;[v]&quot; -map 0:a:0 output.mp4
</span></code></pre></div>
<h4 id="想尝试使用-handbrake-压制">想尝试使用 handbrake 压制<a class="headerlink" href="#想尝试使用-handbrake-压制" title="Permanent link">&para;</a></h4>
<p><a href="https://www.reddit.com/r/handbrake/comments/srqft1/psg_subtitles_forced_burnin/">[PSG] Subtitles forced burn-in : r/handbrake (reddit.com)</a>
原来 mp4 对于 PGS 字幕会强制烧录:</p>
<blockquote>
<p>If you're wanting an mp4 container, PGS is not supported and you should remove the track from your preset. If you don't manually remove the track, it forces an automatic "burn-in" behavior. If you switch to MKV you can use it normally; this is one of the main reasons I personally use mkv</p>
</blockquote>
<p>发现原来勾上 burn in 就好了，<strong>并且不能勾选仅限强制</strong>。mp4 对于 sup 默认是烧录，不能也不用选。</p>
<p><img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20240716033353.png" /></p>
<div class="admonition note 关于字幕行为">
<p class="admonition-title">Note</p>
<p>有 Forien Track, Froien Track then first track。翻译错误，外语音轨翻译成了外部音轨。。。这里的烧录行为用于控制多条字幕时，烧录哪一个。选择 无 的话，则都不烧录。当然无论怎么选，仍然可以手动勾选进行修改。只能烧录一个字幕。还有字幕加载行为，可以选择几个语言，优先加载这些字幕。</p>
</div>
<h3 id="文本字幕">文本字幕<a class="headerlink" href="#文本字幕" title="Permanent link">&para;</a></h3>
<p>ass</p>
<p>SRT</p>
<p>对比前面一个图，为什么ASS/SSA格式字幕会比SRT字幕选项少一些呢，这是因为你的ASS/SSA字幕文件中已经给每一行字幕指定了字体样式颜色和大小，软件会最大程度的遵照格式指定来展现字幕。而SRT字幕并没有这些指定，所以需要我们选择需要使用的字体样式及大小（图标3），屏幕对齐方式和左右、上下的边距（图标4），字幕字体颜色（图标5），字体边框颜色及边框宽度（图标6），字体阴影颜色，宽度及透明度（图标7）。这些对于SRT来说是全局设置，默认的字幕字体都会遵照这个设置。</p>
<h3 id="_1"><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<h4 id="extract">extract<a class="headerlink" href="#extract" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>subrip</strong>: SubRip subtitle</li>
<li><strong>srt</strong>: SubRip subtitle with embedded timing</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>ffmpeg -ss 44 -i City.Hunter.2024.1080p.NF.WEB-DL.DUAL.DDP5.1.Atmos.H.264-FLUX.mkv -t 180 -c copy -map 0:v:0 -map 0:a:0 -map 0:s:36 city_hunter.mkv -y
</span></code></pre></div>
<p>通过 language 选择</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>ffmpeg -ss 44 -i City.Hunter.2024.1080p.NF.WEB-DL.DUAL.DDP5.1.Atmos.H.264-FLUX.mkv -t 180 -c copy -map 0:v:0 -map 0:a:0 -map 0:m:language:chi city_hunter.mkv
</span></code></pre></div>
<h4 id="burn-to-video">burn to video<a class="headerlink" href="#burn-to-video" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>➜  Disk3 ffmpeg -i city_hunter_nosub.mkv -vf subtitles=city_hunter.chi.srt output.mp4
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>ffmpeg version N-113445-ge0da916b8f Copyright (c) 2000-2024 the FFmpeg developers
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>  built with gcc 11 (Ubuntu 11.4.0-1ubuntu1~22.04)
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>  configuration: --prefix=/home/yfy/ffmpeg_build --pkg-config-flags=--static --extra-cflags=&#39;-I/home/yfy/ffmpeg_build/include -march=native&#39; --extra-ldflags=-L/home/yfy/ffmpeg_build/lib --extra-libs=&#39;-lpthread -lm&#39; --ld=g++ --bindir=/home/yfy/bin --enable-gpl --enable-libass --enable-libfdk-aac --enable-libfreetype --enable-libmp3lame --enable-libopus --enable-libsvtav1 --enable-libdav1d --enable-libvorbis --enable-libvpx --enable-libx264 --enable-libx265 --enable-nonfree
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>  libavutil      58. 36.101 / 58. 36.101
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>  libavcodec     60. 38.100 / 60. 38.100
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>  libavformat    60. 20.100 / 60. 20.100
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>  libavdevice    60.  4.100 / 60.  4.100
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>  libavfilter     9. 17.100 /  9. 17.100
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>  libswscale      7.  6.100 /  7.  6.100
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>  libswresample   4. 13.100 /  4. 13.100
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>  libpostproc    57.  4.100 / 57.  4.100
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>Input #0, matroska,webm, from &#39;city_hunter_nosub.mkv&#39;:
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>  Metadata:
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>    ENCODER         : Lavf60.20.100
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>  Duration: 00:03:02.04, start: 0.000000, bitrate: 5779 kb/s
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>  Stream #0:0(jpn): Video: h264 (Main), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 24 fps, 24 tbr, 1k tbn (default) (original)
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>      Metadata:
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>        BPS             : 4791086
</span><span id="__span-51-20"><a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>        NUMBER_OF_FRAMES: 149832
</span><span id="__span-51-21"><a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>        NUMBER_OF_BYTES : 3738844388
</span><span id="__span-51-22"><a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a>        _STATISTICS_WRITING_APP: mkvmerge v83.0 (&#39;Circle Of Friends&#39;) 64-bit
</span><span id="__span-51-23"><a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>        _STATISTICS_TAGS: BPS DURATION NUMBER_OF_FRAMES NUMBER_OF_BYTES
</span><span id="__span-51-24"><a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a>        DURATION        : 00:03:02.041000000
</span><span id="__span-51-25"><a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a>  Stream #0:1(jpn): Audio: eac3 (Dolby Digital Plus + Dolby Atmos), 48000 Hz, 5.1(side), fltp, 768 kb/s (default) (original)
</span><span id="__span-51-26"><a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a>      Metadata:
</span><span id="__span-51-27"><a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a>        BPS             : 768000
</span><span id="__span-51-28"><a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a>        NUMBER_OF_FRAMES: 195093
</span><span id="__span-51-29"><a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a>        NUMBER_OF_BYTES : 599325696
</span><span id="__span-51-30"><a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a>        _STATISTICS_WRITING_APP: mkvmerge v83.0 (&#39;Circle Of Friends&#39;) 64-bit
</span><span id="__span-51-31"><a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a>        _STATISTICS_TAGS: BPS DURATION NUMBER_OF_FRAMES NUMBER_OF_BYTES
</span><span id="__span-51-32"><a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a>        DURATION        : 00:03:02.000000000
</span><span id="__span-51-33"><a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a>[Parsed_subtitles_0 @ 0x5f46b3ffbd40] libass API version: 0x1502000
</span><span id="__span-51-34"><a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a>[Parsed_subtitles_0 @ 0x5f46b3ffbd40] libass source: tarball: 0.15.2
</span><span id="__span-51-35"><a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a>[Parsed_subtitles_0 @ 0x5f46b3ffbd40] Shaper: FriBidi 1.0.8 (SIMPLE) HarfBuzz-ng 2.7.4 (COMPLEX)
</span><span id="__span-51-36"><a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a>[Parsed_subtitles_0 @ 0x5f46b3ffbd40] Using font provider fontconfig
</span><span id="__span-51-37"><a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a>Stream mapping:
</span><span id="__span-51-38"><a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a>  Stream #0:0 -&gt; #0:0 (h264 (native) -&gt; h264 (libx264))
</span><span id="__span-51-39"><a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a>  Stream #0:1 -&gt; #0:1 (eac3 (native) -&gt; aac (native))
</span><span id="__span-51-40"><a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a>Press [q] to stop, [?] for help
</span><span id="__span-51-41"><a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a>[aac @ 0x5f46b4dfd040] Using a PCE to encode channel layout &quot;5.1(side)&quot;
</span><span id="__span-51-42"><a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a>[Parsed_subtitles_0 @ 0x7c8ac4003640] libass API version: 0x1502000
</span><span id="__span-51-43"><a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a>[Parsed_subtitles_0 @ 0x7c8ac4003640] libass source: tarball: 0.15.2
</span><span id="__span-51-44"><a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a>[Parsed_subtitles_0 @ 0x7c8ac4003640] Shaper: FriBidi 1.0.8 (SIMPLE) HarfBuzz-ng 2.7.4 (COMPLEX)
</span><span id="__span-51-45"><a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a>[Parsed_subtitles_0 @ 0x7c8ac4003640] Using font provider fontconfig
</span><span id="__span-51-46"><a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a>[libx264 @ 0x5f46b3ff2380] using SAR=1/1
</span><span id="__span-51-47"><a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a>[libx264 @ 0x5f46b3ff2380] using cpu capabilities: MMX2 SSE2Fast SSSE3 SSE4.2 AVX FMA3 BMI2 AVX2
</span><span id="__span-51-48"><a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a>[libx264 @ 0x5f46b3ff2380] profile High, level 4.0, 4:2:0, 8-bit
</span><span id="__span-51-49"><a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a>[libx264 @ 0x5f46b3ff2380] 264 - core 163 r3060 5db6aa6 - H.264/MPEG-4 AVC codec - Copyleft 2003-2021 - http://www.videolan.org/x264.html - options: cabac=1 ref=3 deblock=1:0:0 analyse=0x3:0x113 me=hex subme=7 psy=1 psy_rd=1.00:0.00 mixed_ref=1 me_range=16 chroma_me=1 trellis=1 8x8dct=1 cqm=0 deadzone=21,11 fast_pskip=1 chroma_qp_offset=-2 threads=24 lookahead_threads=4 sliced_threads=0 nr=0 decimate=1 interlaced=0 bluray_compat=0 constrained_intra=0 bframes=3 b_pyramid=2 b_adapt=1 b_bias=0 direct=1 weightb=1 open_gop=0 weightp=2 keyint=250 keyint_min=24 scenecut=40 intra_refresh=0 rc_lookahead=40 rc=crf mbtree=1 crf=23.0 qcomp=0.60 qpmin=0 qpmax=69 qpstep=4 ip_ratio=1.40 aq=1:1.00
</span><span id="__span-51-50"><a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a>Output #0, mp4, to &#39;output.mp4&#39;:
</span><span id="__span-51-51"><a id="__codelineno-51-51" name="__codelineno-51-51" href="#__codelineno-51-51"></a>  Metadata:
</span><span id="__span-51-52"><a id="__codelineno-51-52" name="__codelineno-51-52" href="#__codelineno-51-52"></a>    encoder         : Lavf60.20.100
</span><span id="__span-51-53"><a id="__codelineno-51-53" name="__codelineno-51-53" href="#__codelineno-51-53"></a>  Stream #0:0(jpn): Video: h264 (avc1 / 0x31637661), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], q=2-31, 24 fps, 12288 tbn (default) (original)
</span><span id="__span-51-54"><a id="__codelineno-51-54" name="__codelineno-51-54" href="#__codelineno-51-54"></a>      Metadata:
</span><span id="__span-51-55"><a id="__codelineno-51-55" name="__codelineno-51-55" href="#__codelineno-51-55"></a>        BPS             : 4791086
</span><span id="__span-51-56"><a id="__codelineno-51-56" name="__codelineno-51-56" href="#__codelineno-51-56"></a>        NUMBER_OF_FRAMES: 149832
</span><span id="__span-51-57"><a id="__codelineno-51-57" name="__codelineno-51-57" href="#__codelineno-51-57"></a>        NUMBER_OF_BYTES : 3738844388
</span><span id="__span-51-58"><a id="__codelineno-51-58" name="__codelineno-51-58" href="#__codelineno-51-58"></a>        _STATISTICS_WRITING_APP: mkvmerge v83.0 (&#39;Circle Of Friends&#39;) 64-bit
</span><span id="__span-51-59"><a id="__codelineno-51-59" name="__codelineno-51-59" href="#__codelineno-51-59"></a>        _STATISTICS_TAGS: BPS DURATION NUMBER_OF_FRAMES NUMBER_OF_BYTES
</span><span id="__span-51-60"><a id="__codelineno-51-60" name="__codelineno-51-60" href="#__codelineno-51-60"></a>        DURATION        : 00:03:02.041000000
</span><span id="__span-51-61"><a id="__codelineno-51-61" name="__codelineno-51-61" href="#__codelineno-51-61"></a>        encoder         : Lavc60.38.100 libx264
</span><span id="__span-51-62"><a id="__codelineno-51-62" name="__codelineno-51-62" href="#__codelineno-51-62"></a>      Side data:
</span><span id="__span-51-63"><a id="__codelineno-51-63" name="__codelineno-51-63" href="#__codelineno-51-63"></a>        cpb: bitrate max/min/avg: 0/0/0 buffer size: 0 vbv_delay: N/A
</span><span id="__span-51-64"><a id="__codelineno-51-64" name="__codelineno-51-64" href="#__codelineno-51-64"></a>  Stream #0:1(jpn): Audio: aac (LC) (mp4a / 0x6134706D), 48000 Hz, 5.1(side), fltp, 394 kb/s (default) (original)
</span><span id="__span-51-65"><a id="__codelineno-51-65" name="__codelineno-51-65" href="#__codelineno-51-65"></a>      Metadata:
</span><span id="__span-51-66"><a id="__codelineno-51-66" name="__codelineno-51-66" href="#__codelineno-51-66"></a>        BPS             : 768000
</span><span id="__span-51-67"><a id="__codelineno-51-67" name="__codelineno-51-67" href="#__codelineno-51-67"></a>        NUMBER_OF_FRAMES: 195093
</span><span id="__span-51-68"><a id="__codelineno-51-68" name="__codelineno-51-68" href="#__codelineno-51-68"></a>        NUMBER_OF_BYTES : 599325696
</span><span id="__span-51-69"><a id="__codelineno-51-69" name="__codelineno-51-69" href="#__codelineno-51-69"></a>        _STATISTICS_WRITING_APP: mkvmerge v83.0 (&#39;Circle Of Friends&#39;) 64-bit
</span><span id="__span-51-70"><a id="__codelineno-51-70" name="__codelineno-51-70" href="#__codelineno-51-70"></a>        _STATISTICS_TAGS: BPS DURATION NUMBER_OF_FRAMES NUMBER_OF_BYTES
</span><span id="__span-51-71"><a id="__codelineno-51-71" name="__codelineno-51-71" href="#__codelineno-51-71"></a>        DURATION        : 00:03:02.000000000
</span><span id="__span-51-72"><a id="__codelineno-51-72" name="__codelineno-51-72" href="#__codelineno-51-72"></a>        encoder         : Lavc60.38.100 aac
</span><span id="__span-51-73"><a id="__codelineno-51-73" name="__codelineno-51-73" href="#__codelineno-51-73"></a>[Parsed_subtitles_0 @ 0x7c8ac4003640] fontselect: (Arial, 400, 0) -&gt; /usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf, 0, LiberationSans
</span><span id="__span-51-74"><a id="__codelineno-51-74" name="__codelineno-51-74" href="#__codelineno-51-74"></a>[Parsed_subtitles_0 @ 0x7c8ac4003640] Glyph 0x6211 not found, selecting one more font for (Arial, 400, 0)
</span><span id="__span-51-75"><a id="__codelineno-51-75" name="__codelineno-51-75" href="#__codelineno-51-75"></a>[Parsed_subtitles_0 @ 0x7c8ac4003640] fontselect: (Arial, 400, 0) -&gt; /usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc, 0, NotoSansCJKjp-Regular
</span><span id="__span-51-76"><a id="__codelineno-51-76" name="__codelineno-51-76" href="#__codelineno-51-76"></a>[out#0/mp4 @ 0x5f46b3fdb400] video:69496kB audio:8768kB subtitle:0kB other streams:0kB global headers:0kB muxing overhead: 0.155742%
</span><span id="__span-51-77"><a id="__codelineno-51-77" name="__codelineno-51-77" href="#__codelineno-51-77"></a>frame= 4369 fps=108 q=-1.0 Lsize=   78386kB time=00:03:01.95 bitrate=3529.1kbits/s speed=4.51x
</span><span id="__span-51-78"><a id="__codelineno-51-78" name="__codelineno-51-78" href="#__codelineno-51-78"></a>[libx264 @ 0x5f46b3ff2380] frame I:77    Avg QP:17.81  size: 86251
</span><span id="__span-51-79"><a id="__codelineno-51-79" name="__codelineno-51-79" href="#__codelineno-51-79"></a>[libx264 @ 0x5f46b3ff2380] frame P:1394  Avg QP:21.37  size: 28008
</span><span id="__span-51-80"><a id="__codelineno-51-80" name="__codelineno-51-80" href="#__codelineno-51-80"></a>[libx264 @ 0x5f46b3ff2380] frame B:2898  Avg QP:23.29  size:  8792
</span><span id="__span-51-81"><a id="__codelineno-51-81" name="__codelineno-51-81" href="#__codelineno-51-81"></a>[libx264 @ 0x5f46b3ff2380] consecutive B-frames:  6.2% 10.5% 16.8% 66.5%
</span><span id="__span-51-82"><a id="__codelineno-51-82" name="__codelineno-51-82" href="#__codelineno-51-82"></a>[libx264 @ 0x5f46b3ff2380] mb I  I16..4: 30.6% 49.3% 20.1%
</span><span id="__span-51-83"><a id="__codelineno-51-83" name="__codelineno-51-83" href="#__codelineno-51-83"></a>[libx264 @ 0x5f46b3ff2380] mb P  I16..4:  6.3% 14.1%  1.9%  P16..4: 34.2%  7.2%  3.7%  0.0%  0.0%    skip:32.7%
</span><span id="__span-51-84"><a id="__codelineno-51-84" name="__codelineno-51-84" href="#__codelineno-51-84"></a>[libx264 @ 0x5f46b3ff2380] mb B  I16..4:  0.6%  1.3%  0.2%  B16..8: 33.5%  2.2%  0.3%  direct: 1.7%  skip:60.1%  L0:43.8% L1:53.7% BI: 2.5%
</span><span id="__span-51-85"><a id="__codelineno-51-85" name="__codelineno-51-85" href="#__codelineno-51-85"></a>[libx264 @ 0x5f46b3ff2380] 8x8 transform intra:60.4% inter:83.4%
</span><span id="__span-51-86"><a id="__codelineno-51-86" name="__codelineno-51-86" href="#__codelineno-51-86"></a>[libx264 @ 0x5f46b3ff2380] coded y,uvDC,uvAC intra: 41.2% 53.9% 15.2% inter: 8.2% 13.8% 1.3%
</span><span id="__span-51-87"><a id="__codelineno-51-87" name="__codelineno-51-87" href="#__codelineno-51-87"></a>[libx264 @ 0x5f46b3ff2380] i16 v,h,dc,p: 26% 29%  6% 39%
</span><span id="__span-51-88"><a id="__codelineno-51-88" name="__codelineno-51-88" href="#__codelineno-51-88"></a>[libx264 @ 0x5f46b3ff2380] i8 v,h,dc,ddl,ddr,vr,hd,vl,hu: 26% 20% 20%  5%  6%  6%  6%  6%  5%
</span><span id="__span-51-89"><a id="__codelineno-51-89" name="__codelineno-51-89" href="#__codelineno-51-89"></a>[libx264 @ 0x5f46b3ff2380] i4 v,h,dc,ddl,ddr,vr,hd,vl,hu: 25% 21% 12%  6%  8%  7%  8%  6%  6%
</span><span id="__span-51-90"><a id="__codelineno-51-90" name="__codelineno-51-90" href="#__codelineno-51-90"></a>[libx264 @ 0x5f46b3ff2380] i8c dc,h,v,p: 50% 24% 21%  5%
</span><span id="__span-51-91"><a id="__codelineno-51-91" name="__codelineno-51-91" href="#__codelineno-51-91"></a>[libx264 @ 0x5f46b3ff2380] Weighted P-Frames: Y:0.6% UV:0.6%
</span><span id="__span-51-92"><a id="__codelineno-51-92" name="__codelineno-51-92" href="#__codelineno-51-92"></a>[libx264 @ 0x5f46b3ff2380] ref P L0: 65.0% 13.1% 15.1%  6.8%  0.0%
</span><span id="__span-51-93"><a id="__codelineno-51-93" name="__codelineno-51-93" href="#__codelineno-51-93"></a>[libx264 @ 0x5f46b3ff2380] ref B L0: 87.5% 10.4%  2.1%
</span><span id="__span-51-94"><a id="__codelineno-51-94" name="__codelineno-51-94" href="#__codelineno-51-94"></a>[libx264 @ 0x5f46b3ff2380] ref B L1: 96.7%  3.3%
</span><span id="__span-51-95"><a id="__codelineno-51-95" name="__codelineno-51-95" href="#__codelineno-51-95"></a>[libx264 @ 0x5f46b3ff2380] kb/s:3127.34
</span><span id="__span-51-96"><a id="__codelineno-51-96" name="__codelineno-51-96" href="#__codelineno-51-96"></a>[aac @ 0x5f46b4dfd040] Qavg: 419.197
</span></code></pre></div>
<h2 id="filter_1">Filter<a class="headerlink" href="#filter_1" title="Permanent link">&para;</a></h2>
<h3 id="concat">concat<a class="headerlink" href="#concat" title="Permanent link">&para;</a></h3>
<p><a href="https://trac.ffmpeg.org/wiki/Concatenate#samecodec">Concatenate – FFmpeg</a></p>
<p>There are two methods within ffmpeg that can be used to concatenate files of the same type:</p>
<ol>
<li><a href="https://trac.ffmpeg.org/wiki/Concatenate#demuxer">the concat ''demuxer''</a></li>
<li><a href="https://trac.ffmpeg.org/wiki/Concatenate#protocol">the concat ''protocol''</a></li>
</ol>
<h3 id="stereo3d">stereo3d<a class="headerlink" href="#stereo3d" title="Permanent link">&para;</a></h3>
<p>不知为什么，我使用有 bug。tb 确实能转成 sbs，但是<strong>转不了 half</strong>。并且转的<strong>速度非常慢</strong>，理论上应该没什么计算，只是重组下像素。远慢于 scale。最后，转换的<strong>结果还很卡顿</strong>，不知道是为什么。</p>
<p>因此 sbs -&gt; half sbs，建议还是使用 scale。至于 tb 转 sbs，还不知道怎么搞。</p>
<p><a href="https://ffmpeg.org/ffmpeg-filters.html#stereo3d">FFmpeg Filters Documentation</a></p>
<ul>
<li><code>sbsl</code>: side by side parallel (left eye left, right eye right)</li>
<li><code>sbs2l</code>: side by side parallel with <strong>half</strong> width resolution (left eye left, right eye right)</li>
<li><code>abl</code>: above-below (left eye above, right eye below)<ul>
<li><code>tbl</code>: same</li>
</ul>
</li>
<li><code>ab2l</code>, <code>tb2l</code>: above-below with half height resolution (left eye above, right eye below)</li>
</ul>
<p><a href="https://stackoverflow.com/questions/35451758/how-to-convert-top-and-bottom-3d-video-to-side-by-side-3d-video-with-ffmpeg">How to convert Top-and-Bottom 3d video to side-by-side 3d video with FFmpeg - Stack Overflow</a></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>ffmpeg -i top-and-bottom.mov -vf stereo3d=abl:sbsl -c:a copy side-by-side.mov
</span></code></pre></div>
<p>‘al’</p>
<ul>
<li>alternating frames (left eye first, right eye second)
‘ar’</li>
<li>alternating frames (right eye first, left eye second)</li>
</ul>
<h3 id="scale">scale<a class="headerlink" href="#scale" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>将 `input.mp4` 的视频缩放到 1280x720 的分辨率
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>ffmpeg -i input.mp4 -vf &quot;scale=1280:720&quot; output.mp4
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a># 将视频宽度缩放到 1280 像素，并保持纵横比
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>ffmpeg -i input.mp4 -vf &quot;scale=1280:-1&quot; output.mp4
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a># 使用 `pad` 过滤器与 `scale` 结合：保持原始尺寸，并只缩放到指定的宽度和高度。
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a># 这会缩放视频以适应指定的分辨率，同时在边缘填充黑色，以保持指定的尺寸。
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>ffmpeg -i input.mp4 -vf &quot;scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2&quot; output.mp4
</span></code></pre></div>
<h3 id="pad">pad<a class="headerlink" href="#pad" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/afrum/my_ffmpeg/blob/main/padding">my_ffmpeg/padding at main · afrum/my_ffmpeg (github.com)</a></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>ffmpeg -i input.mp4 -vf &quot;pad=WIDTH:HEIGHT:(ow-iw)/2:(oh-ih)/2&quot; -c:a copy output.mp4
</span></code></pre></div>
<ul>
<li><code>WIDTH</code> 和 <code>HEIGHT</code> 是目标分辨率。</li>
<li><code>(ow-iw)/2</code> 是水平 left 的 padding，right 根据 width 自动得出。这里 (ow - iw)/2 表示，水平中心对齐。</li>
<li><code>(oh-ih)/2</code> 是垂直 top 的 padding。</li>
</ul>
<p>由于可以使用 ow, iw 变量。因此后面可以固定使用 <code>(ow-iw)/2:(oh-ih)/2</code> ，适用于所有中心对齐的 padding 场景。</p>
<h2 id="gpu-硬件加速">GPU 硬件加速<a class="headerlink" href="#gpu-硬件加速" title="Permanent link">&para;</a></h2>
<p>测试视频：</p>
<ul>
<li><a href="https://peach.blender.org/download/">Big Buck Bunny » Download (blender.org)</a></li>
<li><a href="https://test-videos.co.uk/bigbuckbunny/mp4-h265">MP4 ( H.265 ) | Test Videos (test-videos.co.uk)</a></li>
</ul>
<p>参考资料：</p>
<ul>
<li><a href="https://trac.ffmpeg.org/wiki/Hardware/VAAPI">Hardware/VAAPI – FFmpeg</a></li>
</ul>
<p>查看支持的 h264 编解码</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>ffmpeg -codecs|grep 264
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_v4l2m2m h264_qsv h264_cuvid ) (encoders: libx264 libx264rgb h264_nvenc h264_omx h264_qsv h264_v4l2m2m h264_vaapi )
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>ffmpeg -hwaccels
</span></code></pre></div>
<h3 id="vaapi-测试">vaapi 测试<a class="headerlink" href="#vaapi-测试" title="Permanent link">&para;</a></h3>
<p>使用 vaapi 需要以下库</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>apt install va-driver-all mesa-va-drivers
</span></code></pre></div>
<p>基本测试，测试权限之类的</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>ffmpeg -init_hw_device vaapi=va:/dev/dri/renderD128
</span></code></pre></div>
<p>调用 vaapi 加速编码</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>ffmpeg -y -vaapi_device /dev/dri/renderD128 -i Big_Buck_Bunny_1080_10s_30MB.mp4 -vf &#39;format=nv12,hwupload&#39; -c:v h264_vaapi output.mp4
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>ffmpeg -y -i Big_Buck_Bunny_1080_10s_30MB.mp4 -c:v libx264 output.mp4
</span></code></pre></div>
<p>如果设备支持硬件解码</p>
<ul>
<li>hwaccel vaapi 指定使用硬件解码</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>ffmpeg -hwaccel vaapi -hwaccel_output_format vaapi -hwaccel_device /dev/dri/renderD128 -i input.mp4 -c:v h264_vaapi output.mp4
</span></code></pre></div>
<ul>
<li>n5105 UHD 核显，转码 big bunny 1080p 30fps, 25Mb/s码率大概50fps</li>
<li>使用 cpu 转则只有 13fps</li>
</ul>
<p>vainfo</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>error: can&#39;t connect to X server!
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>libva info: VA-API version 1.7.0
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/radeonsi_drv_video.so
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>libva info: Found init function __vaDriverInit_1_7
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>libva info: va_openDriver() returns 0
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>vainfo: VA-API version: 1.7 (libva 2.6.0)
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>vainfo: Driver version: Mesa Gallium driver 21.2.6 for AMD Radeon (TM) R7 M340 (ICELAND, DRM 3.42.0, 5.15.0-86-generic, LLVM 12.0.0)
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>vainfo: Supported profile and entrypoints
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>      VAProfileMPEG2Simple            : VAEntrypointVLD
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>      VAProfileMPEG2Main              : VAEntrypointVLD
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>      VAProfileNone                   : VAEntrypointVideoProc
</span></code></pre></div>
<p>n5105</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>root@n5105-pve ➜  test vainfo
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>error: can&#39;t connect to X server!
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>libva info: VA-API version 1.17.0
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/iHD_drv_video.so
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>libva info: Found init function __vaDriverInit_1_17
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>libva info: va_openDriver() returns 0
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>vainfo: VA-API version: 1.17 (libva 2.12.0)
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>vainfo: Driver version: Intel iHD driver for Intel(R) Gen Graphics - 23.1.1 ()
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>vainfo: Supported profile and entrypoints
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>      VAProfileNone                   : VAEntrypointVideoProc
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>      VAProfileNone                   : VAEntrypointStats
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>      VAProfileMPEG2Simple            : VAEntrypointVLD
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>      VAProfileMPEG2Main              : VAEntrypointVLD
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>      VAProfileH264Main               : VAEntrypointVLD
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>      VAProfileH264Main               : VAEntrypointEncSliceLP
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>      VAProfileH264High               : VAEntrypointVLD
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a>      VAProfileH264High               : VAEntrypointEncSliceLP
</span><span id="__span-62-18"><a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a>      VAProfileJPEGBaseline           : VAEntrypointVLD
</span><span id="__span-62-19"><a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a>      VAProfileJPEGBaseline           : VAEntrypointEncPicture
</span><span id="__span-62-20"><a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a>      VAProfileH264ConstrainedBaseline: VAEntrypointVLD
</span><span id="__span-62-21"><a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a>      VAProfileH264ConstrainedBaseline: VAEntrypointEncSliceLP
</span><span id="__span-62-22"><a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a>      VAProfileVP8Version0_3          : VAEntrypointVLD
</span><span id="__span-62-23"><a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a>      VAProfileHEVCMain               : VAEntrypointVLD
</span><span id="__span-62-24"><a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a>      VAProfileHEVCMain               : VAEntrypointEncSliceLP
</span><span id="__span-62-25"><a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a>      VAProfileHEVCMain10             : VAEntrypointVLD
</span><span id="__span-62-26"><a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a>      VAProfileHEVCMain10             : VAEntrypointEncSliceLP
</span><span id="__span-62-27"><a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a>      VAProfileVP9Profile0            : VAEntrypointVLD
</span><span id="__span-62-28"><a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a>      VAProfileVP9Profile0            : VAEntrypointEncSliceLP
</span><span id="__span-62-29"><a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a>      VAProfileVP9Profile1            : VAEntrypointVLD
</span><span id="__span-62-30"><a id="__codelineno-62-30" name="__codelineno-62-30" href="#__codelineno-62-30"></a>      VAProfileVP9Profile1            : VAEntrypointEncSliceLP
</span><span id="__span-62-31"><a id="__codelineno-62-31" name="__codelineno-62-31" href="#__codelineno-62-31"></a>      VAProfileVP9Profile2            : VAEntrypointVLD
</span><span id="__span-62-32"><a id="__codelineno-62-32" name="__codelineno-62-32" href="#__codelineno-62-32"></a>      VAProfileVP9Profile2            : VAEntrypointEncSliceLP
</span><span id="__span-62-33"><a id="__codelineno-62-33" name="__codelineno-62-33" href="#__codelineno-62-33"></a>      VAProfileVP9Profile3            : VAEntrypointVLD
</span><span id="__span-62-34"><a id="__codelineno-62-34" name="__codelineno-62-34" href="#__codelineno-62-34"></a>      VAProfileVP9Profile3            : VAEntrypointEncSliceLP
</span><span id="__span-62-35"><a id="__codelineno-62-35" name="__codelineno-62-35" href="#__codelineno-62-35"></a>      VAProfileHEVCMain422_10         : VAEntrypointVLD
</span><span id="__span-62-36"><a id="__codelineno-62-36" name="__codelineno-62-36" href="#__codelineno-62-36"></a>      VAProfileHEVCMain444            : VAEntrypointVLD
</span><span id="__span-62-37"><a id="__codelineno-62-37" name="__codelineno-62-37" href="#__codelineno-62-37"></a>      VAProfileHEVCMain444            : VAEntrypointEncSliceLP
</span><span id="__span-62-38"><a id="__codelineno-62-38" name="__codelineno-62-38" href="#__codelineno-62-38"></a>      VAProfileHEVCMain444_10         : VAEntrypointVLD
</span><span id="__span-62-39"><a id="__codelineno-62-39" name="__codelineno-62-39" href="#__codelineno-62-39"></a>      VAProfileHEVCMain444_10         : VAEntrypointEncSliceLP
</span></code></pre></div>
<h3 id="nvidia-nvenc">nvidia NVENC<a class="headerlink" href="#nvidia-nvenc" title="Permanent link">&para;</a></h3>
<p><a href="https://blog.icyu.me/post/1687528">FFMpeg + NVENC，显卡加成让视频编码快而不糙 - 沧域的小站 (icyu.me)</a></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>-cq                &lt;float&gt;      E..V....... Set target quality level (0 to 51, 0 means automatic) for constant quality mode in VBR rate control (from 0 to 51) (default 0)
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>-qp                &lt;int&gt;        E..V....... Constant quantization parameter rate control method (from -1 to 51) (default -1)
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a># 编码
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>ffmpeg -i input.mp4 -c:v hevc_nvenc -crf 23 -c:a copy output.mp4
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a># 解码+编码
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>ffmpeg -hwaccel cuda -i input.mp4 -c:v hevc_nvenc -crf 23 -c:a copy output.mp4
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>ffmpeg -re -i input.mp4 -c:v hevc_nvenc -preset slow -profile:v main10 -rc vbr_hq -b:v 6000k -maxrate:v 9000k -bufsize:v 12000k -c:a aac -b:a 128k -f mpegts &quot;srt://hostname:port?streamid=stream1&amp;mode=listener&quot;
</span></code></pre></div>
<p>4K 25G h264，如下配置 30s 6.3M，非常多马赛克</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>ffmpeg -hwaccel cuda -ss 4:10 -t 30 -i a.mp4 -c:v hevc_nvenc -preset slow -c:a copy a.h265.gpu.mkv -y
</span></code></pre></div>
<p>cq 比 qp 慢：0.68 vs 1.47</p>
<h2 id="时间戳相关">时间戳相关<a class="headerlink" href="#时间戳相关" title="Permanent link">&para;</a></h2>
<p>DTS 解码时间戳</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>[matroska @ 0x55a111e20440] Non-monotonous DTS in output stream 0:1; previous: 565, current: 564; changing to 565. This may result in incorrect timestamps in the output file.
</span></code></pre></div>
<h3 id="选项">选项<a class="headerlink" href="#选项" title="Permanent link">&para;</a></h3>
<p>-copyts</p>
<p>Do not process input timestamps, but keep their values without trying to sanitize them. In particular, do not remove the initial start time offset value.</p>
<p>Note that, depending on the vsync option or on specific muxer processing (e.g. in case the format option avoid_negative_ts is enabled) the output timestamps may mismatch with the input timestamps even when this option is selected.</p>
<p>-start_at_zero</p>
<p>When used with copyts, shift input timestamps so they start at zero.</p>
<p>This means that using e.g. <code>-ss 50</code> will make output timestamps start at 50 seconds, regardless of what timestamp the input file started at.</p>
<p>-copytb mode</p>
<p>Specify how to set the encoder timebase when stream copying. mode is an integer numeric value, and can assume one of the following values:</p>
<p>1</p>
<p>Use the demuxer timebase.</p>
<p>The time base is copied to the output encoder from the corresponding input demuxer. This is sometimes required to avoid non monotonically increasing timestamps when copying video streams with variable frame rate.</p>
<p>0</p>
<p>Use the decoder timebase.</p>
<p>The time base is copied to the output encoder from the corresponding input decoder.</p>
<p>-1</p>
<p>Try to make the choice automatically, in order to generate a sane output.</p>
<p>Default value is -1.</p>
<h3 id="ffmpeg-输出时间戳默认会置为-0">ffmpeg 输出时间戳默认会置为 0<a class="headerlink" href="#ffmpeg-输出时间戳默认会置为-0" title="Permanent link">&para;</a></h3>
<p><a href="https://stackoverflow.com/questions/51585661/ffmpeg-demux-into-audio-and-video-resets-pts">ffmpeg demux into audio and video resets PTS - Stack Overflow</a></p>
<ul>
<li>ffmpeg 分离 video 时会 reset timestamp？</li>
</ul>
<p>构造一个 start 为 1h 的视频</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>ffmpeg -i bbb_sunflower_1080p_30fps_normal.mp4 -c copy -output_ts_offset 3600 test.mkv
</span></code></pre></div>
<p>查看确实 start_time = 3600</p>
<ul>
<li>使用 mpv 播放进度条仍为 0</li>
<li>使用 windows 自带的视频播放器，进度条确实从 1h 开始</li>
<li>文件管理器显示的视频时常也确实增加了 1h</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>Input #0, matroska,webm, from &#39;test.mkv&#39;:
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>  Metadata:
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>    title           : Big Buck Bunny, Sunflower version
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>    GENRE           : Animation
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>    MAJOR_BRAND     : isom
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>    MINOR_VERSION   : 1
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>    COMPATIBLE_BRANDS: isomavc1
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>    COMPOSER        : Sacha Goedegebure
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>    ARTIST          : Blender Foundation 2008, Janus Bager Kristensen 2013
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a>    COMMENT         : Creative Commons Attribution 3.0 - http://bbb3d.renderfarming.net
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>  Duration: 01:10:34.60, start: 3600.000000, bitrate: 497 kb/s
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>  Stream #0:0: Video: h264 (High), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 30 fps, 30 tbr, 1k tbn, 60 tbc (default)
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a>    Metadata:
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>      HANDLER_NAME    : GPAC ISO Video Handler
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a>      DURATION        : 01:10:34.600000000
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a>  Stream #0:1: Audio: ac3, 48000 Hz, 5.1(side), fltp, 320 kb/s (default)
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a>    Metadata:
</span><span id="__span-69-20"><a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a>      HANDLER_NAME    : GPAC ISO Audio Handler
</span><span id="__span-69-21"><a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-69-22"><a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a>      DURATION        : 01:10:34.144000000
</span><span id="__span-69-23"><a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a>start_pts=3600067
</span><span id="__span-69-24"><a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a>start_time=3600.067000
</span><span id="__span-69-25"><a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a>start_pts=3600000
</span><span id="__span-69-26"><a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a>start_time=3600.000000
</span></code></pre></div>
<p>ffmpeg 复制一下</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>ffmpeg -i test.mkv -c copy test_copy.mkv
</span></code></pre></div>
<p>确实 start 被置为 0 了，即</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>Input #0, matroska,webm, from &#39;test_copy.mkv&#39;:
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>  Metadata:
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>    title           : Big Buck Bunny, Sunflower version
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>    COMMENT         : Creative Commons Attribution 3.0 - http://bbb3d.renderfarming.net
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>    GENRE           : Animation
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>    MAJOR_BRAND     : isom
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>    MINOR_VERSION   : 1
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>    COMPATIBLE_BRANDS: isomavc1
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>    COMPOSER        : Sacha Goedegebure
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>    ARTIST          : Blender Foundation 2008, Janus Bager Kristensen 2013
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a>  Duration: 00:10:34.60, start: 0.000000, bitrate: 3321 kb/s
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>  Stream #0:0: Video: h264 (High), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 30 fps, 30 tbr, 1k tbn, 60 tbc (default)
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>    Metadata:
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a>      HANDLER_NAME    : GPAC ISO Video Handler
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>      DURATION        : 00:10:34.600000000
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>  Stream #0:1: Audio: ac3, 48000 Hz, 5.1(side), fltp, 320 kb/s (default)
</span><span id="__span-71-19"><a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a>    Metadata:
</span><span id="__span-71-20"><a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a>      HANDLER_NAME    : GPAC ISO Audio Handler
</span><span id="__span-71-21"><a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-71-22"><a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>      DURATION        : 00:10:34.144000000
</span><span id="__span-71-23"><a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a>start_pts=67
</span><span id="__span-71-24"><a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a>start_time=0.067000
</span><span id="__span-71-25"><a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a>start_pts=0
</span><span id="__span-71-26"><a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a>start_time=0.000000
</span></code></pre></div>
<h3 id="ffmpeg-合并视频和音频默认居然会有问题">ffmpeg 合并视频和音频，默认居然会有问题<a class="headerlink" href="#ffmpeg-合并视频和音频默认居然会有问题" title="Permanent link">&para;</a></h3>
<p>将视频分解为视频和音频</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>ffmpeg -i bbb_sunflower_1080p_30fps_normal.mkv -vn -c copy a.m4a -an -c copy a.mkv
</span></code></pre></div>
<p>对音频进行截切和偏移（剪掉前 1.7s，同时往右偏移 1.7s，因此相对于 base 还是同步的）</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>ffmpeg -ss 1.7 -itsoffset 1.7 -i a.m4a -c copy b.m4a
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>Input #0, mov,mp4,m4a,3gp,3g2,mj2, from &#39;b.m4a&#39;:
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>  Metadata:
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>    major_brand     : M4A
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>    minor_version   : 512
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>    compatible_brands: M4A isomiso2
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>    title           : Big Buck Bunny, Sunflower version
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>    artist          : Blender Foundation 2008, Janus Bager Kristensen 2013
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a>    composer        : Sacha Goedegebure
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>    encoder         : Lavf58.76.100
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>    comment         : Creative Commons Attribution 3.0 - http://bbb3d.renderfarming.net
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>    genre           : Animation
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a>  Duration: 00:10:34.14, start: 1.696000, bitrate: 319 kb/s
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>  Stream #0:0(und): Audio: ac3 (ac-3 / 0x332D6361), 48000 Hz, 5.1(side), fltp, 320 kb/s (default)
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a>    Metadata:
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a>      handler_name    : GPAC ISO Audio Handler
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a>      vendor_id       : [0][0][0][0]
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a>    Side data:
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a>      audio service type: main
</span><span id="__span-74-19"><a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a>start_pts=81408
</span><span id="__span-74-20"><a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a>start_time=1.696000
</span></code></pre></div>
<p>将原本视频和音频合并
<code>ffmpeg -i a.mkv -i b.m4a -c copy merge2.mkv</code></p>
<ul>
<li>ffmpeg 直接忽视了 input 的时间戳，将其认为是从 0 开始的，然后合并。因此导致声音相比于正确情况提前了。</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a>Input #0, matroska,webm, from &#39;merge.mkv&#39;:
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>  Metadata:
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    title           : Big Buck Bunny, Sunflower version
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>    ARTIST          : Blender Foundation 2008, Janus Bager Kristensen 2013
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>    COMMENT         : Creative Commons Attribution 3.0 - http://bbb3d.renderfarming.net
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>    GENRE           : Animation
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>    MAJOR_BRAND     : isom
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>    MINOR_VERSION   : 1
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>    COMPATIBLE_BRANDS: isomavc1
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>    COMPOSER        : Sacha Goedegebure
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>  Duration: 00:10:34.53, start: 0.000000, bitrate: 3321 kb/s
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>  Stream #0:0: Video: h264 (High), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 30 fps, 30 tbr, 1k tbn, 60 tbc (default)
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>    Metadata:
</span><span id="__span-75-15"><a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>      HANDLER_NAME    : GPAC ISO Video Handler
</span><span id="__span-75-16"><a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-75-17"><a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a>      DURATION        : 00:10:34.533000000
</span><span id="__span-75-18"><a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a>  Stream #0:1: Audio: ac3, 48000 Hz, 5.1(side), fltp, 320 kb/s (default)
</span><span id="__span-75-19"><a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a>    Metadata:
</span><span id="__span-75-20"><a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a>      HANDLER_NAME    : GPAC ISO Audio Handler
</span><span id="__span-75-21"><a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-75-22"><a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a>      DURATION        : 00:10:32.448000000
</span><span id="__span-75-23"><a id="__codelineno-75-23" name="__codelineno-75-23" href="#__codelineno-75-23"></a>start_pts=0
</span><span id="__span-75-24"><a id="__codelineno-75-24" name="__codelineno-75-24" href="#__codelineno-75-24"></a>start_time=0.000000
</span><span id="__span-75-25"><a id="__codelineno-75-25" name="__codelineno-75-25" href="#__codelineno-75-25"></a>start_pts=0
</span><span id="__span-75-26"><a id="__codelineno-75-26" name="__codelineno-75-26" href="#__codelineno-75-26"></a>start_time=0.000000
</span></code></pre></div>
<p>正确合并
<code>ffmpeg -i a.mkv -i b.m4a -copyts -c copy merge2.mkv</code></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>Input #0, matroska,webm, from &#39;merge2.mkv&#39;:
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>  Metadata:
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>    title           : Big Buck Bunny, Sunflower version
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>    ARTIST          : Blender Foundation 2008, Janus Bager Kristensen 2013
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>    COMMENT         : Creative Commons Attribution 3.0 - http://bbb3d.renderfarming.net
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>    GENRE           : Animation
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>    MAJOR_BRAND     : isom
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>    MINOR_VERSION   : 1
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>    COMPATIBLE_BRANDS: isomavc1
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>    COMPOSER        : Sacha Goedegebure
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>  Duration: 00:10:34.60, start: 0.067000, bitrate: 3320 kb/s
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>  Stream #0:0: Video: h264 (High), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 30 fps, 30 tbr, 1k tbn, 60 tbc (default)
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a>    Metadata:
</span><span id="__span-76-15"><a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a>      HANDLER_NAME    : GPAC ISO Video Handler
</span><span id="__span-76-16"><a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-76-17"><a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a>      DURATION        : 00:10:34.600000000
</span><span id="__span-76-18"><a id="__codelineno-76-18" name="__codelineno-76-18" href="#__codelineno-76-18"></a>  Stream #0:1: Audio: ac3, 48000 Hz, 5.1(side), fltp, 320 kb/s (default)
</span><span id="__span-76-19"><a id="__codelineno-76-19" name="__codelineno-76-19" href="#__codelineno-76-19"></a>    Metadata:
</span><span id="__span-76-20"><a id="__codelineno-76-20" name="__codelineno-76-20" href="#__codelineno-76-20"></a>      HANDLER_NAME    : GPAC ISO Audio Handler
</span><span id="__span-76-21"><a id="__codelineno-76-21" name="__codelineno-76-21" href="#__codelineno-76-21"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-76-22"><a id="__codelineno-76-22" name="__codelineno-76-22" href="#__codelineno-76-22"></a>      DURATION        : 00:10:34.144000000
</span><span id="__span-76-23"><a id="__codelineno-76-23" name="__codelineno-76-23" href="#__codelineno-76-23"></a>start_pts=67
</span><span id="__span-76-24"><a id="__codelineno-76-24" name="__codelineno-76-24" href="#__codelineno-76-24"></a>start_time=0.067000
</span><span id="__span-76-25"><a id="__codelineno-76-25" name="__codelineno-76-25" href="#__codelineno-76-25"></a>start_pts=1696
</span><span id="__span-76-26"><a id="__codelineno-76-26" name="__codelineno-76-26" href="#__codelineno-76-26"></a>start_time=1.696000
</span></code></pre></div>
<h3 id="delay-某个流">delay 某个流<a class="headerlink" href="#delay-某个流" title="Permanent link">&para;</a></h3>
<p>强行将音频 delay 0.613s，可以导致不同步</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>(base) fyyuan@icarus4 ➜  reset_pts ffmpeg -i ../src.mkv -itsoffset 0.613 -i ../src.mkv -map 0:0 -map 1:1 -c copy -shortest output_video_adjusted.mkv
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>Input #0, matroska,webm, from &#39;output_video_adjusted.mkv&#39;:
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>  Metadata:
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>  Duration: 00:08:41.15, start: 0.613000, bitrate: 24908 kb/s
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>  Stream #0:0: Video: hevc (Main 10), yuv420p10le(tv, bt2020nc/bt2020/bt2020-10), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 59.94 tbc (default)
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>    Metadata:
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a>      DURATION        : 00:08:41.149000000
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>  Stream #0:1: Audio: aac_latm (LC) ([2][22][0][0] / 0x1602), 48000 Hz, 5.1, fltp (default)
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>    Metadata:
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>      DURATION        : 00:08:41.018000000
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>start_pts=613
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>start_time=0.613000
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a>start_pts=613
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a>start_time=0.613000
</span></code></pre></div>
<h2 id="b-站问题">B 站问题<a class="headerlink" href="#b-站问题" title="Permanent link">&para;</a></h2>
<h3 id="为什么-seek-0638s结果导致-video-起始变成了-41s">为什么 seek 0.638s，结果导致 video 起始变成了 4.1s<a class="headerlink" href="#为什么-seek-0638s结果导致-video-起始变成了-41s" title="Permanent link">&para;</a></h3>
<p>现象就是视频少了 4s，mpv 播放时起始直接变成了 4s</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>Input #0, matroska,webm, from &#39;src.hevc.aac.mkv&#39;:
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>  Metadata:
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>  Duration: 00:08:41.18, start: 0.000000, bitrate: 11146 kb/s
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>  Stream #0:0: Video: hevc (Main 10), yuv420p10le(tv, bt2020nc/bt2020/bt2020-10, progressive), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 59.94 tbc (default)
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>    Metadata:
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>      ENCODER         : Lavc58.134.100 libx265
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a>      DURATION        : 00:08:41.175000000
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>  Stream #0:1: Audio: aac (LC), 48000 Hz, 5.1, fltp (default)
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>    Metadata:
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>      ENCODER         : Lavc58.134.100 aac
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a>      DURATION        : 00:08:41.023000000
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a>start_pts=638
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a>start_time=0.638000
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a>start_pts=0
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a>start_time=0.000000
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>ffmpeg -i src.hevc.aac.mkv -ss 0.638 -c copy cut.hevc.aac.ss638.mkv
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>Input #0, matroska,webm, from &#39;cut.hevc.aac.ss638.mkv&#39;:
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>  Metadata:
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>  Duration: 00:08:40.54, start: 0.002000, bitrate: 10998 kb/s
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>  Stream #0:0: Video: hevc (Main 10), yuv420p10le(tv, bt2020nc/bt2020/bt2020-10, progressive), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 59.94 tbc (default)
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>    Metadata:
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>      ENCODER         : Lavc58.134.100 libx265
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>      DURATION        : 00:08:40.536000000
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>  Stream #0:1: Audio: aac (LC), 48000 Hz, 5.1, fltp (default)
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>    Metadata:
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a>      ENCODER         : Lavc58.134.100 aac
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>      DURATION        : 00:08:40.385000000
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a>start_pts=4171
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a>start_time=4.171000
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a>start_pts=2
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a>start_time=0.002000
</span></code></pre></div>
<p>怀疑是 seek，seek 到下一个关键帧了，导致丢失了关键帧前的所有数据（虽然 chatgpt 告诉我 seek 是 seek 到之前的关键帧）</p>
<h3 id="感觉问题在于为什么自己的视频-video-和-audio-duration-相差没那么大而-b-站转码后就相差-05s-了">感觉问题在于为什么自己的视频 video 和 audio duration 相差没那么大，而 B 站转码后，就相差 0.5s 了<a class="headerlink" href="#感觉问题在于为什么自己的视频-video-和-audio-duration-相差没那么大而-b-站转码后就相差-05s-了" title="Permanent link">&para;</a></h3>
<p>分 p 版本
源文件</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>Input #0, matroska,webm, from &#39;p09.mkv&#39;:
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>  Metadata:
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>  Duration: 00:08:41.15, start: 0.000000, bitrate: 24909 kb/s
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>  Stream #0:0: Video: hevc (Main 10), yuv420p10le(tv, bt2020nc/bt2020/bt2020-10), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 59.94 tbc (default)
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>    Metadata:
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>      DURATION        : 00:08:41.149000000
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>  Stream #0:1: Audio: aac_latm (LC) ([2][22][0][0] / 0x1602), 48000 Hz, 5.1, fltp (default)
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>    Metadata:
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>      DURATION        : 00:08:41.002000000
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>start_pts=613
</span><span id="__span-81-12"><a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>start_time=0.613000
</span><span id="__span-81-13"><a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>start_pts=0
</span><span id="__span-81-14"><a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>start_time=0.000000
</span></code></pre></div>
<p>b 站下载的</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>➜  yt-dlp ./yt-dlp https://www.bilibili.com/video/BV1dG411z7sc -F -I 9
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>[BiliBili] Extracting URL: https://www.bilibili.com/video/BV1dG411z7sc
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>[BiliBili] 1dG411z7sc: Downloading webpage
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>[BiliBili] BV1dG411z7sc: Extracting videos in anthology
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>[BiliBili] Downloading playlist BV1dG411z7sc - add --no-playlist to download just the video BV1dG411z7sc
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>[download] Downloading playlist: 【第73回NHK紅白歌合戦 BS4K】节选
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>[BiliBili] Playlist 【第73回NHK紅白歌合戦 BS4K】节选: Downloading 1 items
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>[download] Downloading item 1 of 1
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a>[BiliBili] Extracting URL: https://www.bilibili.com/video/BV1dG411z7sc?p=9
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a>[BiliBili] 1dG411z7sc: Downloading webpage
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a>[BiliBili] BV1dG411z7sc: Extracting videos in anthology
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a>[BiliBili] 410742370: Extracting chapters
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a>[info] Available formats for BV1dG411z7sc_p9:
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a>ID    EXT RESOLUTION FPS │   FILESIZE    TBR PROTO │ VCODEC         VBR ACODEC      ABR
</span><span id="__span-82-15"><a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a>───────────────────────────────────────────────────────────────────────────────────────
</span><span id="__span-82-16"><a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a>30216 m4a audio only     │ ≈  2.51MiB    39k https │ audio only         mp4a.40.5   39k
</span><span id="__span-82-17"><a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a>30232 m4a audio only     │ ≈  5.88MiB    92k https │ audio only         mp4a.40.2   92k
</span><span id="__span-82-18"><a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a>30280 m4a audio only     │ ≈  9.87MiB   155k https │ audio only         mp4a.40.2  155k
</span><span id="__span-82-19"><a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a>30016 mp4 640x360     30 │ ≈ 23.35MiB   367k https │ avc1.64001E   367k video only
</span><span id="__span-82-20"><a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a>30032 mp4 852x480     30 │ ≈ 52.44MiB   824k https │ avc1.64001F   824k video only
</span><span id="__span-82-21"><a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a>30064 mp4 1280x720    30 │ ≈116.21MiB  1827k https │ avc1.640028  1827k video only
</span><span id="__span-82-22"><a id="__codelineno-82-22" name="__codelineno-82-22" href="#__codelineno-82-22"></a>30080 mp4 1920x1080   30 │ ≈173.36MiB  2725k https │ avc1.640032  2725k video only
</span><span id="__span-82-23"><a id="__codelineno-82-23" name="__codelineno-82-23" href="#__codelineno-82-23"></a>30116 mp4 1920x1080   59 │ ≈346.03MiB  5439k https │ avc1.640032  5439k video only
</span><span id="__span-82-24"><a id="__codelineno-82-24" name="__codelineno-82-24" href="#__codelineno-82-24"></a>30120 mp4 3840x2160   59 │ ≈  1.16GiB 18644k https │ avc1.640034 18644k video only
</span><span id="__span-82-25"><a id="__codelineno-82-25" name="__codelineno-82-25" href="#__codelineno-82-25"></a>[download] Finished downloading playlist: 【第73回NHK紅白歌合戦 BS4K】节选
</span></code></pre></div>
<p>(这里是 yt-dlp 的 bug，需要加 copyts，否则合并时会丢弃 input timestamp。不过我试了手动 merge，貌似仍然不同步，这次变成音频要快一点)</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>Input #0, matroska,webm, from &#39;bili-p09.mkv&#39;:
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>  Metadata:
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>    DESCRIPTION     : Packed by Bilibili XCoder v2.0.2
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>    MAJOR_BRAND     : iso5
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>    MINOR_VERSION   : 1
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>    COMPATIBLE_BRANDS: avc1iso5dsmsmsixdash
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>  Duration: 00:08:41.05, start: 0.000000, bitrate: 18779 kb/s
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>  Stream #0:0: Video: h264 (High), yuv420p(tv, bt709, progressive), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 119.88 tbc (default)
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>    Metadata:
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a>      HANDLER_NAME    : VideoHandler
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-83-13"><a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a>      DURATION        : 00:08:40.539000000
</span><span id="__span-83-14"><a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a>  Stream #0:1: Audio: aac (LC), 48000 Hz, stereo, fltp (default)
</span><span id="__span-83-15"><a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a>    Metadata:
</span><span id="__span-83-16"><a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a>      HANDLER_NAME    : SoundHandler
</span><span id="__span-83-17"><a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-83-18"><a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a>      DURATION        : 00:08:41.045000000
</span><span id="__span-83-19"><a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a>start_pts=0
</span><span id="__span-83-20"><a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a>start_time=0.000000
</span><span id="__span-83-21"><a id="__codelineno-83-21" name="__codelineno-83-21" href="#__codelineno-83-21"></a>start_pts=0
</span><span id="__span-83-22"><a id="__codelineno-83-22" name="__codelineno-83-22" href="#__codelineno-83-22"></a>start_time=0.000000
</span></code></pre></div>
<p>手动合并的（这里的 1.226 不就是 0.613 的两倍吗）（果然，将音频 delay +600ms 后，就很同步了）</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>Input #0, matroska,webm, from &#39;p9.mkv&#39;:
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>  Metadata:
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>    DESCRIPTION     : Packed by Bilibili XCoder v2.0.2
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>    MAJOR_BRAND     : iso5
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>    MINOR_VERSION   : 1
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>    COMPATIBLE_BRANDS: avc1iso5dsmsmsixdash
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>  Duration: 00:08:41.77, start: 0.000000, bitrate: 18753 kb/s
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>  Stream #0:0: Video: h264 (High), yuv420p(tv, bt709, progressive), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 119.88 tbc (default)
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>    Metadata:
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>      HANDLER_NAME    : VideoHandler
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a>      DURATION        : 00:08:41.765000000
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a>  Stream #0:1: Audio: aac (LC), 48000 Hz, stereo, fltp (default)
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a>    Metadata:
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a>      HANDLER_NAME    : SoundHandler
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a>      DURATION        : 00:08:41.045000000
</span><span id="__span-84-19"><a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a>start_pts=1226
</span><span id="__span-84-20"><a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a>start_time=1.226000
</span><span id="__span-84-21"><a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a>start_pts=0
</span><span id="__span-84-22"><a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a>start_time=0.000000
</span></code></pre></div>
<p>原因在于这里的 duration 是包含 start_pts 的，因此源视频的 video 就比 audio 少约 0.5s</p>
<p>使用 setpts（后面发现该命令是 filter 因此需要转码，速度很慢，实际上对可以 input video 单独设置 input pts offset，后面会用到该命令进行修复），可以复现 duration 差值变大</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a> ffmpeg -i src.mkv -filter_complex &quot;[0:v]setpts=PTS-STARTPTS[v];[0:a]asetpts=PTS-STARTPTS[a]&quot; -map &quot;[v]&quot; -map &quot;[a]&quot; setpts.mkv
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>Input #0, matroska,webm, from &#39;setpts.mkv&#39;:
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>  Metadata:
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>  Duration: 00:08:41.01, start: 0.000000, bitrate: 20558 kb/s
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a>  Stream #0:0: Video: h264 (High 10), yuv420p10le(tv, bt2020nc/bt2020/bt2020-10, progressive), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 119.88 tbc (default)
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a>    Metadata:
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a>      ENCODER         : Lavc58.134.100 libx264
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a>      DURATION        : 00:08:40.540000000
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a>  Stream #0:1: Audio: vorbis, 48000 Hz, 5.1, fltp (default)
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a>    Metadata:
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>      ENCODER         : Lavc58.134.100 libvorbis
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a>      DURATION        : 00:08:41.006000000
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a>start_pts=0
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a>start_time=0.000000
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a>start_pts=0
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a>start_time=0.000000
</span></code></pre></div>
<h3 id="猜想问题原因">猜想问题原因<a class="headerlink" href="#猜想问题原因" title="Permanent link">&para;</a></h3>
<p>可以看到我上传到 B 站的文件视频流的起始帧的 pts 为 0.613s，差不多正是 B 站音画不同步的时间</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>Input #0, matroska,webm, from &#39;src.mkv&#39;:
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>  Metadata:
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>  Duration: 00:08:41.15, start: 0.000000, bitrate: 24909 kb/s
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>  Stream #0:0: Video: hevc (Main 10), yuv420p10le(tv, bt2020nc/bt2020/bt2020-10), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 59.94 tbc (default)
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>    Metadata:
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>      DURATION        : 00:08:41.149000000
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>  Stream #0:1: Audio: aac_latm (LC) ([2][22][0][0] / 0x1602), 48000 Hz, 5.1, fltp (default)
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>    Metadata:
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>      DURATION        : 00:08:41.002000000
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>start_pts=613
</span><span id="__span-87-12"><a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a>start_time=0.613000
</span><span id="__span-87-13"><a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>start_pts=0
</span><span id="__span-87-14"><a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a>start_time=0.000000
</span></code></pre></div>
<p>并且经过很多次转码实验，发现转码并不能重置掉这个 start_pts，而是基本完全保留</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>src.hevc.aac.60fps.mkv  start_pts=638
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>src.hevc.aac.mkv  start_pts=638
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>src.avc.mkv start_pts=638
</span></code></pre></div>
<p>而 start_pts 的含义便是视频的第一帧应该显示出来的时间。
如果我把这个 pts 重置为 0，视频就会比音频提前（假设原本的 pts，音画是同步的话）</p>
<p>而 yt-dlp 下载 B 站视频时，视频和音频是分开下载，最后再合并成一个视频的。
我观察了好几个 yt-dlp 下载的视频，发现 start_pts 都变成了 0。所以猜测：</p>
<ul>
<li><del>B 站转码的时候将 pts 重置为了 0（每个 frame 做如下 filter：<code>[0:v]setpts=PTS-STARTPTS[v]</code>）</del></li>
<li><del>后面发现 yt-dlp 合并时丢弃了原本的 ts，将两个流当作 start_pts=0 进行合并的。B 站的视频和音频文件是有 offset</del></li>
<li><del>但是即使手动-copyts 合并，仍然不同步，并且这次变成音频提前了。</del>
UDPATE: 是 yt-dlp 会清除 timestamps。不过这里的问题在于 B 站好像也忽略了时间戳，导致不同步</li>
</ul>
<p>至于为什么一开始使用-ss 剪辑出 8 分钟的片段时，pts 为 613 而不是干脆置为 0。<strong>怀疑流复制情况，只能 seek 到 pos 之后的一个关键帧</strong>（而不是 chatgpt 告诉我的 seek 到之前的关键帧）</p>
<h3 id="其它">其它<a class="headerlink" href="#其它" title="Permanent link">&para;</a></h3>
<h4 id="发现原始视频有两个-audio">发现原始视频有两个 audio<a class="headerlink" href="#发现原始视频有两个-audio" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>Input #0, mpegts, from &#39;2022-12-31 第73回NHK 紅白歌合戦 NHK BS4K.m2ts&#39;:
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>  Duration: 04:25:01.42, start: 61.462067, bitrate: 26406 kb/s
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>  Program 101
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>  Stream #0:0[0x1011]: Video: hevc (Main 10) (HESE / 0x45534548), yuv420p10le(tv, bt2020nc/bt2020/bt2020-10), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 90k tbn, 59.94 tbc
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>  Stream #0:1[0x1100]: Audio: aac_latm (LC) ([17][0][0][0] / 0x0011), 48000 Hz, stereo, fltp
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>  Stream #0:2[0x1c00]: Data: bin_data ([6][0][0][0] / 0x0006)
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>  Stream #0:3[0x1c01]: Data: bin_data ([6][0][0][0] / 0x0006)
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a>  Stream #0:4[0x1101]: Audio: aac_latm (LC) ([17][0][0][0] / 0x0011), 48000 Hz, stereo, fltp
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a>Unsupported codec with id 100359 for input stream 2
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a>Unsupported codec with id 100359 for input stream 3
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a>start_pts=5577842
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a>start_time=61.976022
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a>start_pts=5531586
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a>start_time=61.462067
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a>start_pts=5531586
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a>start_time=61.462067
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a>start_pts=5531586
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a>start_time=61.462067
</span><span id="__span-89-19"><a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a>start_pts=5589186
</span><span id="__span-89-20"><a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a>start_time=62.102067
</span></code></pre></div>
<h4 id="youtube-没问题">youtube 没问题<a class="headerlink" href="#youtube-没问题" title="Permanent link">&para;</a></h4>
<p>yt-dlp 合并视频和音频时，究竟是如何对准 ts 的？</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>Input #0, mpegts, from &#39;youtube.f312.mp4&#39;:
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>  Duration: 00:08:41.15, start: 0.016678, bitrate: 5441 kb/s
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>  Program 1
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>  Stream #0:0[0x100]: Video: h264 (High) ([27][0][0][0] / 0x001B), yuv420p(tv, bt709, progressive), 1920x1080 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 90k tbn, 119.88 tbc
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>start_pts=1501
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>start_time=0.016678
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>Input #0, mov,mp4,m4a,3gp,3g2,mj2, from &#39;youtube.f380.m4a&#39;:
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>  Metadata:
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>    major_brand     : dash
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>    minor_version   : 0
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>    compatible_brands: iso6mp41
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>    creation_time   : 2024-01-02T23:44:20.000000Z
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>  Duration: 00:08:41.15, start: 0.000000, bitrate: 384 kb/s
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a>  Stream #0:0(und): Audio: ac3 (ac-3 / 0x332D6361), 48000 Hz, 5.1(side), fltp, 384 kb/s (default)
</span><span id="__span-90-16"><a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a>    Metadata:
</span><span id="__span-90-17"><a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a>      creation_time   : 2024-01-02T23:44:20.000000Z
</span><span id="__span-90-18"><a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a>      handler_name    : ISO Media file produced by Google Inc.
</span><span id="__span-90-19"><a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a>      vendor_id       : [0][0][0][0]
</span><span id="__span-90-20"><a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a>    Side data:
</span><span id="__span-90-21"><a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a>      audio service type: main
</span><span id="__span-90-22"><a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a>start_pts=0
</span><span id="__span-90-23"><a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a>start_time=0.000000
</span><span id="__span-90-24"><a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a>
</span><span id="__span-90-25"><a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a>Input #0, matroska,webm, from &#39;youtube.mkv&#39;:
</span><span id="__span-90-26"><a id="__codelineno-90-26" name="__codelineno-90-26" href="#__codelineno-90-26"></a>  Metadata:
</span><span id="__span-90-27"><a id="__codelineno-90-27" name="__codelineno-90-27" href="#__codelineno-90-27"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-90-28"><a id="__codelineno-90-28" name="__codelineno-90-28" href="#__codelineno-90-28"></a>  Duration: 00:08:41.15, start: 0.000000, bitrate: 5661 kb/s
</span><span id="__span-90-29"><a id="__codelineno-90-29" name="__codelineno-90-29" href="#__codelineno-90-29"></a>  Stream #0:0: Video: h264 (High), yuv420p(tv, bt709, progressive), 1920x1080 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 119.88 tbc (default)
</span><span id="__span-90-30"><a id="__codelineno-90-30" name="__codelineno-90-30" href="#__codelineno-90-30"></a>    Metadata:
</span><span id="__span-90-31"><a id="__codelineno-90-31" name="__codelineno-90-31" href="#__codelineno-90-31"></a>      DURATION        : 00:08:41.154000000
</span><span id="__span-90-32"><a id="__codelineno-90-32" name="__codelineno-90-32" href="#__codelineno-90-32"></a>  Stream #0:1: Audio: ac3, 48000 Hz, 5.1(side), fltp, 384 kb/s (default)
</span><span id="__span-90-33"><a id="__codelineno-90-33" name="__codelineno-90-33" href="#__codelineno-90-33"></a>    Metadata:
</span><span id="__span-90-34"><a id="__codelineno-90-34" name="__codelineno-90-34" href="#__codelineno-90-34"></a>      HANDLER_NAME    : ISO Media file produced by Google Inc.
</span><span id="__span-90-35"><a id="__codelineno-90-35" name="__codelineno-90-35" href="#__codelineno-90-35"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-90-36"><a id="__codelineno-90-36" name="__codelineno-90-36" href="#__codelineno-90-36"></a>      DURATION        : 00:08:41.152000000
</span><span id="__span-90-37"><a id="__codelineno-90-37" name="__codelineno-90-37" href="#__codelineno-90-37"></a>start_pts=0
</span><span id="__span-90-38"><a id="__codelineno-90-38" name="__codelineno-90-38" href="#__codelineno-90-38"></a>start_time=0.000000
</span><span id="__span-90-39"><a id="__codelineno-90-39" name="__codelineno-90-39" href="#__codelineno-90-39"></a>start_pts=0
</span><span id="__span-90-40"><a id="__codelineno-90-40" name="__codelineno-90-40" href="#__codelineno-90-40"></a>start_time=0.000000
</span></code></pre></div>
<p>手动 merge + -copyts</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>Input #0, matroska,webm, from &#39;youtube-hand-merge2.mkv&#39;:
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>  Metadata:
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>  Duration: 00:08:41.17, start: 0.000000, bitrate: 5661 kb/s
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>  Stream #0:0: Video: h264 (High), yuv420p(tv, bt709, progressive), 1920x1080 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 119.88 tbc (default)
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a>    Metadata:
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a>      DURATION        : 00:08:41.171000000
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a>  Stream #0:1: Audio: ac3, 48000 Hz, 5.1(side), fltp, 384 kb/s (default)
</span><span id="__span-91-9"><a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a>    Metadata:
</span><span id="__span-91-10"><a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a>      HANDLER_NAME    : ISO Media file produced by Google Inc.
</span><span id="__span-91-11"><a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a>      VENDOR_ID       : [0][0][0][0]
</span><span id="__span-91-12"><a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a>      DURATION        : 00:08:41.152000000
</span><span id="__span-91-13"><a id="__codelineno-91-13" name="__codelineno-91-13" href="#__codelineno-91-13"></a>start_pts=17
</span><span id="__span-91-14"><a id="__codelineno-91-14" name="__codelineno-91-14" href="#__codelineno-91-14"></a>start_time=0.017000
</span><span id="__span-91-15"><a id="__codelineno-91-15" name="__codelineno-91-15" href="#__codelineno-91-15"></a>start_pts=0
</span><span id="__span-91-16"><a id="__codelineno-91-16" name="__codelineno-91-16" href="#__codelineno-91-16"></a>start_time=0.000000
</span></code></pre></div>
<h3 id="设置输入和输出-pts">设置输入和输出 pts<a class="headerlink" href="#设置输入和输出-pts" title="Permanent link">&para;</a></h3>
<p>尝试 cut + reset offset</p>
<ul>
<li>重点在于-itsoffset 是对输入的文件的所有流加上一个偏移</li>
<li>而 output 则是对输出的再加上个偏移</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>ffmpeg -vn -ss 0.613 -itsoffset 0.613 -i ../src.mkv -an -i ../src.mkv -c copy -map 0:a -map 1:v -output_ts_offset -0.613 output_combined.mkv
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>Input #0, matroska,webm, from &#39;output_combined.mkv&#39;:
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a>  Metadata:
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>    ENCODER         : Lavf58.76.100
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a>  Duration: 00:08:40.59, start: 0.000000, bitrate: 24935 kb/s
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a>  Stream #0:0: Audio: aac_latm (LC) ([2][22][0][0] / 0x1602), 48000 Hz, 5.1, fltp (default)
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a>    Metadata:
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a>      DURATION        : 00:08:40.438000000
</span><span id="__span-92-11"><a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a>  Stream #0:1: Video: hevc (Main 10), yuv420p10le(tv, bt2020nc/bt2020/bt2020-10), 3840x2160 [SAR 1:1 DAR 16:9], 59.94 fps, 59.94 tbr, 1k tbn, 59.94 tbc (default)
</span><span id="__span-92-12"><a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a>    Metadata:
</span><span id="__span-92-13"><a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a>      DURATION        : 00:08:40.585000000
</span><span id="__span-92-14"><a id="__codelineno-92-14" name="__codelineno-92-14" href="#__codelineno-92-14"></a>start_pts=55
</span><span id="__span-92-15"><a id="__codelineno-92-15" name="__codelineno-92-15" href="#__codelineno-92-15"></a>start_time=0.055000
</span><span id="__span-92-16"><a id="__codelineno-92-16" name="__codelineno-92-16" href="#__codelineno-92-16"></a>start_pts=0
</span><span id="__span-92-17"><a id="__codelineno-92-17" name="__codelineno-92-17" href="#__codelineno-92-17"></a>start_time=0.000000
</span></code></pre></div>
<p>文件 duration 的不可靠，是包含了 start_pts 的</p>
<ul>
<li><strong>这解释了为什么从 B 站下载的文件，start_pts 变 0 后，为什么 duration 相差很大</strong></li>
<li>相当于 stream 和文件 duration，duration 都是计算最长的？</li>
</ul>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../../../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2022/05/24/2022-05-24-%E4%BD%BF%E7%94%A8docker%E9%85%8D%E7%BD%AEhexo%E5%8D%9A%E5%AE%A2%E7%8E%AF%E5%A2%83/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 使用 docker 配置 hexo 博客环境">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                使用 docker 配置 hexo 博客环境
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2022/07/11/2022-07-11-%E5%8F%B0%E5%BC%8F%E6%9C%BA%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92/" class="md-footer__link md-footer__link--next" aria-label="下一页: 台式机改造计划">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                台式机改造计划
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/TheRainstorm" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>