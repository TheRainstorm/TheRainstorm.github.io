
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
      
      
      
        <link rel="canonical" href="https://yfy.cqu.ai/page/4/">
      
      
      
        <link rel="next" href="../../about/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>博客 - Rain 的随笔</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#博客" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Rain 的随笔" class="md-header__button md-logo" aria-label="Rain 的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rain 的随笔
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              博客
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../archive/2024/" class="md-tabs__link">
          
  
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../category/%E4%B8%AA%E4%BA%BA/" class="md-tabs__link">
          
  
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Rain 的随笔" class="md-nav__button md-logo" aria-label="Rain 的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Rain 的随笔
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="../.." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ucore-mips-代码分析" class="md-nav__link">
    <span class="md-ellipsis">
      ucore-mips 代码分析
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#更新固态之旅" class="md-nav__link">
    <span class="md-ellipsis">
      更新固态之旅
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux-内核设计与实现阅读" class="md-nav__link">
    <span class="md-ellipsis">
      linux 内核设计与实现阅读
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#安装-linux-后的配置" class="md-nav__link">
    <span class="md-ellipsis">
      安装 linux 后的配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wsl-记录" class="md-nav__link">
    <span class="md-ellipsis">
      WSL 记录
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#字体分类" class="md-nav__link">
    <span class="md-ellipsis">
      字体分类
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在虚拟机上搭建-overleaf" class="md-nav__link">
    <span class="md-ellipsis">
      在虚拟机上搭建 overleaf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ucore-lab3-总结" class="md-nav__link">
    <span class="md-ellipsis">
      ucore lab3 总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ucore-lab2-总结" class="md-nav__link">
    <span class="md-ellipsis">
      ucore lab2 总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#关于-2020-到目前的一个总结" class="md-nav__link">
    <span class="md-ellipsis">
      关于 2020 到目前的一个总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#virtual-box-配置双网卡" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual Box 配置双网卡
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#编译原理总结" class="md-nav__link">
    <span class="md-ellipsis">
      编译原理总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloudview-平台运行-bad-apple" class="md-nav__link">
    <span class="md-ellipsis">
      CloudView 平台运行 bad apple
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-dlib-in-c" class="md-nav__link">
    <span class="md-ellipsis">
      Use dlib in C++
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#安装使用-opencvwindows" class="md-nav__link">
    <span class="md-ellipsis">
      安装使用 OpenCV(windows)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#运行-hpl" class="md-nav__link">
    <span class="md-ellipsis">
      运行 HPL
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#记录一次失眠" class="md-nav__link">
    <span class="md-ellipsis">
      记录一次失眠
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#井字棋与最大最小值算法" class="md-nav__link">
    <span class="md-ellipsis">
      井字棋与最大最小值算法
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vacation-routine-asc2020-tips-up-to-0209" class="md-nav__link">
    <span class="md-ellipsis">
      Vacation routine: ASC2020 tips (up to 02/09)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-重装系统步骤" class="md-nav__link">
    <span class="md-ellipsis">
      windows 重装系统步骤
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#安装-centos-虚拟机以及配置-gameboylive-记录" class="md-nav__link">
    <span class="md-ellipsis">
      安装 centos 虚拟机以及配置 gameboy.live 记录
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-报告" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V 报告
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#嵌入式技术基础与实践-第五版" class="md-nav__link">
    <span class="md-ellipsis">
      嵌入式技术基础与实践 第五版
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#非对齐指令总结" class="md-nav__link">
    <span class="md-ellipsis">
      非对齐指令总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-blog-in-pc-through-sshing-to-a-mobile-phone" class="md-nav__link">
    <span class="md-ellipsis">
      write blog in PC through sshing to a mobile phone
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    标签
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    系列
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    分类
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E4%B8%AA%E4%BA%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    个人
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E5%8D%9A%E5%AE%A2--%E7%BD%91%E7%BB%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客 &amp; 网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    学习笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    折腾记录
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    课程笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    软件工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E9%98%85%E8%AF%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    阅读
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="博客">博客<a class="headerlink" href="#博客" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-04-06 22:51:13+00:00">2021年4月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-meta__link">课程笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 17 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ucore-mips-代码分析"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">ucore-mips 代码分析</a></h2>
<div class="toc">
<ul>
<li><a href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#ucore-mips-代码分析">ucore-mips 代码分析</a></li>
</ul>
</div>
<h4 id="1-makefile"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#1-makefile">1. Makefile</a></h4>
<ol>
<li><code>boot/loader.bin</code>基本就是一个读取 elf 的函数，我们上板使用 pmon 加载 ucore，因此用不到。</li>
<li><code>obj/ucore-kernel-initrd</code>是一个 elf 文件，特殊之处在于，它的 data 段包含<code>user/_archive</code>目录下的文件（包含一个 test.txt）和<code>$(USER_APP_BINS)</code>（如 sh, ls 等用户程序）的内容。<strong>将内核和文件系统打包到了一起</strong>。</li>
</ol>
<h4 id="2-kernel_entry"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#2-kernel_entry">2. kernel_entry</a></h4>
<p>kern/init/entry.S</p>
<ol>
<li>
<p>设置了$gp</p>
<p>定义在链接脚本里，可以通过<code>readelf obj/ucore-kernel-initrd -a|grep _gp</code>来查看其值。参考值（修改了代码编译出的值可能不一样）<code>0x800c7f40</code></p>
</li>
<li>
<p>设置了$sp，启动时用的栈，栈大小为<code>KSTACKSIZE</code>，8KB</p>
<p>参考值：<code>bootstacktop(0x80068730)</code>，<code>bootstack(0x80066730)</code></p>
</li>
<li>
<p>设置了 Ebase 为<code>__exception_vector</code>。参考值：<code>0x8002b000</code>。__exception_vector 包含了各异常向量地址的入口。</p>
</li>
</ol>
<h4 id="3-kern_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#3-kern_init">3. kern_init</a></h4>
<p>kern/int/init.c</p>
<h5 id="杂项"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#杂项">杂项</a></h5>
<h6 id="tlb_invalidate_all"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#tlb_invalidate_all">tlb_invalidate_all</a></h6>
<p>定义于 kern/include/thumips_tlb.h 和 kern/mm/thumips_tlb.c</p>
<p>tlb_invalidata_all 循环调用 write_one_tlb 清空 tlb 表项
<strong>默认 tlb 有 128 项</strong>，虽然不会导致错误，但是可以优化</p>
<h6 id="pic_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pic_init">pic_init</a></h6>
<p>定义于 kern/driver/picirq.c
pic_init -&gt; write_c0_status
将 Statu 中的 IM 域全置 0，关闭所有中断。
之后可以通过 pic_enable(int irq) 或 pic_disable(int irq) 开关中断</p>
<h6 id="cons_init--clock_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#cons_init--clock_init">cons_init &amp; clock_init</a></h6>
<p>一个初始化串口，一个初始化时钟中断。</p>
<p>相关宏定义于/kern/include/thumips.h</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a><span class="cp">#define COM1_IRQ        3</span>
</span><span id="__span-152-2"><a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a><span class="cp">#define TIMER0_IRQ       7</span>
</span></code></pre></div>
<p>clock 需要用到<code>cp0_count</code>和<code>cp0_compare</code>
设置 clock 中断后，每<code>clock.c::TIMER0_INTERVAL</code>=1000000 后会产生一个时钟中断</p>
<h6 id="check_initrd"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_initrd">check_initrd</a></h6>
<p>检查内核是否有 initrd，通过判断是否_initrd_begin == _initrd_end)</p>
<h5 id="kprintf"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kprintf">kprintf</a></h5>
<p>内核第一次输出信息</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;(THU.CST) os is loading ...</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-153-2"><a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a><span class="n">kprintf</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span></code></pre></div>
<p>kprintf 函数最后调用串口的 cons_putc 输出字符。串口输出字符采用忙等待方式。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">kprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vkprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">printfmt</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vprintfmt</span><span class="p">(</span><span class="n">cputch</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</span><span id="__span-154-2"><a id="__codelineno-154-2" name="__codelineno-154-2" href="#__codelineno-154-2"></a>
</span><span id="__span-154-3"><a id="__codelineno-154-3" name="__codelineno-154-3" href="#__codelineno-154-3"></a><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cputch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">driver</span><span class="o">/</span><span class="n">console</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cons_putc</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a><span class="cp">#!kern/driver/console.c</span>
</span><span id="__span-155-2"><a id="__codelineno-155-2" name="__codelineno-155-2" href="#__codelineno-155-2"></a>
</span><span id="__span-155-3"><a id="__codelineno-155-3" name="__codelineno-155-3" href="#__codelineno-155-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-155-4"><a id="__codelineno-155-4" name="__codelineno-155-4" href="#__codelineno-155-4"></a><span class="nf">serial_putc_sub</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-155-5"><a id="__codelineno-155-5" name="__codelineno-155-5" href="#__codelineno-155-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">COM1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">COM_LSR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">COM_LSR_TXRDY</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-155-6"><a id="__codelineno-155-6" name="__codelineno-155-6" href="#__codelineno-155-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-155-7"><a id="__codelineno-155-7" name="__codelineno-155-7" href="#__codelineno-155-7"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">COM_TX</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-155-8"><a id="__codelineno-155-8" name="__codelineno-155-8" href="#__codelineno-155-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>作为对比，用户程序 cprintf</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-156-1"><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vcprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vprintfmt</span><span class="p">(</span><span class="n">cputch</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</span><span id="__span-156-2"><a id="__codelineno-156-2" name="__codelineno-156-2" href="#__codelineno-156-2"></a><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cputch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">sys_putc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">syscall</span><span class="p">(</span><span class="n">SYS_putc</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-156-3"><a id="__codelineno-156-3" name="__codelineno-156-3" href="#__codelineno-156-3"></a><span class="n">系统调用</span><span class="err">，</span><span class="n">进入内核</span>
</span><span id="__span-156-4"><a id="__codelineno-156-4" name="__codelineno-156-4" href="#__codelineno-156-4"></a><span class="n">异常处理程序调用kern</span><span class="o">/</span><span class="n">syscall</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">sys_putc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">kputchar</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons_putc</span>
</span></code></pre></div>
<p><strong>用户程序输出每一个字符都会触发一次系统调用</strong></p>
<h5 id="pmm_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pmm_init">pmm_init</a></h5>
<h6 id="page-结构体"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page-结构体">page 结构体</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-157-1"><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-157-2"><a id="__codelineno-157-2" name="__codelineno-157-2" href="#__codelineno-157-2"></a><span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">ref</span><span class="p">;</span><span class="w">                   </span><span class="c1">// page frame&#39;s reference counter</span>
</span><span id="__span-157-3"><a id="__codelineno-157-3" name="__codelineno-157-3" href="#__codelineno-157-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                 </span><span class="c1">// array of flags that describe the status of the page frame</span>
</span><span id="__span-157-4"><a id="__codelineno-157-4" name="__codelineno-157-4" href="#__codelineno-157-4"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">property</span><span class="p">;</span><span class="w">          </span><span class="c1">// used in buddy system, stores the order (the X in 2^X) of the continuous memory block</span>
</span><span id="__span-157-5"><a id="__codelineno-157-5" name="__codelineno-157-5" href="#__codelineno-157-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">zone_num</span><span class="p">;</span><span class="w">                   </span><span class="c1">// used in buddy system, the No. of zone which the page belongs to</span>
</span><span id="__span-157-6"><a id="__codelineno-157-6" name="__codelineno-157-6" href="#__codelineno-157-6"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">page_link</span><span class="p">;</span><span class="w">         </span><span class="c1">// free list link</span>
</span><span id="__span-157-7"><a id="__codelineno-157-7" name="__codelineno-157-7" href="#__codelineno-157-7"></a><span class="c1">//    swap_entry_t index;             // stores a swapped-out page identifier</span>
</span><span id="__span-157-8"><a id="__codelineno-157-8" name="__codelineno-157-8" href="#__codelineno-157-8"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">swap_link</span><span class="p">;</span><span class="w">         </span><span class="c1">// swap hash link</span>
</span><span id="__span-157-9"><a id="__codelineno-157-9" name="__codelineno-157-9" href="#__codelineno-157-9"></a><span class="p">};</span>
</span></code></pre></div>
<p>ucore 将物理内存划分成一个一个的页，并使用 Page 结构体数组来管理。一个 Page 项对应一个物理页。</p>
<p>参考 pmm.c::page_init 代码</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-158-1"><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;memory map:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-158-2"><a id="__codelineno-158-2" name="__codelineno-158-2" href="#__codelineno-158-2"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;    [&quot;</span><span class="p">);</span>
</span><span id="__span-158-3"><a id="__codelineno-158-3" name="__codelineno-158-3" href="#__codelineno-158-3"></a><span class="n">printhex</span><span class="p">(</span><span class="n">KERNBASE</span><span class="p">);</span>
</span><span id="__span-158-4"><a id="__codelineno-158-4" name="__codelineno-158-4" href="#__codelineno-158-4"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
</span><span id="__span-158-5"><a id="__codelineno-158-5" name="__codelineno-158-5" href="#__codelineno-158-5"></a><span class="n">printhex</span><span class="p">(</span><span class="n">KERNTOP</span><span class="p">);</span>
</span><span id="__span-158-6"><a id="__codelineno-158-6" name="__codelineno-158-6" href="#__codelineno-158-6"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-158-7"><a id="__codelineno-158-7" name="__codelineno-158-7" href="#__codelineno-158-7"></a>
</span><span id="__span-158-8"><a id="__codelineno-158-8" name="__codelineno-158-8" href="#__codelineno-158-8"></a><span class="n">maxpa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNTOP</span><span class="p">;</span>
</span><span id="__span-158-9"><a id="__codelineno-158-9" name="__codelineno-158-9" href="#__codelineno-158-9"></a><span class="n">npage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KMEMSIZE</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">;</span>
</span><span id="__span-158-10"><a id="__codelineno-158-10" name="__codelineno-158-10" href="#__codelineno-158-10"></a>
</span><span id="__span-158-11"><a id="__codelineno-158-11" name="__codelineno-158-11" href="#__codelineno-158-11"></a><span class="c1">// end address of kernel</span>
</span><span id="__span-158-12"><a id="__codelineno-158-12" name="__codelineno-158-12" href="#__codelineno-158-12"></a><span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">end</span><span class="p">[];</span>
</span><span id="__span-158-13"><a id="__codelineno-158-13" name="__codelineno-158-13" href="#__codelineno-158-13"></a><span class="c1">// put page structure table at the end of kernel</span>
</span><span id="__span-158-14"><a id="__codelineno-158-14" name="__codelineno-158-14" href="#__codelineno-158-14"></a><span class="n">pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ROUNDUP_2N</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div>
<p><code>KMEMSIZE</code>代表内核管理的物理内存的大小，npage 计算出来为物理页的个数。</p>
<p>end 在链接脚本中定义，为 ucore-kernel-initrd 的结尾。即 ucore 在内核的结尾分配了（直接写）Page 数组的空间，pages 为数组的起始地址。</p>
<p>此时 page 项可以和物理页一一对应起来了</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-159-1"><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">ppn_t</span>
</span><span id="__span-159-2"><a id="__codelineno-159-2" name="__codelineno-159-2" href="#__codelineno-159-2"></a><span class="nf">page2ppn</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-159-3"><a id="__codelineno-159-3" name="__codelineno-159-3" href="#__codelineno-159-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pages</span><span class="p">;</span>
</span><span id="__span-159-4"><a id="__codelineno-159-4" name="__codelineno-159-4" href="#__codelineno-159-4"></a><span class="p">}</span>
</span><span id="__span-159-5"><a id="__codelineno-159-5" name="__codelineno-159-5" href="#__codelineno-159-5"></a>
</span><span id="__span-159-6"><a id="__codelineno-159-6" name="__codelineno-159-6" href="#__codelineno-159-6"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uintptr_t</span>
</span><span id="__span-159-7"><a id="__codelineno-159-7" name="__codelineno-159-7" href="#__codelineno-159-7"></a><span class="nf">page2pa</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-159-8"><a id="__codelineno-159-8" name="__codelineno-159-8" href="#__codelineno-159-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KERNBASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">page2ppn</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-159-9"><a id="__codelineno-159-9" name="__codelineno-159-9" href="#__codelineno-159-9"></a><span class="p">}</span>
</span><span id="__span-159-10"><a id="__codelineno-159-10" name="__codelineno-159-10" href="#__codelineno-159-10"></a>
</span><span id="__span-159-11"><a id="__codelineno-159-11" name="__codelineno-159-11" href="#__codelineno-159-11"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-159-12"><a id="__codelineno-159-12" name="__codelineno-159-12" href="#__codelineno-159-12"></a><span class="n">pa2page</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">pa</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-159-13"><a id="__codelineno-159-13" name="__codelineno-159-13" href="#__codelineno-159-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PPN</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">npage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-159-14"><a id="__codelineno-159-14" name="__codelineno-159-14" href="#__codelineno-159-14"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;pa2page called with invalid pa&quot;</span><span class="p">);</span>
</span><span id="__span-159-15"><a id="__codelineno-159-15" name="__codelineno-159-15" href="#__codelineno-159-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-159-16"><a id="__codelineno-159-16" name="__codelineno-159-16" href="#__codelineno-159-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pages</span><span class="p">[</span><span class="n">PPN</span><span class="p">(</span><span class="n">pa</span><span class="p">)];</span>
</span><span id="__span-159-17"><a id="__codelineno-159-17" name="__codelineno-159-17" href="#__codelineno-159-17"></a><span class="p">}</span>
</span><span id="__span-159-18"><a id="__codelineno-159-18" name="__codelineno-159-18" href="#__codelineno-159-18"></a>
</span><span id="__span-159-19"><a id="__codelineno-159-19" name="__codelineno-159-19" href="#__codelineno-159-19"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-159-20"><a id="__codelineno-159-20" name="__codelineno-159-20" href="#__codelineno-159-20"></a><span class="n">page2kva</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-159-21"><a id="__codelineno-159-21" name="__codelineno-159-21" href="#__codelineno-159-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KADDR</span><span class="p">(</span><span class="n">page2pa</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
</span><span id="__span-159-22"><a id="__codelineno-159-22" name="__codelineno-159-22" href="#__codelineno-159-22"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里强调一下<code>page2kva</code>中<code>KADDR</code>的作用，事实上如果看其定义的话，KADDR(pa) 的值和 pa 是一样的，如下</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-160-1"><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a><span class="cm">/* *</span>
</span><span id="__span-160-2"><a id="__codelineno-160-2" name="__codelineno-160-2" href="#__codelineno-160-2"></a><span class="cm"> * PADDR - takes a kernel virtual address (an address that points above KERNBASE),</span>
</span><span id="__span-160-3"><a id="__codelineno-160-3" name="__codelineno-160-3" href="#__codelineno-160-3"></a><span class="cm"> * where the machine&#39;s maximum 256MB of physical memory is mapped and returns the</span>
</span><span id="__span-160-4"><a id="__codelineno-160-4" name="__codelineno-160-4" href="#__codelineno-160-4"></a><span class="cm"> * corresponding physical address.  It panics if you pass it a non-kernel virtual address.</span>
</span><span id="__span-160-5"><a id="__codelineno-160-5" name="__codelineno-160-5" href="#__codelineno-160-5"></a><span class="cm"> * */</span>
</span><span id="__span-160-6"><a id="__codelineno-160-6" name="__codelineno-160-6" href="#__codelineno-160-6"></a><span class="cp">#define PADDR(kva) ({                                                   \</span>
</span><span id="__span-160-7"><a id="__codelineno-160-7" name="__codelineno-160-7" href="#__codelineno-160-7"></a><span class="cp">            uintptr_t __m_kva = (uintptr_t)(kva);                       \</span>
</span><span id="__span-160-8"><a id="__codelineno-160-8" name="__codelineno-160-8" href="#__codelineno-160-8"></a><span class="cp">            if (__m_kva &lt; KERNBASE) {                                   \</span>
</span><span id="__span-160-9"><a id="__codelineno-160-9" name="__codelineno-160-9" href="#__codelineno-160-9"></a><span class="cp">                panic(&quot;PADDR called with invalid kva %08lx&quot;, __m_kva);  \</span>
</span><span id="__span-160-10"><a id="__codelineno-160-10" name="__codelineno-160-10" href="#__codelineno-160-10"></a><span class="cp">            }                                                           \</span>
</span><span id="__span-160-11"><a id="__codelineno-160-11" name="__codelineno-160-11" href="#__codelineno-160-11"></a><span class="cp">            __m_kva ;                                         \</span>
</span><span id="__span-160-12"><a id="__codelineno-160-12" name="__codelineno-160-12" href="#__codelineno-160-12"></a><span class="cp">        })</span>
</span><span id="__span-160-13"><a id="__codelineno-160-13" name="__codelineno-160-13" href="#__codelineno-160-13"></a>
</span><span id="__span-160-14"><a id="__codelineno-160-14" name="__codelineno-160-14" href="#__codelineno-160-14"></a><span class="cm">/* *</span>
</span><span id="__span-160-15"><a id="__codelineno-160-15" name="__codelineno-160-15" href="#__codelineno-160-15"></a><span class="cm"> * KADDR - takes a physical address and returns the corresponding kernel virtual</span>
</span><span id="__span-160-16"><a id="__codelineno-160-16" name="__codelineno-160-16" href="#__codelineno-160-16"></a><span class="cm"> * address. It panics if you pass an invalid physical address.</span>
</span><span id="__span-160-17"><a id="__codelineno-160-17" name="__codelineno-160-17" href="#__codelineno-160-17"></a><span class="cm"> * */</span>
</span><span id="__span-160-18"><a id="__codelineno-160-18" name="__codelineno-160-18" href="#__codelineno-160-18"></a><span class="cp">#define KADDR(pa) ({                                                    \</span>
</span><span id="__span-160-19"><a id="__codelineno-160-19" name="__codelineno-160-19" href="#__codelineno-160-19"></a><span class="cp">            uintptr_t __m_pa = (pa);                                    \</span>
</span><span id="__span-160-20"><a id="__codelineno-160-20" name="__codelineno-160-20" href="#__codelineno-160-20"></a><span class="cp">            size_t __m_ppn = PPN(__m_pa);                               \</span>
</span><span id="__span-160-21"><a id="__codelineno-160-21" name="__codelineno-160-21" href="#__codelineno-160-21"></a><span class="cp">            if (__m_ppn &gt;= npage) {                                     \</span>
</span><span id="__span-160-22"><a id="__codelineno-160-22" name="__codelineno-160-22" href="#__codelineno-160-22"></a><span class="cp">                panic(&quot;KADDR called with invalid pa %08lx&quot;, __m_pa);    \</span>
</span><span id="__span-160-23"><a id="__codelineno-160-23" name="__codelineno-160-23" href="#__codelineno-160-23"></a><span class="cp">            }                                                           \</span>
</span><span id="__span-160-24"><a id="__codelineno-160-24" name="__codelineno-160-24" href="#__codelineno-160-24"></a><span class="cp">            (void *) (__m_pa);                               \</span>
</span><span id="__span-160-25"><a id="__codelineno-160-25" name="__codelineno-160-25" href="#__codelineno-160-25"></a><span class="cp">        })</span>
</span></code></pre></div>
<p>而之所以需要进行一次转换，主要是保持逻辑上的一致性。因为 CPU 直接发出的地址都是虚拟地址，会经过 MMU 进行虚拟地址转换（一般基于 TLB，而 TLB 基于操作系统管理的页表）。整个转换过程是硬件自动完成的，因此软件基本不用和物理地址打交道（操作系统中涉及到和硬件软硬件协同的部分会涉及到物理地址，如页表中存储的地址是物理地址，当 MIPS 中 tlb refill 异常时，便会读取页表项加载到 TLB 表项中）</p>
<p>因而我们在代码中访问数据时都要使用虚拟地址。</p>
<p>因为这里的整个内核虚拟空间（<code>[KERNBASE, KERNBASE+KMEMSIZE]=[0x8000_0000, 0x8200_0000)</code>）都位于 MIPS 中的 kseg0 段，而该段采用固定地址映射的方式，而不使用 TLB，因此内核访问整个内核虚拟地址空间丝毫不用担心。</p>
<h6 id="这里应该有一个错误"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#这里应该有一个错误">这里应该有一个错误</a></h6>
<p>按照定义来说，page2pa 就应该是 (page2ppn(page) &lt;&lt; PGSHIFT)，加了 KERNBASE 后反而是虚拟地址了。</p>
<p>不过因为 KADDR 也错了，因此当我们分配了一个空闲物理页 page 后，要获得其虚拟地址</p>
<p><code>KADDR(page2pa(page))</code>反而没错了</p>
<h6 id="空闲页"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#空闲页">空闲页</a></h6>
<p>空闲地址开始于 Page 数组之后。init_memmap 会调用 pmm_manager 的 init_memmap 函数，用于记录哪些页是空闲的。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-161-1"><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">freemem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PADDR</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">pages</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">npage</span><span class="p">);</span>
</span><span id="__span-161-2"><a id="__codelineno-161-2" name="__codelineno-161-2" href="#__codelineno-161-2"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;freemem start at: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">freemem</span><span class="p">);</span>
</span><span id="__span-161-3"><a id="__codelineno-161-3" name="__codelineno-161-3" href="#__codelineno-161-3"></a>
</span><span id="__span-161-4"><a id="__codelineno-161-4" name="__codelineno-161-4" href="#__codelineno-161-4"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mbegin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDUP_2N</span><span class="p">(</span><span class="n">freemem</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-161-5"><a id="__codelineno-161-5" name="__codelineno-161-5" href="#__codelineno-161-5"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">KERNTOP</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-161-6"><a id="__codelineno-161-6" name="__codelineno-161-6" href="#__codelineno-161-6"></a><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">mbegin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mend</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-161-7"><a id="__codelineno-161-7" name="__codelineno-161-7" href="#__codelineno-161-7"></a><span class="n">init_memmap</span><span class="p">(</span><span class="n">pa2page</span><span class="p">(</span><span class="n">mbegin</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">mend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mbegin</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-161-8"><a id="__codelineno-161-8" name="__codelineno-161-8" href="#__codelineno-161-8"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;free pages: &quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mend</span><span class="o">-</span><span class="n">mbegin</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-161-9"><a id="__codelineno-161-9" name="__codelineno-161-9" href="#__codelineno-161-9"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;## &quot;</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="p">));</span>
</span></code></pre></div>
<h6 id="pmm_manager"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pmm_manager">pmm_manager</a></h6>
<p>物理内存管理其实就是要实现<strong>物理空闲页</strong>的分配和回收，ucore 定义了 pmm_manager 的结构体，可以认为 C 中实现的类。</p>
<p>关键的两个函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-162-1"><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc_pages</span><span class="p">)(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-162-2"><a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">free_pages</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span></code></pre></div>
<p>alloc_pages 从空闲页中分配了一段连续的空闲页</p>
<p>而 free_pages 则将指定的一段连续的页重新回收为空闲页</p>
<p>ucore 代码实现了伙伴分配系统 (buddy system)，可以参考其具体实现</p>
<h6 id="页表相关函数"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#页表相关函数">页表相关函数</a></h6>
<p>ucore 实现了二级页表</p>
<p>关键函数</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-163-1"><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="nf">get_pte</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">create</span><span class="p">);</span>
</span><span id="__span-163-2"><a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">get_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">pte_t</span><span class="w"> </span><span class="o">**</span><span class="n">ptep_store</span><span class="p">);</span><span class="w"> </span><span class="c1">//根据 pte 的值获得对应的 page</span>
</span><span id="__span-163-3"><a id="__codelineno-163-3" name="__codelineno-163-3" href="#__codelineno-163-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">page_remove</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">);</span>
</span><span id="__span-163-4"><a id="__codelineno-163-4" name="__codelineno-163-4" href="#__codelineno-163-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">page_insert</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
</span><span id="__span-163-5"><a id="__codelineno-163-5" name="__codelineno-163-5" href="#__codelineno-163-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="get_pte"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#get_pte">get_pte</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-164-1"><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_pte</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">create</span><span class="p">)</span>
</span></code></pre></div>
<p>函数作用：给定页目录表的虚拟地址，查找虚拟地址 la 对应的页表项 pte。（只要 la 在一个页内，返回的 pte 是相同的）
 注：获得的是 pte 项的<strong>虚拟地址</strong>
过程：</p>
<ol>
<li>
<p>先计算页目录表中对应 pde 表项的虚拟地址</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-165-1"><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a><span class="n">pdep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PDX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>如果 pde 项有效，即<code>((*pdep)&amp;PTE_P) == 0</code>。直接访问 pde 获得 la 对应二级页表的物理地址。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-166-1"><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>计算二级页表中对应页表项 pte 的<strong>物理</strong>地址</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-167-1"><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)(</span><span class="w">    </span><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">)</span><span class="w">   </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PTX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>转换成虚拟地址</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-168-1"><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)</span><span class="n">KADDR</span><span class="p">(</span><span class="w">   </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="w">  </span><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)(</span><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">))</span><span class="o">+</span><span class="n">PTX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="w">  </span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>如果 02 中无效，则需要根据 create 决定是否创建二级页表。（下面代码只考虑了创建情形，并为了突出重点，删减了许多有用的代码）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-169-1"><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="o">*</span><span class="w"> </span><span class="n">new_pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">();</span>
</span><span id="__span-169-2"><a id="__codelineno-169-2" name="__codelineno-169-2" href="#__codelineno-169-2"></a>
</span><span id="__span-169-3"><a id="__codelineno-169-3" name="__codelineno-169-3" href="#__codelineno-169-3"></a><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">page2kva</span><span class="p">(</span><span class="n">new_pte</span><span class="p">);</span>
</span><span id="__span-169-4"><a id="__codelineno-169-4" name="__codelineno-169-4" href="#__codelineno-169-4"></a><span class="o">*</span><span class="n">pdep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PADDR</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
</span></code></pre></div>
<p>最后一行，页表中存储的是物理地址。然而根据之前的分析，我们知道上面代码中的 PADDR(pa) 实际上是虚拟地址。然而我们发现在这样设置之后，下次调用 get_pte 时，获得的 pte 的地址确实是虚拟地址（KADDR 不产生作用）。</p>
</li>
</ol>
<h6 id="page_insert"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page_insert">page_insert</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-170-1"><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">page_insert</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span>
</span></code></pre></div>
<p>作用：将虚拟地址 la 映射到 page 对应的物理页上</p>
<p>步骤：</p>
<ol>
<li>
<p>根据虚拟地址 la 查找到二级页表项 ptep</p>
</li>
<li>
<p>如果原本 ptep 已经映射到另一个物理页上了，则删除该映射（有可能导致回收物理页）</p>
</li>
<li>
<p>设置 ptep 映射到新物理页</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-171-1"><a id="__codelineno-171-1" name="__codelineno-171-1" href="#__codelineno-171-1"></a>*ptep = page2pa(page) | PTE_P | perm;
</span></code></pre></div>
<p>由以上代码，可以看到二级页表项中存储的地址其实是虚拟地址。</p>
</li>
</ol>
<h6 id="page_remove"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page_remove">page_remove</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-172-1"><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">page_remove</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span></code></pre></div>
<p>作用：解除 pgdir 中虚拟地址 la 的映射</p>
<p>步骤：</p>
<ol>
<li>
<p>获得 pte</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-173-1"><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>如果<code>ptep != NULL</code>且<code>*ptep &amp; PTE_P</code>，</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-174-1"><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte2page</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
</span><span id="__span-174-2"><a id="__codelineno-174-2" name="__codelineno-174-2" href="#__codelineno-174-2"></a><span class="n">page_ref_dec</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span><span id="__span-174-3"><a id="__codelineno-174-3" name="__codelineno-174-3" href="#__codelineno-174-3"></a><span class="c1">// and free it when reach 0</span>
</span><span id="__span-174-4"><a id="__codelineno-174-4" name="__codelineno-174-4" href="#__codelineno-174-4"></a><span class="k">if</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-174-5"><a id="__codelineno-174-5" name="__codelineno-174-5" href="#__codelineno-174-5"></a><span class="w">    </span><span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span><span id="__span-174-6"><a id="__codelineno-174-6" name="__codelineno-174-6" href="#__codelineno-174-6"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>清除映射</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-175-1"><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
</li>
</ol>
<h6 id="pgdir_alloc_page"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pgdir_alloc_page">pgdir_alloc_page</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-176-1"><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span>
</span></code></pre></div>
<p>作用：该函数分配一个物理页，并将 la 对应的虚拟页，映射到该物理页</p>
<h6 id="check"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check">check</a></h6>
<h6 id="check_pgdir"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_pgdir">check_pgdir</a></h6>
<ol>
<li>将虚拟地址 0x0 映射到一个物理页 (随便分配一个 page, p1) 上。</li>
<li>将虚拟地址 0x1000(PAGESIZE) 映射到一个物理页 (随便分配一个 page, p2)。</li>
<li>将 0x1000 重新映射到 p1.
   ......
   主要是检查了 page_insert, page_remove 等函数的正确性。</li>
</ol>
<h6 id="check_boot_pgdirtlb-refill-处理"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_boot_pgdirtlb-refill-处理">check_boot_pgdir（tlb refill 处理)</a></h6>
<ol>
<li>
<p>分配一个物理页，并写入初始值</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-177-1"><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-177-2"><a id="__codelineno-177-2" name="__codelineno-177-2" href="#__codelineno-177-2"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">();</span>
</span><span id="__span-177-3"><a id="__codelineno-177-3" name="__codelineno-177-3" href="#__codelineno-177-3"></a><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x100</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1234</span><span class="p">;</span>
</span></code></pre></div>
</li>
<li>
<p>将两个虚拟页映射到该物理页上</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-178-1"><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_insert</span><span class="p">(</span><span class="n">boot_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mh">0x100</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-178-2"><a id="__codelineno-178-2" name="__codelineno-178-2" href="#__codelineno-178-2"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-178-3"><a id="__codelineno-178-3" name="__codelineno-178-3" href="#__codelineno-178-3"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_insert</span><span class="p">(</span><span class="n">boot_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mh">0x100</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-178-4"><a id="__codelineno-178-4" name="__codelineno-178-4" href="#__codelineno-178-4"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>直接使用虚拟地址访问该物理页，引发 tlb refill 异常</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-179-1"><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a><span class="n">assert</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0x100</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x1234</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>进入对应异常处理程序</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-180-1"><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handle_tlbmiss</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="o">*</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">write</span><span class="p">)</span>
</span><span id="__span-180-2"><a id="__codelineno-180-2" name="__codelineno-180-2" href="#__codelineno-180-2"></a><span class="p">{</span>
</span><span id="__span-180-3"><a id="__codelineno-180-3" name="__codelineno-180-3" href="#__codelineno-180-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">in_kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trap_in_kernel</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-180-4"><a id="__codelineno-180-4" name="__codelineno-180-4" href="#__codelineno-180-4"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">current_pgdir</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-180-5"><a id="__codelineno-180-5" name="__codelineno-180-5" href="#__codelineno-180-5"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">badaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">;</span>
</span><span id="__span-180-6"><a id="__codelineno-180-6" name="__codelineno-180-6" href="#__codelineno-180-6"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-180-7"><a id="__codelineno-180-7" name="__codelineno-180-7" href="#__codelineno-180-7"></a><span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">current_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-180-8"><a id="__codelineno-180-8" name="__codelineno-180-8" href="#__codelineno-180-8"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="o">==</span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ptep_invalid</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span><span class="w">   </span><span class="c1">//PTE miss, pgfault</span>
</span><span id="__span-180-9"><a id="__codelineno-180-9" name="__codelineno-180-9" href="#__codelineno-180-9"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;## pagefault in kernel, badaddr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">);</span>
</span><span id="__span-180-10"><a id="__codelineno-180-10" name="__codelineno-180-10" href="#__codelineno-180-10"></a><span class="w">    </span><span class="c1">//tlb will not be refill in do_pgfault,</span>
</span><span id="__span-180-11"><a id="__codelineno-180-11" name="__codelineno-180-11" href="#__codelineno-180-11"></a><span class="w">    </span><span class="c1">//so a vmm pgfault will trigger 2 exception</span>
</span><span id="__span-180-12"><a id="__codelineno-180-12" name="__codelineno-180-12" href="#__codelineno-180-12"></a><span class="w">    </span><span class="c1">//permission check in tlb miss</span>
</span><span id="__span-180-13"><a id="__codelineno-180-13" name="__codelineno-180-13" href="#__codelineno-180-13"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgfault_handler</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">get_error_code</span><span class="p">(</span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">));</span>
</span><span id="__span-180-14"><a id="__codelineno-180-14" name="__codelineno-180-14" href="#__codelineno-180-14"></a><span class="w">  </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"> </span><span class="c1">//tlb miss only, reload it</span>
</span><span id="__span-180-15"><a id="__codelineno-180-15" name="__codelineno-180-15" href="#__codelineno-180-15"></a><span class="w">    </span><span class="cm">/* refill two slot */</span>
</span><span id="__span-180-16"><a id="__codelineno-180-16" name="__codelineno-180-16" href="#__codelineno-180-16"></a><span class="w">    </span><span class="cm">/* check permission */</span>
</span><span id="__span-180-17"><a id="__codelineno-180-17" name="__codelineno-180-17" href="#__codelineno-180-17"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">in_kernel</span><span class="p">){</span>
</span><span id="__span-180-18"><a id="__codelineno-180-18" name="__codelineno-180-18" href="#__codelineno-180-18"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;## tlb refill in kernel, badaddr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">);</span>
</span><span id="__span-180-19"><a id="__codelineno-180-19" name="__codelineno-180-19" href="#__codelineno-180-19"></a><span class="w">      </span><span class="n">tlb_refill</span><span class="p">(</span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-180-20"><a id="__codelineno-180-20" name="__codelineno-180-20" href="#__codelineno-180-20"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-180-21"><a id="__codelineno-180-21" name="__codelineno-180-21" href="#__codelineno-180-21"></a><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-180-22"><a id="__codelineno-180-22" name="__codelineno-180-22" href="#__codelineno-180-22"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ptep_u_read</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span>
</span><span id="__span-180-23"><a id="__codelineno-180-23" name="__codelineno-180-23" href="#__codelineno-180-23"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-180-24"><a id="__codelineno-180-24" name="__codelineno-180-24" href="#__codelineno-180-24"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
</span><span id="__span-180-25"><a id="__codelineno-180-25" name="__codelineno-180-25" href="#__codelineno-180-25"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-180-26"><a id="__codelineno-180-26" name="__codelineno-180-26" href="#__codelineno-180-26"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">ptep_u_write</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span>
</span><span id="__span-180-27"><a id="__codelineno-180-27" name="__codelineno-180-27" href="#__codelineno-180-27"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
</span><span id="__span-180-28"><a id="__codelineno-180-28" name="__codelineno-180-28" href="#__codelineno-180-28"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
</span><span id="__span-180-29"><a id="__codelineno-180-29" name="__codelineno-180-29" href="#__codelineno-180-29"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-180-30"><a id="__codelineno-180-30" name="__codelineno-180-30" href="#__codelineno-180-30"></a><span class="w">    </span><span class="c1">//kprintf(&quot;## refill U %d %08x\n&quot;, write, badaddr);</span>
</span><span id="__span-180-31"><a id="__codelineno-180-31" name="__codelineno-180-31" href="#__codelineno-180-31"></a><span class="w">      </span><span class="n">tlb_refill</span><span class="p">(</span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">);</span>
</span><span id="__span-180-32"><a id="__codelineno-180-32" name="__codelineno-180-32" href="#__codelineno-180-32"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-180-33"><a id="__codelineno-180-33" name="__codelineno-180-33" href="#__codelineno-180-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-180-34"><a id="__codelineno-180-34" name="__codelineno-180-34" href="#__codelineno-180-34"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-180-35"><a id="__codelineno-180-35" name="__codelineno-180-35" href="#__codelineno-180-35"></a>
</span><span id="__span-180-36"><a id="__codelineno-180-36" name="__codelineno-180-36" href="#__codelineno-180-36"></a><span class="nl">exit</span><span class="p">:</span>
</span><span id="__span-180-37"><a id="__codelineno-180-37" name="__codelineno-180-37" href="#__codelineno-180-37"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">){</span>
</span><span id="__span-180-38"><a id="__codelineno-180-38" name="__codelineno-180-38" href="#__codelineno-180-38"></a><span class="w">    </span><span class="n">print_trapframe</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-180-39"><a id="__codelineno-180-39" name="__codelineno-180-39" href="#__codelineno-180-39"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">in_kernel</span><span class="p">){</span>
</span><span id="__span-180-40"><a id="__codelineno-180-40" name="__codelineno-180-40" href="#__codelineno-180-40"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;unhandled pgfault&quot;</span><span class="p">);</span>
</span><span id="__span-180-41"><a id="__codelineno-180-41" name="__codelineno-180-41" href="#__codelineno-180-41"></a><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-180-42"><a id="__codelineno-180-42" name="__codelineno-180-42" href="#__codelineno-180-42"></a><span class="w">      </span><span class="n">do_exit</span><span class="p">(</span><span class="o">-</span><span class="n">E_KILLED</span><span class="p">);</span>
</span><span id="__span-180-43"><a id="__codelineno-180-43" name="__codelineno-180-43" href="#__codelineno-180-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-180-44"><a id="__codelineno-180-44" name="__codelineno-180-44" href="#__codelineno-180-44"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-180-45"><a id="__codelineno-180-45" name="__codelineno-180-45" href="#__codelineno-180-45"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-180-46"><a id="__codelineno-180-46" name="__codelineno-180-46" href="#__codelineno-180-46"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>
<p>首先判断是否在内核中发生了异常，这里通过 Status.KSU 位来判断，2'b00 表示 kernel mode，2'b10 表示 user mode。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-181-1"><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a><span class="kt">bool</span>
</span><span id="__span-181-2"><a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a><span class="nf">trap_in_kernel</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-181-3"><a id="__codelineno-181-3" name="__codelineno-181-3" href="#__codelineno-181-3"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KSU_USER</span><span class="p">);</span>
</span><span id="__span-181-4"><a id="__codelineno-181-4" name="__codelineno-181-4" href="#__codelineno-181-4"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>然后获得 pte</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-182-1"><a id="__codelineno-182-1" name="__codelineno-182-1" href="#__codelineno-182-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">current_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>之后进入 tlb_refill 函数，tlb_refill 执行 tlbwr，从 pte 读取映射的物理页号写入到 tlb 项中。（一次映射两页）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-183-1"><a id="__codelineno-183-1" name="__codelineno-183-1" href="#__codelineno-183-1"></a><span class="n">tlb_replace_random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">THUMIPS_TLB_ENTRYH_VPN2_MASK</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-183-2"><a id="__codelineno-183-2" name="__codelineno-183-2" href="#__codelineno-183-2"></a><span class="w">      </span><span class="n">pte2tlblow</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">),</span><span class="w"> </span><span class="n">pte2tlblow</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pte</span><span class="o">+</span><span class="mi">1</span><span class="p">)));</span>
</span></code></pre></div>
</li>
</ol>
</li>
</ol>
<p>终端输出</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-184-1"><a id="__codelineno-184-1" name="__codelineno-184-1" href="#__codelineno-184-1"></a>## tlb refill in kernel, badaddr: 0x100
</span><span id="__span-184-2"><a id="__codelineno-184-2" name="__codelineno-184-2" href="#__codelineno-184-2"></a>check_boot_pgdir() succeeded!
</span></code></pre></div>
<h6 id="kmalloc"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kmalloc">kmalloc</a></h6>
<p>pmm_init 中还调用了 kmalloc_init。</p>
<p>kmalloc 中主要实现了以下关键函数</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-185-1"><a id="__codelineno-185-1" name="__codelineno-185-1" href="#__codelineno-185-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">kmalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-185-2"><a id="__codelineno-185-2" name="__codelineno-185-2" href="#__codelineno-185-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kfree</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">objp</span><span class="p">);</span>
</span></code></pre></div>
<p>可以看到 kmalloc 函数的参数为字节数，返回值为分配的物理内存的虚拟起始地址。</p>
<p>kmalloc 利用到了 slab 机制</p>
<blockquote>
<p>slab 是 Linux 操作系统的一种内存分配机制。其工作是针对一些经常分配并释放的对象，如进程描述符等，这些对象的大小一般比较小，如果直接采用伙伴系统来进行分配和释放，不仅会造成大量的内存碎片，而且处理速度也太慢。而 slab 分配器是基于对象进行管理的，相同类型的对象归为一类 (如进程描述符就是一类)，每当要申请这样一个对象，slab 分配器就从一个 slab 列表中分配一个这样大小的单元出去，而当要释放时，将其重新保存在该列表中，而不是直接返回给伙伴系统，从而避免这些内碎片。</p>
</blockquote>
<h5 id="vmm_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#vmm_init">vmm_init</a></h5>
<p>通过内存地址虚拟化，可以使得软件在没有访问某虚拟内存地址时不分配具体的物理理内存，而只有在实际访问某虚拟内存地址时，操作系统再动态地分配物理内存，建立虚拟内存到物理理内存的页映射关系，这种技术称为按需分页（demand paging）。把不不经常访问的数据所占的内存空间临时写到硬盘上，这样可以腾出更更多的空闲内存空间
给经常访问的数据；当 CPU 访问到不不经常访问的数据时，再把这些数据从硬盘读入到内存中。这种技术称为页换入换出 (page in/out)</p>
<h6 id="vma_struct"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#vma_struct">vma_struct</a></h6>
<p>vma 用于描述进程对虚拟内存的需求</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-186-1"><a id="__codelineno-186-1" name="__codelineno-186-1" href="#__codelineno-186-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-186-2"><a id="__codelineno-186-2" name="__codelineno-186-2" href="#__codelineno-186-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vm_mm</span><span class="p">;</span><span class="w"> </span><span class="c1">// the set of vma using the same PDT </span>
</span><span id="__span-186-3"><a id="__codelineno-186-3" name="__codelineno-186-3" href="#__codelineno-186-3"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_start</span><span class="p">;</span><span class="w">      </span><span class="c1">// start addr of vma </span>
</span><span id="__span-186-4"><a id="__codelineno-186-4" name="__codelineno-186-4" href="#__codelineno-186-4"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_end</span><span class="p">;</span><span class="w">        </span><span class="c1">// end addr of vma</span>
</span><span id="__span-186-5"><a id="__codelineno-186-5" name="__codelineno-186-5" href="#__codelineno-186-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span><span class="w">       </span><span class="c1">// flags of vma</span>
</span><span id="__span-186-6"><a id="__codelineno-186-6" name="__codelineno-186-6" href="#__codelineno-186-6"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">list_link</span><span class="p">;</span><span class="w">  </span><span class="c1">// linear list link which sorted by start addr of vma</span>
</span><span id="__span-186-7"><a id="__codelineno-186-7" name="__codelineno-186-7" href="#__codelineno-186-7"></a><span class="p">};</span>
</span></code></pre></div>
<p>vma 指示了一段连续的虚拟内存空间，不同 vma 通过 list_link 相连，共同表示一个进程的虚拟内存空间。</p>
<h6 id="mm_struct"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#mm_struct">mm_struct</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-187-1"><a id="__codelineno-187-1" name="__codelineno-187-1" href="#__codelineno-187-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-187-2"><a id="__codelineno-187-2" name="__codelineno-187-2" href="#__codelineno-187-2"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">mmap_list</span><span class="p">;</span><span class="w">        </span><span class="c1">// linear list link which sorted by start addr of vma</span>
</span><span id="__span-187-3"><a id="__codelineno-187-3" name="__codelineno-187-3" href="#__codelineno-187-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mmap_cache</span><span class="p">;</span><span class="w"> </span><span class="c1">// current accessed vma, used for speed purpose</span>
</span><span id="__span-187-4"><a id="__codelineno-187-4" name="__codelineno-187-4" href="#__codelineno-187-4"></a><span class="w">    </span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">;</span><span class="w">                  </span><span class="c1">// the PDT of these vma</span>
</span><span id="__span-187-5"><a id="__codelineno-187-5" name="__codelineno-187-5" href="#__codelineno-187-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">map_count</span><span class="p">;</span><span class="w">                 </span><span class="c1">// the count of these vma</span>
</span><span id="__span-187-6"><a id="__codelineno-187-6" name="__codelineno-187-6" href="#__codelineno-187-6"></a><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sm_priv</span><span class="p">;</span><span class="w">       </span><span class="c1">// the private data for swap manager</span>
</span><span id="__span-187-7"><a id="__codelineno-187-7" name="__codelineno-187-7" href="#__codelineno-187-7"></a><span class="w"> </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">mm_count</span><span class="p">;</span>
</span><span id="__span-187-8"><a id="__codelineno-187-8" name="__codelineno-187-8" href="#__codelineno-187-8"></a><span class="w"> </span><span class="n">semaphore_t</span><span class="w"> </span><span class="n">mm_sem</span><span class="p">;</span>
</span><span id="__span-187-9"><a id="__codelineno-187-9" name="__codelineno-187-9" href="#__codelineno-187-9"></a><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">locked_by</span><span class="p">;</span>
</span><span id="__span-187-10"><a id="__codelineno-187-10" name="__codelineno-187-10" href="#__codelineno-187-10"></a><span class="p">};</span>
</span></code></pre></div>
<p>mm_struct 用于管理一系列使用同一个页目录表的 vma 的集合。</p>
<p>进程控制块中包含一个 mm_struct 的指针，用于管理该进程的虚拟内存空间</p>
<h6 id="关键函数"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#关键函数">关键函数</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-188-1"><a id="__codelineno-188-1" name="__codelineno-188-1" href="#__codelineno-188-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">find_vma</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-188-2"><a id="__codelineno-188-2" name="__codelineno-188-2" href="#__codelineno-188-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma_create</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_start</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_end</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">);</span>
</span><span id="__span-188-3"><a id="__codelineno-188-3" name="__codelineno-188-3" href="#__codelineno-188-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">insert_vma_struct</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="check_pgfaultpagefault-的处理"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_pgfaultpagefault-的处理">check_pgfault（pagefault 的处理）</a></h6>
<ol>
<li>
<p>创建 mm_struct</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-189-1"><a id="__codelineno-189-1" name="__codelineno-189-1" href="#__codelineno-189-1"></a><span class="n">check_mm_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create</span><span class="p">();</span>
</span></code></pre></div>
<p>这里的<code>check_mm_struct</code>为全局变量</p>
</li>
<li>
<p>分配[0, PTSIZE]的虚拟内存</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-190-1"><a id="__codelineno-190-1" name="__codelineno-190-1" href="#__codelineno-190-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma_create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PTSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">);</span><span class="w"> </span><span class="c1">//如果该成 VM_READ，之后在 do_pgfault 便会通不过权限检查。</span>
</span><span id="__span-190-2"><a id="__codelineno-190-2" name="__codelineno-190-2" href="#__codelineno-190-2"></a><span class="n">insert_vma_struct</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>访问 0x100</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-191-1"><a id="__codelineno-191-1" name="__codelineno-191-1" href="#__codelineno-191-1"></a><span class="w">  </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100</span><span class="p">;</span>
</span><span id="__span-191-2"><a id="__codelineno-191-2" name="__codelineno-191-2" href="#__codelineno-191-2"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vma</span><span class="p">);</span>
</span><span id="__span-191-3"><a id="__codelineno-191-3" name="__codelineno-191-3" href="#__codelineno-191-3"></a>
</span><span id="__span-191-4"><a id="__codelineno-191-4" name="__codelineno-191-4" href="#__codelineno-191-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-191-5"><a id="__codelineno-191-5" name="__codelineno-191-5" href="#__codelineno-191-5"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-191-6"><a id="__codelineno-191-6" name="__codelineno-191-6" href="#__codelineno-191-6"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">    </span><span class="c1">//page fault</span>
</span><span id="__span-191-7"><a id="__codelineno-191-7" name="__codelineno-191-7" href="#__codelineno-191-7"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-191-8"><a id="__codelineno-191-8" name="__codelineno-191-8" href="#__codelineno-191-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-191-9"><a id="__codelineno-191-9" name="__codelineno-191-9" href="#__codelineno-191-9"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-191-10"><a id="__codelineno-191-10" name="__codelineno-191-10" href="#__codelineno-191-10"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-191-11"><a id="__codelineno-191-11" name="__codelineno-191-11" href="#__codelineno-191-11"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-191-12"><a id="__codelineno-191-12" name="__codelineno-191-12" href="#__codelineno-191-12"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">sum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>触发 tlb refill 异常。（实际为 pagefault，此时页表中没有该映射，因此 tlb 中也没有该项）</p>
<p>参考之前 tlb refill 异常处理的代码，进入 pgfault_handler</p>
<p>1. 首先通过判断 check_mm_struct 非空，知道是在执行 check_pgfault 函数，将 mm 设置为 check_mm_struct
  2. 在 do_pgfault 中首先调用 find_vma 函数，确定该虚拟地址是有效的
  3. 然后检查该地址访问权限是否正确（如果将
  4. 都通过了后，调用 pgdir_alloc_page，直接分配一个物理页，并在 mm-&gt;pgdir 中插入映射关系。
  5. 异常处理完成并返回</p>
</li>
<li>
<p>再次触发 tlb refill 异常。（现在页表中存在了该映射，因此进入 tlb_refill 函数）</p>
</li>
</ol>
<p>终端输出</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-192-1"><a id="__codelineno-192-1" name="__codelineno-192-1" href="#__codelineno-192-1"></a>## pagefault in kernel, badaddr: 0x100
</span><span id="__span-192-2"><a id="__codelineno-192-2" name="__codelineno-192-2" href="#__codelineno-192-2"></a>## tlb refill in kernel, badaddr: 0x100
</span><span id="__span-192-3"><a id="__codelineno-192-3" name="__codelineno-192-3" href="#__codelineno-192-3"></a>check_pgfault() succeeded!
</span></code></pre></div>
<p>代码</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-193-1"><a id="__codelineno-193-1" name="__codelineno-193-1" href="#__codelineno-193-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">get_error_code</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">)</span>
</span><span id="__span-193-2"><a id="__codelineno-193-2" name="__codelineno-193-2" href="#__codelineno-193-2"></a><span class="p">{</span>
</span><span id="__span-193-3"><a id="__codelineno-193-3" name="__codelineno-193-3" href="#__codelineno-193-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-193-4"><a id="__codelineno-193-4" name="__codelineno-193-4" href="#__codelineno-193-4"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="o">!=</span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ptep_present</span><span class="p">(</span><span class="n">pte</span><span class="p">))</span><span class="w"> </span><span class="c1">//因为 pagefault 的条件 (pte==NULL || ptep_invalid(pte))，这里根本不可能为真</span>
</span><span id="__span-193-5"><a id="__codelineno-193-5" name="__codelineno-193-5" href="#__codelineno-193-5"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
</span><span id="__span-193-6"><a id="__codelineno-193-6" name="__codelineno-193-6" href="#__codelineno-193-6"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">)</span>
</span><span id="__span-193-7"><a id="__codelineno-193-7" name="__codelineno-193-7" href="#__codelineno-193-7"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">;</span>
</span><span id="__span-193-8"><a id="__codelineno-193-8" name="__codelineno-193-8" href="#__codelineno-193-8"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-193-9"><a id="__codelineno-193-9" name="__codelineno-193-9" href="#__codelineno-193-9"></a><span class="p">}</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-194-1"><a id="__codelineno-194-1" name="__codelineno-194-1" href="#__codelineno-194-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-194-2"><a id="__codelineno-194-2" name="__codelineno-194-2" href="#__codelineno-194-2"></a><span class="nf">pgfault_handler</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">error_code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-194-3"><a id="__codelineno-194-3" name="__codelineno-194-3" href="#__codelineno-194-3"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">check_mm_struct</span><span class="p">;</span>
</span><span id="__span-194-4"><a id="__codelineno-194-4" name="__codelineno-194-4" href="#__codelineno-194-4"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-194-5"><a id="__codelineno-194-5" name="__codelineno-194-5" href="#__codelineno-194-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_mm_struct</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-194-6"><a id="__codelineno-194-6" name="__codelineno-194-6" href="#__codelineno-194-6"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-194-7"><a id="__codelineno-194-7" name="__codelineno-194-7" href="#__codelineno-194-7"></a><span class="w">    </span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_mm_struct</span><span class="p">;</span>
</span><span id="__span-194-8"><a id="__codelineno-194-8" name="__codelineno-194-8" href="#__codelineno-194-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-194-9"><a id="__codelineno-194-9" name="__codelineno-194-9" href="#__codelineno-194-9"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-194-10"><a id="__codelineno-194-10" name="__codelineno-194-10" href="#__codelineno-194-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-194-11"><a id="__codelineno-194-11" name="__codelineno-194-11" href="#__codelineno-194-11"></a><span class="w">      </span><span class="n">print_trapframe</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-194-12"><a id="__codelineno-194-12" name="__codelineno-194-12" href="#__codelineno-194-12"></a><span class="w">      </span><span class="c1">//print_pgfault(tf);</span>
</span><span id="__span-194-13"><a id="__codelineno-194-13" name="__codelineno-194-13" href="#__codelineno-194-13"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;unhandled page fault.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-194-14"><a id="__codelineno-194-14" name="__codelineno-194-14" href="#__codelineno-194-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-194-15"><a id="__codelineno-194-15" name="__codelineno-194-15" href="#__codelineno-194-15"></a><span class="w">    </span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-194-16"><a id="__codelineno-194-16" name="__codelineno-194-16" href="#__codelineno-194-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-194-17"><a id="__codelineno-194-17" name="__codelineno-194-17" href="#__codelineno-194-17"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">do_pgfault</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">error_code</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-194-18"><a id="__codelineno-194-18" name="__codelineno-194-18" href="#__codelineno-194-18"></a><span class="p">}</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-195-1"><a id="__codelineno-195-1" name="__codelineno-195-1" href="#__codelineno-195-1"></a><span class="cp">#! vmm.c</span>
</span><span id="__span-195-2"><a id="__codelineno-195-2" name="__codelineno-195-2" href="#__codelineno-195-2"></a>
</span><span id="__span-195-3"><a id="__codelineno-195-3" name="__codelineno-195-3" href="#__codelineno-195-3"></a><span class="c1">//page fault number</span>
</span><span id="__span-195-4"><a id="__codelineno-195-4" name="__codelineno-195-4" href="#__codelineno-195-4"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pgfault_num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-195-5"><a id="__codelineno-195-5" name="__codelineno-195-5" href="#__codelineno-195-5"></a><span class="c1">// do_pgfault - interrupt handler to process the page fault execption</span>
</span><span id="__span-195-6"><a id="__codelineno-195-6" name="__codelineno-195-6" href="#__codelineno-195-6"></a><span class="kt">int</span>
</span><span id="__span-195-7"><a id="__codelineno-195-7" name="__codelineno-195-7" href="#__codelineno-195-7"></a><span class="nf">do_pgfault</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">error_code</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-8"><a id="__codelineno-195-8" name="__codelineno-195-8" href="#__codelineno-195-8"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_INVAL</span><span class="p">;</span>
</span><span id="__span-195-9"><a id="__codelineno-195-9" name="__codelineno-195-9" href="#__codelineno-195-9"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-195-10"><a id="__codelineno-195-10" name="__codelineno-195-10" href="#__codelineno-195-10"></a><span class="w">  </span><span class="c1">//kprintf(&quot;## %08x %08x\n&quot;, error_code, addr);</span>
</span><span id="__span-195-11"><a id="__codelineno-195-11" name="__codelineno-195-11" href="#__codelineno-195-11"></a>
</span><span id="__span-195-12"><a id="__codelineno-195-12" name="__codelineno-195-12" href="#__codelineno-195-12"></a><span class="w">  </span><span class="n">pgfault_num</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-195-13"><a id="__codelineno-195-13" name="__codelineno-195-13" href="#__codelineno-195-13"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vma</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-14"><a id="__codelineno-195-14" name="__codelineno-195-14" href="#__codelineno-195-14"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;not valid addr %x, and  can not find it in vma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-195-15"><a id="__codelineno-195-15" name="__codelineno-195-15" href="#__codelineno-195-15"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-195-16"><a id="__codelineno-195-16" name="__codelineno-195-16" href="#__codelineno-195-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-195-17"><a id="__codelineno-195-17" name="__codelineno-195-17" href="#__codelineno-195-17"></a>
</span><span id="__span-195-18"><a id="__codelineno-195-18" name="__codelineno-195-18" href="#__codelineno-195-18"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">error_code</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-19"><a id="__codelineno-195-19" name="__codelineno-195-19" href="#__codelineno-195-19"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-195-20"><a id="__codelineno-195-20" name="__codelineno-195-20" href="#__codelineno-195-20"></a><span class="w">      </span><span class="cm">/* default is 3: write, present */</span>
</span><span id="__span-195-21"><a id="__codelineno-195-21" name="__codelineno-195-21" href="#__codelineno-195-21"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write, not present */</span>
</span><span id="__span-195-22"><a id="__codelineno-195-22" name="__codelineno-195-22" href="#__codelineno-195-22"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-23"><a id="__codelineno-195-23" name="__codelineno-195-23" href="#__codelineno-195-23"></a><span class="w">        </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;write, not present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-195-24"><a id="__codelineno-195-24" name="__codelineno-195-24" href="#__codelineno-195-24"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-195-25"><a id="__codelineno-195-25" name="__codelineno-195-25" href="#__codelineno-195-25"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-195-26"><a id="__codelineno-195-26" name="__codelineno-195-26" href="#__codelineno-195-26"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-195-27"><a id="__codelineno-195-27" name="__codelineno-195-27" href="#__codelineno-195-27"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read, present */</span>
</span><span id="__span-195-28"><a id="__codelineno-195-28" name="__codelineno-195-28" href="#__codelineno-195-28"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;read, present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-195-29"><a id="__codelineno-195-29" name="__codelineno-195-29" href="#__codelineno-195-29"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-195-30"><a id="__codelineno-195-30" name="__codelineno-195-30" href="#__codelineno-195-30"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read, not present */</span>
</span><span id="__span-195-31"><a id="__codelineno-195-31" name="__codelineno-195-31" href="#__codelineno-195-31"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">VM_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_EXEC</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-32"><a id="__codelineno-195-32" name="__codelineno-195-32" href="#__codelineno-195-32"></a><span class="w">        </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;read, not present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-195-33"><a id="__codelineno-195-33" name="__codelineno-195-33" href="#__codelineno-195-33"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-195-34"><a id="__codelineno-195-34" name="__codelineno-195-34" href="#__codelineno-195-34"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-195-35"><a id="__codelineno-195-35" name="__codelineno-195-35" href="#__codelineno-195-35"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-195-36"><a id="__codelineno-195-36" name="__codelineno-195-36" href="#__codelineno-195-36"></a>
</span><span id="__span-195-37"><a id="__codelineno-195-37" name="__codelineno-195-37" href="#__codelineno-195-37"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">;</span>
</span><span id="__span-195-38"><a id="__codelineno-195-38" name="__codelineno-195-38" href="#__codelineno-195-38"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-39"><a id="__codelineno-195-39" name="__codelineno-195-39" href="#__codelineno-195-39"></a><span class="w">    </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">;</span>
</span><span id="__span-195-40"><a id="__codelineno-195-40" name="__codelineno-195-40" href="#__codelineno-195-40"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-195-41"><a id="__codelineno-195-41" name="__codelineno-195-41" href="#__codelineno-195-41"></a><span class="w">  </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-195-42"><a id="__codelineno-195-42" name="__codelineno-195-42" href="#__codelineno-195-42"></a>
</span><span id="__span-195-43"><a id="__codelineno-195-43" name="__codelineno-195-43" href="#__codelineno-195-43"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-195-44"><a id="__codelineno-195-44" name="__codelineno-195-44" href="#__codelineno-195-44"></a>
</span><span id="__span-195-45"><a id="__codelineno-195-45" name="__codelineno-195-45" href="#__codelineno-195-45"></a><span class="w">  </span><span class="c1">// try to find a pte, if pte&#39;s PT(Page Table) isn&#39;t existed, then create a PT.</span>
</span><span id="__span-195-46"><a id="__codelineno-195-46" name="__codelineno-195-46" href="#__codelineno-195-46"></a><span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptep</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-195-47"><a id="__codelineno-195-47" name="__codelineno-195-47" href="#__codelineno-195-47"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-48"><a id="__codelineno-195-48" name="__codelineno-195-48" href="#__codelineno-195-48"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-195-49"><a id="__codelineno-195-49" name="__codelineno-195-49" href="#__codelineno-195-49"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-195-50"><a id="__codelineno-195-50" name="__codelineno-195-50" href="#__codelineno-195-50"></a>
</span><span id="__span-195-51"><a id="__codelineno-195-51" name="__codelineno-195-51" href="#__codelineno-195-51"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// if the phy addr isn&#39;t exist, then alloc a page &amp; map the phy addr with logical addr</span>
</span><span id="__span-195-52"><a id="__codelineno-195-52" name="__codelineno-195-52" href="#__codelineno-195-52"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-53"><a id="__codelineno-195-53" name="__codelineno-195-53" href="#__codelineno-195-53"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-195-54"><a id="__codelineno-195-54" name="__codelineno-195-54" href="#__codelineno-195-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-195-55"><a id="__codelineno-195-55" name="__codelineno-195-55" href="#__codelineno-195-55"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-195-56"><a id="__codelineno-195-56" name="__codelineno-195-56" href="#__codelineno-195-56"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// if this pte is a swap entry, then load data from disk to a page with phy addr, </span>
</span><span id="__span-195-57"><a id="__codelineno-195-57" name="__codelineno-195-57" href="#__codelineno-195-57"></a><span class="w">    </span><span class="c1">// map the phy addr with logical addr, trig swap manager to record the access situation of this page</span>
</span><span id="__span-195-58"><a id="__codelineno-195-58" name="__codelineno-195-58" href="#__codelineno-195-58"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">swap_init_ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-59"><a id="__codelineno-195-59" name="__codelineno-195-59" href="#__codelineno-195-59"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;No swap!! never reach!!&quot;</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-195-60"><a id="__codelineno-195-60" name="__codelineno-195-60" href="#__codelineno-195-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-195-61"><a id="__codelineno-195-61" name="__codelineno-195-61" href="#__codelineno-195-61"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-195-62"><a id="__codelineno-195-62" name="__codelineno-195-62" href="#__codelineno-195-62"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;no swap_init_ok but ptep is %x, failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
</span><span id="__span-195-63"><a id="__codelineno-195-63" name="__codelineno-195-63" href="#__codelineno-195-63"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-195-64"><a id="__codelineno-195-64" name="__codelineno-195-64" href="#__codelineno-195-64"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-195-65"><a id="__codelineno-195-65" name="__codelineno-195-65" href="#__codelineno-195-65"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-195-66"><a id="__codelineno-195-66" name="__codelineno-195-66" href="#__codelineno-195-66"></a><span class="w">  </span><span class="cm">/* refill TLB for mips, no second exception */</span>
</span><span id="__span-195-67"><a id="__codelineno-195-67" name="__codelineno-195-67" href="#__codelineno-195-67"></a><span class="w">  </span><span class="c1">//tlb_refill(addr, ptep);</span>
</span><span id="__span-195-68"><a id="__codelineno-195-68" name="__codelineno-195-68" href="#__codelineno-195-68"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-195-69"><a id="__codelineno-195-69" name="__codelineno-195-69" href="#__codelineno-195-69"></a><span class="nl">failed</span><span class="p">:</span>
</span><span id="__span-195-70"><a id="__codelineno-195-70" name="__codelineno-195-70" href="#__codelineno-195-70"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-195-71"><a id="__codelineno-195-71" name="__codelineno-195-71" href="#__codelineno-195-71"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="函数调用"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#函数调用">函数调用</a></h5>
<ol>
<li>
<p>使用 jal 调用函数，使用 jr ra 返回。使用 a0-a3 传递参数，使用 v0-v1 传递返回值。对于更多的参数，使用栈传递。</p>
</li>
<li>
<p>为了防止寄存器的值被覆盖。需要在存储寄存器的值，可以由 caller 或者 callee 来完成。但是只有一方完成时，因为 caller 不知道 callee 会用哪些寄存器，或者 callee 不知道 caller 需要用哪些寄存器。因此就会导致存储不必要的寄存器。MIPS 采用了一种折衷的策略，将寄存器分为 caller-save（如 t0-t7, a0-a3, v0-v1）和 callee-save（如 s0-s7, ra）</p>
</li>
<li>
<p>fp 寄存器（也是 s8）用于指向栈帧的第一个元素。因为 x86 中提供了 push 和 pop 指令，sp 的位置是变化的，要引用不同变量的值是用 fp 更方便。而 MIPS 中则是在函数的开头手动将 sp 设置，sp 之后的值不会变化，因此 fp 貌似作用不大。</p>
</li>
<li>
<p>gp 寄存器，用于程序访问全局变量（比如函数的地址）。</p>
<blockquote>
<p>ps. 使用 mipsel-linux-gnu-gcc -S 编译一个简单的函数调用测试代码。不知为什么和上面讲的 caller-save，callee-save 对不上。比如函数开头<code>addiu $sp,$sp,-40</code>，但结果却根本没用上这么大的空间。然后，为什么还会出现<code>sw $a0,40($fp)</code>，即将参数<code>a0</code>写入父函数栈帧的情况。（这个然后 fp 和 sp 始终相等，不知道为什么要去存储 fp</p>
</blockquote>
</li>
</ol>
<h5 id="sched_init--proc_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#sched_init--proc_init">sched_init &amp; proc_init</a></h5>
<h6 id="proc_struct进程控制块"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#proc_struct进程控制块">proc_struct(进程控制块)</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-196-1"><a id="__codelineno-196-1" name="__codelineno-196-1" href="#__codelineno-196-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-196-2"><a id="__codelineno-196-2" name="__codelineno-196-2" href="#__codelineno-196-2"></a><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">proc_state</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Process state</span>
</span><span id="__span-196-3"><a id="__codelineno-196-3" name="__codelineno-196-3" href="#__codelineno-196-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w">                                    </span><span class="c1">// Process ID</span>
</span><span id="__span-196-4"><a id="__codelineno-196-4" name="__codelineno-196-4" href="#__codelineno-196-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">runs</span><span class="p">;</span><span class="w">                                   </span><span class="c1">// the running times of Proces</span>
</span><span id="__span-196-5"><a id="__codelineno-196-5" name="__codelineno-196-5" href="#__codelineno-196-5"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">kstack</span><span class="p">;</span><span class="w">                           </span><span class="c1">// Process kernel stack</span>
</span><span id="__span-196-6"><a id="__codelineno-196-6" name="__codelineno-196-6" href="#__codelineno-196-6"></a><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">need_resched</span><span class="p">;</span><span class="w">                 </span><span class="c1">// bool value: need to be rescheduled to release CPU?</span>
</span><span id="__span-196-7"><a id="__codelineno-196-7" name="__codelineno-196-7" href="#__codelineno-196-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">                 </span><span class="c1">// the parent process</span>
</span><span id="__span-196-8"><a id="__codelineno-196-8" name="__codelineno-196-8" href="#__codelineno-196-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span><span class="w">                       </span><span class="c1">// Process&#39;s memory management field</span>
</span><span id="__span-196-9"><a id="__codelineno-196-9" name="__codelineno-196-9" href="#__codelineno-196-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Switch here to run process</span>
</span><span id="__span-196-10"><a id="__codelineno-196-10" name="__codelineno-196-10" href="#__codelineno-196-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">;</span><span class="w">                       </span><span class="c1">// Trap frame for current interrupt</span>
</span><span id="__span-196-11"><a id="__codelineno-196-11" name="__codelineno-196-11" href="#__codelineno-196-11"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">cr3</span><span class="p">;</span><span class="w">                              </span><span class="c1">// CR3 register: the base addr of Page Directroy Table(PDT)</span>
</span><span id="__span-196-12"><a id="__codelineno-196-12" name="__codelineno-196-12" href="#__codelineno-196-12"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                             </span><span class="c1">// Process flag</span>
</span><span id="__span-196-13"><a id="__codelineno-196-13" name="__codelineno-196-13" href="#__codelineno-196-13"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">PROC_NAME_LEN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">               </span><span class="c1">// Process name</span>
</span><span id="__span-196-14"><a id="__codelineno-196-14" name="__codelineno-196-14" href="#__codelineno-196-14"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">list_link</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Process link list </span>
</span><span id="__span-196-15"><a id="__codelineno-196-15" name="__codelineno-196-15" href="#__codelineno-196-15"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">hash_link</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Process hash list</span>
</span><span id="__span-196-16"><a id="__codelineno-196-16" name="__codelineno-196-16" href="#__codelineno-196-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">exit_code</span><span class="p">;</span><span class="w">                              </span><span class="c1">// exit code (be sent to parent proc)</span>
</span><span id="__span-196-17"><a id="__codelineno-196-17" name="__codelineno-196-17" href="#__codelineno-196-17"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">wait_state</span><span class="p">;</span><span class="w">                        </span><span class="c1">// waiting state</span>
</span><span id="__span-196-18"><a id="__codelineno-196-18" name="__codelineno-196-18" href="#__codelineno-196-18"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">yptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">optr</span><span class="p">;</span><span class="w">     </span><span class="c1">// relations between processes</span>
</span><span id="__span-196-19"><a id="__codelineno-196-19" name="__codelineno-196-19" href="#__codelineno-196-19"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">run_queue</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">;</span><span class="w">                       </span><span class="c1">// running queue contains Process</span>
</span><span id="__span-196-20"><a id="__codelineno-196-20" name="__codelineno-196-20" href="#__codelineno-196-20"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">run_link</span><span class="p">;</span><span class="w">                      </span><span class="c1">// the entry linked in run queue</span>
</span><span id="__span-196-21"><a id="__codelineno-196-21" name="__codelineno-196-21" href="#__codelineno-196-21"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">time_slice</span><span class="p">;</span><span class="w">                             </span><span class="c1">// time slice for occupying the CPU</span>
</span><span id="__span-196-22"><a id="__codelineno-196-22" name="__codelineno-196-22" href="#__codelineno-196-22"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fs_struct</span><span class="w"> </span><span class="o">*</span><span class="n">fs_struct</span><span class="p">;</span><span class="w">                </span><span class="c1">// the file related info(pwd, files_count, files_array, fs_semaphore) of process</span>
</span><span id="__span-196-23"><a id="__codelineno-196-23" name="__codelineno-196-23" href="#__codelineno-196-23"></a><span class="p">};</span>
</span></code></pre></div>
<h6 id="tf"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#tf">tf</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-197-1"><a id="__codelineno-197-1" name="__codelineno-197-1" href="#__codelineno-197-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-197-2"><a id="__codelineno-197-2" name="__codelineno-197-2" href="#__codelineno-197-2"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_vaddr</span><span class="p">;</span><span class="w"> </span><span class="cm">/* coprocessor 0 vaddr register */</span>
</span><span id="__span-197-3"><a id="__codelineno-197-3" name="__codelineno-197-3" href="#__codelineno-197-3"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_status</span><span class="p">;</span><span class="w"> </span><span class="cm">/* coprocessor 0 status register */</span>
</span><span id="__span-197-4"><a id="__codelineno-197-4" name="__codelineno-197-4" href="#__codelineno-197-4"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_cause</span><span class="p">;</span><span class="w"> </span><span class="cm">/* coprocessor 0 cause register */</span>
</span><span id="__span-197-5"><a id="__codelineno-197-5" name="__codelineno-197-5" href="#__codelineno-197-5"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_lo</span><span class="p">;</span>
</span><span id="__span-197-6"><a id="__codelineno-197-6" name="__codelineno-197-6" href="#__codelineno-197-6"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_hi</span><span class="p">;</span>
</span><span id="__span-197-7"><a id="__codelineno-197-7" name="__codelineno-197-7" href="#__codelineno-197-7"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_ra</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Saved register 31 */</span>
</span><span id="__span-197-8"><a id="__codelineno-197-8" name="__codelineno-197-8" href="#__codelineno-197-8"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">pushregs</span><span class="w"> </span><span class="n">tf_regs</span><span class="p">;</span>
</span><span id="__span-197-9"><a id="__codelineno-197-9" name="__codelineno-197-9" href="#__codelineno-197-9"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_epc</span><span class="p">;</span><span class="w"> </span><span class="cm">/* coprocessor 0 epc register */</span>
</span><span id="__span-197-10"><a id="__codelineno-197-10" name="__codelineno-197-10" href="#__codelineno-197-10"></a><span class="p">};</span>
</span></code></pre></div>
<p>tf 记录了</p>
<ol>
<li>进程的上下文：32 个通用寄存器的值</li>
<li>epc, status, cause 等 CP0 寄存器</li>
</ol>
<p>进入异常后，要将 sp 切换到内核栈。对于内核进程来说，就是当前的 sp，而对于用户进程来说，需要从进程控制块中读取 kstack 的地址。</p>
<p>uCore 内核允许嵌套中断。因此为了了保证嵌套中断发⽣生时 tf 总是能够指向当前的 trapframe，uCore 在内核栈上维护了了 tf 的链。</p>
<blockquote>
<p>发生中断（异常）时，trap.c::mips_trap 会改变当前进程 current-&gt;tf 的值</p>
<p><code>current-&gt;tf = *tf*;</code></p>
<p>要实现嵌套中断，需要在改变 current-&gt;tf 前使用一个 trapframe *otf（局部变量，存储在内核栈中）存下来。之后再将 current-&gt;tf 恢复为 otf。</p>
<p>这里提一下，如果一个用户进程发生了异常，在异常处理程序中又发生了一次异常，那么第二次异常时，已经处于了内核模式（在压入 tf 后，调用 mips_trap 之前）。在 ramExcHandle_general 中就不会计算新的 sp</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-198-1"><a id="__codelineno-198-1" name="__codelineno-198-1" href="#__codelineno-198-1"></a>mfc0 k0, CP0_STATUS /* Get status register */
</span><span id="__span-198-2"><a id="__codelineno-198-2" name="__codelineno-198-2" href="#__codelineno-198-2"></a>andi k0, k0, KSU_USER/* Check the we-were-in-user-mode bit */
</span><span id="__span-198-3"><a id="__codelineno-198-3" name="__codelineno-198-3" href="#__codelineno-198-3"></a>beq k0, $0, 1f  /* If clear, from kernel, already have stack */
</span></code></pre></div>
</blockquote>
<h6 id="kstack"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kstack">kstack</a></h6>
<p>内核栈用于存储中断帧 tf 以及作为进程在内核中执行使用的 sp</p>
<p>对于内核线程，该栈就是运行时的程序使⽤用的栈。而对于普通进程，uCore 在创建进程时分配了了 2 个连续的物理理⻚页作为内核栈的空间。</p>
<p>内核栈位于内核地址空间，并且是不不共享的（每个线程都拥有⾃自⼰己的内核栈），因此不不受到 mm 的管理理，当进程退出的时候，内核能够根据 kstack 的值快速定位栈的位置并进⾏行行回收。</p>
<h6 id="mm"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#mm">mm</a></h6>
<p>内存管理理的信息，包括内存映射列列表、⻚页表指针等。mm 成员变量量在 lab3 中⽤用于虚存管理理。但在实际 OS 中，内核线程常驻内存，不不需要考虑 swap page 问题，在 lab3 中涉及到了了⽤用户进程，才考虑进程⽤用户内存空间的 swap page 问题，mm 才会发挥作⽤用。</p>
<blockquote>
<p>还没看到用户进程的 swap page 代码</p>
</blockquote>
<h6 id="创建内核线程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#创建内核线程">创建内核线程</a></h6>
<h6 id="idle"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#idle">idle</a></h6>
<p>proc_init 函数启动了创建内核线程的步骤。首先当前的执行上下文（从 kern_init 启动至今）就可以看成是 uCore 内核中的一个内线程的上下文。为此，uCore 调用 alloc_proc 函数给当前执行的上下文分配一个进程控制块并在 proc_init 中对它进行相应初始化，将其打造成第 0 个内核线程 --idleproc。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-199-1"><a id="__codelineno-199-1" name="__codelineno-199-1" href="#__codelineno-199-1"></a><span class="w">   </span><span class="c1">//alloc_proc</span>
</span><span id="__span-199-2"><a id="__codelineno-199-2" name="__codelineno-199-2" href="#__codelineno-199-2"></a><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">    </span><span class="c1">//不需要，所有内核进程公用一个页表</span>
</span><span id="__span-199-3"><a id="__codelineno-199-3" name="__codelineno-199-3" href="#__codelineno-199-3"></a><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">cr3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boot_cr3</span><span class="p">;</span><span class="w">  </span><span class="c1">//在 pmm_init 中分配为 PADDR(boot_pgdir)</span>
</span><span id="__span-199-4"><a id="__codelineno-199-4" name="__codelineno-199-4" href="#__codelineno-199-4"></a>
</span><span id="__span-199-5"><a id="__codelineno-199-5" name="__codelineno-199-5" href="#__codelineno-199-5"></a><span class="w">   </span><span class="c1">//proc_init</span>
</span><span id="__span-199-6"><a id="__codelineno-199-6" name="__codelineno-199-6" href="#__codelineno-199-6"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-199-7"><a id="__codelineno-199-7" name="__codelineno-199-7" href="#__codelineno-199-7"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PROC_RUNNABLE</span><span class="p">;</span>
</span><span id="__span-199-8"><a id="__codelineno-199-8" name="__codelineno-199-8" href="#__codelineno-199-8"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">bootstack</span><span class="p">;</span><span class="w"> </span><span class="c1">//在 entry.S 中设置的</span>
</span><span id="__span-199-9"><a id="__codelineno-199-9" name="__codelineno-199-9" href="#__codelineno-199-9"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">//表明在 kern_init 后会切换</span>
</span></code></pre></div>
<h6 id="initkernel_thread--do_fork"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#initkernel_thread--do_fork">init(kernel_thread &amp; do_fork)</a></h6>
<p>idle 内核线程主要工作是完成内核中各个子系统的初始化，idle 会调用 kernel_thread 函数创建内核线程 init。</p>
<p>kernel_thread 简单来说为新进程分配了 PCB 空间，和 kstack 空间。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-200-1"><a id="__codelineno-200-1" name="__codelineno-200-1" href="#__codelineno-200-1"></a><span class="w">  </span><span class="c1">//proc_init</span>
</span><span id="__span-200-2"><a id="__codelineno-200-2" name="__codelineno-200-2" href="#__codelineno-200-2"></a><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">init_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-200-3"><a id="__codelineno-200-3" name="__codelineno-200-3" href="#__codelineno-200-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-200-4"><a id="__codelineno-200-4" name="__codelineno-200-4" href="#__codelineno-200-4"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create init_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-200-5"><a id="__codelineno-200-5" name="__codelineno-200-5" href="#__codelineno-200-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-200-6"><a id="__codelineno-200-6" name="__codelineno-200-6" href="#__codelineno-200-6"></a><span class="w">    </span><span class="n">initproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_proc</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-200-7"><a id="__codelineno-200-7" name="__codelineno-200-7" href="#__codelineno-200-7"></a><span class="w">    </span><span class="n">set_proc_name</span><span class="p">(</span><span class="n">initproc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;init&quot;</span><span class="p">);</span>
</span></code></pre></div>
<p>过程：</p>
<ol>
<li>
<p>kernel_thread 创建内核线程的中断帧，重点在于将 epc 设置为了 kernel_thread_entry，以及设置 a0 和 a1 为 arg 和 fn。<strong>还有一点值得注意，status 的 KSU 为内核模式</strong>。</p>
<p>当从 eret 返回后（forkrets -&gt; exception_return），CPU 便会进入 kernel_thread_entry，并以 tf 中指定的寄存器值执行。</p>
<p>kernel_thread 函数采用了局部变量 tf 来放置中断帧，并把中断帧的指针传递给 do_fork 函数。</p>
<p>kernel_thread 调用 do_fork 的 stack 参数为 0。在 do_fork-&gt;copy_thread 以此来判断是创建内核线程</p>
</li>
<li>
<p>do_fork 作用是以当前进程为父进程，创建一个子进程，可以根据 clone_flags 决定是否共享 mm。具体主要做了以下一些事情：</p>
<ol>
<li>
<p>调用 alloc_proc 为子进程分配 PCB 空间</p>
</li>
<li>
<p>调用 setup_kstack(proc)<strong>分配了内核栈空间</strong>（注意这里的 kstack 为空闲页的起始地址，而非栈顶）</p>
</li>
<li>
<p>调用 copy_mm，根据 clone_flags 来确定是复制还是共享 mm。（只对用户进程有效，内核线程 mm 都为 NULL）</p>
</li>
<li>
<p>调用 copy_thread：将 tf 拷贝到 kstack 的栈顶，<strong>设置 tf 中的 sp 为 proc-&gt;tf - 32</strong>（这里的减 32 应该和之前提到的 MIPS 函数调用规则有关，不管怎样，sp 是位于 kstack 中的）</p>
<p><strong>将 context 中的 ra 设置为 forkret</strong></p>
</li>
<li>
<p>将子进程插入 hash_list 和 proc_list</p>
</li>
<li>
<p>调用 wakeup_proc 将进程加入调度队列</p>
</li>
</ol>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-201-1"><a id="__codelineno-201-1" name="__codelineno-201-1" href="#__codelineno-201-1"></a><span class="kt">int</span>
</span><span id="__span-201-2"><a id="__codelineno-201-2" name="__codelineno-201-2" href="#__codelineno-201-2"></a><span class="nf">kernel_thread</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-201-3"><a id="__codelineno-201-3" name="__codelineno-201-3" href="#__codelineno-201-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-201-4"><a id="__codelineno-201-4" name="__codelineno-201-4" href="#__codelineno-201-4"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="p">));</span>
</span><span id="__span-201-5"><a id="__codelineno-201-5" name="__codelineno-201-5" href="#__codelineno-201-5"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span><span id="__span-201-6"><a id="__codelineno-201-6" name="__codelineno-201-6" href="#__codelineno-201-6"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">fn</span><span class="p">;</span>
</span><span id="__span-201-7"><a id="__codelineno-201-7" name="__codelineno-201-7" href="#__codelineno-201-7"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_V0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-201-8"><a id="__codelineno-201-8" name="__codelineno-201-8" href="#__codelineno-201-8"></a><span class="w">    </span><span class="c1">//TODO</span>
</span><span id="__span-201-9"><a id="__codelineno-201-9" name="__codelineno-201-9" href="#__codelineno-201-9"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_c0_status</span><span class="p">();</span>
</span><span id="__span-201-10"><a id="__codelineno-201-10" name="__codelineno-201-10" href="#__codelineno-201-10"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">ST0_KSU</span><span class="p">;</span>
</span><span id="__span-201-11"><a id="__codelineno-201-11" name="__codelineno-201-11" href="#__codelineno-201-11"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_IE</span><span class="p">;</span>
</span><span id="__span-201-12"><a id="__codelineno-201-12" name="__codelineno-201-12" href="#__codelineno-201-12"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_EXL</span><span class="p">;</span>
</span><span id="__span-201-13"><a id="__codelineno-201-13" name="__codelineno-201-13" href="#__codelineno-201-13"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_GP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__read_reg</span><span class="p">(</span><span class="n">$28</span><span class="p">);</span>
</span><span id="__span-201-14"><a id="__codelineno-201-14" name="__codelineno-201-14" href="#__codelineno-201-14"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_epc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">kernel_thread_entry</span><span class="p">;</span>
</span><span id="__span-201-15"><a id="__codelineno-201-15" name="__codelineno-201-15" href="#__codelineno-201-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">do_fork</span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_VM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-201-16"><a id="__codelineno-201-16" name="__codelineno-201-16" href="#__codelineno-201-16"></a><span class="p">}</span>
</span><span id="__span-201-17"><a id="__codelineno-201-17" name="__codelineno-201-17" href="#__codelineno-201-17"></a>
</span><span id="__span-201-18"><a id="__codelineno-201-18" name="__codelineno-201-18" href="#__codelineno-201-18"></a><span class="c1">//kern/proc/entry.S</span>
</span><span id="__span-201-19"><a id="__codelineno-201-19" name="__codelineno-201-19" href="#__codelineno-201-19"></a><span class="nl">kernel_thread_entry</span><span class="p">:</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-201-20"><a id="__codelineno-201-20" name="__codelineno-201-20" href="#__codelineno-201-20"></a><span class="w">  </span><span class="n">addiu</span><span class="w"> </span><span class="n">$sp</span><span class="p">,</span><span class="w"> </span><span class="n">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
</span><span id="__span-201-21"><a id="__codelineno-201-21" name="__codelineno-201-21" href="#__codelineno-201-21"></a><span class="w">  </span><span class="n">jal</span><span class="w"> </span><span class="n">$a1</span>
</span><span id="__span-201-22"><a id="__codelineno-201-22" name="__codelineno-201-22" href="#__codelineno-201-22"></a><span class="w">  </span><span class="n">nop</span>
</span><span id="__span-201-23"><a id="__codelineno-201-23" name="__codelineno-201-23" href="#__codelineno-201-23"></a><span class="w">  </span><span class="n">move</span><span class="w"> </span><span class="n">$a0</span><span class="p">,</span><span class="w"> </span><span class="n">$v0</span>
</span><span id="__span-201-24"><a id="__codelineno-201-24" name="__codelineno-201-24" href="#__codelineno-201-24"></a><span class="w">  </span><span class="n">la</span><span class="w">  </span><span class="n">$t0</span><span class="p">,</span><span class="w"> </span><span class="n">do_exit</span>
</span><span id="__span-201-25"><a id="__codelineno-201-25" name="__codelineno-201-25" href="#__codelineno-201-25"></a><span class="w">  </span><span class="n">jal</span><span class="w"> </span><span class="n">$t0</span><span class="w"> </span>
</span><span id="__span-201-26"><a id="__codelineno-201-26" name="__codelineno-201-26" href="#__codelineno-201-26"></a><span class="w">  </span><span class="n">nop</span>
</span><span id="__span-201-27"><a id="__codelineno-201-27" name="__codelineno-201-27" href="#__codelineno-201-27"></a><span class="w">  </span><span class="cm">/* never here */</span>
</span><span id="__span-201-28"><a id="__codelineno-201-28" name="__codelineno-201-28" href="#__codelineno-201-28"></a>
</span><span id="__span-201-29"><a id="__codelineno-201-29" name="__codelineno-201-29" href="#__codelineno-201-29"></a><span class="c1">//called by do_fork</span>
</span><span id="__span-201-30"><a id="__codelineno-201-30" name="__codelineno-201-30" href="#__codelineno-201-30"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-201-31"><a id="__codelineno-201-31" name="__codelineno-201-31" href="#__codelineno-201-31"></a><span class="n">copy_thread</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-201-32"><a id="__codelineno-201-32" name="__codelineno-201-32" href="#__codelineno-201-32"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KSTACKSIZE</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-201-33"><a id="__codelineno-201-33" name="__codelineno-201-33" href="#__codelineno-201-33"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-201-34"><a id="__codelineno-201-34" name="__codelineno-201-34" href="#__codelineno-201-34"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_V0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-201-35"><a id="__codelineno-201-35" name="__codelineno-201-35" href="#__codelineno-201-35"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">esp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">//a kernel thread</span>
</span><span id="__span-201-36"><a id="__codelineno-201-36" name="__codelineno-201-36" href="#__codelineno-201-36"></a><span class="w">      </span><span class="n">esp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
</span><span id="__span-201-37"><a id="__codelineno-201-37" name="__codelineno-201-37" href="#__codelineno-201-37"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_SP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esp</span><span class="p">;</span>
</span><span id="__span-201-38"><a id="__codelineno-201-38" name="__codelineno-201-38" href="#__codelineno-201-38"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sf_ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">forkret</span><span class="p">;</span>
</span><span id="__span-201-39"><a id="__codelineno-201-39" name="__codelineno-201-39" href="#__codelineno-201-39"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sf_sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
</span><span id="__span-201-40"><a id="__codelineno-201-40" name="__codelineno-201-40" href="#__codelineno-201-40"></a><span class="p">}</span>
</span><span id="__span-201-41"><a id="__codelineno-201-41" name="__codelineno-201-41" href="#__codelineno-201-41"></a>
</span><span id="__span-201-42"><a id="__codelineno-201-42" name="__codelineno-201-42" href="#__codelineno-201-42"></a><span class="c1">// do_fork - parent process for a new child process</span>
</span><span id="__span-201-43"><a id="__codelineno-201-43" name="__codelineno-201-43" href="#__codelineno-201-43"></a><span class="c1">//    1. call alloc_proc to allocate a proc_struct</span>
</span><span id="__span-201-44"><a id="__codelineno-201-44" name="__codelineno-201-44" href="#__codelineno-201-44"></a><span class="c1">//    2. call setup_kstack to allocate a kernel stack for child process</span>
</span><span id="__span-201-45"><a id="__codelineno-201-45" name="__codelineno-201-45" href="#__codelineno-201-45"></a><span class="c1">//    3. call copy_mm to dup OR share mm according clone_flag</span>
</span><span id="__span-201-46"><a id="__codelineno-201-46" name="__codelineno-201-46" href="#__codelineno-201-46"></a><span class="c1">//    4. call copy_thread to setup tf &amp; context in proc_struct</span>
</span><span id="__span-201-47"><a id="__codelineno-201-47" name="__codelineno-201-47" href="#__codelineno-201-47"></a><span class="c1">//    5. insert proc_struct into hash_list &amp;&amp; proc_list</span>
</span><span id="__span-201-48"><a id="__codelineno-201-48" name="__codelineno-201-48" href="#__codelineno-201-48"></a><span class="c1">//    6. call wakup_proc to make the new child process RUNNABLE </span>
</span><span id="__span-201-49"><a id="__codelineno-201-49" name="__codelineno-201-49" href="#__codelineno-201-49"></a><span class="c1">//    7. set the </span>
</span><span id="__span-201-50"><a id="__codelineno-201-50" name="__codelineno-201-50" href="#__codelineno-201-50"></a><span class="kt">int</span>
</span><span id="__span-201-51"><a id="__codelineno-201-51" name="__codelineno-201-51" href="#__codelineno-201-51"></a><span class="n">do_fork</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-201-52"><a id="__codelineno-201-52" name="__codelineno-201-52" href="#__codelineno-201-52"></a><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_FREE_PROC</span><span class="p">;</span>
</span><span id="__span-201-53"><a id="__codelineno-201-53" name="__codelineno-201-53" href="#__codelineno-201-53"></a><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-201-54"><a id="__codelineno-201-54" name="__codelineno-201-54" href="#__codelineno-201-54"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nr_process</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_PROCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-201-55"><a id="__codelineno-201-55" name="__codelineno-201-55" href="#__codelineno-201-55"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-201-56"><a id="__codelineno-201-56" name="__codelineno-201-56" href="#__codelineno-201-56"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-201-57"><a id="__codelineno-201-57" name="__codelineno-201-57" href="#__codelineno-201-57"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-201-58"><a id="__codelineno-201-58" name="__codelineno-201-58" href="#__codelineno-201-58"></a><span class="w"> </span><span class="c1">//LAB4:EXERCISE2 2009010989</span>
</span><span id="__span-201-59"><a id="__codelineno-201-59" name="__codelineno-201-59" href="#__codelineno-201-59"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_proc</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-201-60"><a id="__codelineno-201-60" name="__codelineno-201-60" href="#__codelineno-201-60"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-201-61"><a id="__codelineno-201-61" name="__codelineno-201-61" href="#__codelineno-201-61"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-201-62"><a id="__codelineno-201-62" name="__codelineno-201-62" href="#__codelineno-201-62"></a>
</span><span id="__span-201-63"><a id="__codelineno-201-63" name="__codelineno-201-63" href="#__codelineno-201-63"></a><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
</span><span id="__span-201-64"><a id="__codelineno-201-64" name="__codelineno-201-64" href="#__codelineno-201-64"></a>
</span><span id="__span-201-65"><a id="__codelineno-201-65" name="__codelineno-201-65" href="#__codelineno-201-65"></a><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">setup_kstack</span><span class="p">(</span><span class="n">proc</span><span class="p">)){</span>
</span><span id="__span-201-66"><a id="__codelineno-201-66" name="__codelineno-201-66" href="#__codelineno-201-66"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_proc</span><span class="p">;</span>
</span><span id="__span-201-67"><a id="__codelineno-201-67" name="__codelineno-201-67" href="#__codelineno-201-67"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-201-68"><a id="__codelineno-201-68" name="__codelineno-201-68" href="#__codelineno-201-68"></a><span class="w"> </span><span class="c1">//LAB8:EXERCISE2 2009010989 HINT:how to copy the fs in parent&#39;s proc_struct?</span>
</span><span id="__span-201-69"><a id="__codelineno-201-69" name="__codelineno-201-69" href="#__codelineno-201-69"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_fs</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-201-70"><a id="__codelineno-201-70" name="__codelineno-201-70" href="#__codelineno-201-70"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_kstack</span><span class="p">;</span>
</span><span id="__span-201-71"><a id="__codelineno-201-71" name="__codelineno-201-71" href="#__codelineno-201-71"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-201-72"><a id="__codelineno-201-72" name="__codelineno-201-72" href="#__codelineno-201-72"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_mm</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="p">)){</span>
</span><span id="__span-201-73"><a id="__codelineno-201-73" name="__codelineno-201-73" href="#__codelineno-201-73"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_fs</span><span class="p">;</span>
</span><span id="__span-201-74"><a id="__codelineno-201-74" name="__codelineno-201-74" href="#__codelineno-201-74"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-201-75"><a id="__codelineno-201-75" name="__codelineno-201-75" href="#__codelineno-201-75"></a>
</span><span id="__span-201-76"><a id="__codelineno-201-76" name="__codelineno-201-76" href="#__codelineno-201-76"></a><span class="w"> </span><span class="n">copy_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-201-77"><a id="__codelineno-201-77" name="__codelineno-201-77" href="#__codelineno-201-77"></a>
</span><span id="__span-201-78"><a id="__codelineno-201-78" name="__codelineno-201-78" href="#__codelineno-201-78"></a><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pid</span><span class="p">();</span>
</span><span id="__span-201-79"><a id="__codelineno-201-79" name="__codelineno-201-79" href="#__codelineno-201-79"></a><span class="w"> </span><span class="n">hash_proc</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-201-80"><a id="__codelineno-201-80" name="__codelineno-201-80" href="#__codelineno-201-80"></a>
</span><span id="__span-201-81"><a id="__codelineno-201-81" name="__codelineno-201-81" href="#__codelineno-201-81"></a>
</span><span id="__span-201-82"><a id="__codelineno-201-82" name="__codelineno-201-82" href="#__codelineno-201-82"></a><span class="w"> </span><span class="c1">//list_add(&amp;proc_list, &amp;(proc-&gt;list_link));</span>
</span><span id="__span-201-83"><a id="__codelineno-201-83" name="__codelineno-201-83" href="#__codelineno-201-83"></a><span class="w"> </span><span class="n">set_links</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-201-84"><a id="__codelineno-201-84" name="__codelineno-201-84" href="#__codelineno-201-84"></a>
</span><span id="__span-201-85"><a id="__codelineno-201-85" name="__codelineno-201-85" href="#__codelineno-201-85"></a><span class="w"> </span><span class="n">wakeup_proc</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-201-86"><a id="__codelineno-201-86" name="__codelineno-201-86" href="#__codelineno-201-86"></a>
</span><span id="__span-201-87"><a id="__codelineno-201-87" name="__codelineno-201-87" href="#__codelineno-201-87"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
</span><span id="__span-201-88"><a id="__codelineno-201-88" name="__codelineno-201-88" href="#__codelineno-201-88"></a>
</span><span id="__span-201-89"><a id="__codelineno-201-89" name="__codelineno-201-89" href="#__codelineno-201-89"></a><span class="nl">fork_out</span><span class="p">:</span>
</span><span id="__span-201-90"><a id="__codelineno-201-90" name="__codelineno-201-90" href="#__codelineno-201-90"></a><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-201-91"><a id="__codelineno-201-91" name="__codelineno-201-91" href="#__codelineno-201-91"></a>
</span><span id="__span-201-92"><a id="__codelineno-201-92" name="__codelineno-201-92" href="#__codelineno-201-92"></a><span class="nl">bad_fork_cleanup_fs</span><span class="p">:</span>
</span><span id="__span-201-93"><a id="__codelineno-201-93" name="__codelineno-201-93" href="#__codelineno-201-93"></a><span class="w"> </span><span class="n">put_fs</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-201-94"><a id="__codelineno-201-94" name="__codelineno-201-94" href="#__codelineno-201-94"></a><span class="nl">bad_fork_cleanup_kstack</span><span class="p">:</span>
</span><span id="__span-201-95"><a id="__codelineno-201-95" name="__codelineno-201-95" href="#__codelineno-201-95"></a><span class="w"> </span><span class="n">put_kstack</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-201-96"><a id="__codelineno-201-96" name="__codelineno-201-96" href="#__codelineno-201-96"></a><span class="nl">bad_fork_cleanup_proc</span><span class="p">:</span>
</span><span id="__span-201-97"><a id="__codelineno-201-97" name="__codelineno-201-97" href="#__codelineno-201-97"></a><span class="w"> </span><span class="n">kfree</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-201-98"><a id="__codelineno-201-98" name="__codelineno-201-98" href="#__codelineno-201-98"></a><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-201-99"><a id="__codelineno-201-99" name="__codelineno-201-99" href="#__codelineno-201-99"></a><span class="p">}</span>
</span></code></pre></div>
<h6 id="user_main"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#user_main">user_main</a></h6>
<p>在 init_main 中，创建了 user_main 线程。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-202-1"><a id="__codelineno-202-1" name="__codelineno-202-1" href="#__codelineno-202-1"></a><span class="c1">// init_main - the second kernel thread used to create user_main kernel threads</span>
</span><span id="__span-202-2"><a id="__codelineno-202-2" name="__codelineno-202-2" href="#__codelineno-202-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-202-3"><a id="__codelineno-202-3" name="__codelineno-202-3" href="#__codelineno-202-3"></a><span class="nf">init_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-202-4"><a id="__codelineno-202-4" name="__codelineno-202-4" href="#__codelineno-202-4"></a><span class="w"> </span><span class="p">...</span>
</span><span id="__span-202-5"><a id="__codelineno-202-5" name="__codelineno-202-5" href="#__codelineno-202-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">user_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-202-6"><a id="__codelineno-202-6" name="__codelineno-202-6" href="#__codelineno-202-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-202-7"><a id="__codelineno-202-7" name="__codelineno-202-7" href="#__codelineno-202-7"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create user_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-202-8"><a id="__codelineno-202-8" name="__codelineno-202-8" href="#__codelineno-202-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-202-9"><a id="__codelineno-202-9" name="__codelineno-202-9" href="#__codelineno-202-9"></a>
</span><span id="__span-202-10"><a id="__codelineno-202-10" name="__codelineno-202-10" href="#__codelineno-202-10"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">do_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-202-11"><a id="__codelineno-202-11" name="__codelineno-202-11" href="#__codelineno-202-11"></a><span class="w">        </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-202-12"><a id="__codelineno-202-12" name="__codelineno-202-12" href="#__codelineno-202-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-202-13"><a id="__codelineno-202-13" name="__codelineno-202-13" href="#__codelineno-202-13"></a>
</span><span id="__span-202-14"><a id="__codelineno-202-14" name="__codelineno-202-14" href="#__codelineno-202-14"></a><span class="w">    </span><span class="n">fs_cleanup</span><span class="p">();</span>
</span><span id="__span-202-15"><a id="__codelineno-202-15" name="__codelineno-202-15" href="#__codelineno-202-15"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;all user-mode processes have quit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-202-16"><a id="__codelineno-202-16" name="__codelineno-202-16" href="#__codelineno-202-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-202-17"><a id="__codelineno-202-17" name="__codelineno-202-17" href="#__codelineno-202-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>kernel_thread 之前已经分析过了，我们来看 user_main 做了什么</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-203-1"><a id="__codelineno-203-1" name="__codelineno-203-1" href="#__codelineno-203-1"></a><span class="c1">// user_main - kernel thread used to exec a user program</span>
</span><span id="__span-203-2"><a id="__codelineno-203-2" name="__codelineno-203-2" href="#__codelineno-203-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-203-3"><a id="__codelineno-203-3" name="__codelineno-203-3" href="#__codelineno-203-3"></a><span class="nf">user_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-203-4"><a id="__codelineno-203-4" name="__codelineno-203-4" href="#__codelineno-203-4"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;in user main, pid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-203-5"><a id="__codelineno-203-5" name="__codelineno-203-5" href="#__codelineno-203-5"></a><span class="w">    </span><span class="n">KERNEL_EXECVE</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
</span><span id="__span-203-6"><a id="__codelineno-203-6" name="__codelineno-203-6" href="#__codelineno-203-6"></a><span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;user_main execve failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-203-7"><a id="__codelineno-203-7" name="__codelineno-203-7" href="#__codelineno-203-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>user_main 调用了<code>KERNEL_EXECVE</code>来加载执行一个用户程序。<code>KERNEL_EXECVE</code>被展开为对 kernel_execve 的调用。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-204-1"><a id="__codelineno-204-1" name="__codelineno-204-1" href="#__codelineno-204-1"></a><span class="c1">// kernel_execve - do SYS_exec syscall to exec a user program called by user_main kernel_thread</span>
</span><span id="__span-204-2"><a id="__codelineno-204-2" name="__codelineno-204-2" href="#__codelineno-204-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-204-3"><a id="__codelineno-204-3" name="__codelineno-204-3" href="#__codelineno-204-3"></a><span class="nf">kernel_execve</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-204-4"><a id="__codelineno-204-4" name="__codelineno-204-4" href="#__codelineno-204-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-204-5"><a id="__codelineno-204-5" name="__codelineno-204-5" href="#__codelineno-204-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argc</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-204-6"><a id="__codelineno-204-6" name="__codelineno-204-6" href="#__codelineno-204-6"></a><span class="w">        </span><span class="n">argc</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-204-7"><a id="__codelineno-204-7" name="__codelineno-204-7" href="#__codelineno-204-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-204-8"><a id="__codelineno-204-8" name="__codelineno-204-8" href="#__codelineno-204-8"></a><span class="w">    </span><span class="c1">//panic(&quot;unimpl&quot;);</span>
</span><span id="__span-204-9"><a id="__codelineno-204-9" name="__codelineno-204-9" href="#__codelineno-204-9"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
</span><span id="__span-204-10"><a id="__codelineno-204-10" name="__codelineno-204-10" href="#__codelineno-204-10"></a><span class="w">      </span><span class="s">&quot;la $v0, %1;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="cm">/* syscall no. */</span>
</span><span id="__span-204-11"><a id="__codelineno-204-11" name="__codelineno-204-11" href="#__codelineno-204-11"></a><span class="w">      </span><span class="s">&quot;move $a0, %2;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-204-12"><a id="__codelineno-204-12" name="__codelineno-204-12" href="#__codelineno-204-12"></a><span class="w">      </span><span class="s">&quot;move $a1, %3;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-204-13"><a id="__codelineno-204-13" name="__codelineno-204-13" href="#__codelineno-204-13"></a><span class="w">      </span><span class="s">&quot;move $a2, %4;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-204-14"><a id="__codelineno-204-14" name="__codelineno-204-14" href="#__codelineno-204-14"></a><span class="w">      </span><span class="s">&quot;move $a3, %5;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-204-15"><a id="__codelineno-204-15" name="__codelineno-204-15" href="#__codelineno-204-15"></a><span class="w">      </span><span class="s">&quot;syscall;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-204-16"><a id="__codelineno-204-16" name="__codelineno-204-16" href="#__codelineno-204-16"></a><span class="w">      </span><span class="s">&quot;nop;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-204-17"><a id="__codelineno-204-17" name="__codelineno-204-17" href="#__codelineno-204-17"></a><span class="w">      </span><span class="s">&quot;move %0, $v0;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-204-18"><a id="__codelineno-204-18" name="__codelineno-204-18" href="#__codelineno-204-18"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span><span id="__span-204-19"><a id="__codelineno-204-19" name="__codelineno-204-19" href="#__codelineno-204-19"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">SYSCALL_BASE</span><span class="o">+</span><span class="n">SYS_exec</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argc</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argv</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argc</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-204-20"><a id="__codelineno-204-20" name="__codelineno-204-20" href="#__codelineno-204-20"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;a0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;v0&quot;</span>
</span><span id="__span-204-21"><a id="__codelineno-204-21" name="__codelineno-204-21" href="#__codelineno-204-21"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-204-22"><a id="__codelineno-204-22" name="__codelineno-204-22" href="#__codelineno-204-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-204-23"><a id="__codelineno-204-23" name="__codelineno-204-23" href="#__codelineno-204-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>而 kernel_execve 则是进行了一次系统调用。</p>
<p>kernel_execve -&gt; SYSCALL -&gt; sys_exec -&gt; do_execve</p>
<ol>
<li>
<p>因为 kernel_execve 就是在内核线程，所以之后进行系统调用，仍然是使用一样的内核栈。</p>
</li>
<li>
<p>do_execve 做的事情</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-205-1"><a id="__codelineno-205-1" name="__codelineno-205-1" href="#__codelineno-205-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">do_execve</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
<ol>
<li>
<p>创建局部变量 local_name, kargv（位于上下文的内核栈中），将参数 name, argv 复制过来。</p>
<p>kernel_execve 调用时传递了"sh"字符串常量的地址。而该"sh"的地址在 gdb 调试时显示为 0x8002_7ff0，而 local_name 的地址则为 0x81fe_bd20（此时 sp 为 0x81fe_bd00，可以知道 local_name 位于当前函数的栈帧中，而"sh"位于别处）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-206-1"><a id="__codelineno-206-1" name="__codelineno-206-1" href="#__codelineno-206-1"></a><span class="n">copy_string</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">local_name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">local_name</span><span class="p">))</span>
</span><span id="__span-206-2"><a id="__codelineno-206-2" name="__codelineno-206-2" href="#__codelineno-206-2"></a>
</span><span id="__span-206-3"><a id="__codelineno-206-3" name="__codelineno-206-3" href="#__codelineno-206-3"></a><span class="n">copy_kargv</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">kargv</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
</span></code></pre></div>
<p>copy_string 函数，作用是先检查访问 src 是否合法（通过 mm），然后将 src 复制到 dst 中。这里的 dst 位于内核空间</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-207-1"><a id="__codelineno-207-1" name="__codelineno-207-1" href="#__codelineno-207-1"></a><span class="kt">bool</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxn</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
<p>copy_string 具体代码，if 判断有点复杂，且没有注释，没太看懂。</p>
</li>
<li>
<p>读取文件系统，获得文件号，之后传给 load_icode 使用。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-208-1"><a id="__codelineno-208-1" name="__codelineno-208-1" href="#__codelineno-208-1"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysfile_open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>清空原本的 mm。vma，分配的 Page，页表等等都会被清除。(user 此时是内核进程，因此没有 mm)</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-209-1"><a id="__codelineno-209-1" name="__codelineno-209-1" href="#__codelineno-209-1"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-209-2"><a id="__codelineno-209-2" name="__codelineno-209-2" href="#__codelineno-209-2"></a><span class="w">        </span><span class="n">lcr3</span><span class="p">(</span><span class="n">boot_cr3</span><span class="p">);</span>
</span><span id="__span-209-3"><a id="__codelineno-209-3" name="__codelineno-209-3" href="#__codelineno-209-3"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm_count_dec</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-209-4"><a id="__codelineno-209-4" name="__codelineno-209-4" href="#__codelineno-209-4"></a><span class="w">            </span><span class="n">exit_mmap</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-209-5"><a id="__codelineno-209-5" name="__codelineno-209-5" href="#__codelineno-209-5"></a><span class="w">            </span><span class="n">put_pgdir</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-209-6"><a id="__codelineno-209-6" name="__codelineno-209-6" href="#__codelineno-209-6"></a><span class="w">            </span><span class="n">mm_destroy</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-209-7"><a id="__codelineno-209-7" name="__codelineno-209-7" href="#__codelineno-209-7"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-209-8"><a id="__codelineno-209-8" name="__codelineno-209-8" href="#__codelineno-209-8"></a><span class="w">        </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-209-9"><a id="__codelineno-209-9" name="__codelineno-209-9" href="#__codelineno-209-9"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>调用 load_icode</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-210-1"><a id="__codelineno-210-1" name="__codelineno-210-1" href="#__codelineno-210-1"></a><span class="n">load_icode</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">kargv</span><span class="p">)</span>
</span></code></pre></div>
<p>调用完 load_icode 后，elf 文件已经被全部加载进内存，并且根据 elf 文件 program header 的内容设置好了 vma，页表等内容。还分配了 USTACK 空间。</p>
</li>
</ol>
</li>
<li>
<p>load_icode 做的事情</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-211-1"><a id="__codelineno-211-1" name="__codelineno-211-1" href="#__codelineno-211-1"></a><span class="c1">// load_icode -  called by sys_exec--&gt;do_execve</span>
</span><span id="__span-211-2"><a id="__codelineno-211-2" name="__codelineno-211-2" href="#__codelineno-211-2"></a><span class="c1">// 1. create a new mm for current process</span>
</span><span id="__span-211-3"><a id="__codelineno-211-3" name="__codelineno-211-3" href="#__codelineno-211-3"></a><span class="c1">// 2. create a new PDT, and mm-&gt;pgdir= kernel virtual addr of PDT</span>
</span><span id="__span-211-4"><a id="__codelineno-211-4" name="__codelineno-211-4" href="#__codelineno-211-4"></a><span class="c1">// 3. copy TEXT/DATA/BSS parts in binary to memory space of process</span>
</span><span id="__span-211-5"><a id="__codelineno-211-5" name="__codelineno-211-5" href="#__codelineno-211-5"></a><span class="c1">// 4. call mm_map to setup user stack, and put parameters into user stack</span>
</span><span id="__span-211-6"><a id="__codelineno-211-6" name="__codelineno-211-6" href="#__codelineno-211-6"></a><span class="c1">// 5. setup trapframe for user environment </span>
</span><span id="__span-211-7"><a id="__codelineno-211-7" name="__codelineno-211-7" href="#__codelineno-211-7"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-211-8"><a id="__codelineno-211-8" name="__codelineno-211-8" href="#__codelineno-211-8"></a><span class="n">load_icode</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">kargv</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>
<p>创建新的 mm</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-212-1"><a id="__codelineno-212-1" name="__codelineno-212-1" href="#__codelineno-212-1"></a><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-212-2"><a id="__codelineno-212-2" name="__codelineno-212-2" href="#__codelineno-212-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-212-3"><a id="__codelineno-212-3" name="__codelineno-212-3" href="#__codelineno-212-3"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_mm</span><span class="p">;</span>
</span><span id="__span-212-4"><a id="__codelineno-212-4" name="__codelineno-212-4" href="#__codelineno-212-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-212-5"><a id="__codelineno-212-5" name="__codelineno-212-5" href="#__codelineno-212-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setup_pgdir</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-212-6"><a id="__codelineno-212-6" name="__codelineno-212-6" href="#__codelineno-212-6"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_pgdir_cleanup_mm</span><span class="p">;</span>
</span><span id="__span-212-7"><a id="__codelineno-212-7" name="__codelineno-212-7" href="#__codelineno-212-7"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>接下来涉及到对 elf 文件的解析。首先调用 load_icode_read 读取 elf 头 (struct elfhdr32)。然后根据 elfhdr，获得程序头 (struct proghdr) 的文件内偏移 elf-&gt;e_phoff、程序头的数量 elf-&gt;e_phnum。再通过 for 循环，读取每个程序头 ph。程序头显示了每个段的信息。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-213-1"><a id="__codelineno-213-1" name="__codelineno-213-1" href="#__codelineno-213-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">phnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">phnum</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span><span class="w"> </span><span class="n">phnum</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-213-2"><a id="__codelineno-213-2" name="__codelineno-213-2" href="#__codelineno-213-2"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">phoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proghdr</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">phnum</span><span class="p">;</span>
</span><span id="__span-213-3"><a id="__codelineno-213-3" name="__codelineno-213-3" href="#__codelineno-213-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_icode_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proghdr</span><span class="p">),</span><span class="w"> </span><span class="n">phoff</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-213-4"><a id="__codelineno-213-4" name="__codelineno-213-4" href="#__codelineno-213-4"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-213-5"><a id="__codelineno-213-5" name="__codelineno-213-5" href="#__codelineno-213-5"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-213-6"><a id="__codelineno-213-6" name="__codelineno-213-6" href="#__codelineno-213-6"></a><span class="w">    </span><span class="p">...</span>
</span></code></pre></div>
<p>readelf -l  obj/user/sh的信息</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-214-1"><a id="__codelineno-214-1" name="__codelineno-214-1" href="#__codelineno-214-1"></a>Elf 文件类型为 EXEC (可执行文件)
</span><span id="__span-214-2"><a id="__codelineno-214-2" name="__codelineno-214-2" href="#__codelineno-214-2"></a>Entry point 0x100033d0
</span><span id="__span-214-3"><a id="__codelineno-214-3" name="__codelineno-214-3" href="#__codelineno-214-3"></a>There are 2 program headers, starting at offset 52
</span><span id="__span-214-4"><a id="__codelineno-214-4" name="__codelineno-214-4" href="#__codelineno-214-4"></a>
</span><span id="__span-214-5"><a id="__codelineno-214-5" name="__codelineno-214-5" href="#__codelineno-214-5"></a>程序头：
</span><span id="__span-214-6"><a id="__codelineno-214-6" name="__codelineno-214-6" href="#__codelineno-214-6"></a>  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
</span><span id="__span-214-7"><a id="__codelineno-214-7" name="__codelineno-214-7" href="#__codelineno-214-7"></a>  ABIFLAGS       0x0141d0 0x100041d0 0x100041d0 0x00018 0x00018 R   0x8
</span><span id="__span-214-8"><a id="__codelineno-214-8" name="__codelineno-214-8" href="#__codelineno-214-8"></a>  LOAD           0x010000 0x10000000 0x10000000 0x05010 0x09010 RWE 0x10000
</span><span id="__span-214-9"><a id="__codelineno-214-9" name="__codelineno-214-9" href="#__codelineno-214-9"></a>
</span><span id="__span-214-10"><a id="__codelineno-214-10" name="__codelineno-214-10" href="#__codelineno-214-10"></a> Section to Segment mapping:
</span><span id="__span-214-11"><a id="__codelineno-214-11" name="__codelineno-214-11" href="#__codelineno-214-11"></a>  段节...
</span><span id="__span-214-12"><a id="__codelineno-214-12" name="__codelineno-214-12" href="#__codelineno-214-12"></a>   00     .MIPS.abiflags 
</span><span id="__span-214-13"><a id="__codelineno-214-13" name="__codelineno-214-13" href="#__codelineno-214-13"></a>   01     .text .MIPS.abiflags .data .bss
</span></code></pre></div>
</li>
<li>
<p>根据每个 ph 的信息，添加 vma。这里用的是 ph-&gt;p_memsz。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-215-1"><a id="__codelineno-215-1" name="__codelineno-215-1" href="#__codelineno-215-1"></a><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-215-2"><a id="__codelineno-215-2" name="__codelineno-215-2" href="#__codelineno-215-2"></a><span class="w">      </span><span class="c1">//ptep_set_u_read(&amp;perm);</span>
</span><span id="__span-215-3"><a id="__codelineno-215-3" name="__codelineno-215-3" href="#__codelineno-215-3"></a><span class="w">    </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">;</span>
</span><span id="__span-215-4"><a id="__codelineno-215-4" name="__codelineno-215-4" href="#__codelineno-215-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_X</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_EXEC</span><span class="p">;</span>
</span><span id="__span-215-5"><a id="__codelineno-215-5" name="__codelineno-215-5" href="#__codelineno-215-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_W</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">;</span>
</span><span id="__span-215-6"><a id="__codelineno-215-6" name="__codelineno-215-6" href="#__codelineno-215-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_R</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_READ</span><span class="p">;</span>
</span><span id="__span-215-7"><a id="__codelineno-215-7" name="__codelineno-215-7" href="#__codelineno-215-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">)</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-215-8"><a id="__codelineno-215-8" name="__codelineno-215-8" href="#__codelineno-215-8"></a>
</span><span id="__span-215-9"><a id="__codelineno-215-9" name="__codelineno-215-9" href="#__codelineno-215-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_map</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">,</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-215-10"><a id="__codelineno-215-10" name="__codelineno-215-10" href="#__codelineno-215-10"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-215-11"><a id="__codelineno-215-11" name="__codelineno-215-11" href="#__codelineno-215-11"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>调用 pgdir_alloc_page 为每个虚拟地址分配物理页，并添加页表映射。调用 load_icode_read 将 elf 文件对应段 (segment) 读取到对应的物理页中。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-216-1"><a id="__codelineno-216-1" name="__codelineno-216-1" href="#__codelineno-216-1"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="p">;</span>
</span><span id="__span-216-2"><a id="__codelineno-216-2" name="__codelineno-216-2" href="#__codelineno-216-2"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-216-3"><a id="__codelineno-216-3" name="__codelineno-216-3" href="#__codelineno-216-3"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-216-4"><a id="__codelineno-216-4" name="__codelineno-216-4" href="#__codelineno-216-4"></a>
</span><span id="__span-216-5"><a id="__codelineno-216-5" name="__codelineno-216-5" href="#__codelineno-216-5"></a><span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_filesz</span><span class="p">;</span>
</span><span id="__span-216-6"><a id="__codelineno-216-6" name="__codelineno-216-6" href="#__codelineno-216-6"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-216-7"><a id="__codelineno-216-7" name="__codelineno-216-7" href="#__codelineno-216-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-216-8"><a id="__codelineno-216-8" name="__codelineno-216-8" href="#__codelineno-216-8"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-216-9"><a id="__codelineno-216-9" name="__codelineno-216-9" href="#__codelineno-216-9"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-216-10"><a id="__codelineno-216-10" name="__codelineno-216-10" href="#__codelineno-216-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-216-11"><a id="__codelineno-216-11" name="__codelineno-216-11" href="#__codelineno-216-11"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-216-12"><a id="__codelineno-216-12" name="__codelineno-216-12" href="#__codelineno-216-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-216-13"><a id="__codelineno-216-13" name="__codelineno-216-13" href="#__codelineno-216-13"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-216-14"><a id="__codelineno-216-14" name="__codelineno-216-14" href="#__codelineno-216-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-216-15"><a id="__codelineno-216-15" name="__codelineno-216-15" href="#__codelineno-216-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_icode_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-216-16"><a id="__codelineno-216-16" name="__codelineno-216-16" href="#__codelineno-216-16"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-216-17"><a id="__codelineno-216-17" name="__codelineno-216-17" href="#__codelineno-216-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-216-18"><a id="__codelineno-216-18" name="__codelineno-216-18" href="#__codelineno-216-18"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-216-19"><a id="__codelineno-216-19" name="__codelineno-216-19" href="#__codelineno-216-19"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>设置 bss 段（猜测）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-217-1"><a id="__codelineno-217-1" name="__codelineno-217-1" href="#__codelineno-217-1"></a><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">;</span>
</span><span id="__span-217-2"><a id="__codelineno-217-2" name="__codelineno-217-2" href="#__codelineno-217-2"></a>
</span><span id="__span-217-3"><a id="__codelineno-217-3" name="__codelineno-217-3" href="#__codelineno-217-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-217-4"><a id="__codelineno-217-4" name="__codelineno-217-4" href="#__codelineno-217-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-217-5"><a id="__codelineno-217-5" name="__codelineno-217-5" href="#__codelineno-217-5"></a><span class="w">            </span><span class="k">continue</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-217-6"><a id="__codelineno-217-6" name="__codelineno-217-6" href="#__codelineno-217-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-217-7"><a id="__codelineno-217-7" name="__codelineno-217-7" href="#__codelineno-217-7"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
</span><span id="__span-217-8"><a id="__codelineno-217-8" name="__codelineno-217-8" href="#__codelineno-217-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-217-9"><a id="__codelineno-217-9" name="__codelineno-217-9" href="#__codelineno-217-9"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-217-10"><a id="__codelineno-217-10" name="__codelineno-217-10" href="#__codelineno-217-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-217-11"><a id="__codelineno-217-11" name="__codelineno-217-11" href="#__codelineno-217-11"></a><span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-217-12"><a id="__codelineno-217-12" name="__codelineno-217-12" href="#__codelineno-217-12"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-217-13"><a id="__codelineno-217-13" name="__codelineno-217-13" href="#__codelineno-217-13"></a><span class="w">        </span><span class="n">assert</span><span class="p">((</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">la</span><span class="p">));</span>
</span><span id="__span-217-14"><a id="__codelineno-217-14" name="__codelineno-217-14" href="#__codelineno-217-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-217-15"><a id="__codelineno-217-15" name="__codelineno-217-15" href="#__codelineno-217-15"></a>
</span><span id="__span-217-16"><a id="__codelineno-217-16" name="__codelineno-217-16" href="#__codelineno-217-16"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-217-17"><a id="__codelineno-217-17" name="__codelineno-217-17" href="#__codelineno-217-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-217-18"><a id="__codelineno-217-18" name="__codelineno-217-18" href="#__codelineno-217-18"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-217-19"><a id="__codelineno-217-19" name="__codelineno-217-19" href="#__codelineno-217-19"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-217-20"><a id="__codelineno-217-20" name="__codelineno-217-20" href="#__codelineno-217-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-217-21"><a id="__codelineno-217-21" name="__codelineno-217-21" href="#__codelineno-217-21"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-217-22"><a id="__codelineno-217-22" name="__codelineno-217-22" href="#__codelineno-217-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-217-23"><a id="__codelineno-217-23" name="__codelineno-217-23" href="#__codelineno-217-23"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-217-24"><a id="__codelineno-217-24" name="__codelineno-217-24" href="#__codelineno-217-24"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-217-25"><a id="__codelineno-217-25" name="__codelineno-217-25" href="#__codelineno-217-25"></a><span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-217-26"><a id="__codelineno-217-26" name="__codelineno-217-26" href="#__codelineno-217-26"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-217-27"><a id="__codelineno-217-27" name="__codelineno-217-27" href="#__codelineno-217-27"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>映射用户栈空间（添加 vma，当发生 pagefault 时，异常处理程序会自动分配物理页）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-218-1"><a id="__codelineno-218-1" name="__codelineno-218-1" href="#__codelineno-218-1"></a><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_STACK</span><span class="p">;</span>
</span><span id="__span-218-2"><a id="__codelineno-218-2" name="__codelineno-218-2" href="#__codelineno-218-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_map</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">USTACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">USTACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-218-3"><a id="__codelineno-218-3" name="__codelineno-218-3" href="#__codelineno-218-3"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-218-4"><a id="__codelineno-218-4" name="__codelineno-218-4" href="#__codelineno-218-4"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>将函数调用参数压入用户栈中</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-219-1"><a id="__codelineno-219-1" name="__codelineno-219-1" href="#__codelineno-219-1"></a><span class="w">   </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">stacktop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-219-2"><a id="__codelineno-219-2" name="__codelineno-219-2" href="#__codelineno-219-2"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">uargv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="p">)(</span><span class="n">stacktop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">));</span>
</span><span id="__span-219-3"><a id="__codelineno-219-3" name="__codelineno-219-3" href="#__codelineno-219-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-219-4"><a id="__codelineno-219-4" name="__codelineno-219-4" href="#__codelineno-219-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-219-5"><a id="__codelineno-219-5" name="__codelineno-219-5" href="#__codelineno-219-5"></a><span class="w">        </span><span class="n">uargv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">stacktop</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">),</span><span class="w"> </span><span class="n">kargv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-219-6"><a id="__codelineno-219-6" name="__codelineno-219-6" href="#__codelineno-219-6"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<p>上一个步骤已经将 USTACKTOP 添加到了 vma 中。因此在第一次访问用户栈时会触发 pagefault（页表中没有映射关系），操作系统会动态分配 Page。第二次访问会再触发一次 tlb refill，tlb 添加映射关系，之后便可以正常访问了。</p>
</li>
<li>
<p>设置 tf。</p>
<p>1. 将 tf-&gt;tf_epc 设置为了 elf-&gt;e_entry。因此异常返回时便开始执行 elf 程序。</p>
<p>3. 在 tf-&gt;tf_status 中设置了 KSU_USER，因此从 SYSCALL 返回后，CPU 会转变为用户态。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-220-1"><a id="__codelineno-220-1" name="__codelineno-220-1" href="#__codelineno-220-1"></a><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-220-2"><a id="__codelineno-220-2" name="__codelineno-220-2" href="#__codelineno-220-2"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="p">));</span>
</span><span id="__span-220-3"><a id="__codelineno-220-3" name="__codelineno-220-3" href="#__codelineno-220-3"></a>
</span><span id="__span-220-4"><a id="__codelineno-220-4" name="__codelineno-220-4" href="#__codelineno-220-4"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_epc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">;</span>
</span><span id="__span-220-5"><a id="__codelineno-220-5" name="__codelineno-220-5" href="#__codelineno-220-5"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_SP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="p">;</span>
</span><span id="__span-220-6"><a id="__codelineno-220-6" name="__codelineno-220-6" href="#__codelineno-220-6"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_c0_status</span><span class="p">();</span>
</span><span id="__span-220-7"><a id="__codelineno-220-7" name="__codelineno-220-7" href="#__codelineno-220-7"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">ST0_KSU</span><span class="p">;</span>
</span><span id="__span-220-8"><a id="__codelineno-220-8" name="__codelineno-220-8" href="#__codelineno-220-8"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">KSU_USER</span><span class="p">;</span><span class="w">     </span><span class="c1">//变成用户进程</span>
</span><span id="__span-220-9"><a id="__codelineno-220-9" name="__codelineno-220-9" href="#__codelineno-220-9"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_EXL</span><span class="p">;</span>
</span><span id="__span-220-10"><a id="__codelineno-220-10" name="__codelineno-220-10" href="#__codelineno-220-10"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-220-11"><a id="__codelineno-220-11" name="__codelineno-220-11" href="#__codelineno-220-11"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span>
</span><span id="__span-220-12"><a id="__codelineno-220-12" name="__codelineno-220-12" href="#__codelineno-220-12"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">uargv</span><span class="p">;</span>
</span></code></pre></div>
</li>
</ol>
</li>
</ol>
<h6 id="调度"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#调度">调度</a></h6>
<p>执行完 proc_init 后，已经创建好了两个内核线程 idle 和 init，并且当前执行的线程为 proc_init。当 ucore 的所有初始化工作完成后，ucore 执行 kern_init 的最后一个函数 cpu_idle 函数。cpu_idle 会调用 schedule 让出 CPU。</p>
<p>schedule 具体的实现我们可以不关心。我们只需要知道 sched_class_enqueue(proc) 将一个进程放入运行队列 run queue。next = sched_class_pick_next() 从 rq 中找到下一个执行的进程。</p>
<p>当选定需要执行的进程后，proc_run 函数将该进程载入 CPU 执行。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-221-1"><a id="__codelineno-221-1" name="__codelineno-221-1" href="#__codelineno-221-1"></a><span class="kt">void</span>
</span><span id="__span-221-2"><a id="__codelineno-221-2" name="__codelineno-221-2" href="#__codelineno-221-2"></a><span class="nf">cpu_idle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-3"><a id="__codelineno-221-3" name="__codelineno-221-3" href="#__codelineno-221-3"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-4"><a id="__codelineno-221-4" name="__codelineno-221-4" href="#__codelineno-221-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-5"><a id="__codelineno-221-5" name="__codelineno-221-5" href="#__codelineno-221-5"></a><span class="w">            </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-221-6"><a id="__codelineno-221-6" name="__codelineno-221-6" href="#__codelineno-221-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-221-7"><a id="__codelineno-221-7" name="__codelineno-221-7" href="#__codelineno-221-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-221-8"><a id="__codelineno-221-8" name="__codelineno-221-8" href="#__codelineno-221-8"></a><span class="p">}</span>
</span><span id="__span-221-9"><a id="__codelineno-221-9" name="__codelineno-221-9" href="#__codelineno-221-9"></a>
</span><span id="__span-221-10"><a id="__codelineno-221-10" name="__codelineno-221-10" href="#__codelineno-221-10"></a><span class="kt">void</span>
</span><span id="__span-221-11"><a id="__codelineno-221-11" name="__codelineno-221-11" href="#__codelineno-221-11"></a><span class="nf">schedule</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-12"><a id="__codelineno-221-12" name="__codelineno-221-12" href="#__codelineno-221-12"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">intr_flag</span><span class="p">;</span>
</span><span id="__span-221-13"><a id="__codelineno-221-13" name="__codelineno-221-13" href="#__codelineno-221-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-221-14"><a id="__codelineno-221-14" name="__codelineno-221-14" href="#__codelineno-221-14"></a><span class="w">    </span><span class="n">local_intr_save</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-221-15"><a id="__codelineno-221-15" name="__codelineno-221-15" href="#__codelineno-221-15"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-221-16"><a id="__codelineno-221-16" name="__codelineno-221-16" href="#__codelineno-221-16"></a><span class="w">        </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-221-17"><a id="__codelineno-221-17" name="__codelineno-221-17" href="#__codelineno-221-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PROC_RUNNABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-18"><a id="__codelineno-221-18" name="__codelineno-221-18" href="#__codelineno-221-18"></a><span class="w">            </span><span class="n">sched_class_enqueue</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span><span id="__span-221-19"><a id="__codelineno-221-19" name="__codelineno-221-19" href="#__codelineno-221-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-221-20"><a id="__codelineno-221-20" name="__codelineno-221-20" href="#__codelineno-221-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_class_pick_next</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-21"><a id="__codelineno-221-21" name="__codelineno-221-21" href="#__codelineno-221-21"></a><span class="w">            </span><span class="n">sched_class_dequeue</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</span><span id="__span-221-22"><a id="__codelineno-221-22" name="__codelineno-221-22" href="#__codelineno-221-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-221-23"><a id="__codelineno-221-23" name="__codelineno-221-23" href="#__codelineno-221-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-24"><a id="__codelineno-221-24" name="__codelineno-221-24" href="#__codelineno-221-24"></a><span class="w">            </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idleproc</span><span class="p">;</span>
</span><span id="__span-221-25"><a id="__codelineno-221-25" name="__codelineno-221-25" href="#__codelineno-221-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-221-26"><a id="__codelineno-221-26" name="__codelineno-221-26" href="#__codelineno-221-26"></a><span class="w">        </span><span class="n">next</span><span class="o">-&gt;</span><span class="n">runs</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-221-27"><a id="__codelineno-221-27" name="__codelineno-221-27" href="#__codelineno-221-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-28"><a id="__codelineno-221-28" name="__codelineno-221-28" href="#__codelineno-221-28"></a><span class="w">            </span><span class="c1">//kprintf(&quot;########################\n&quot;);</span>
</span><span id="__span-221-29"><a id="__codelineno-221-29" name="__codelineno-221-29" href="#__codelineno-221-29"></a><span class="w">            </span><span class="c1">//kprintf(&quot;c %d TO %d\n&quot;, current-&gt;pid, next-&gt;pid);</span>
</span><span id="__span-221-30"><a id="__codelineno-221-30" name="__codelineno-221-30" href="#__codelineno-221-30"></a><span class="w">            </span><span class="c1">//print_trapframe(next-&gt;tf);</span>
</span><span id="__span-221-31"><a id="__codelineno-221-31" name="__codelineno-221-31" href="#__codelineno-221-31"></a><span class="w">            </span><span class="c1">//kprintf(&quot;@@@@@@@@@@@@@@@@@@@@@@@@\n&quot;);</span>
</span><span id="__span-221-32"><a id="__codelineno-221-32" name="__codelineno-221-32" href="#__codelineno-221-32"></a><span class="w">            </span><span class="n">proc_run</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</span><span id="__span-221-33"><a id="__codelineno-221-33" name="__codelineno-221-33" href="#__codelineno-221-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-221-34"><a id="__codelineno-221-34" name="__codelineno-221-34" href="#__codelineno-221-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-221-35"><a id="__codelineno-221-35" name="__codelineno-221-35" href="#__codelineno-221-35"></a><span class="w">    </span><span class="n">local_intr_restore</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-221-36"><a id="__codelineno-221-36" name="__codelineno-221-36" href="#__codelineno-221-36"></a><span class="p">}</span>
</span><span id="__span-221-37"><a id="__codelineno-221-37" name="__codelineno-221-37" href="#__codelineno-221-37"></a>
</span><span id="__span-221-38"><a id="__codelineno-221-38" name="__codelineno-221-38" href="#__codelineno-221-38"></a><span class="kt">void</span>
</span><span id="__span-221-39"><a id="__codelineno-221-39" name="__codelineno-221-39" href="#__codelineno-221-39"></a><span class="nf">proc_run</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-40"><a id="__codelineno-221-40" name="__codelineno-221-40" href="#__codelineno-221-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-221-41"><a id="__codelineno-221-41" name="__codelineno-221-41" href="#__codelineno-221-41"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">intr_flag</span><span class="p">;</span>
</span><span id="__span-221-42"><a id="__codelineno-221-42" name="__codelineno-221-42" href="#__codelineno-221-42"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-221-43"><a id="__codelineno-221-43" name="__codelineno-221-43" href="#__codelineno-221-43"></a><span class="w">        </span><span class="n">local_intr_save</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-221-44"><a id="__codelineno-221-44" name="__codelineno-221-44" href="#__codelineno-221-44"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-221-45"><a id="__codelineno-221-45" name="__codelineno-221-45" href="#__codelineno-221-45"></a><span class="w">          </span><span class="c1">//panic(&quot;unimpl&quot;);</span>
</span><span id="__span-221-46"><a id="__codelineno-221-46" name="__codelineno-221-46" href="#__codelineno-221-46"></a><span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-221-47"><a id="__codelineno-221-47" name="__codelineno-221-47" href="#__codelineno-221-47"></a><span class="w">            </span><span class="c1">//load_sp(next-&gt;kstack + KSTACKSIZE);</span>
</span><span id="__span-221-48"><a id="__codelineno-221-48" name="__codelineno-221-48" href="#__codelineno-221-48"></a><span class="w">            </span><span class="n">lcr3</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">cr3</span><span class="p">);</span>
</span><span id="__span-221-49"><a id="__codelineno-221-49" name="__codelineno-221-49" href="#__codelineno-221-49"></a><span class="w">            </span><span class="n">tlb_invalidate_all</span><span class="p">();</span><span class="w">       </span><span class="c1">//标注一下这里的 tlb 清空，待优化</span>
</span><span id="__span-221-50"><a id="__codelineno-221-50" name="__codelineno-221-50" href="#__codelineno-221-50"></a><span class="w">            </span><span class="n">switch_to</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
</span><span id="__span-221-51"><a id="__codelineno-221-51" name="__codelineno-221-51" href="#__codelineno-221-51"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-221-52"><a id="__codelineno-221-52" name="__codelineno-221-52" href="#__codelineno-221-52"></a><span class="w">        </span><span class="n">local_intr_restore</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-221-53"><a id="__codelineno-221-53" name="__codelineno-221-53" href="#__codelineno-221-53"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-221-54"><a id="__codelineno-221-54" name="__codelineno-221-54" href="#__codelineno-221-54"></a><span class="p">}</span>
</span></code></pre></div>
<p>proc_run 会调用 switch_to，switch_to 会：</p>
<ol>
<li>将当前的 context 存储在 prev-&gt;context 中。（注意，context 只包含 s0-s8, sp, gp, ra）</li>
<li>恢复 next-&gt;context</li>
<li>执行<code>j ra</code></li>
</ol>
<h6 id="init-进程执行过程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#init-进程执行过程">init 进程执行过程</a></h6>
<p>通过 kernel_thread(init_main, NULL, 0) 创建 init 进程后</p>
<ol>
<li>
<p>cpu_idle 中（idle 进程中），执行 schedule()，此时只有 idle 和 init 两个进程，因此调度到 init 进程执行 proc_run。</p>
</li>
<li>
<p>执行 switch_to，kernel_thread 设置了 context 中的 sp, ra。执行 jr ra 后，跳转到 forkret</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-222-1"><a id="__codelineno-222-1" name="__codelineno-222-1" href="#__codelineno-222-1"></a><span class="c1">// forkret -- the first kernel entry point of a new thread/process</span>
</span><span id="__span-222-2"><a id="__codelineno-222-2" name="__codelineno-222-2" href="#__codelineno-222-2"></a><span class="c1">// NOTE: the addr of forkret is setted in copy_thread function</span>
</span><span id="__span-222-3"><a id="__codelineno-222-3" name="__codelineno-222-3" href="#__codelineno-222-3"></a><span class="c1">//       after switch_to, the current proc will execute here.</span>
</span><span id="__span-222-4"><a id="__codelineno-222-4" name="__codelineno-222-4" href="#__codelineno-222-4"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-222-5"><a id="__codelineno-222-5" name="__codelineno-222-5" href="#__codelineno-222-5"></a><span class="nf">forkret</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-222-6"><a id="__codelineno-222-6" name="__codelineno-222-6" href="#__codelineno-222-6"></a><span class="w">    </span><span class="n">forkrets</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-222-7"><a id="__codelineno-222-7" name="__codelineno-222-7" href="#__codelineno-222-7"></a><span class="p">}</span>
</span><span id="__span-222-8"><a id="__codelineno-222-8" name="__codelineno-222-8" href="#__codelineno-222-8"></a>
</span><span id="__span-222-9"><a id="__codelineno-222-9" name="__codelineno-222-9" href="#__codelineno-222-9"></a><span class="nl">forkrets</span><span class="p">:</span>
</span><span id="__span-222-10"><a id="__codelineno-222-10" name="__codelineno-222-10" href="#__codelineno-222-10"></a><span class="w">  </span><span class="n">addiu</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
</span><span id="__span-222-11"><a id="__codelineno-222-11" name="__codelineno-222-11" href="#__codelineno-222-11"></a><span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="n">exception_return</span>
</span><span id="__span-222-12"><a id="__codelineno-222-12" name="__codelineno-222-12" href="#__codelineno-222-12"></a><span class="w">  </span><span class="n">nop</span>
</span></code></pre></div>
</li>
<li>
<p>forkrets-&gt;exception_return 从中断返回，弹出中断帧 tf。CPU 便会进入 kernel_thread_entry，并以 tf 中指定的寄存器值执行</p>
</li>
<li>
<p>kernel_thread_entry 跳转执行$a1 即 init_main</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-223-1"><a id="__codelineno-223-1" name="__codelineno-223-1" href="#__codelineno-223-1"></a>//kern/proc/entry.S
</span><span id="__span-223-2"><a id="__codelineno-223-2" name="__codelineno-223-2" href="#__codelineno-223-2"></a>kernel_thread_entry:        # void kernel_thread(void)
</span><span id="__span-223-3"><a id="__codelineno-223-3" name="__codelineno-223-3" href="#__codelineno-223-3"></a>  addiu $sp, $sp, -16
</span><span id="__span-223-4"><a id="__codelineno-223-4" name="__codelineno-223-4" href="#__codelineno-223-4"></a>  jal $a1
</span><span id="__span-223-5"><a id="__codelineno-223-5" name="__codelineno-223-5" href="#__codelineno-223-5"></a>  nop
</span><span id="__span-223-6"><a id="__codelineno-223-6" name="__codelineno-223-6" href="#__codelineno-223-6"></a>  move $a0, $v0
</span><span id="__span-223-7"><a id="__codelineno-223-7" name="__codelineno-223-7" href="#__codelineno-223-7"></a>  la  $t0, do_exit
</span><span id="__span-223-8"><a id="__codelineno-223-8" name="__codelineno-223-8" href="#__codelineno-223-8"></a>  jal $t0 
</span><span id="__span-223-9"><a id="__codelineno-223-9" name="__codelineno-223-9" href="#__codelineno-223-9"></a>  nop
</span><span id="__span-223-10"><a id="__codelineno-223-10" name="__codelineno-223-10" href="#__codelineno-223-10"></a>  /* never here */
</span></code></pre></div>
</li>
</ol>
<h6 id="user_main-的执行过程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#user_main-的执行过程">user_main 的执行过程</a></h6>
<ol>
<li>
<p>在 init_main 中，创建了 user_main 线程。然后 init_main 执行 do_wait</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-224-1"><a id="__codelineno-224-1" name="__codelineno-224-1" href="#__codelineno-224-1"></a><span class="c1">// init_main - the second kernel thread used to create user_main kernel threads</span>
</span><span id="__span-224-2"><a id="__codelineno-224-2" name="__codelineno-224-2" href="#__codelineno-224-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-224-3"><a id="__codelineno-224-3" name="__codelineno-224-3" href="#__codelineno-224-3"></a><span class="nf">init_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-224-4"><a id="__codelineno-224-4" name="__codelineno-224-4" href="#__codelineno-224-4"></a><span class="w"> </span><span class="p">...</span>
</span><span id="__span-224-5"><a id="__codelineno-224-5" name="__codelineno-224-5" href="#__codelineno-224-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">user_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-224-6"><a id="__codelineno-224-6" name="__codelineno-224-6" href="#__codelineno-224-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-224-7"><a id="__codelineno-224-7" name="__codelineno-224-7" href="#__codelineno-224-7"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create user_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-224-8"><a id="__codelineno-224-8" name="__codelineno-224-8" href="#__codelineno-224-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-224-9"><a id="__codelineno-224-9" name="__codelineno-224-9" href="#__codelineno-224-9"></a>
</span><span id="__span-224-10"><a id="__codelineno-224-10" name="__codelineno-224-10" href="#__codelineno-224-10"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">do_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-224-11"><a id="__codelineno-224-11" name="__codelineno-224-11" href="#__codelineno-224-11"></a><span class="w">        </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-224-12"><a id="__codelineno-224-12" name="__codelineno-224-12" href="#__codelineno-224-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-224-13"><a id="__codelineno-224-13" name="__codelineno-224-13" href="#__codelineno-224-13"></a>
</span><span id="__span-224-14"><a id="__codelineno-224-14" name="__codelineno-224-14" href="#__codelineno-224-14"></a><span class="w">    </span><span class="n">fs_cleanup</span><span class="p">();</span>
</span><span id="__span-224-15"><a id="__codelineno-224-15" name="__codelineno-224-15" href="#__codelineno-224-15"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;all user-mode processes have quit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-224-16"><a id="__codelineno-224-16" name="__codelineno-224-16" href="#__codelineno-224-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-224-17"><a id="__codelineno-224-17" name="__codelineno-224-17" href="#__codelineno-224-17"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>do_wait 的作用是等待指定的或者任意一个（传入的 pid 为 0）子线程进入 ZOMBIE 状态，释放子进程的内核栈空间和 PCB 空间。否则，自己进入睡眠状态 SLEEPING，然后调用 schedule()。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-225-1"><a id="__codelineno-225-1" name="__codelineno-225-1" href="#__codelineno-225-1"></a><span class="c1">// do_wait - wait one OR any children with PROC_ZOMBIE state, and free memory space of kernel stack</span>
</span><span id="__span-225-2"><a id="__codelineno-225-2" name="__codelineno-225-2" href="#__codelineno-225-2"></a><span class="c1">//         - proc struct of this child.</span>
</span><span id="__span-225-3"><a id="__codelineno-225-3" name="__codelineno-225-3" href="#__codelineno-225-3"></a><span class="c1">// NOTE: only after do_wait function, all resources of the child proces are free.</span>
</span><span id="__span-225-4"><a id="__codelineno-225-4" name="__codelineno-225-4" href="#__codelineno-225-4"></a><span class="kt">int</span>
</span><span id="__span-225-5"><a id="__codelineno-225-5" name="__codelineno-225-5" href="#__codelineno-225-5"></a><span class="n">do_wait</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">code_store</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>schedule 调用到 user_main 线程。和 init 一样，执行到 user_main 函数。</p>
</li>
<li>
<p>user_main 函数调用了 kernel_execv 函数，实质为一次 SYS_exec 系统调用。</p>
</li>
<li>
<p>最后重新分配内核和用户空间，加载了 sh 用户程序。user_main 线程从内核线程变为用户线程。</p>
</li>
<li>
<p>用户进程链接脚本 user.ld 指定了 ENTRY(_start)。_start 在 user/libs/initcode.S 中定义。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-226-1"><a id="__codelineno-226-1" name="__codelineno-226-1" href="#__codelineno-226-1"></a>_start:
</span><span id="__span-226-2"><a id="__codelineno-226-2" name="__codelineno-226-2" href="#__codelineno-226-2"></a>    nop
</span><span id="__span-226-3"><a id="__codelineno-226-3" name="__codelineno-226-3" href="#__codelineno-226-3"></a>    la $gp, _gp
</span><span id="__span-226-4"><a id="__codelineno-226-4" name="__codelineno-226-4" href="#__codelineno-226-4"></a>    addiu $sp, $sp, -16
</span><span id="__span-226-5"><a id="__codelineno-226-5" name="__codelineno-226-5" href="#__codelineno-226-5"></a>    jal umain
</span><span id="__span-226-6"><a id="__codelineno-226-6" name="__codelineno-226-6" href="#__codelineno-226-6"></a>    nop
</span></code></pre></div>
<p>umain 在 user/libs/umain.c 中定义</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-227-1"><a id="__codelineno-227-1" name="__codelineno-227-1" href="#__codelineno-227-1"></a><span class="kt">void</span>
</span><span id="__span-227-2"><a id="__codelineno-227-2" name="__codelineno-227-2" href="#__codelineno-227-2"></a><span class="nf">umain</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-227-3"><a id="__codelineno-227-3" name="__codelineno-227-3" href="#__codelineno-227-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-227-4"><a id="__codelineno-227-4" name="__codelineno-227-4" href="#__codelineno-227-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initfd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stdin:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-227-5"><a id="__codelineno-227-5" name="__codelineno-227-5" href="#__codelineno-227-5"></a><span class="w">        </span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;open &lt;stdin&gt; failed: %e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-227-6"><a id="__codelineno-227-6" name="__codelineno-227-6" href="#__codelineno-227-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-227-7"><a id="__codelineno-227-7" name="__codelineno-227-7" href="#__codelineno-227-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initfd</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stdout:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-227-8"><a id="__codelineno-227-8" name="__codelineno-227-8" href="#__codelineno-227-8"></a><span class="w">        </span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;open &lt;stdout&gt; failed: %e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-227-9"><a id="__codelineno-227-9" name="__codelineno-227-9" href="#__codelineno-227-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-227-10"><a id="__codelineno-227-10" name="__codelineno-227-10" href="#__codelineno-227-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
</span><span id="__span-227-11"><a id="__codelineno-227-11" name="__codelineno-227-11" href="#__codelineno-227-11"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-227-12"><a id="__codelineno-227-12" name="__codelineno-227-12" href="#__codelineno-227-12"></a><span class="p">}</span>
</span></code></pre></div>
</li>
</ol>
<h5 id="ide_init--fs_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#ide_init--fs_init">ide_init &amp; fs_init</a></h5>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-08 12:02:35+00:00">2021年2月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-meta__link">折腾记录</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="更新固态之旅"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2021/02/08/2021-02-08-%E6%9B%B4%E6%96%B0%E5%9B%BA%E6%80%81%E4%B9%8B%E6%97%85/">更新固态之旅</a></h2>
<p>我姐的电脑是 15-16 年买的，型号为 Acer Aspire V15 Nitro Black Edition(暗影骑士 2，精确型号为 Aspire VN7-592G-58NG)，<a href="http://detail.zol.com.cn/notebook/index1102903.shtml">ZOL</a>上的商品信息</p>
<p>不得不说这台电脑确实是非常厉害了，有以下这些亮眼的地方。</p>
<ul>
<li>i5-6300HQ。HQ 表示标压 - 四核。</li>
<li>NIVIDIA 的 GTX960M 独立显卡。（当时的中端主流显卡）</li>
</ul>
<p>下面这些即使是现在也是完全够用的，特别是那个支持 2x2 MU-MIMO 的无线网卡。</p>
<ul>
<li>Realtek 8168/8111 <strong>千兆</strong>以太网卡。</li>
<li>Qualcommm Atheros NFA344A 无线网卡。（<strong>支持 2x2 MU-MIMO</strong>，Wifi4, Wifi5）<a href="https://oemdrivers.com/network-qualcomm-atheros-qca61x4a-wireless">https://oemdrivers.com/network-qualcomm-atheros-qca61x4a-wireless</a></li>
<li>1 个 USB 2.0， <strong>2 个</strong>USB 3.0，1 个<strong>Thunderbolt 3</strong>接口。s</li>
</ul>
<p>而不仅限于此，这台电脑的扩展性是真的非常不错。</p>
<ul>
<li>2 条内存条插槽。支持最大 32G（原装了一条海力士的 4GB DDR4 2133MHz 内存条）</li>
<li>一个 m.2 插槽，<strong>支持 NVMe 协议</strong>（PCIe Gen3x4，最高 4GB/s）。</li>
</ul>
<p>下面是发现这台电脑支持 NVMe 协议的固态的曲折过程：</p>
<p>在阅读之前，需要以下知识：</p>
<ul>
<li>m.2 接口（也叫 NGFF(Next Generation Form Factor)）</li>
<li>NVMe</li>
</ul>

    
      <nav class="md-post__action">
        <a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2021/02/08/2021-02-08-%E6%9B%B4%E6%96%B0%E5%9B%BA%E6%80%81%E4%B9%8B%E6%97%85/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-01-01 00:00:00+00:00">2021年1月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E9%98%85%E8%AF%BB/" class="md-meta__link">阅读</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linux-内核设计与实现阅读"><a class="toclink" href="../../%E9%98%85%E8%AF%BB/2021/01/01/2021-01-01-linux%E5%86%85%E6%A0%B8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB/">linux 内核设计与实现阅读</a></h2>
<p>linux 内核设计与实现（原书第 3 版）, Robert Love</p>
<ul>
<li>一个内核由：负责响应中断的中断服务程序，负责多个程序分享处理器时间的进程调度程序，负责管理进程地址空间的内存管理程序和网络、进程间通信等系统服务程序组成。</li>
</ul>
<ul>
<li>
<p>应用程序通过系统调用访问内核，内核运行于进程上下文中。（不同进程运行同样的内核代码，上下文不同，因此有不同效果）</p>
<ul>
<li>对于中断来说，内核运行于中断上下文</li>
</ul>
</li>
</ul>
<ul>
<li>单内核和微内核。linux 汲取了微内核的优点：linux 是模块化的，多线程的以及内核本身可调度的。</li>
</ul>
<ul>
<li>inline 函数必须用 static 修饰，涉及到编译，因为 inline 的含义有点像宏。而如果不用 static 修饰，那么其他文件的函数也可以调用它，那么就会导致不得不建立一个符号表项。因此声明为 static 实现起来更简单。</li>
</ul>
<ul>
<li>内核使用的 C 语言用到了 ISO99 和 GUN C 扩展特性，其中几个用的比较广的 GUN C 扩展特性<ul>
<li>内联函数</li>
<li>内联汇编</li>
</ul>
</li>
</ul>

    
      <nav class="md-post__action">
        <a href="../../%E9%98%85%E8%AF%BB/2021/01/01/2021-01-01-linux%E5%86%85%E6%A0%B8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-11 23:05:13+00:00">2020年10月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-meta__link">折腾记录</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="安装-linux-后的配置"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/10/11/2020-10-12-%E5%AE%89%E8%A3%85linux%E5%90%8E%E7%9A%84%E9%85%8D%E7%BD%AE/">安装 linux 后的配置</a></h2>
<div class="toc">
<ul>
<li><a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/10/11/2020-10-12-%E5%AE%89%E8%A3%85linux%E5%90%8E%E7%9A%84%E9%85%8D%E7%BD%AE/#安装-linux-后的配置">安装 linux 后的配置</a></li>
</ul>
</div>
<h3 id="概述"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/10/11/2020-10-12-%E5%AE%89%E8%A3%85linux%E5%90%8E%E7%9A%84%E9%85%8D%E7%BD%AE/#概述">概述</a></h3>
<p>不想每次配置 linux 都需要重新去搜索，因此在自己平时折腾时顺便记录一下（长期更新）</p>

    
      <nav class="md-post__action">
        <a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/10/11/2020-10-12-%E5%AE%89%E8%A3%85linux%E5%90%8E%E7%9A%84%E9%85%8D%E7%BD%AE/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-11 23:04:42+00:00">2020年10月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-meta__link">学习笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="wsl-记录"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/10/11/2020-10-11-WSL%E8%AE%B0%E5%BD%95/">WSL 记录</a></h2>
<h3 id="概述"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/10/11/2020-10-11-WSL%E8%AE%B0%E5%BD%95/#概述">概述</a></h3>
<p>发现使用 wsl + docker + vs code(remote wsl + remote container 插件) 可以让开发、部署、运行整个流程变得更加方便。因此想写一篇文章记录接触 wsl 后了解到的一些知识以及遇到的一些问题以及解决方案（长期更新）。</p>

    
      <nav class="md-post__action">
        <a href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/10/11/2020-10-11-WSL%E8%AE%B0%E5%BD%95/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-11 23:03:51+00:00">2020年10月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-meta__link">学习笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="字体分类"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/10/11/2020-10-11-%E5%AD%97%E4%BD%93%E5%88%86%E7%B1%BB/">字体分类</a></h2>
<div class="toc">
<ul>
<li><a href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/10/11/2020-10-11-%E5%AD%97%E4%BD%93%E5%88%86%E7%B1%BB/#字体分类">字体分类</a></li>
</ul>
</div>
<h3 id="概述"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/10/11/2020-10-11-%E5%AD%97%E4%BD%93%E5%88%86%E7%B1%BB/#概述">概述</a></h3>
<p>目前还没有一种统一的字体分类方法。因此本文从易于理解的角度，使用 4 个维度对字体进行分类。</p>
<p>简单来说，确定了大小、粗细、样式和字体系列后便确定了一种字体。</p>
<h4 id="font-family"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/10/11/2020-10-11-%E5%AD%97%E4%BD%93%E5%88%86%E7%B1%BB/#font-family">font family</a></h4>
<p><strong>字体系列</strong>(font family) 表示符合同一种设计风格的字体的集合。比如大名鼎鼎的 Helvetica 字体就因醒目，清晰而广泛应用于广告，宣传语等场合。Time New Roman 也是一种使用非常广泛的字体。</p>
<p>一种字体系列包含多种变体字体，如 Times 包含 TimeIt(倾斜), TimeBd(加粗) 等。我们口语中说的某一种字体，其实通常说的是一种字体系列。</p>
<p>而对于现有的五花八门的字体系列，可以根据一些特点分成 5 类，也叫<strong>通用字体系列</strong>(generic font families)。如 Helvetica 就属于无衬线 (sans serif) 字体。</p>
<p>以下是字体系列的 5 种类别</p>

    
      <nav class="md-post__action">
        <a href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/10/11/2020-10-11-%E5%AD%97%E4%BD%93%E5%88%86%E7%B1%BB/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-11 23:03:15+00:00">2020年10月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-meta__link">折腾记录</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在虚拟机上搭建-overleaf"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/10/11/2020-10-10-%E5%9C%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A%E6%90%AD%E5%BB%BAoverleaf/">在虚拟机上搭建 overleaf</a></h2>
<div class="toc">
<ul>
<li><a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/10/11/2020-10-10-%E5%9C%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A%E6%90%AD%E5%BB%BAoverleaf/#在虚拟机上搭建-overleaf">在虚拟机上搭建 overleaf</a></li>
</ul>
</div>
<h3 id="概述"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/10/11/2020-10-10-%E5%9C%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A%E6%90%AD%E5%BB%BAoverleaf/#概述">概述</a></h3>
<p>因为学校的 overleaf 无法通过 latex 代码定位到 pdf 位置。因此想在本地搭建一个 latex 环境，而如果在 windows 里安装 texlive+ 配置 VS code 比较麻烦，且以后重装系统又无法保留，因此考虑在 ubuntu 虚拟机里安装。</p>
<p>这里考虑同样搭建一个 overleaf，毕竟在主机里打开浏览器直接就能用就很方便，且界面也更美观。</p>
<hr />
<p>更新</p>
<p>在 virtualbox 虚拟机搭建后发现存在性能问题。以编译计组指导书为例，每次修改编译需要 1 分钟，并且经常出现编译 2-3 分钟然后失败的情况。</p>
<p>在查阅 wsl 性能比较后，发现 wsl2 的性能已经比较好了，有些场合接近原生 linux 的性能。参考<a href="https://www.phoronix.com/scan.php?page=article&amp;item=windows10-may2020-wsl2&amp;num=1">Windows 10 May 2020 Performance For WSL vs. WSL2</a></p>
<p>于是补充了在 wsl2 上搭建的内容。</p>

    
      <nav class="md-post__action">
        <a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/10/11/2020-10-10-%E5%9C%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A%E6%90%AD%E5%BB%BAoverleaf/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-20 23:52:30+00:00">2020年9月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-meta__link">课程笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ucore-lab3-总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/09/20/2020-09-20-ucore-lab3-%E6%80%BB%E7%BB%93/">ucore lab3 总结</a></h2>
<h4 id="目录"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/09/20/2020-09-20-ucore-lab3-%E6%80%BB%E7%BB%93/#目录">目录</a></h4>
<ol>
<li>x86 中断/异常处理 (tss 和 tf 作用)</li>
<li>重要函数说明
    1. 创建进程 (线程)
    2. 调度，运行
    3. do_wait &amp; do_exit
    4. do_execve
    5. 其它系统调用</li>
<li>FAQ
    1. 一个进程被创建后如何开始执行？
    2. 一个用户进程如果因为时间片用完而被调度掉后，再次被调度回来时会从哪里继续执行？
    3. 一个进程的完整生命周期？
    4. fork 调用，为什么父进程返回值为 pid，子进程返回值为 0（<strong>涉及到用户进程的创建</strong>）</li>
</ol>
<h4 id="总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/09/20/2020-09-20-ucore-lab3-%E6%80%BB%E7%BB%93/#总结">总结</a></h4>
<p>实验 3 涉及到的知识点：</p>
<ol>
<li>x86 中断中 tss 的作用（类似的内核栈，中断帧的概念）</li>
<li>进程如何创建、执行、切换（do_fork, do_wait, do_exit 等系统调用的设计与实现）</li>
<li>用户进程的创建、执行过程</li>
<li>用户 ulib 库 fork, wait, exit 的实现</li>
</ol>

    
      <nav class="md-post__action">
        <a href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/09/20/2020-09-20-ucore-lab3-%E6%80%BB%E7%BB%93/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-14 20:59:11+00:00">2020年9月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-meta__link">课程笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ucore-lab2-总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/09/14/2020-09-14-ucore-lab2%E6%80%BB%E7%BB%93/">ucore lab2 总结</a></h2>
<h3 id="概述"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/09/14/2020-09-14-ucore-lab2%E6%80%BB%E7%BB%93/#概述">概述</a></h3>
<p>回顾实验 1，我觉得需要学习的知识有：</p>
<ol>
<li><strong>gdb</strong>工具的使用</li>
<li><strong>ELF</strong>文件的格式，以及 readelf, objdump, objcopy 工具的使用（查看各个 section，查看符号表）</li>
<li>x86 汇编基础（通用寄存器，段寄存器，EIP，EFLAG 等），GCC<strong>内联汇编</strong>格式（AT&amp;T 格式）</li>
<li>x86 内存<strong>分段</strong>机制（GDT 表，段描述符）</li>
<li>x86<strong>中断</strong>处理机制（IDT 表，中断向量 -&gt; 中断处理程序）</li>
<li>操作系统启动过程（BIOS-&gt;bootloader(第一扇区)-&gt;Kernel 各阶段做的事情）</li>
</ol>
<p>而做完实验 2 后，我觉得需要学习的知识有：</p>
<ol>
<li>BIOS 探测物理内存，Kernel 打开分页时自带一个页表</li>
<li><strong>二级页表</strong>进行虚拟地址转换</li>
<li>物理内存管理 之 <strong>空闲块</strong>(以页为单位) 管理（Page 数据结构和物理页的对应，空闲块链表 free_list，FirstHit 分配连续的物理页）</li>
<li>虚拟内存管理 之 <strong>有效虚拟页</strong>（表示一个程序可能使用的虚拟地址段，vma, mm 数据结构）</li>
<li>导致<strong>PageFault</strong>的原因（1. pte=0 即从来没有被加载过，2. 被 swap out, 3. 访问权限错误）</li>
<li><strong>FIFO 页替换</strong>算法实现（page struct 增加 pra_page_link, pra_vaddr，mm-&gt;sm_priv(<strong>pra_list_header</strong>) 记录最近使用的页序列；swap_manager）</li>
</ol>
<p>以下介绍一些难点</p>

    
      <nav class="md-post__action">
        <a href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/09/14/2020-09-14-ucore-lab2%E6%80%BB%E7%BB%93/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-07 20:56:47+00:00">2020年9月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E4%B8%AA%E4%BA%BA/" class="md-meta__link">个人</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="关于-2020-到目前的一个总结"><a class="toclink" href="../../%E4%B8%AA%E4%BA%BA/2020/09/07/2020-09-07-%E5%85%B3%E4%BA%8E2020%E5%88%B0%E7%9B%AE%E5%89%8D%E7%9A%84%E4%B8%80%E4%B8%AA%E6%80%BB%E7%BB%93/">关于 2020 到目前的一个总结</a></h2>
<p>2020 年对全人类来说是不平凡的一年，而对我来说也是不同寻常的一年。这一年发生了许多大大小小的事，有些事情身处其中时觉得非常不得了，而经历过后，又觉得也许很快就会忘记，因此想记录一些这一年我都干了些什么事。</p>

    
      <nav class="md-post__action">
        <a href="../../%E4%B8%AA%E4%BA%BA/2020/09/07/2020-09-07-%E5%85%B3%E4%BA%8E2020%E5%88%B0%E7%9B%AE%E5%89%8D%E7%9A%84%E4%B8%80%E4%B8%AA%E6%80%BB%E7%BB%93/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-07 19:02:24+00:00">2020年9月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-meta__link">折腾记录</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="virtual-box-配置双网卡"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/09/07/2020-09-07-Virtual-Box%E9%85%8D%E7%BD%AE%E5%8F%8C%E7%BD%91%E5%8D%A1/">Virtual Box 配置双网卡</a></h2>
<p>由于目前在电脑上运行一个虚拟机已经比较流畅，而虚拟机又有着真机无法比拟的优势，如：</p>
<ul>
<li>可以快速地进行备份与还原，且备份的虚拟机镜像可以复制到其它电脑上</li>
<li>可以保存虚拟机当前的运行状态（快速休眠），而下次启动时恢复运行（且速度很快）</li>
</ul>
<p>因此我配置了一台 Ubuntu18.0 的虚拟机，并做了以下配置：</p>
<ul>
<li>配置了 build-essential, python3, git, vim 等常用软件</li>
<li>配置了 zsh，以及一些 zsh 的插件如自动提示，命令高亮，auto-jump</li>
<li>配置了 VS Code, Chromium 软件</li>
<li>配置了 nodejs, cnpm, hexo 等，用于编写 hexo 博客</li>
<li>启动 sshd，并配置网络</li>
</ul>
<p>其中，关于最后一点。刚开始我采用了桥接网络 + 静态 ip 的方案。但是发现当主机网络环境改变时，ssh 便连接不上了，于是便有了这篇博客。</p>

    
      <nav class="md-post__action">
        <a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/09/07/2020-09-07-Virtual-Box%E9%85%8D%E7%BD%AE%E5%8F%8C%E7%BD%91%E5%8D%A1/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-31 22:50:15+00:00">2020年5月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-meta__link">课程笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="编译原理总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/05/31/2020-05-31-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/">编译原理总结</a></h2>
<h3 id="目前我眼中的计算机层次"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/05/31/2020-05-31-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/#目前我眼中的计算机层次">目前我眼中的计算机层次</a></h3>
<ul>
<li>计算机体系结构（RTL 级设计，流水线，缓存，多发射）</li>
<li>ISA（访存模式，中断/异常）</li>
<li>汇编语言（寄存器 + 内存空间）</li>
<li>高级语言（编译器）</li>
<li>操作系统（内核：进程调度，同步与死锁，内存管理：页表，文件系统
    应用：桌面系统，浏览器）</li>
</ul>
<h3 id="编译器各阶段"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/05/31/2020-05-31-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/#编译器各阶段">编译器各阶段</a></h3>
<ol>
<li>
<p><strong>词法分析</strong>：解析源代码文件，输出记号流。
记号即指一个有独立意义的“单词”。空白字符便一般不包含意义，故可以省略。
这些单词一般可分类为：标识符，常数（整数，浮点数），字符常量，字符串，
操作符，界符，关键字。</p>
</li>
<li>
<p><strong>语法分析</strong>：分析记号流，输出程序的逻辑结构，如语法分析树（或 AST 树）
一种语言的语法规则可以被文法产生式完全定义。
文法一般包括表达式的定义，各种语句的定义（if, while, for），变量声明，
函数定义等。</p>
</li>
</ol>

    
      <nav class="md-post__action">
        <a href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/05/31/2020-05-31-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-09 12:00:00+00:00">2020年4月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-meta__link">折腾记录</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cloudview-平台运行-bad-apple"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/04/09/2020-04-09-CloudView%E5%B9%B3%E5%8F%B0%E8%BF%90%E8%A1%8Cbad%20apple/">CloudView 平台运行 bad apple</a></h2>
<p>重写了 bad-apple 的代码，利用了多进程的方式进行视频转换。</p>
<p>以下是各个配置转换 bad apple.mp4 的时间</p>
<table>
<thead>
<tr>
<th></th>
<th>线性执行</th>
<th>4 线程</th>
<th>1 进程</th>
<th>2 进程</th>
<th>4 进程</th>
<th>8 进程</th>
<th>16 进程</th>
</tr>
</thead>
<tbody>
<tr>
<td>时间 (秒)</td>
<td>34.97</td>
<td>34.70</td>
<td>35.05</td>
<td>24.15</td>
<td>18.11</td>
<td>18.09</td>
<td>18</td>
</tr>
</tbody>
</table>
<p>其中线程为采用 threading 库，进程则采用 multiprocessing 库</p>
<p>我的电脑配置为：</p>
<table>
<thead>
<tr>
<th>CPU</th>
<th>intel(R) Core(TM) i5-7200U CPU @ 2.50GHz 2.70GHz</th>
</tr>
</thead>
<tbody>
<tr>
<td>RAM</td>
<td>8.00 GB</td>
</tr>
<tr>
<td>Windows</td>
<td>Windows10 家庭版 1909 18363.720</td>
</tr>
</tbody>
</table>
<p>官方文档说明了 threading 库底层实现时仍只有一个线程，因而只适用于大量 I/O 并发的情况。而我们的图片转换成字符画的过程主要是计算密集型，因此基本没有改善性能。</p>
<p>而采用多进程时，刚好对应我电脑的 4 线程（2 核，采用超线程技术可以有 4 个线程，其实这里进程线程有点晕）时提升最大。</p>
<p>于是便想知道 32 个核时，能提升多少，便想在服务器上跑跑看。以下是配置运行过程。</p>
<p>出人意料的结果：</p>
<table>
<thead>
<tr>
<th></th>
<th>1 进程</th>
<th>4 线程</th>
<th>8 进程</th>
<th>16 进程</th>
<th>32 进程</th>
</tr>
</thead>
<tbody>
<tr>
<td>时间 (秒)</td>
<td>51</td>
<td>24</td>
<td>23.22</td>
<td>21.57</td>
<td>21.14</td>
</tr>
</tbody>
</table>
<p>可能进程多了后，写文件的速度反而成了瓶颈，查看 top 发现各个核的 cpu 利用率都只有 10% 左右，在代码中输出 cvt_frame.qsize() 也发现几乎都是满的。（在自己电脑上大多数都是 0，表明 cvt_frame 供不应求）</p>

    
      <nav class="md-post__action">
        <a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/04/09/2020-04-09-CloudView%E5%B9%B3%E5%8F%B0%E8%BF%90%E8%A1%8Cbad%20apple/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-01 01:25:00+00:00">2020年3月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-meta__link">学习笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="use-dlib-in-c"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/">Use dlib in C++</a></h2>
<h3 id="use-dlib-in-c_1"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#use-dlib-in-c_1">use dlib in c++</a></h3>
<p>从方法 1.1 到 1.3 都不必预编译 dlib 库，而是在使用 dlib 的项目中编译。</p>
<p>方法 1.4 介绍了将 dlib 预编译成静态库然后使用时会遇到的一些问题。</p>
<h4 id="with-cmakeofficially-recommend"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#with-cmakeofficially-recommend">with CMake(officially recommend)</a></h4>
<p>看<code>dlib/example/CMakeLists.txt</code></p>
<div class="language-cmake highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">2.8.12</span><span class="p">)</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nb">project</span><span class="p">(</span><span class="s">examples</span><span class="p">)</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c"># Tell cmake we will need dlib.  This command will pull in dlib and compile it</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="c"># into your project.  Note that you don&#39;t need to compile or install dlib.  All</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="c"># cmake needs is the dlib source code folder and it will take care of everything.</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">./dlib</span><span class="w"> </span><span class="s">dlib_build</span><span class="p">)</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="nb">macro</span><span class="p">(</span><span class="s">add_example</span><span class="w"> </span><span class="s">name</span><span class="p">)</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">   </span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">.cpp</span><span class="p">)</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">   </span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="w"> </span><span class="s">dlib::dlib</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="nb">endmacro</span><span class="p">()</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="c"># if an example requires GUI, call this macro to check DLIB_NO_GUI_SUPPORT to include or exclude</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="nb">macro</span><span class="p">(</span><span class="s">add_gui_example</span><span class="w"> </span><span class="s">name</span><span class="p">)</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">   </span><span class="nb">if</span><span class="w"> </span><span class="p">(</span><span class="s">DLIB_NO_GUI_SUPPORT</span><span class="p">)</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">      </span><span class="nb">message</span><span class="p">(</span><span class="s2">&quot;No GUI support, so we won&#39;t build the ${name} example.&quot;</span><span class="p">)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">   </span><span class="nb">else</span><span class="p">()</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">      </span><span class="nb">add_example</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="p">)</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">   </span><span class="nb">endif</span><span class="p">()</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="nb">endmacro</span><span class="p">()</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="c"># </span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="nb">add_gui_example</span><span class="p">(</span><span class="s">3d_point_cloud_ex</span><span class="p">)</span>
</span></code></pre></div>
<p>命令行执行：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>mkdir<span class="w"> </span>build
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nb">cd</span><span class="w"> </span>build
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>cmake<span class="w"> </span>..<span class="w"> </span>-G<span class="w"> </span><span class="s2">&quot;Visual Studio 14 2015 Win64&quot;</span><span class="w"> </span>-T<span class="w"> </span><span class="nv">host</span><span class="o">=</span>x64<span class="w"> </span><span class="c1">#-T host=x64告诉CMake生成64bit的可执行文件。其实安装了最新的VisualStudio后，-G -T都不用指定，默认使用最新的VisualStudio，默认64位。</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>cmake<span class="w"> </span>--build<span class="w"> </span>.<span class="w"> </span>--config<span class="w"> </span>Release
</span></code></pre></div>
<p>使用 CMake GUI 可以设置一些选项，configure, generate 之后可以使用命令行执行最后一步 (不用打开 VisualStudio)</p>
<h4 id="with-gcc-in-terminal"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#with-gcc-in-terminal">with GCC in terminal</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>g++<span class="w"> </span>-std<span class="o">=</span>c++11<span class="w"> </span>-O3<span class="w"> </span>-I..<span class="w"> </span>../dlib/all/source.cpp<span class="w"> </span>-lpthread<span class="w"> </span>-lX11<span class="w"> </span>example_program_name.cpp
</span></code></pre></div>
<p>windows 下还需<code>gdi32, comctl32, user32, winmm, ws2_32, or imm32</code>库</p>
<h4 id="with-visualstudio"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#with-visualstudio">with VisualStudio</a></h4>
<ul>
<li>
<p>把 dlib 的<strong>父目录</strong>添加到 include search path</p>
<blockquote>
<p>You should <em>NOT</em> add the dlib folder itself to your compiler's include path.
Doing so will cause the build to fail because of name collisions (such as
dlib/string.h and string.h from the standard library). Instead you should
add the folder that contains the dlib folder to your include search path
and then use include statements of the form #include <dlib/queue.h> or</p>
<h2 id="include-dlibqueueh-this-will-ensure-that-everything-builds-correctly"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#include-dlibqueueh-this-will-ensure-that-everything-builds-correctly">include "dlib/queue.h".  This will ensure that everything builds correctly.</a></h2>
</blockquote>
</li>
</ul>
<ul>
<li>
<p>把 dlib/all/source.cpp 添加到源文件</p>
<blockquote>
<p>If you are using Visual Studio you add .cpp files to your application using
the solution explorer window.  Specifically, right click on Source Files,
then select Add -&gt; Existing Item and select the .cpp files you want to add.</p>
</blockquote>
</li>
</ul>
<ul>
<li>如果需要 libjpeg 等，把 dlib/external 文件夹下的源文件添加到 project，并 define the DLIB_PNG_SUPPORT and DLIB_JPEG_SUPPORT preprocessor directives.</li>
</ul>
<h4 id="installing-dlib-as-a-precompiled-library"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#installing-dlib-as-a-precompiled-library">Installing dlib as a precompiled library</a></h4>
<p>dlib 的 CMake 脚本包含 INSTALL target，因此可以像其它 C++ 库一样将 dlib 作为一个静态或动态库安装到系统上。</p>
<ul>
<li>
<p><strong>使用预编译的库时，必须保证项目中使用的所有库都是同一个版本的 VisualStudio 编译出来的。</strong></p>
<p>说明：<a href="http://siomsystems.com/mixing-visual-studio-versions/">Mixing Multiple Visual Studio Versions in a Program is Evil</a></p>
</li>
</ul>
<ul>
<li>调用 dlib 时出现 USER_ERROR <strong>inconsistent_build_configuration</strong> see_dlib_faq_2 错误。
  需要将 build/dlib/config.h 文件拷贝到源码目录 dlib-19.17/dlib 进行覆盖。config.h 文件内有其说明。</li>
</ul>
<h3 id="配置-3d_face_reconstruction-总结"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#配置-3d_face_reconstruction-总结">配置 3d_face_reconstruction 总结</a></h3>
<h4 id="1-opencv"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#1-opencv">1. OpenCV</a></h4>
<ol>
<li>
<p>windows 下载预编译版 (只含有 msvc 编译的版本)</p>
</li>
<li>
<p>CMake 直接使用 find_packages 即可。（需添加环境变量，以便找到 OpenCV 的 config 文件）</p>
</li>
</ol>
<h4 id="2-dlib"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#2-dlib">2. dlib</a></h4>
<ol>
<li>
<p>官方推荐将代码直接包含到项目中编译（好处是没有 ABI 一致性问题）</p>
<p>CMake 中 add_subdirectory(/path/to/dlib/top/dir) 即可。（甚至可以自动从网上下载）</p>
</li>
</ol>
<h4 id="3-boost"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#3-boost">3. boost</a></h4>
<ol>
<li>分为只含有头文件的库和需要独立编译的库。</li>
<li>官方编译方法为：<ol>
<li>先 build 出 Boost.Build（可以看作 Boost 的一个 build 工具）</li>
<li>然后调用 b2 编译指定模块。（可以添加参数指定编译的库的路径）</li>
<li>我的编译目录是 stage/（库位于 stage/lib/下）</li>
</ol>
</li>
<li>CMake find_packages 暂时是失败的。</li>
</ol>
<h4 id="4-eos"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#4-eos">4. eos</a></h4>
<ol>
<li>只需要包含头文件即可 (header only)，include 和 3rdparty</li>
<li>顶层目录下的 CMakeLists.txt 默认勾选了编译 example 下的示例（需要 boost 的 system, filesystem, program_options 和 openCV 的 core, higui, imgproc</li>
<li>CMake 直接 add_subdirectory(/path/to/eos) 比较方便。</li>
</ol>
<h4 id="5-qt"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#5-qt">5. Qt</a></h4>
<ol>
<li>官方介绍了如何使用 CMake find_packages，自动 tic, moc 等。</li>
</ol>
<h4 id="todo"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/03/01/2020-02-29-use-dlib-in-c%2B%2B/#todo">TODO</a></h4>
<ol>
<li>学习 Qt，能自己写界面。</li>
<li>明白 eos 那个示例程序输入输出是什么</li>
<li>最后，自己来改写 eos 的程序，自己写 Qt 程序，最后展示出来。</li>
</ol>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-29 12:00:00+00:00">2020年2月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-meta__link">学习笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="安装使用-opencvwindows"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/29/2020-02-29-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8OpenCV%28windows%29/">安装使用 OpenCV(windows)</a></h2>
<h3 id="install"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/29/2020-02-29-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8OpenCV%28windows%29/#install">Install</a></h3>
<h4 id="安装预编译版"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/29/2020-02-29-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8OpenCV%28windows%29/#安装预编译版">安装预编译版</a></h4>
<p>在<a href="https://opencv.org/releases.html">opencv.org</a>上提供了源代码以及各个操作系统的预编译版。windows 预编译版为一个 installer 程序，运行后会将各种文件 extract 到安装目录。安装完成后，<code>/path/to/opencv/</code>包含两个目录——build, source。source 为源代码目录 (和直接下载源代码解压一模一样)，build 下包含了许多其它文件。其中：</p>
<ul>
<li><strong>include/</strong>为调用 OpenCV 时需要包含的头文件 (源代码目录下也有)</li>
</ul>
<ul>
<li>
<p><strong>x64/vcxx/</strong>下包含 bin/和 lib/，为预编译的库。vcxx 代表使用 MSVC xx 编译的，运行时需要对应的 runtime 库。</p>
<table>
<thead>
<tr>
<th>IDE</th>
<th>编译器</th>
</tr>
</thead>
<tbody>
<tr>
<td>VS2017</td>
<td>VC15</td>
</tr>
<tr>
<td>VS2015</td>
<td>VC14</td>
</tr>
<tr>
<td>VS2013</td>
<td>VC12</td>
</tr>
<tr>
<td>VS2012</td>
<td>VC11</td>
</tr>
<tr>
<td>VS2010</td>
<td>VC10</td>
</tr>
<tr>
<td>VS2008</td>
<td>VC9</td>
</tr>
<tr>
<td>VS2005</td>
<td>VC8</td>
</tr>
</tbody>
</table>
</li>
</ul>
<ul>
<li><strong>etc/</strong>文件夹中是 OpenCV 某些算法所依赖的数据集。</li>
</ul>
<ul>
<li><strong><code>OpenCVConfig.cmake</code></strong>文件在使用 CMake 编译项目时可使用 find_package 自动搜索头文件、库文件路径</li>
</ul>
<ul>
<li>其它文件暂时不管</li>
</ul>
<h4 id="从源文件编译-opencv"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/29/2020-02-29-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8OpenCV%28windows%29/#从源文件编译-opencv">从源文件编译 OpenCV</a></h4>
<p>略</p>
<h3 id="usage"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/29/2020-02-29-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8OpenCV%28windows%29/#usage">Usage</a></h3>
<h4 id="通过-visualstudio-编译-opencv-程序"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/29/2020-02-29-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8OpenCV%28windows%29/#通过-visualstudio-编译-opencv-程序">通过 VisualStudio 编译 OpenCV 程序</a></h4>
<ol>
<li>
<p>菜单栏 project-&gt;properities。（或在右侧的 Solution Explorer 下找到一个 project(solution 和 project 的关系)。鼠标右键-&gt;Properities）</p>
</li>
<li>
<p>C/C++/AdditionalIncludeDirectories。编译器从该文件夹下查找头文件。</p>
<p>(<em>p.s.</em> <code>#include "opencv2/opencv.hpp"</code>和<code>#include "opencv.hpp"</code>对应不同的设置)</p>
</li>
<li>
<p>Linker/Input/AdditionalDependencies 添加<code>opencv_world420.lib</code></p>
</li>
<li>
<p>Linker/General/AdditionalLibraryDirectories 添加<code>opencv_world420.lib</code>所在目录。（或直接在 3 中输入绝对路径）</p>
</li>
<li>
<p>设置环境变量，把<code>opencv_world420.dll</code>所在目录添加到 Path 变量。(否则运行时报错：无法找到<code>opencv_world420.dll</code>)。不添加环境变量的方法是直接把<code>opencv_world420.dll</code>拷贝到 exe 所在目录。</p>
<p><em>p.s.</em> 貌似<code>opencv_world420.lib</code>表面上是一个静态链接库，但实际上是一个动态链接库，因而运行时需要<code>opencv_world420.dll</code>。而第 3 步如若改成添加<code>opencv_world420.dll</code>，则编译失败。</p>
<blockquote>
<p>LNK1107 could also occur if you attempt to pass a module (.dll or .netmodule extension created with <a href="https://docs.microsoft.com/en-us/cpp/build/reference/clr-common-language-runtime-compilation?view=vs-2019">/clr:noAssembly</a> or <a href="https://docs.microsoft.com/en-us/cpp/build/reference/noassembly-create-a-msil-module?view=vs-2019">/NOASSEMBLY</a>) to the linker; pass the .obj file instead.</p>
</blockquote>
</li>
</ol>
<h4 id="通过-cmake-编译-opencv-程序"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/29/2020-02-29-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8OpenCV%28windows%29/#通过-cmake-编译-opencv-程序">通过 CMake 编译 OpenCV 程序</a></h4>
<p>参考：<a href="https://docs.opencv.org/2.4/doc/tutorials/introduction/linux_gcc_cmake/linux_gcc_cmake.html">Using OpenCV with gcc and CMake</a></p>
<p>通过 CMake 编译 OpenCV 程序有几点好处：</p>
<ul>
<li>在 Windows 和 Linux 之间移植程序不用更改设置。</li>
</ul>
<ul>
<li>自动搜索 include，lib 路径。(通过<code>OpenCVConfig.cmake</code>文件，需添加到 Path 环境变量)</li>
<li>写代码的方式比 VisualStudio 点击按钮然后输入方便，配置的文件可以保留下来用于其它项目。</li>
</ul>
<p>缺点：</p>
<ul>
<li>
<h2 id="include-某个文件vs-code-不会自动提示不会自动自动补全函数不会显示函数文档"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/29/2020-02-29-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8OpenCV%28windows%29/#include-某个文件vs-code-不会自动提示不会自动自动补全函数不会显示函数文档">include 某个文件，VS Code 不会自动提示，不会自动自动补全函数，不会显示函数文档</a></h2>
<p>（可以先用 CMake 配置好 include, lib 后，生成 sln 并用 VS 打开）</p>
</li>
</ul>
<p>步骤：</p>
<ol>
<li>
<p>添加<code>opencv/build/</code>到 Path(<code>OpenCVConfig.cmake</code>所在目录)。</p>
</li>
<li>
<p>编写<code>CMakeLists.txt</code>。示例：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>cmake_minimum_required(VERSION 2.8)
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>project( DisplayImage )
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>find_package( OpenCV REQUIRED ) //
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>add_executable( DisplayImage DisplayImage.cpp )
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>target_link_libraries( DisplayImage ${OpenCV_LIBS} ) //
</span></code></pre></div>
</li>
<li>
<p>使用 CMake GUI，点击 configure(可以先 File-&gt;Delete Cache，删除掉之前的配置)</p>
<p>选择 VS 的编译器。</p>
</li>
<li>
<p>在中间面板修改一些变量的值。（重新 configure）</p>
</li>
<li>
<p>Generate，在 build 目录下生成 VS 的 sln 文件，双击打开。</p>
</li>
<li>
<p>在 ALL_BUILD 上右键 build。</p>
</li>
</ol>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-16 00:07:30+00:00">2020年2月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-meta__link">学习笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="运行-hpl"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/16/2020-02-16-HPL-complie/">运行 HPL</a></h2>
<h3 id="编译-blascblas"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/16/2020-02-16-HPL-complie/#编译-blascblas">编译 BLAS/CBLAS</a></h3>
<p>BLAS 为 fortran 接口的库，CBLAS 为 C 语言接口的库</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="w"> </span>tar<span class="w"> </span>zxf<span class="w"> </span>blas-3.8.0.tgz<span class="w"> </span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w"> </span>tar<span class="w"> </span>zxf<span class="w"> </span>cblas.tgz
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>BLAS-3.8.0
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w"> </span>make<span class="w"> </span><span class="c1">#生成blas_LINUX.a</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w"> </span>cp<span class="w"> </span>blas_LINUX.a<span class="w"> </span>../CBLAS
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>../CBLAS
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w"> </span>vi<span class="w"> </span>Makefile.in
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w"> </span><span class="c1">#修改</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w"> </span><span class="c1"># BLLIB = ../blas_LINUX.a</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w"> </span>make<span class="w"> </span><span class="c1">#在lib/下生成cblas_LINUX.a</span>
</span></code></pre></div>
<h3 id="编译-hpl"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/16/2020-02-16-HPL-complie/#编译-hpl">编译 HPL</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>tar<span class="w"> </span>zxf<span class="w"> </span>hpl-2.3.tar.gz<span class="w"> </span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nb">cd</span><span class="w"> </span>hpl-2.3
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>cp<span class="w"> </span>setup/Make.Linux_PII_CBLAS<span class="w"> </span>./Make.&lt;arch&gt;<span class="w"> </span><span class="c1">#在top-level 文件夹下</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>vi<span class="w"> </span>Make.&lt;arch&gt;<span class="w"> </span><span class="c1">#修改</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>make<span class="w"> </span>&lt;arch&gt;<span class="w"> </span><span class="c1">#在bin/&lt;arch&gt;/下生成HPL.dat xhpl</span>
</span></code></pre></div>
<h4 id="make示例"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/16/2020-02-16-HPL-complie/#make示例">Make.<arch>示例</a></h4>
<h5 id="openmpicblas"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/16/2020-02-16-HPL-complie/#openmpicblas">OpenMPI+CBLAS</a></h5>
<div class="language-makefile highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nv">ARCH</span><span class="w">         </span><span class="o">=</span><span class="w"> </span>&lt;arch&gt;
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nv">TOPdir</span><span class="w">       </span><span class="o">=</span><span class="w"> </span>/home/mpiuser/hpl-2.3
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="nv">MPdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>/path/to/OpenMPI
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="nv">MPinc</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>-I<span class="k">$(</span>MPdir<span class="k">)</span>/include
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="nv">MPlib</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>MPdir<span class="k">)</span>/lib/libmpi.so
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="nv">LAdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="nv">LAinc</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="nv">LAlib</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>path/to/cblas_LINUX.a<span class="w"> </span>path/to/blas_LINUX.a<span class="w"> </span><span class="c1">#顺序不能改变，cblas依赖blas</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="nv">HPL_OPTS</span><span class="w">     </span><span class="o">=</span><span class="w"> </span>-DHPL_CALL_CBLAS<span class="w"> </span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="nv">CC</span><span class="w">           </span><span class="o">=</span><span class="w"> </span>mpicc
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="nv">LINKER</span><span class="w">       </span><span class="o">=</span><span class="w"> </span>mpif77
</span></code></pre></div>
<h3 id="hpl-优化"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/16/2020-02-16-HPL-complie/#hpl-优化">HPL 优化</a></h3>
<h4 id="配置参数"><a class="toclink" href="../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2020/02/16/2020-02-16-HPL-complie/#配置参数">配置参数</a></h4>
<p>计算次数：</p>
<div class="arithmatex">\[
\#Ns \times \#NBs \times \#(Ps, Qs) \times \#PFACTs \times \#NBMINs \times \#BCASTs \times \#DEPTHs
\]</div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>HPLinpack benchmark input file
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>Innovative Computing Laboratory, University of Tennessee
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>HPL.out      output file name (if any)
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>6            device out (6=stdout,7=stderr,file)
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>1            # of problems sizes (N)
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>8192         Ns
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>1            # of NBs
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>128          NBs
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>0            PMAP process mapping (0=Row-,1=Column-major)
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>3            # of process grids (P x Q)
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>2 1 4        Ps
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>2 4 1        Qs
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>16.0         threshold
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>3            # of panel fact
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>0 1 2        PFACTs (0=left, 1=Crout, 2=Right)
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>2            # of recursive stopping criterium
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>2 4          NBMINs (&gt;= 1)
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>2            # of panels in recursion
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>2            NDIVs
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>3            # of recursive panel fact.
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>0 1 2        RFACTs (0=left, 1=Crout, 2=Right)
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>1            # of broadcast
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>0            BCASTs (0=1rg,1=1rM,2=2rg,3=2rM,4=Lng,5=LnM)
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>1            # of lookahead depth
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>0            DEPTHs (&gt;=0)
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>2            SWAP (0=bin-exch,1=long,2=mix)
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>64           swapping threshold
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>0            L1 in (0=transposed,1=no-transposed) form
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>0            U  in (0=transposed,1=no-transposed) form
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>1            Equilibration (0=no,1=yes)
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>8            memory alignment in double (&gt; 0)
</span></code></pre></div>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-14 02:07:30+00:00">2020年2月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E4%B8%AA%E4%BA%BA/" class="md-meta__link">个人</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="记录一次失眠"><a class="toclink" href="../../%E4%B8%AA%E4%BA%BA/2020/02/14/2020-02-14-%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%A4%B1%E7%9C%A0/">记录一次失眠</a></h2>
<p>今天查了一些关于保研的事，
晚上有点失眠。
我回顾了以往的事，
有初中还有高中。</p>
<p>我回忆起那时自己是怎样的模样，
我感慨有些事不记录也许就真的忘了。
我明白如果不经常眺望一下远方，
而只是低头看着现在，
时间也许眨眼就过去了。</p>
<p>要对短期的未来有所计划，
计划不是一个严格的日程表，
让自己失去自由，
而是明白你最近最想做什么，
你现在想做什么。</p>
<p>我想要：
1 我想要练习口语，为夏令营的英语自我介绍做准备
2 我想要联系一些同学，和他们聊聊未来。必定有所收获。
3 我想有一个爱好，如学会基础的日语。
4 我想在编程能力（数据结构和算法）上有所提高。</p>
<p>我发现列出愿望能让自己更加明确方向。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-11 23:25:33+00:00">2020年2月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E5%8D%9A%E5%AE%A2/" class="md-meta__link">博客</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="井字棋与最大最小值算法"><a class="toclink" href="../../%E5%8D%9A%E5%AE%A2/2020/02/11/2020-02-11-%E4%BA%95%E5%AD%97%E6%A3%8B%E4%B8%8E%E6%9C%80%E5%A4%A7%E6%9C%80%E5%B0%8F%E5%80%BC%E7%AE%97%E6%B3%95/">井字棋与最大最小值算法</a></h2>
<p>经过昨晚，和今天早上 8 点醒来趴在床上努力的思考。我终于想起了如何使用数学归纳法证明策梅洛定理。然后经过一上午的努力，我成功使用最大最小值算法实现了井字棋 (Tic-Tak-Toe) 的 AI，然后添加到 wwh 的井字棋代码中。</p>

    
      <nav class="md-post__action">
        <a href="../../%E5%8D%9A%E5%AE%A2/2020/02/11/2020-02-11-%E4%BA%95%E5%AD%97%E6%A3%8B%E4%B8%8E%E6%9C%80%E5%A4%A7%E6%9C%80%E5%B0%8F%E5%80%BC%E7%AE%97%E6%B3%95/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-09 22:39:14+00:00">2020年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E4%B8%AA%E4%BA%BA/" class="md-meta__link">个人</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="vacation-routine-asc2020-tips-up-to-0209"><a class="toclink" href="../../%E4%B8%AA%E4%BA%BA/2020/02/09/2020-02-09-Vacation-routine-ASC2020-tips-up-to-02-09/">Vacation routine: ASC2020 tips (up to 02/09)</a></h2>
<p>记录了这么多天弄 ASC2020 学到的一些知识，原本记录在 txt 里:-)，因此有点丑。</p>

    
      <nav class="md-post__action">
        <a href="../../%E4%B8%AA%E4%BA%BA/2020/02/09/2020-02-09-Vacation-routine-ASC2020-tips-up-to-02-09/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-02 19:08:52+00:00">2020年2月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-meta__link">折腾记录</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="windows-重装系统步骤"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/02/02/2020-02-02-windows%E9%87%8D%E8%A3%85%E7%B3%BB%E7%BB%9F%E6%AD%A5%E9%AA%A4/">windows 重装系统步骤</a></h2>
<p>windows 重装系统步骤</p>

    
      <nav class="md-post__action">
        <a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/02/02/2020-02-02-windows%E9%87%8D%E8%A3%85%E7%B3%BB%E7%BB%9F%E6%AD%A5%E9%AA%A4/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-02 19:08:52+00:00">2020年2月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-meta__link">折腾记录</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="安装-centos-虚拟机以及配置-gameboylive-记录"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/02/02/2020-02-02-%E5%AE%89%E8%A3%85centos%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AEgameboy.live%E8%AE%B0%E5%BD%95/">安装 centos 虚拟机以及配置 gameboy.live 记录</a></h2>
<p>安装 centos 虚拟机以及配置 gameboy.live 记录</p>

    
      <nav class="md-post__action">
        <a href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2020/02/02/2020-02-02-%E5%AE%89%E8%A3%85centos%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AEgameboy.live%E8%AE%B0%E5%BD%95/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-07 22:24:46+00:00">2020年1月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-meta__link">课程笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="risc-v-报告"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/">RISC-V 报告</a></h2>
<p>author: 计科卓越班 袁福焱 20174260</p>
<h3 id="0-导言"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/#0-导言">0. 导言</a></h3>
<p>RISC-V 是 21 世纪诞生的一种完全开放的计算机精简指令集，可应用于小到嵌入式系统大到高性能处理器等广泛领域。RISC-V 充分汲取了许多指令集的实践经验，具有非常多的优点。并且它完全开放，采用 BSD 开源协议——全世界任何公司、大学、个人都可以自由免费地使用 RISC-V 指令集构建自己的系统。</p>
<p>本报告第一部分讲述 RISC-V 的几个主要特点与优势，第二部分介绍 RISC-V 的目前已构建建的生态系统。最后一部分，谈论 RISC-V 在推动开源硬件中起到的作用。</p>
<h3 id="1-risc-v-的特点"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/#1-risc-v-的特点">1. RISC-V 的特点</a></h3>
<h4 id="11-指令集模块化"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/#11-指令集模块化">1.1 指令集模块化</a></h4>
<p>以往的指令集为了实现兼容，往往采用增量扩展的方法。即新的处理器不仅要实现新的扩展，还必需要实现过去所有的扩展。如典型的 x86 架构，其中许多指令早已失效，但为了兼容性却必须实现，这导致硬件实现变得越来越复杂。RISC-V 按照功能将指令集分为很多个模块。其中 I 模块为基础整型指令集，这是 RISC-V 要求必须实现的指令集，并且永远不会发生改变。只要实现了该指令集便可以运行完整的基于 RISC-V 的软件。这样，RISC-V 在扩展时便不再会像 x86 那样背上沉重的历史包裹。编译器也可以在保证兼容的基础上，根据已实现的扩展，选择性地生成更高效的代码。</p>
<h4 id="12-回避以往的设计缺陷"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/#12-回避以往的设计缺陷">1.2 回避以往的设计缺陷</a></h4>
<p>目前主流的指令集有 x86, ARM, MIPS 等。其中 x86 为复杂指令集 (RISC)，于 1978 年诞生。而 ARM, MIPS 为精简指令集 (RISC)，都是 1986 年诞生的。从计算机体系结构的发展上来看，RISC 由于简洁性，能够更加充分地利用现代微体系结构中的流水线、分支预测、cache 等技术，因此比 CISC 更加高效。因此，诞生于 21 世纪 (2004) 的 RISC-V，必然也是精简指令集。并且，由于有了前面指令的经验，RISC-V 吸收了以往指令集的优点，并回避了以往指令集的一些缺陷。优点如，RISC-V 有 32 个通用寄存器，有专门的 0 寄存器。使用专门的移位指令来处理移位操作。使用 load/store 指令访问内存。跳转指令不使用条件码。缺陷则如，RISC-V 废弃了 MIPS 中的分支延迟槽 (有利于架构和实现的分离)，立即数只进行有符号扩展，算数运算不抛出异常 (通过软件判断)，更规整的指令格式（源及目的字段位置固定），整数乘除法可选 (简化了基础实现)。</p>
<h4 id="13-完全开放"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/#13-完全开放">1.3 完全开放</a></h4>
<p>RISC-V 采用 BSD 开源协议，任何人都可以自由免费地使用 RISC-V。其他指令集如 x86 是完全闭源的，只有 intel 和 AMD 等少数公司能够基于 x86 架构生产产品。而 ARM 和 MIPS 都采用授权的方式，通过卖授权的方式盈利，其中 ARM 的授权费则十分昂贵。RISC-V 如今由 RISC-V 基金会维护，任何公司只要愿意每年支付一笔会员费即可成为会员，会员可以参与到 RISC-V 之后标准的制定中。RISC-V 也因此真正成为一个开放的指令集，不会因为任何一个公司的起伏而受到影响。</p>
<h3 id="2-risc-v-的生态"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/#2-risc-v-的生态">2. RISC-V 的生态</a></h3>
<p>以下内容引用自<a href="http://crva.io/documents/OpenISA-OpenSourceChip-Report.pdf">开放指令集与开源芯片进展报告-v1p1</a></p>
<blockquote>
<p>2011 年，加州大学伯克利分校发布了开放指令集 RISC-V，并很快建立起一个开源软硬件生态系统。截止 2019 年 1 月，已有包括 Google、NVidia 等在内的 200 多个公司和高校在资助和参与 RISC-V 项目。其中，部分企业已经开始将 RISC-V 集成到产品中。例如全球第一大硬盘厂商西部数据（Western Digital）最近宣布将把每年各类存储产品中嵌入的 10 亿个处理器核换成 RISC-V；Google 利用 RISC-V 来实现主板控制模块；NVidia 也将在 GPU 上引入 RISC-V 等。此外，国内阿里巴巴、华为、联想等公司都在逐步研究各自的 RISC-V 实现；上海市将 RISC-V 列为重点扶持项目；印度政府也正在大力资助基于 RISC-V 的处理器项目，使 RISC-V 成为了印度的事实国家指令集。</p>
</blockquote>
<p>由此可见，RISC-V 国内外的兴起使得目前 RISC-V 的生态已经比较完善了。</p>
<h3 id="3-之于构建开放硬件生态的意义"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/#3-之于构建开放硬件生态的意义">3. 之于构建开放硬件生态的意义</a></h3>
<p>2019 年度国际计算机体系结构旗舰会议 ISCA 于 6 月在美国亚利桑那州凤凰城召开，会议的主题即是“面向下一代计算的敏捷开放硬件（Agile and Open Hardware for Next-Generation Computing）”。由此可见开放硬件，敏捷开发已成为未来的趋势。而 RISC-V 则刚好成为这趋势中不可或缺的一环。</p>
<p>目前开源硬件开发中面临着 4 个关键问题 (Yungang Bao, Chinese Academy of Sciences, The Four Steps to An Open-Source Chip Design Ecosystem)：</p>
<ol>
<li>开放的指令集 ISA/开源 IPs/开源 Socs</li>
<li>硬件描述语言 Lanuages/开源的 EDA 工具</li>
<li>验证和仿真 Vertification/Simulation</li>
<li>OS/Complier</li>
</ol>
<p>RISC-V 便处于第一环中，</p>
<p>虽然目前每个环节都还未完全解决，但我们可以相信，在未来，开发硬件可以像开发一个软件一样。充分利用已开源的资源，用户只需要定制 10% 以内的代码，便可以以月为单位开发出客制化的硬件系统。</p>
<h3 id="4-参考资料"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2020/01/07/2020-02-09-RISC-V-trend/#4-参考资料">4. 参考资料</a></h3>
<p><a href="https://mp.weixin.qq.com/s/deNZzdSfxbdUoO58ok53tw">大道至简——RISC-V 架构之魂（上）</a></p>
<p><a href="https://mp.weixin.qq.com/s/rB9ln7-cDb0VjtikD6KWzw">大道至简——RISC-V 架构之魂（中）</a></p>
<p><a href="https://mp.weixin.qq.com/s/sIkKnJt6rQLxM5GM60OnLA">大道至简——RISC-V 架构之魂（下）</a></p>
<p><a href="http://crva.io/documents/OpenISA-OpenSourceChip-Report.pdf">开放指令集与开源芯片进展报告-v1p1（2019-02-22 更新）</a></p>
<p><a href="http://crva.io/documents/SIGARCH-Visioning-Workshop-Summary-Agile-and-Open-Hardware-for-Next-Generation-Computing.pdf">远景研讨会纪要–面向下一代计算的开源芯片与敏捷开发</a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-01 00:00:00+00:00">2020年1月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E9%98%85%E8%AF%BB/" class="md-meta__link">阅读</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="嵌入式技术基础与实践-第五版"><a class="toclink" href="../../%E9%98%85%E8%AF%BB/2020/01/01/2020-01-01-%E5%B5%8C%E5%85%A5%E5%BC%8F%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E8%B7%B5/">嵌入式技术基础与实践 第五版</a></h2>
<h3 id="心得"><a class="toclink" href="../../%E9%98%85%E8%AF%BB/2020/01/01/2020-01-01-%E5%B5%8C%E5%85%A5%E5%BC%8F%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E8%B7%B5/#心得">心得</a></h3>
<ol>
<li>
<p>为什么单片机可以控制灯的亮灭，通用 PC 却没办法控制灯呢？（因为没有 CPU 到 LED 的接口也没有驱动程序）</p>
</li>
<li>
<p>中断向量机制和 MIPS 采用的统一入口地址不太一样。中断向量机制硬件产生中断请求时，中断号是确定了的（通过中断控制器发送中断号），软件可以配置对应中断服务程序。而 MIPS 没有中断号的概念，通过软件检查 Stastus 寄存器，来确定是哪一个中断，跳转到对应中断服务程序。</p>
<p>中断向量机制的 CPU 通常需要一个中断控制器，连接在总线上。中断控制器会给 CPU 提供中断号。</p>
</li>
<li>
<p>MCU 本质就是一个微型计算机，包含 CPU，存储器，I/O 接口（控制器模块）。嵌入式开发就是要基于 MCU 搭建一个硬件系统（通过 MCU 的 I/O 接口连接各种需要被控制的外设），并逐层向上编写构件（驱动），最后基于构件编写嵌入式应用，从而完成需要的功能。</p>
</li>
<li>
<p>MCU 由于需要通用性，使得用户可以基于 MCU 去搭建自己的系统，驱动自己的外设，因此每个引脚都复用多个功能。通过配置 MCU 内对应控制器的寄存器来配置引脚的功能。</p>
<p>比如 MSP432 100 个引脚中有 84 个可以配置成 GPIO 引脚。只需要将 MSP432 分配的 GPIO 寄存器中的 PxSEL0, PxSEL1 寄存器（x 表示端口号，有 11 个端口 P1~P10 和 PJ）都置为 0 时，该端口的引脚即为 GPIO 功能。同样可以通过配置 GPIO 寄存器控制引脚方向作为输入还是输出，用于点亮 LED 灯或者接受开关输入。</p>
<p>再比如 MSP432 有 4 个增强型通用串行通信接口模块 (eUSCI)，也分配了若干寄存器。通过配置寄存器可以将对应引脚配置为 UART 的引脚或 SPI 的引脚。</p>
<p>但是我们在 FPGA 上搭建 SoC 时，开发板上的灯、拨码开关和 FGPA 芯片的引脚是连好了的（由开发板的提供商基于 FPGA 芯片搭建），也就是说每个引脚作为输入还是输出是已经确定了的。我们能改变的只是——是否使用该外设。当然，不排除保留了一些引脚被接到扩展插口上（那一排排的黑色插孔）。因此在 FPGA 上搭建 SoC 后，实现外设驱动需要对外设的控制器进行配置。而嵌入式开发还多出了配置 MCU 内用于复用的模块寄存器。</p>
</li>
</ol>

    
      <nav class="md-post__action">
        <a href="../../%E9%98%85%E8%AF%BB/2020/01/01/2020-01-01-%E5%B5%8C%E5%85%A5%E5%BC%8F%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E8%B7%B5/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-12-21 02:51:12+00:00">2019年12月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="md-meta__link">课程笔记</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="非对齐指令总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2019/12/21/2019-12-21-mips%E9%9D%9E%E5%AF%B9%E9%BD%90%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%A4%A7%E5%B0%8F%E7%AB%AF/">非对齐指令总结</a></h2>
<h3 id="1-大端与小端"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2019/12/21/2019-12-21-mips%E9%9D%9E%E5%AF%B9%E9%BD%90%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%A4%A7%E5%B0%8F%E7%AB%AF/#1-大端与小端">1 大端与小端</a></h3>
<ul>
<li>大端：数据的高位位于内存的低地址，数据的地位位于内存的高地址。</li>
<li>小端：与大端相反。</li>
</ul>
<p>事实上大端更符合人的思维，因为在写一个数字时人们更习惯从高位写到低位，且高位是写在左边的。而这可以直接和内存的“图像”对应，而小端则需要把每个字的字节地址颠倒一下才可以。
例如，一个 32 位的整数 0xffeeddcc，在内存里的存储情况如下。<em>（非对齐，起始地址为 0x01）</em></p>
<p><strong>大端</strong>:
           0  1  2  3
0x00    00ffeedd
0x01    cc556677
<strong>小端</strong>:
           3  2  1  0
0x00    eeddcc00
0x01    776655ff
<em>ps.假设除去该整数存储的空间，字节地址与存储的十六进制数对应，即地址为 0x01 存 11，0x05 存 55，这点用来突出字节地址是多少。</em></p>
<h3 id="2-非对齐指令"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2019/12/21/2019-12-21-mips%E9%9D%9E%E5%AF%B9%E9%BD%90%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%A4%A7%E5%B0%8F%E7%AB%AF/#2-非对齐指令">2 非对齐指令</a></h3>
<p>instruction
lwl/swl, lwr/swr
usage
lwl t0, offset(s0)</p>
<p><em>其中的 left，与 shift left 的“左”都表示数据的高位。right 则表示数据的低位。</em></p>
<p>lwl 表示将内存对应地址所在的字（align_address，即抹掉地址低两位对应地址）的数据低位复制到寄存器数据的高位。寄存器其它部分不变。</p>
<p>swl 则表示将寄存器的数据高位复制到内存对应数据低位。其它部分不变。
即
lwl/swl
寄存器数据高位↹内存数据低位
lwr/swr
寄存器数据低位↹内存数据高位</p>
<h4 id="1-从1-中读取该整数实例"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2019/12/21/2019-12-21-mips%E9%9D%9E%E5%AF%B9%E9%BD%90%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%A4%A7%E5%B0%8F%E7%AB%AF/#1-从1-中读取该整数实例">1 从#1 中读取该整数实例</a></h4>
<p>大端
lwl s0, 0(1)
lwr s0, 3(1)
小端
lwr s0, 0(1)
lwl s0, 3(1)</p>
<p><em>将整数以图中所示存储到内存中只需将 lw*改为 sw*。</em></p>
<p>可以以此定义非对齐加载、存储伪指令，
如 uld(rd, rb) 表示非对齐 load，加载内存[rb+3:rb]的数据，
uld(rd, rb)=&gt;
lwl rd, 0(rb)
lwr rd, 3(rb)
<em>（可能 uld 是加载 8 字节，待确认）</em></p>
<h4 id="2-关于-loadstore-多少字节"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/2019/12/21/2019-12-21-mips%E9%9D%9E%E5%AF%B9%E9%BD%90%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%A4%A7%E5%B0%8F%E7%AB%AF/#2-关于-loadstore-多少字节">2 关于 load/store 多少字节</a></h4>
<p>n 为地址低 2 位，n=addr[1:0]
大端
lwl/swl  4-n
lwr/swr   n+1
小端
lwr/swr 4-n
lwl/swl n+1</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-12-21 02:38:02+00:00">2019年12月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="md-meta__link">折腾记录</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="write-blog-in-pc-through-sshing-to-a-mobile-phone"><a class="toclink" href="../../%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/2019/12/21/2019-12-21-write-blog-in-PC-through-sshing-to-a-mobile-phone/">write blog in PC through sshing to a mobile phone</a></h2>
<p>这是一篇文章。</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../..">1</a> <a class="md-pagination__link" href="../2/">2</a> <a class="md-pagination__link" href="../3/">3</a> <span class="md-pagination__current">4</span> <a class="md-pagination__link" href="../5/">5</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
        
          
          <a href="../../about/" class="md-footer__link md-footer__link--next" aria-label="下一页: 关于">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                关于
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/TheRainstorm" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>